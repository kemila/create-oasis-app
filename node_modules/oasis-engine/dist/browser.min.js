!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).oasisEngine={})}(this,(function(e){"use strict";var t,r;(t=e.ContainmentType||(e.ContainmentType={}))[t.Disjoint=0]="Disjoint",t[t.Contains=1]="Contains",t[t.Intersects=2]="Intersects",(r=e.PlaneIntersectionType||(e.PlaneIntersectionType={}))[r.Back=0]="Back",r[r.Front=1]="Front",r[r.Intersecting=2]="Intersecting";var n=function(){function e(){}return e.clamp=function(e,t,r){return Math.max(t,Math.min(r,e))},e.equals=function(t,r){return Math.abs(t-r)<=e.zeroTolerance},e.isPowerOf2=function(e){return 0==(e&e-1)},e.radianToDegree=function(t){return t*e.radToDegreeFactor},e.degreeToRadian=function(t){return t*e.degreeToRadFactor},e}();n.zeroTolerance=1e-6,n.radToDegreeFactor=180/Math.PI,n.degreeToRadFactor=Math.PI/180;var i=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this.x=void 0,this.y=void 0,this.z=void 0,this.x=e,this.y=t,this.z=r}e.add=function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z},e.subtract=function(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z},e.multiply=function(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z},e.divide=function(e,t,r){r.x=e.x/t.x,r.y=e.y/t.y,r.z=e.z/t.z},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},e.cross=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,c=t.z;r.x=i*c-a*s,r.y=a*o-n*c,r.z=n*s-i*o},e.distance=function(e,t){var r=t.x-e.x,n=t.y-e.y,i=t.z-e.z;return Math.sqrt(r*r+n*n+i*i)},e.distanceSquared=function(e,t){var r=t.x-e.x,n=t.y-e.y,i=t.z-e.z;return r*r+n*n+i*i},e.equals=function(e,t){return n.equals(e.x,t.x)&&n.equals(e.y,t.y)&&n.equals(e.z,t.z)},e.lerp=function(e,t,r,n){var i=e.x,a=e.y,o=e.z;n.x=i+(t.x-i)*r,n.y=a+(t.y-a)*r,n.z=o+(t.z-o)*r},e.max=function(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)},e.min=function(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z},e.normalize=function(e,t){var r=e.x,n=e.y,i=e.z,a=Math.sqrt(r*r+n*n+i*i);a>0&&(a=1/a,t.x=r*a,t.y=n*a,t.z=i*a)},e.scale=function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t},e.transformNormal=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=n*o[0]+i*o[4]+a*o[8],r.y=n*o[1]+i*o[5]+a*o[9],r.z=n*o[2]+i*o[6]+a*o[10]},e.transformToVec3=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=n*o[0]+i*o[4]+a*o[8]+o[12],r.y=n*o[1]+i*o[5]+a*o[9]+o[13],r.z=n*o[2]+i*o[6]+a*o[10]+o[14]},e.transformToVec4=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements;r.x=n*o[0]+i*o[4]+a*o[8]+o[12],r.y=n*o[1]+i*o[5]+a*o[9]+o[13],r.z=n*o[2]+i*o[6]+a*o[10]+o[14],r.w=n*o[3]+i*o[7]+a*o[11]+o[15]},e.transformCoordinate=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.elements,s=n*o[3]+i*o[7]+a*o[11]+o[15];s=1/s,r.x=(n*o[0]+i*o[4]+a*o[8]+o[12])*s,r.y=(n*o[1]+i*o[5]+a*o[9]+o[13])*s,r.z=(n*o[2]+i*o[6]+a*o[10]+o[14])*s},e.transformByQuat=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,c=t.z,u=t.w,l=u*n+s*a-c*i,d=u*i+c*n-o*a,h=u*a+o*i-s*n,f=-o*n-s*i-c*a;r.x=l*u-f*o-d*c+h*s,r.y=d*u-f*s-h*o+l*c,r.z=h*u-f*c-l*s+d*o};var t=e.prototype;return t.setValue=function(e,t,r){return this.x=e,this.y=t,this.z=r,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.length=function(){var e=this.x,t=this.y,r=this.z;return Math.sqrt(e*e+t*t+r*r)},t.lengthSquared=function(){var e=this.x,t=this.y,r=this.z;return e*e+t*t+r*r},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z},t.clone=function(){return new e(this.x,this.y,this.z)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e},t.transformNormal=function(t){return e.transformNormal(this,t,this),this},t.transformToVec3=function(t){return e.transformToVec3(this,t,this),this},t.transformCoordinate=function(t){return e.transformCoordinate(this,t,this),this},t.transformByQuat=function(t){return e.transformByQuat(this,t,this),this},e}();i._zero=new i(0,0,0),i._one=new i(1,1,1),i._tempVector3=new i;var a=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.center=new i,this.radius=0,e&&e.cloneTo(this.center),this.radius=t}e.fromPoints=function(t,r){if(!t||0===t.length)throw new Error("points must be array and length must > 0");var n=t.length,a=e._tempVec30;a.x=a.y=a.z=0;for(var o=0;o<n;++o)i.add(t[o],a,a);i.scale(a,1/n,r.center);for(var s=0,c=0;c<n;++c){var u=i.distanceSquared(a,t[c]);u>s&&(s=u)}r.radius=Math.sqrt(s)},e.fromBox=function(e,t){var r=t.center,n=e.min,a=e.max;r.x=.5*(n.x+a.x),r.y=.5*(n.y+a.y),r.z=.5*(n.z+a.z),t.radius=i.distance(r,a)};var t=e.prototype;return t.clone=function(){return new e(this.center,this.radius)},t.cloneTo=function(e){return this.center.cloneTo(e.center),e.radius=this.radius,e},e}();a._tempVec30=new i;var o=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.min=new i,this.max=new i,e&&e.cloneTo(this.min),t&&t.cloneTo(this.max)}e.fromCenterAndExtent=function(e,t,r){i.subtract(e,t,r.min),i.add(e,t,r.max)},e.fromPoints=function(e,t){if(!e||0===e.length)throw new Error("points must be array and length must > 0");var r=t.min,n=t.max;r.x=r.y=r.z=Number.MAX_VALUE,n.x=n.y=n.z=-Number.MAX_VALUE;for(var a=0,o=e.length;a<o;++a){var s=e[a];i.min(r,s,r),i.max(n,s,n)}},e.fromSphere=function(e,t){var r=e.center,n=e.radius,i=t.min,a=t.max;i.x=r.x-n,i.y=r.y-n,i.z=r.z-n,a.x=r.x+n,a.y=r.y+n,a.z=r.z+n},e.transform=function(t,r,n){var a=e._tempVec30,o=e._tempVec31;t.getCenter(a),t.getExtent(o),i.transformCoordinate(a,r,a);var s=o.x,c=o.y,u=o.z,l=r.elements;o.x=Math.abs(s*l[0])+Math.abs(c*l[4])+Math.abs(u*l[8]),o.y=Math.abs(s*l[1])+Math.abs(c*l[5])+Math.abs(u*l[9]),o.z=Math.abs(s*l[2])+Math.abs(c*l[6])+Math.abs(u*l[10]),i.subtract(a,o,n.min),i.add(a,o,n.max)},e.merge=function(e,t,r){return i.min(e.min,t.min,r.min),i.max(e.max,t.max,r.max),r};var t=e.prototype;return t.clone=function(){return new e(this.min,this.max)},t.cloneTo=function(e){return this.min.cloneTo(e.min),this.max.cloneTo(e.max),e},t.getCenter=function(e){return i.add(this.min,this.max,e),i.scale(e,.5,e),e},t.getExtent=function(e){return i.subtract(this.max,this.min,e),i.scale(e,.5,e),e},t.getCorners=function(e){void 0===e&&(e=[]);var t=this.min,r=this.max,n=t.x,a=t.y,o=t.z,s=r.x,c=r.y,u=r.z,l=e.length;if(l<8)for(var d=0,h=8-l;d<h;++d)e[l+d]=new i;return e[0].setValue(n,c,u),e[1].setValue(s,c,u),e[2].setValue(s,a,u),e[3].setValue(n,a,u),e[4].setValue(n,c,o),e[5].setValue(s,c,o),e[6].setValue(s,a,o),e[7].setValue(n,a,o),e},t.transform=function(t){return e.transform(this,t,this),this},e}();o._tempVec30=new i,o._tempVec31=new i;var s=function(){function t(){}return t.distancePlaneAndPoint=function(e,t){return i.dot(e.normal,t)+e.distance},t.intersectsPlaneAndPoint=function(r,n){var i=t.distancePlaneAndPoint(r,n);return i>0?e.PlaneIntersectionType.Front:i<0?e.PlaneIntersectionType.Back:e.PlaneIntersectionType.Intersecting},t.intersectsPlaneAndBox=function(r,n){var i=n.min,a=n.max,o=r.normal,s=t._tempVec30,c=t._tempVec31;return o.x>=0?(s.x=a.x,c.x=i.x):(s.x=i.x,c.x=a.x),o.y>=0?(s.y=a.y,c.y=i.y):(s.y=i.y,c.y=a.y),o.z>=0?(s.z=a.z,c.z=i.z):(s.z=i.z,c.z=a.z),t.distancePlaneAndPoint(r,s)<0?e.PlaneIntersectionType.Back:t.distancePlaneAndPoint(r,c)>0?e.PlaneIntersectionType.Front:e.PlaneIntersectionType.Intersecting},t.intersectsPlaneAndSphere=function(r,n){var i=n.center,a=n.radius,o=t.distancePlaneAndPoint(r,i);return o>a?e.PlaneIntersectionType.Front:o<-a?e.PlaneIntersectionType.Back:e.PlaneIntersectionType.Intersecting},t.intersectsRayAndPlane=function(e,t){var r=t.normal,a=n.zeroTolerance,o=i.dot(r,e.direction);if(Math.abs(o)<a)return-1;var s=i.dot(r,e.origin),c=(-t.distance-s)/o;if(c<0){if(c<-a)return-1;c=0}return c},t.intersectsRayAndBox=function(e,t){var r=n.zeroTolerance,i=e.origin,a=e.direction,o=t.min,s=t.max,c=a.x,u=a.y,l=a.z,d=i.x,h=i.y,f=i.z,_=0,p=Number.MAX_VALUE;if(Math.abs(c)<r){if(d<o.x||d>s.x)return-1}else{var g=1/c,v=(o.x-d)*g,m=(s.x-d)*g;if(v>m){var y=v;v=m,m=y}if((_=Math.max(v,_))>(p=Math.min(m,p)))return-1}if(Math.abs(u)<r){if(h<o.y||h>s.y)return-1}else{var x=1/u,T=(o.y-h)*x,b=(s.y-h)*x;if(T>b){var A=T;T=b,b=A}if((_=Math.max(T,_))>(p=Math.min(b,p)))return-1}if(Math.abs(l)<r){if(f<o.z||f>s.z)return-1}else{var w=1/l,C=(o.z-f)*w,M=(s.z-f)*w;if(C>M){var S=C;C=M,M=S}if((_=Math.max(C,_))>(p=Math.min(M,p)))return-1}return _},t.intersectsRayAndSphere=function(e,r){var n=e.origin,a=e.direction,o=r.center,s=r.radius,c=t._tempVec30;i.subtract(n,o,c);var u=i.dot(c,a),l=i.dot(c,c)-s*s;if(u>0&&l>0)return-1;var d=u*u-l;if(d<0)return-1;var h=-u-Math.sqrt(d);return h<0&&(h=0),h},t.intersectsFrustumAndBox=function(e,r){for(var n=r.min,a=r.max,o=t._tempVec30,s=0;s<6;++s){var c=e.getPlane(s),u=c.normal;if(o.x=u.x>=0?n.x:a.x,o.y=u.y>=0?n.y:a.y,o.z=u.z>=0?n.z:a.z,i.dot(c.normal,o)>-c.distance)return!1}return!0},t.frustumContainsBox=function(r,n){for(var i=n.min,a=n.max,o=t._tempVec30,s=t._tempVec31,c=e.ContainmentType.Contains,u=0;u<6;++u){var l=r.getPlane(u),d=l.normal;if(d.x>=0?(o.x=a.x,s.x=i.x):(o.x=i.x,s.x=a.x),d.y>=0?(o.y=a.y,s.y=i.y):(o.y=i.y,s.y=a.y),d.z>=0?(o.z=a.z,s.z=i.z):(o.z=i.z,s.z=a.z),t.intersectsPlaneAndPoint(l,s)===e.PlaneIntersectionType.Front)return e.ContainmentType.Disjoint;t.intersectsPlaneAndPoint(l,o)===e.PlaneIntersectionType.Front&&(c=e.ContainmentType.Intersects)}return c},t.frustumContainsSphere=function(r,n){for(var i=e.ContainmentType.Contains,a=0;a<6;++a){var o=r.getPlane(a),s=t.intersectsPlaneAndSphere(o,n);if(s===e.PlaneIntersectionType.Front)return e.ContainmentType.Disjoint;if(s===e.PlaneIntersectionType.Intersecting){i=e.ContainmentType.Intersects;break}}return i},t}();s._tempVec30=new i,s._tempVec31=new i;var c=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.normal=new i,this.distance=0,e&&e.cloneTo(this.normal),this.distance=t}e.normalize=function(e,t){var r=e.normal,n=1/r.length(),i=t.normal;i.x=r.x*n,i.y=r.y*n,i.z=r.z*n,t.distance=e.distance*n},e.fromPoints=function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=t.x-i,c=t.y-a,u=t.z-o,l=r.x-i,d=r.y-a,h=r.z-o,f=c*h-u*d,_=u*l-s*h,p=s*d-c*l,g=1/Math.sqrt(f*f+_*_+p*p),v=f*g,m=_*g,y=p*g,x=n.normal;x.x=v,x.y=m,x.z=y,n.distance=-(v*i+m*a+y*o)};var t=e.prototype;return t.normalize=function(){return e.normalize(this,this),this},t.clone=function(){var t=new e;return this.cloneTo(t),t},t.cloneTo=function(e){return this.normal.cloneTo(e.normal),e.distance=this.distance,e},e}(),u=function(){function t(e){void 0===e&&(e=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new c,this.far=new c,this.left=new c,this.right=new c,this.top=new c,this.bottom=new c,e&&this.calculateFromMatrix(e)}var r=t.prototype;return r.clone=function(){var e=new t;return this.cloneTo(e),e},r.cloneTo=function(e){return this.near.cloneTo(e.near),this.far.cloneTo(e.far),this.left.cloneTo(e.left),this.right.cloneTo(e.right),this.top.cloneTo(e.top),this.bottom.cloneTo(e.bottom),e},r.getPlane=function(e){switch(e){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},r.calculateFromMatrix=function(e){var t=e.elements,r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],c=t[6],u=t[7],l=t[8],d=t[9],h=t[10],f=t[11],_=t[12],p=t[13],g=t[14],v=t[15],m=this.near.normal;m.x=-a-i,m.y=-u-c,m.z=-f-h,this.near.distance=-v-g,this.near.normalize();var y=this.far.normal;y.x=i-a,y.y=c-u,y.z=h-f,this.far.distance=g-v,this.far.normalize();var x=this.left.normal;x.x=-a-r,x.y=-u-o,x.z=-f-l,this.left.distance=-v-_,this.left.normalize();var T=this.right.normal;T.x=r-a,T.y=o-u,T.z=l-f,this.right.distance=_-v,this.right.normalize();var b=this.top.normal;b.x=n-a,b.y=s-u,b.z=d-f,this.top.distance=p-v,this.top.normalize();var A=this.bottom.normal;A.x=-a-n,A.y=-u-s,A.z=-f-d,this.bottom.distance=-v-p,this.bottom.normalize()},r.intersectsBox=function(e){return s.intersectsFrustumAndBox(this,e)},r.intersectsSphere=function(t){return s.frustumContainsSphere(this,t)!==e.ContainmentType.Disjoint},t}(),l=function(){function e(e,t,r,n,i,a,o,s,c){void 0===e&&(e=1),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=1),this.elements=new Float32Array(9);var u=this.elements;u[0]=e,u[1]=t,u[2]=r,u[3]=n,u[4]=i,u[5]=a,u[6]=o,u[7]=s,u[8]=c}e.add=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements;a[0]=n[0]+i[0],a[1]=n[1]+i[1],a[2]=n[2]+i[2],a[3]=n[3]+i[3],a[4]=n[4]+i[4],a[5]=n[5]+i[5],a[6]=n[6]+i[6],a[7]=n[7]+i[7],a[8]=n[8]+i[8]},e.subtract=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements;a[0]=n[0]-i[0],a[1]=n[1]-i[1],a[2]=n[2]-i[2],a[3]=n[3]-i[3],a[4]=n[4]-i[4],a[5]=n[5]-i[5],a[6]=n[6]-i[6],a[7]=n[7]-i[7],a[8]=n[8]-i[8]},e.multiply=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],c=n[2],u=n[3],l=n[4],d=n[5],h=n[6],f=n[7],_=n[8],p=i[0],g=i[1],v=i[2],m=i[3],y=i[4],x=i[5],T=i[6],b=i[7],A=i[8];a[0]=o*p+u*g+h*v,a[1]=s*p+l*g+f*v,a[2]=c*p+d*g+_*v,a[3]=o*m+u*y+h*x,a[4]=s*m+l*y+f*x,a[5]=c*m+d*y+_*x,a[6]=o*T+u*b+h*A,a[7]=s*T+l*b+f*A,a[8]=c*T+d*b+_*A},e.equals=function(e,t){var r=e.elements,i=t.elements;return n.equals(r[0],i[0])&&n.equals(r[1],i[1])&&n.equals(r[2],i[2])&&n.equals(r[3],i[3])&&n.equals(r[4],i[4])&&n.equals(r[5],i[5])&&n.equals(r[6],i[6])&&n.equals(r[7],i[7])&&n.equals(r[8],i[8])},e.rotationQuaternion=function(e,t){var r=t.elements,n=e.x,i=e.y,a=e.z,o=e.w,s=n+n,c=i+i,u=a+a,l=n*s,d=i*s,h=i*c,f=a*s,_=a*c,p=a*u,g=o*s,v=o*c,m=o*u;r[0]=1-h-p,r[3]=d-m,r[6]=f+v,r[1]=d+m,r[4]=1-l-p,r[7]=_-g,r[2]=f-v,r[5]=_+g,r[8]=1-l-h},e.scaling=function(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},e.translation=function(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1},e.invert=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],c=r[4],u=r[5],l=r[6],d=r[7],h=r[8],f=h*c-u*d,_=-h*s+u*l,p=d*s-c*l,g=i*f+a*_+o*p;g&&(g=1/g,n[0]=f*g,n[1]=(-h*a+o*d)*g,n[2]=(u*a-o*c)*g,n[3]=_*g,n[4]=(h*i-o*l)*g,n[5]=(-u*i+o*s)*g,n[6]=p*g,n[7]=(-d*i+a*l)*g,n[8]=(c*i-a*s)*g)},e.normalMatrix=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],c=r[4],u=r[5],l=r[6],d=r[7],h=r[8],f=r[9],_=r[10],p=r[11],g=r[12],v=r[13],m=r[14],y=r[15],x=i*u-a*c,T=i*l-o*c,b=i*d-s*c,A=a*l-o*u,w=a*d-s*u,C=o*d-s*l,M=h*v-f*g,S=h*m-_*g,P=h*y-p*g,R=f*m-_*v,L=f*y-p*v,E=_*y-p*m,O=x*E-T*L+b*R+A*P-w*S+C*M;if(!O)return null;O=1/O,n[0]=(u*E-l*L+d*R)*O,n[1]=(l*P-c*E-d*S)*O,n[2]=(c*L-u*P+d*M)*O,n[3]=(o*L-a*E-s*R)*O,n[4]=(i*E-o*P+s*S)*O,n[5]=(a*P-i*L-s*M)*O,n[6]=(v*C-m*w+y*A)*O,n[7]=(m*b-g*C-y*T)*O,n[8]=(g*w-v*b+y*x)*O},e.rotate=function(e,t,r){var n=e.elements,i=r.elements,a=Math.sin(t),o=Math.cos(t),s=n[0],c=n[1],u=n[2],l=n[3],d=n[4],h=n[5],f=n[6],_=n[7],p=n[8];i[0]=o*s+a*l,i[1]=o*c+a*d,i[2]=o*u+a*h,i[3]=o*l-a*s,i[4]=o*d-a*c,i[5]=o*h-a*u,i[6]=f,i[7]=_,i[8]=p},e.scale=function(e,t,r){var n=t.x,i=t.y,a=e.elements,o=r.elements;o[0]=n*a[0],o[1]=n*a[1],o[2]=n*a[2],o[3]=i*a[3],o[4]=i*a[4],o[5]=i*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]},e.translate=function(e,t,r){var n=t.x,i=t.y,a=e.elements,o=r.elements,s=a[0],c=a[1],u=a[2],l=a[3],d=a[4],h=a[5],f=a[6],_=a[7],p=a[8];o[0]=s,o[1]=c,o[2]=u,o[3]=l,o[4]=d,o[5]=h,o[6]=n*s+i*l+f,o[7]=n*c+i*d+_,o[8]=n*u+i*h+p},e.transpose=function(e,t){var r=e.elements,n=t.elements;if(t===e){var i=r[1],a=r[2],o=r[5];n[1]=r[3],n[2]=r[6],n[3]=i,n[5]=r[7],n[6]=a,n[7]=o}else n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8]};var t=e.prototype;return t.setValue=function(e,t,r,n,i,a,o,s,c){var u=this.elements;return u[0]=e,u[1]=t,u[2]=r,u[3]=n,u[4]=i,u[5]=a,u[6]=o,u[7]=s,u[8]=c,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var r=this.elements,n=0;n<12;n++)r[n]=e[n+t];return this},t.setValueByMatrix=function(e){var t=e.elements,r=this.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],this},t.toArray=function(e,t){void 0===t&&(t=0);var r=this.elements;e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},t.cloneTo=function(e){var t=this.elements,r=e.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],e},t.add=function(t){return e.add(this,t,this),this},t.subtract=function(t){return e.subtract(this,t,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],u=e[8];return t*(u*a-o*c)+r*(-u*i+o*s)+n*(c*i-a*s)},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotate=function(t){return e.rotate(this,t,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}(),d=function(){function e(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=1),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=r,this.w=n}e.add=function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w},e.multiply=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w,s=t.x,c=t.y,u=t.z,l=t.w;r.x=n*l+o*s+i*u-a*c,r.y=i*l+o*c+a*s-n*u,r.z=a*l+o*u+n*c-i*s,r.w=o*l-n*s-i*c-a*u},e.conjugate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.equals=function(e,t){return n.equals(e.x,t.x)&&n.equals(e.y,t.y)&&n.equals(e.z,t.z)&&n.equals(e.w,t.w)},e.rotationAxisAngle=function(t,r,n){var a=e._tempVector3;i.normalize(t,a),r*=.5;var o=Math.sin(r);n.x=a.x*o,n.y=a.y*o,n.z=a.z*o,n.w=Math.cos(r)},e.rotationEuler=function(t,r,n,i){e.rotationYawPitchRoll(r,t,n,i)},e.rotationYawPitchRoll=function(e,t,r,n){var i=.5*r,a=.5*t,o=.5*e,s=Math.sin(i),c=Math.cos(i),u=Math.sin(a),l=Math.cos(a),d=Math.sin(o),h=Math.cos(o),f=h*l,_=d*u;n.x=h*u*c+d*l*s,n.y=d*l*c-h*u*s,n.z=f*s-_*c,n.w=f*c+_*s},e.rotationMatrix3x3=function(e,t){var r,n,i=e.elements,a=i[0],o=i[1],s=i[2],c=i[3],u=i[4],l=i[5],d=i[6],h=i[7],f=i[8],_=a+u+f;_>0?(r=Math.sqrt(_+1),t.w=.5*r,r=.5/r,t.x=(l-h)*r,t.y=(d-s)*r,t.z=(o-c)*r):a>=u&&a>=f?(n=.5/(r=Math.sqrt(1+a-u-f)),t.x=.5*r,t.y=(o+c)*n,t.z=(s+d)*n,t.w=(l-h)*n):u>f?(n=.5/(r=Math.sqrt(1+u-a-f)),t.x=(c+o)*n,t.y=.5*r,t.z=(h+l)*n,t.w=(d-s)*n):(n=.5/(r=Math.sqrt(1+f-a-u)),t.x=(s+d)*n,t.y=(l+h)*n,t.z=.5*r,t.w=(o-c)*n)},e.invert=function(e,t){var r=e.x,i=e.y,a=e.z,o=e.w,s=r*r+i*i+a*a+o*o;if(s>n.zeroTolerance){var c=1/s;t.x=-r*c,t.y=-i*c,t.z=-a*c,t.w=o*c}},e.lerp=function(t,r,n,i){var a=1-n;e.dot(t,r)>=0?(i.x=t.x*a+r.x*n,i.y=t.y*a+r.y*n,i.z=t.z*a+r.z*n,i.w=t.w*a+r.w*n):(i.x=t.x*a-r.x*n,i.y=t.y*a-r.y*n,i.z=t.z*a-r.z*n,i.w=t.w*a-r.w*n),i.normalize()},e.slerp=function(e,t,r,i){var a,o,s=e.x,c=e.y,u=e.z,l=e.w,d=t.x,h=t.y,f=t.z,_=t.w,p=s*d+c*h+u*f+l*_;if(p<0&&(p=-p,d=-d,h=-h,f=-f,_=-_),1-p>n.zeroTolerance){var g=Math.acos(p),v=Math.sin(g);a=Math.sin((1-r)*g)/v,o=Math.sin(r*g)/v}else a=1-r,o=r;i.x=a*s+o*d,i.y=a*c+o*h,i.z=a*u+o*f,i.w=a*l+o*_},e.normalize=function(e,t){var r=e.x,i=e.y,a=e.z,o=e.w,s=Math.sqrt(r*r+i*i+a*a+o*o);s>n.zeroTolerance&&(s=1/s,t.x=r*s,t.y=i*s,t.z=a*s,t.w=o*s)},e.rotationX=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=r,t.y=0,t.z=0,t.w=n},e.rotationY=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=0,t.y=r,t.z=0,t.w=n},e.rotationZ=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t.x=0,t.y=0,t.z=r,t.w=n},e.rotateX=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);r.x=n*c+o*s,r.y=i*c+a*s,r.z=a*c-i*s,r.w=o*c-n*s},e.rotateY=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);r.x=n*c-a*s,r.y=i*c+o*s,r.z=a*c+n*s,r.w=o*c-i*s},e.rotateZ=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);r.x=n*c+i*s,r.y=i*c-n*s,r.z=a*c+o*s,r.w=o*c-a*s},e.scale=function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t};var t=e.prototype;return t.setValue=function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.getAxisAngle=function(e){var t=this.x,r=this.y,i=this.z,a=t*t+r*r+i*i;if(a<n.zeroTolerance)return e.x=1,e.y=0,e.z=0,0;var o=1/a;return e.x=this.x*o,e.y=this.y*o,e.z=this.z*o,2*Math.acos(this.w)},t.identity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},t.length=function(){var e=this.x,t=this.y,r=this.z,n=this.w;return Math.sqrt(e*e+t*t+r*r+n*n)},t.lengthSquared=function(){var e=this.x,t=this.y,r=this.z,n=this.w;return e*e+t*t+r*r+n*n},t.normalize=function(){return e.normalize(this,this),this},t.toEuler=function(e){this.toYawPitchRoll(e);var t=e.x;return e.x=e.y,e.y=t,e},t.toYawPitchRoll=function(e){var t=this.x,r=this.y,i=this.z,a=this.w,o=t*t,s=r*r,c=i*i,u=t*r,l=i*a,d=i*t,h=r*a,f=r*i,_=t*a;return e.y=Math.asin(2*(_-f)),Math.cos(e.y)>n.zeroTolerance?(e.z=Math.atan2(2*(u+l),1-2*(c+o)),e.x=Math.atan2(2*(d+h),1-2*(s+o))):(e.z=Math.atan2(-2*(u-l),1-2*(s+c)),e.x=0),e},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},t.rotateX=function(t){return e.rotateX(this,t,this),this},t.rotateY=function(t){return e.rotateY(this,t,this),this},t.rotateZ=function(t){return e.rotateZ(this,t,this),this},t.rotationAxisAngle=function(t,r){return e.rotationAxisAngle(t,r,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.invert=function(){return e.invert(this,this),this},t.dot=function(t){return e.dot(this,t)},t.lerp=function(t,r){return e.lerp(this,t,r,this),this},e}();d._tempVector3=new i;var h=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,h,f,_,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===u&&(u=0),void 0===l&&(l=1),void 0===d&&(d=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=e,g[1]=t,g[2]=r,g[3]=n,g[4]=i,g[5]=a,g[6]=o,g[7]=s,g[8]=c,g[9]=u,g[10]=l,g[11]=d,g[12]=h,g[13]=f,g[14]=_,g[15]=p}e.multiply=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],c=n[2],u=n[3],l=n[4],d=n[5],h=n[6],f=n[7],_=n[8],p=n[9],g=n[10],v=n[11],m=n[12],y=n[13],x=n[14],T=n[15],b=i[0],A=i[1],w=i[2],C=i[3],M=i[4],S=i[5],P=i[6],R=i[7],L=i[8],E=i[9],O=i[10],F=i[11],I=i[12],B=i[13],z=i[14],D=i[15];a[0]=o*b+l*A+_*w+m*C,a[1]=s*b+d*A+p*w+y*C,a[2]=c*b+h*A+g*w+x*C,a[3]=u*b+f*A+v*w+T*C,a[4]=o*M+l*S+_*P+m*R,a[5]=s*M+d*S+p*P+y*R,a[6]=c*M+h*S+g*P+x*R,a[7]=u*M+f*S+v*P+T*R,a[8]=o*L+l*E+_*O+m*F,a[9]=s*L+d*E+p*O+y*F,a[10]=c*L+h*E+g*O+x*F,a[11]=u*L+f*E+v*O+T*F,a[12]=o*I+l*B+_*z+m*D,a[13]=s*I+d*B+p*z+y*D,a[14]=c*I+h*B+g*z+x*D,a[15]=u*I+f*B+v*z+T*D},e.equals=function(e,t){var r=e.elements,i=t.elements;return n.equals(r[0],i[0])&&n.equals(r[1],i[1])&&n.equals(r[2],i[2])&&n.equals(r[3],i[3])&&n.equals(r[4],i[4])&&n.equals(r[5],i[5])&&n.equals(r[6],i[6])&&n.equals(r[7],i[7])&&n.equals(r[8],i[8])&&n.equals(r[9],i[9])&&n.equals(r[10],i[10])&&n.equals(r[11],i[11])&&n.equals(r[12],i[12])&&n.equals(r[13],i[13])&&n.equals(r[14],i[14])&&n.equals(r[15],i[15])},e.rotationQuaternion=function(e,t){var r=t.elements,n=e.x,i=e.y,a=e.z,o=e.w,s=n+n,c=i+i,u=a+a,l=n*s,d=i*s,h=i*c,f=a*s,_=a*c,p=a*u,g=o*s,v=o*c,m=o*u;r[0]=1-h-p,r[1]=d+m,r[2]=f-v,r[3]=0,r[4]=d-m,r[5]=1-l-p,r[6]=_+g,r[7]=0,r[8]=f+v,r[9]=_-g,r[10]=1-l-h,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},e.rotationAxisAngle=function(e,t,r){var i,a,o,s=r.elements,c=e.x,u=e.y,l=e.z,d=Math.sqrt(c*c+u*u+l*l);Math.abs(d)<n.zeroTolerance||(c*=d=1/d,u*=d,l*=d,i=Math.sin(t),o=1-(a=Math.cos(t)),s[0]=c*c*o+a,s[1]=u*c*o+l*i,s[2]=l*c*o-u*i,s[3]=0,s[4]=c*u*o-l*i,s[5]=u*u*o+a,s[6]=l*u*o+c*i,s[7]=0,s[8]=c*l*o+u*i,s[9]=u*l*o-c*i,s[10]=l*l*o+a,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1)},e.rotationTranslation=function(t,r,n){e.rotationQuaternion(t,n);var i=n.elements;i[12]=r.x,i[13]=r.y,i[14]=r.z},e.affineTransformation=function(e,t,r,n){var i=n.elements,a=t.x,o=t.y,s=t.z,c=t.w,u=a+a,l=o+o,d=s+s,h=a*u,f=a*l,_=a*d,p=o*l,g=o*d,v=s*d,m=c*u,y=c*l,x=c*d,T=e.x,b=e.y,A=e.z;i[0]=(1-(p+v))*T,i[1]=(f+x)*T,i[2]=(_-y)*T,i[3]=0,i[4]=(f-x)*b,i[5]=(1-(h+v))*b,i[6]=(g+m)*b,i[7]=0,i[8]=(_+y)*A,i[9]=(g-m)*A,i[10]=(1-(h+p))*A,i[11]=0,i[12]=r.x,i[13]=r.y,i[14]=r.z,i[15]=1},e.scaling=function(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e.y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e.z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},e.translation=function(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1},e.invert=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],c=r[4],u=r[5],l=r[6],d=r[7],h=r[8],f=r[9],_=r[10],p=r[11],g=r[12],v=r[13],m=r[14],y=r[15],x=i*u-a*c,T=i*l-o*c,b=i*d-s*c,A=a*l-o*u,w=a*d-s*u,C=o*d-s*l,M=h*v-f*g,S=h*m-_*g,P=h*y-p*g,R=f*m-_*v,L=f*y-p*v,E=_*y-p*m,O=x*E-T*L+b*R+A*P-w*S+C*M;if(!O)return null;O=1/O,n[0]=(u*E-l*L+d*R)*O,n[1]=(o*L-a*E-s*R)*O,n[2]=(v*C-m*w+y*A)*O,n[3]=(_*w-f*C-p*A)*O,n[4]=(l*P-c*E-d*S)*O,n[5]=(i*E-o*P+s*S)*O,n[6]=(m*b-g*C-y*T)*O,n[7]=(h*C-_*b+p*T)*O,n[8]=(c*L-u*P+d*M)*O,n[9]=(a*P-i*L-s*M)*O,n[10]=(g*w-v*b+y*x)*O,n[11]=(f*b-h*w-p*x)*O,n[12]=(u*S-c*R-l*M)*O,n[13]=(i*R-a*S+o*M)*O,n[14]=(v*T-g*A-m*x)*O,n[15]=(h*A-f*T+_*x)*O},e.lookAt=function(t,r,n,a){var o=a.elements,s=e._tempVec30,c=e._tempVec31,u=e._tempVec32;i.subtract(t,r,u),u.normalize(),i.cross(n,u,s),s.normalize(),i.cross(u,s,c),o[0]=s.x,o[1]=c.x,o[2]=u.x,o[3]=0,o[4]=s.y,o[5]=c.y,o[6]=u.y,o[7]=0,o[8]=s.z,o[9]=c.z,o[10]=u.z,o[11]=0,o[12]=-i.dot(s,t),o[13]=-i.dot(c,t),o[14]=-i.dot(u,t),o[15]=1},e.ortho=function(e,t,r,n,i,a,o){var s=o.elements,c=1/(e-t),u=1/(r-n),l=1/(i-a);s[0]=-2*c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(e+t)*c,s[13]=(n+r)*u,s[14]=(a+i)*l,s[15]=1},e.perspective=function(e,t,r,n,i){var a=i.elements,o=1/Math.tan(e/2),s=1/(r-n);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(n+r)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*n*r*s,a[15]=0},e.rotateAxisAngle=function(e,t,r,i){var a=t.x,o=t.y,s=t.z,c=Math.sqrt(a*a+o*o+s*s);if(!(Math.abs(c)<n.zeroTolerance)){var u,l,d,h=e.elements,f=i.elements;a*=c=1/c,o*=c,s*=c,u=Math.sin(r),d=1-(l=Math.cos(r));var _=h[0],p=h[1],g=h[2],v=h[3],m=h[4],y=h[5],x=h[6],T=h[7],b=h[8],A=h[9],w=h[10],C=h[11],M=a*a*d+l,S=o*a*d+s*u,P=s*a*d-o*u,R=a*o*d-s*u,L=o*o*d+l,E=s*o*d+a*u,O=a*s*d+o*u,F=o*s*d-a*u,I=s*s*d+l;f[0]=_*M+m*S+b*P,f[1]=p*M+y*S+A*P,f[2]=g*M+x*S+w*P,f[3]=v*M+T*S+C*P,f[4]=_*R+m*L+b*E,f[5]=p*R+y*L+A*E,f[6]=g*R+x*L+w*E,f[7]=v*R+T*L+C*E,f[8]=_*O+m*F+b*I,f[9]=p*O+y*F+A*I,f[10]=g*O+x*F+w*I,f[11]=v*O+T*F+C*I,e!==i&&(f[12]=h[12],f[13]=h[13],f[14]=h[14],f[15]=h[15])}},e.scale=function(e,t,r){var n=e.elements,i=r.elements,a=t.x,o=t.y,s=t.z;i[0]=n[0]*a,i[1]=n[1]*a,i[2]=n[2]*a,i[3]=n[3]*a,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7]*o,i[8]=n[8]*s,i[9]=n[9]*s,i[10]=n[10]*s,i[11]=n[11]*s,i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15]},e.translate=function(e,t,r){var n=e.elements,i=r.elements,a=t.x,o=t.y,s=t.z;if(e===r)i[12]=n[0]*a+n[4]*o+n[8]*s+n[12],i[13]=n[1]*a+n[5]*o+n[9]*s+n[13],i[14]=n[2]*a+n[6]*o+n[10]*s+n[14],i[15]=n[3]*a+n[7]*o+n[11]*s+n[15];else{var c=n[0],u=n[1],l=n[2],d=n[3],h=n[4],f=n[5],_=n[6],p=n[7],g=n[8],v=n[9],m=n[10],y=n[11];i[0]=c,i[1]=u,i[2]=l,i[3]=d,i[4]=h,i[5]=f,i[6]=_,i[7]=p,i[8]=g,i[9]=v,i[10]=m,i[11]=y,i[12]=c*a+h*o+g*s+n[12],i[13]=u*a+f*o+v*s+n[13],i[14]=l*a+_*o+m*s+n[14],i[15]=d*a+p*o+y*s+n[15]}},e.transpose=function(e,t){var r=e.elements,n=t.elements;if(t===e){var i=r[1],a=r[2],o=r[3],s=r[6],c=r[7],u=r[11];n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=i,n[6]=r[9],n[7]=r[13],n[8]=a,n[9]=s,n[11]=r[14],n[12]=o,n[13]=c,n[14]=u}else n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15]};var t=e.prototype;return t.setValue=function(e,t,r,n,i,a,o,s,c,u,l,d,h,f,_,p){var g=this.elements;return g[0]=e,g[1]=t,g[2]=r,g[3]=n,g[4]=i,g[5]=a,g[6]=o,g[7]=s,g[8]=c,g[9]=u,g[10]=l,g[11]=d,g[12]=h,g[13]=f,g[14]=_,g[15]=p,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var r=this.elements,n=0;n<16;n++)r[n]=e[n+t];return this},t.toArray=function(e,t){void 0===t&&(t=0);var r=this.elements;e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},t.cloneTo=function(e){var t=this.elements,r=e.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],e},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],u=e[8],l=e[9],d=e[10],h=e[11],f=e[12],_=e[13],p=e[14],g=e[15];return(t*o-r*a)*(d*g-h*p)-(t*s-n*a)*(l*g-h*_)+(t*c-i*a)*(l*p-d*_)+(r*s-n*o)*(u*g-h*f)-(r*c-i*o)*(u*p-d*f)+(n*c-i*s)*(u*_-l*f)},t.decompose=function(t,r,i){var a=e._tempMat30,o=this.elements,s=a.elements,c=o[0],u=o[1],l=o[2],h=o[3],f=o[4],_=o[5],p=o[6],g=o[7],v=o[8],m=o[9],y=o[10],x=o[11];t.x=o[12],t.y=o[13],t.z=o[14];var T=Math.sign(c*u*l*h)<0?-1:1,b=Math.sign(f*_*p*g)<0?-1:1,A=Math.sign(v*m*y*x)<0?-1:1,w=T*Math.sqrt(c*c+u*u+l*l),C=b*Math.sqrt(f*f+_*_+p*p),M=A*Math.sqrt(v*v+m*m+y*y);if(i.x=w,i.y=C,i.z=M,Math.abs(w)<n.zeroTolerance||Math.abs(C)<n.zeroTolerance||Math.abs(M)<n.zeroTolerance)return r.identity(),!1;var S=1/w,P=1/C,R=1/M;return s[0]=c*S,s[1]=u*S,s[2]=l*S,s[3]=f*P,s[4]=_*P,s[5]=p*P,s[6]=v*R,s[7]=m*R,s[8]=y*R,d.rotationMatrix3x3(a,r),!0},t.getRotation=function(e){var t=this.elements,r=t[0]+t[5]+t[10];if(r>n.zeroTolerance){var i=2*Math.sqrt(r+1);e.w=.25*i,e.x=(t[6]-t[9])/i,e.y=(t[8]-t[2])/i,e.z=(t[1]-t[4])/i}else if(t[0]>t[5]&&t[0]>t[10]){var a=2*Math.sqrt(1+t[0]-t[5]-t[10]);e.w=(t[6]-t[9])/a,e.x=.25*a,e.y=(t[1]+t[4])/a,e.z=(t[8]+t[2])/a}else if(t[5]>t[10]){var o=2*Math.sqrt(1+t[5]-t[0]-t[10]);e.w=(t[8]-t[2])/o,e.x=(t[1]+t[4])/o,e.y=.25*o,e.z=(t[6]+t[9])/o}else{var s=2*Math.sqrt(1+t[10]-t[0]-t[5]);e.w=(t[1]-t[4])/s,e.x=(t[8]+t[2])/s,e.y=(t[6]+t[9])/s,e.z=.25*s}return e},t.getScaling=function(e){var t=this.elements,r=t[0],n=t[1],i=t[2],a=t[4],o=t[5],s=t[6],c=t[8],u=t[9],l=t[10];return e.x=Math.sqrt(r*r+n*n+i*i),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(c*c+u*u+l*l),e},t.getTranslation=function(e){var t=this.elements;return e.x=t[12],e.y=t[13],e.z=t[14],e},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotateAxisAngle=function(t,r){return e.rotateAxisAngle(this,t,r,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}();h._tempVec30=new i,h._tempVec31=new i,h._tempVec32=new i,h._tempMat30=new l,h._identity=new h(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var f=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.origin=new i,this.direction=new i,e&&e.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var t=e.prototype;return t.intersectPlane=function(e){return s.intersectsRayAndPlane(this,e)},t.intersectSphere=function(e){return s.intersectsRayAndSphere(this,e)},t.intersectBox=function(e){return s.intersectsRayAndBox(this,e)},t.getPoint=function(e,t){return i.scale(this.direction,e,t),t.add(this.origin)},e}(),_=n.zeroTolerance,p=function(){function e(e,t,r){this.radius=void 0,this.phi=void 0,this.theta=void 0,this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0}var t=e.prototype;return t.set=function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},t.makeSafe=function(){return this.phi=n.clamp(this.phi,_,Math.PI-_),this},t.setFromVec3=function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(n.clamp(e.y/this.radius,-1,1))),this},t.setToVec3=function(e){var t=Math.sin(this.phi)*this.radius;return e.x=t*Math.sin(this.theta),e.y=Math.cos(this.phi)*this.radius,e.z=t*Math.cos(this.theta),this},e}(),g=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=void 0,this.y=void 0,this.x=e,this.y=t}e.add=function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y},e.subtract=function(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y},e.multiply=function(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y},e.divide=function(e,t,r){r.x=e.x/t.x,r.y=e.y/t.y},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.distance=function(e,t){var r=t.x-e.x,n=t.y-e.y;return Math.sqrt(r*r+n*n)},e.distanceSquared=function(e,t){var r=t.x-e.x,n=t.y-e.y;return r*r+n*n},e.equals=function(e,t){return n.equals(e.x,t.x)&&n.equals(e.y,t.y)},e.lerp=function(e,t,r,n){var i=e.x,a=e.y;n.x=i+(t.x-i)*r,n.y=a+(t.y-a)*r},e.max=function(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y)},e.min=function(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y},e.normalize=function(e,t){var r=e.x,i=e.y,a=Math.sqrt(r*r+i*i);a>n.zeroTolerance&&(a=1/a,t.x=r*a,t.y=i*a)},e.scale=function(e,t,r){r.x=e.x*t,r.y=e.y*t};var t=e.prototype;return t.setValue=function(e,t){return this.x=e,this.y=t,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this},t.length=function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)},t.lengthSquared=function(){var e=this.x,t=this.y;return e*e+t*t},t.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y},t.clone=function(){return new e(this.x,this.y)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e},e}();g._zero=new g(0,0),g._one=new g(1,1);var v=function(){function e(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=r,this.w=n}e.add=function(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w},e.subtract=function(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w},e.multiply=function(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w},e.divide=function(e,t,r){r.x=e.x/t.x,r.y=e.y/t.y,r.z=e.z/t.z,r.w=e.w/t.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.distance=function(e,t){var r=t.x-e.x,n=t.y-e.y,i=t.z-e.z,a=t.w-e.w;return Math.sqrt(r*r+n*n+i*i+a*a)},e.distanceSquared=function(e,t){var r=t.x-e.x,n=t.y-e.y,i=t.z-e.z,a=t.w-e.w;return r*r+n*n+i*i+a*a},e.equals=function(e,t){return n.equals(e.x,t.x)&&n.equals(e.y,t.y)&&n.equals(e.z,t.z)&&n.equals(e.w,t.w)},e.lerp=function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=e.w;n.x=i+(t.x-i)*r,n.y=a+(t.y-a)*r,n.z=o+(t.z-o)*r,n.w=s+(t.w-s)*r},e.max=function(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)},e.min=function(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w},e.normalize=function(e,t){var r=e.x,i=e.y,a=e.z,o=e.w,s=Math.sqrt(r*r+i*i+a*a+o*o);s>n.zeroTolerance&&(s=1/s,t.x=r*s,t.y=i*s,t.z=a*s,t.w=o*s)},e.scale=function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t},e.transform=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w,s=t.elements;r.x=n*s[0]+i*s[4]+a*s[8]+o*s[12],r.y=n*s[1]+i*s[5]+a*s[9]+o*s[13],r.z=n*s[2]+i*s[6]+a*s[10]+o*s[14],r.w=n*s[3]+i*s[7]+a*s[11]+o*s[15]},e.transformByQuat=function(e,t,r){var n=e.x,i=e.y,a=e.z,o=e.w,s=t.x,c=t.y,u=t.z,l=t.w,d=l*n+c*a-u*i,h=l*i+u*n-s*a,f=l*a+s*i-c*n,_=-s*n-c*i-u*a;r.x=d*l-_*s-h*u+f*c,r.y=h*l-_*c-f*s+d*u,r.z=f*l-_*u-d*c+h*s,r.w=o};var t=e.prototype;return t.setValue=function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.length=function(){var e=this.x,t=this.y,r=this.z,n=this.w;return Math.sqrt(e*e+t*t+r*r+n*n)},t.lengthSquared=function(){var e=this.x,t=this.y,r=this.z,n=this.w;return e*e+t*t+r*r+n*n},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},e}();v._zero=new v(0,0,0,0),v._one=new v(1,1,1,1);var m,y=function(){function e(e,t,r,n){void 0===e&&(e=1),void 0===t&&(t=1),void 0===r&&(r=1),void 0===n&&(n=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=r,this.a=n}e.gammaToLinearSpace=function(e){return e<=0?0:e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)},e.linearToGammaSpace=function(e){return e<=0?0:e<.0031308?12.92*e:e<1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)},e.equals=function(e,t){return n.equals(e.r,t.r)&&n.equals(e.g,t.g)&&n.equals(e.b,t.b)&&n.equals(e.a,t.a)};var t=e.prototype;return t.clone=function(){return new e(this.r,this.g,this.b,this.a)},t.cloneTo=function(e){return e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a,e},t.toLinear=function(t){return t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b),t},t.toGamma=function(t){return t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b),t},e}();function x(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function T(e,t,r){return t&&x(e.prototype,t),r&&x(e,r),e}function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function A(){return(A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function w(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function C(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,S(e,t)}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function P(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function R(e,t,r){return(R=P()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&S(i,r.prototype),i}).apply(null,arguments)}function L(e){var t="function"==typeof Map?new Map:void 0;return(L=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return R(e,arguments,M(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),S(n,e)})(e)}function E(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function F(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return O(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?O(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function I(e,t,r,n){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function B(e,t,r,n,i){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=r.slice().reverse().reduce((function(r,n){return n(e,t,r)||r}),a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}(m=e.AssetPromiseStatus||(e.AssetPromiseStatus={}))[m.Success=0]="Success",m[m.Pending=1]="Pending",m[m.Failed=2]="Failed";var z=function(t){C(n,t),n.all=function(e){return new n((function(t,r,n){if(!Array.isArray(e))return t([e]);var i=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,n((i+=1)/a),i==a&&t(o)})).catch((function(e){return r(e)}))}))}))};var r=n.prototype;function n(r){var n,i,a=function(e){if(!(e<=n._progress)){n._progress=e;for(var t,r=F(n._listeners);!(t=r()).done;){(0,t.value)(e)}}};return(n=t.call(this,(function(t,o){r((function(r){Promise.resolve().then((function(){a(1),n._status=e.AssetPromiseStatus.Success,t(r)}))}),i=function(t){Promise.resolve().then((function(){n._status=e.AssetPromiseStatus.Failed,o(t)}))},(function(e){Promise.resolve().then((function(){a(e)}))}))}))||this)._status=void 0,n._progress=void 0,n._reject=void 0,n._listeners=void 0,n._reject=i,n._listeners=new Set,n._progress=0,n._status=e.AssetPromiseStatus.Pending,n}return r.onProgress=function(e){return this._listeners.add(e),this},r.cancel=function(){return this._status!==e.AssetPromiseStatus.Pending||this._reject("Promise Canceled"),this},T(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(L(Promise)),D={isArray:"isArray"in Array?Array.isArray:function(e){return"[object Array]"===toString.call(e)},isArrayLike:function(e){return!!e&&"number"==typeof e.length&&"function"!=typeof e},clone:function(e){if("object"!=typeof e||null===e)return e;var t;if(D.isArrayLike(e)){t=e.slice();for(var r=0,n=e.length;r<n;r++)t[r]=D.clone(e[r])}else for(var i in t={},e)e.hasOwnProperty(i)&&(t[i]=D.clone(e[i]));return t},downloadBlob:function(e,t){if(void 0===t&&(t=""),navigator&&navigator.msSaveBlob)navigator.msSaveBlob(e,t);else{var r=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=r,n.download=t,n.addEventListener("click",(function(){n.parentElement&&n.parentElement.removeChild(n)})),n.click(),window.URL.revokeObjectURL(r)}}};function N(e){return Object.keys(e).map((function(t){return e[t]}))}var G=function(){function e(e){this.engine=e,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}e._addLoader=function(e,t,r){this._loaders[e]=t;for(var n=0,i=r.length;n<i;n++)this._extTypeMapping[r[n]]=e},e._getTypeByUrl=function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]};var t=e.prototype;return t.load=function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var r=e.map((function(e){return t._loadSingleItem(e)}));return z.all(r)},t.cancelNotLoaded=function(e){var t=this;if(e)if("string"==typeof e){var r;null===(r=this._loadingPromises[e])||void 0===r||r.cancel()}else e.forEach((function(e){var r;null===(r=t._loadingPromises[e])||void 0===r||r.cancel()}));else N(this._loadingPromises).forEach((function(e){e.cancel()}))},t.gc=function(){for(var e=N(this._refObjectPool),t=0,r=e.length;t<r;t++)e[t].isGCIgnored||e[t].destroy()},t.getAssetPath=function(e){return this._assetPool[e]},t._addAsset=function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t},t._deleteAsset=function(e){var t=e.instanceId,r=this._assetPool[t];r&&(delete this._assetPool[t],delete this._assetUrlPool[r])},t._addRefObject=function(e,t){this._refObjectPool[e]=t},t._deleteRefObject=function(e){delete this._refObjectPool[e]},t._assignDefaultOptions=function(t){var r,n,i,a,o;if(t.type=null!=(r=t.type)?r:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: "+t.url;return t.retryCount=null!=(n=t.retryCount)?n:this.retryCount,t.timeout=null!=(i=t.timeout)?i:this.timeout,t.retryInterval=null!=(a=t.retryInterval)?a:this.retryInterval,t.url=null!=(o=t.url)?o:t.urls.join(","),t},t._loadSingleItem=function(t){var r=this,n=this._assignDefaultOptions("string"==typeof t?{url:t}:t),i=n.url;if(this._assetUrlPool[i])return new z((function(e){e(r._assetUrlPool[i])}));if(this._loadingPromises[i])return this._loadingPromises[n.url];var a=e._loaders[n.type],o=a.load(n,this);return this._loadingPromises[i]=o,o.then((function(e){a.useCache&&r._addAsset(i,e),delete r._loadingPromises[i]})).catch((function(){})),o},e}();function U(e,t,r){return void 0===r&&(r=!0),function(n){var i=new n(r);G._addLoader(e,i,t)}}G._loaders={},G._extTypeMapping={};var V,k=function(){function e(e,t,r,n){void 0===t&&(t=null),void 0===r&&(r={}),void 0===n&&(n=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=(new Date).getTime(),this._target=t,this.data=r,this._currentTarget=null,this._bubbles=n,this._propagationStopped=!1,this._type=e}return e.prototype.stopPropagation=function(){this._propagationStopped=!0},T(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),e}();function H(e,t){J.registerCloneMode(e,t,V.Ignore)}function W(e,t){J.registerCloneMode(e,t,V.Shallow)}function j(e,t){J.registerCloneMode(e,t,V.Deep)}!function(e){e[e.Ignore=0]="Ignore",e[e.Assignment=1]="Assignment",e[e.Shallow=2]="Shallow",e[e.Deep=3]="Deep"}(V||(V={}));var X,K,q,Y,Q,J=function(){function e(){}return e.registerCloneMode=function(t,r,n){var i=e._subCloneModeMap.get(t.constructor);i||(i=Object.create(null),e._subCloneModeMap.set(t.constructor,i)),i[r]=n},e.getCloneMode=function(t){var r=e._cloneModeMap.get(t);if(!r){r=Object.create(null),e._cloneModeMap.set(t,r);for(var n=e._obejctType,i=e._subCloneModeMap;t!==n;){var a=i.get(t);a&&A(r,a),t=Object.getPrototypeOf(t)}}return r},e.deepCloneObject=function(t,r){switch(t.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:r.set(t);break;case Array:for(var n=0,i=t.length;n<i;n++)e._deepCloneObjectItem(t,r,n);break;default:var a=t;if(a.clone&&a.cloneTo)a.cloneTo(r);else for(var o=Object.keys(t),s=0,c=o.length;s<c;s++)e._deepCloneObjectItem(t,r,o[s])}},e._deepCloneObjectItem=function(t,r,n){var i=t[n];if(i instanceof Object)switch(i.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var a=i,o=r[n];null==o?r[n]=a.slice():o.set(a);break;case Array:var s=i,c=r[n];null==c?r[n]=new Array(s.length):c.length=s.length,e.deepCloneObject(s,c);break;default:if(!i.clone||!i.cloneTo){var u=r[n];null==u&&(r[n]=u=new i.constructor),e.deepCloneObject(i,u);break}var l=i,d=r[n];d?l.cloneTo(d):r[n]=l.clone()}else r[n]=i},e}();J._subCloneModeMap=new Map,J._cloneModeMap=new Map,J._obejctType=Object.getPrototypeOf(Object);var Z,$,ee,te,re,ne,ie,ae,oe,se,ce,ue,le,de,he,fe=(Q=Y=function(e){I(this,"instanceId",K,this),I(this,"_engine",q,this),this._engine=e},Y._instanceIdCounter=0,K=B((X=Q).prototype,"instanceId",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++fe._instanceIdCounter}}),q=B(X.prototype,"_engine",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),X),_e=($=B((Z=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return I(t=e.call.apply(e,[this].concat(n))||this,"_evts",$,E(t)),t._evtCount=0,t}C(t,e);var r=t.prototype;return r.hasEvent=function(e){return null!=this._evts[e]},r.eventNames=function(){return 0===this._evtCount?[]:Object.keys(this._evts)},r.listenerCount=function(e){var t=this._evts[e];return t?t.fn?1:t.length:0},r.dispatch=function(e,t){if(!this._evts[e])return!1;var r=this._evts[e];if(r.fn)r.once&&this.removeEventListener(e,r.fn),r.fn(t);else for(var n=r.length,i=0;i<n;i++)r[i].once&&this.removeEventListener(e,r[i].fn),r[i].fn(t);return!0},r.on=function(e,t){return this.addEventListener(e,t)},r.once=function(e,t){return this.addEventListener(e,t,!0)},r.addEventListener=function(e,t,r){var n={fn:t,once:r},i=this._evts;return i[e]?i[e].fn?i[e]=[i[e],n]:i[e].push(n):(i[e]=n,this._evtCount++),this},r.off=function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var r=this._evts[e];if(r.fn&&r.fn===t)this._clearEvent(e);else{var n=r.indexOf(t);if(n>-1){var i=r[r.length-1];r[n]=i,r.length--,1===r.length&&(this._evts[e]=r[0])}}return this},r.removeEventListener=function(e,t){return this.off(e,t)},r.removeAllEventListeners=function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)},r.trigger=function(e){this.dispatch(e.type,e.data)},r._clearEvent=function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]},t}(fe)).prototype,"_evts",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),Z),pe=function(e){},ge=console.log.bind(console),ve=console.info.bind(console),me=console.warn.bind(console),ye=console.error.bind(console),xe={debug:pe,info:pe,warn:pe,error:pe,isEnabled:!1,enable:function(){this.debug=ge,this.info=ve,this.warn=me,this.error=ye,this.isEnabled=!0},disable:function(){this.debug=pe,this.info=pe,this.warn=pe,this.error=pe,this.isEnabled=!1}},Te=function(){function e(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var e=this._clock.now();this._startTime=e,this._lastTickTime=e}var t=e.prototype;return t.reset=function(){this._lastTickTime=this._clock.now()},t.tick=function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e},T(e,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}();(ee=e.InternalAssetType||(e.InternalAssetType={}))[ee.Scene=1]="Scene",ee[ee.Cache=2]="Cache",(te=e.ClearMode||(e.ClearMode={}))[te.DONT_CLEAR=0]="DONT_CLEAR",te[te.SOLID_COLOR=1]="SOLID_COLOR",te[te.DEPTH_ONLY=2]="DEPTH_ONLY",te[te.COLOR_ONLY=3]="COLOR_ONLY",te[te.STENCIL_ONLY=4]="STENCIL_ONLY",te[te.ALL_CLEAR=5]="ALL_CLEAR",(re=e.MaterialType||(e.MaterialType={}))[re.OPAQUE=1e3]="OPAQUE",re[re.TRANSPARENT=2e3]="TRANSPARENT",(ne=e.RenderState||(e.RenderState={}))[ne.BLEND=3042]="BLEND",ne[ne.CULL_FACE=2884]="CULL_FACE",ne[ne.DEPTH_TEST=2929]="DEPTH_TEST",ne[ne.ALPHA_TEST=3008]="ALPHA_TEST",ne[ne.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",ne[ne.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",ne[ne.SCISSOR_TEST=3089]="SCISSOR_TEST",(ie=e.FrontFace||(e.FrontFace={}))[ie.CW=2304]="CW",ie[ie.CCW=2305]="CCW",(ae=e.CullFace||(e.CullFace={}))[ae.FRONT=1028]="FRONT",ae[ae.BACK=1029]="BACK",ae[ae.FRONT_AND_BACK=1032]="FRONT_AND_BACK",(oe=e.Side||(e.Side={}))[oe.FRONT=0]="FRONT",oe[oe.BACK=1]="BACK",oe[oe.NONE=2]="NONE",oe[oe.DOUBLE=3]="DOUBLE",(se=e.CompFunc||(e.CompFunc={}))[se.NEVER=512]="NEVER",se[se.LESS=513]="LESS",se[se.EQUAL=514]="EQUAL",se[se.LEQUAL=515]="LEQUAL",se[se.GREATER=516]="GREATER",se[se.NOTEQUAL=517]="NOTEQUAL",se[se.GEQUAL=518]="GEQUAL",se[se.ALWAYS=519]="ALWAYS",(ce=e.DataType||(e.DataType={}))[ce.FLOAT=5126]="FLOAT",ce[ce.FLOAT_VEC2=35664]="FLOAT_VEC2",ce[ce.FLOAT_VEC3=35665]="FLOAT_VEC3",ce[ce.FLOAT_VEC4=35666]="FLOAT_VEC4",ce[ce.INT=5124]="INT",ce[ce.INT_VEC2=35667]="INT_VEC2",ce[ce.INT_VEC3=35668]="INT_VEC3",ce[ce.INT_VEC4=35669]="INT_VEC4",ce[ce.BOOL=35670]="BOOL",ce[ce.BOOL_VEC2=35671]="BOOL_VEC2",ce[ce.BOOL_VEC3=35672]="BOOL_VEC3",ce[ce.BOOL_VEC4=35673]="BOOL_VEC4",ce[ce.FLOAT_MAT2=35674]="FLOAT_MAT2",ce[ce.FLOAT_MAT3=35675]="FLOAT_MAT3",ce[ce.FLOAT_MAT4=35676]="FLOAT_MAT4",ce[ce.FLOAT_ARRAY=35677]="FLOAT_ARRAY",ce[ce.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",ce[ce.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",ce[ce.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",ce[ce.INT_ARRAY=100003]="INT_ARRAY",ce[ce.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",ce[ce.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",ce[ce.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",ce[ce.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",ce[ce.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",ce[ce.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",ce[ce.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",ce[ce.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",ce[ce.SAMPLER_2D=35678]="SAMPLER_2D",ce[ce.SAMPLER_CUBE=35680]="SAMPLER_CUBE",ce[ce.BYTE=5120]="BYTE",ce[ce.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",ce[ce.SHORT=5122]="SHORT",ce[ce.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",ce[ce.UNSIGNED_INT=5125]="UNSIGNED_INT",(ue=e.UniformSemantic||(e.UniformSemantic={}))[ue.LOCAL=1]="LOCAL",ue[ue.MODEL=2]="MODEL",ue[ue.VIEW=3]="VIEW",ue[ue.PROJECTION=4]="PROJECTION",ue[ue.MODELVIEW=5]="MODELVIEW",ue[ue.VIEWPROJECTION=21]="VIEWPROJECTION",ue[ue.MODELVIEWPROJECTION=6]="MODELVIEWPROJECTION",ue[ue.MODELINVERSE=7]="MODELINVERSE",ue[ue.VIEWINVERSE=8]="VIEWINVERSE",ue[ue.PROJECTIONINVERSE=9]="PROJECTIONINVERSE",ue[ue.MODELVIEWINVERSE=10]="MODELVIEWINVERSE",ue[ue.MODELVIEWPROJECTIONINVERSE=11]="MODELVIEWPROJECTIONINVERSE",ue[ue.MODELINVERSETRANSPOSE=12]="MODELINVERSETRANSPOSE",ue[ue.MODELVIEWINVERSETRANSPOSE=13]="MODELVIEWINVERSETRANSPOSE",ue[ue.VIEWPORT=14]="VIEWPORT",ue[ue.JOINTMATRIX=15]="JOINTMATRIX",ue[ue.MORPHWEIGHTS=16]="MORPHWEIGHTS",ue[ue.EYEPOS=17]="EYEPOS",ue[ue.TIME=18]="TIME",ue[ue.JOINTTEXTURE=19]="JOINTTEXTURE",ue[ue.JOINTCOUNT=20]="JOINTCOUNT",(le=e.BlendFunc||(e.BlendFunc={}))[le.ZERO=0]="ZERO",le[le.ONE=1]="ONE",le[le.SRC_COLOR=768]="SRC_COLOR",le[le.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",le[le.SRC_ALPHA=770]="SRC_ALPHA",le[le.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",le[le.DST_ALPHA=772]="DST_ALPHA",le[le.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",le[le.DST_COLOR=774]="DST_COLOR",le[le.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",le[le.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",le[le.enumANT_COLOR=32769]="enumANT_COLOR",le[le.ONE_MINUS_enumANT_COLOR=32770]="ONE_MINUS_enumANT_COLOR",le[le.enumANT_ALPHA=32771]="enumANT_ALPHA",le[le.ONE_MINUS_enumANT_ALPHA=32772]="ONE_MINUS_enumANT_ALPHA",(de=e.RefreshRate||(e.RefreshRate={}))[de.ONCE=1]="ONCE",de[de.EVERYFRAME=2]="EVERYFRAME",(he=e.GLCapabilityType||(e.GLCapabilityType={})).standardDerivatives="OES_standard_derivatives",he.shaderTextureLod="EXT_shader_texture_lod",he.elementIndexUint="OES_element_index_uint",he.depthTexture="WEBGL_depth_texture",he.drawBuffers="WEBGL_draw_buffers",he.vertexArrayObject="OES_vertex_array_object",he.instancedArrays="ANGLE_instanced_arrays",he.multipleSample="multipleSampleOnlySupportedInWebGL2",he.textureFloat="OES_texture_float",he.textureFloatLinear="OES_texture_float_linear",he.textureHalfFloat="OES_texture_half_float",he.textureHalfFloatLinear="OES_texture_half_float_linear",he.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",he.colorBufferFloat="EXT_color_buffer_float",he.colorBufferHalfFloat="EXT_color_buffer_half_float",he.textureFilterAnisotropic="EXT_texture_filter_anisotropic",he.astc="WEBGL_compressed_texture_astc",he.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",he.etc="WEBGL_compressed_texture_etc",he.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",he.etc1="WEBGL_compressed_texture_etc1",he.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",he.pvrtc="WEBGL_compressed_texture_pvrtc",he.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",he.s3tc="WEBGL_compressed_texture_s3tc",he.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc";var be,Ae,we,Ce,Me,Se,Pe=function(){function e(e){void 0===e&&(e=0),this._elements=void 0,this.length=0,this._elements=new Array(e)}var t=e.prototype;return t.add=function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++},t.delete=function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)},t.deleteByIndex=function(e){var t=this._elements,r=null,n=this.length-1;return e!==n&&(r=t[n],t[e]=r),this.length--,r},t.garbageCollection=function(){this._elements.length=this.length},e}(),Re=function(){function e(){this._mask=[],this._length=0}e.unionCollection=function(e,t,r){var n,i,a,o,s=r._mask;e._length<t._length?(n=e._length,i=t._length,a=e._mask,o=t._mask):(n=t._length,i=e._length,a=t._mask,o=e._mask);var c=0;for(s.length<i&&(s.length=i);c<n;c++)s[c]=a[c]|o[c];for(;c<i;c++)s[c]=o[c];r._length=i};var t=e.prototype;return t.enable=function(e){var t=e._index,r=t+1,n=this._mask,i=this._length;if(i<r){for(n.length<r&&(n.length=r);i<t;i++)n[i]=0;n[t]=e._value,this._length=r}else n[t]|=e._value},t.disable=function(e){var t=e._index,r=this._mask,n=this._length-1;if(!(t>n)){var i=r[t]&~e._value;t==n&&0===i?this._length--:r[t]=i}},t.unionCollection=function(e){var t=e._mask,r=e._length,n=this._mask,i=this._length;if(i<r){n.length<r&&(n.length=r);for(var a=0;a<i;a++)n[a]|=t[a];for(;a<r;a++)n[a]=t[a];this._length=r}else for(var o=0;o<r;o++)n[o]|=t[o]},t.complementaryCollection=function(e){for(var t=e._mask,r=this._mask,n=this._length-1,i=Math.min(e._length-1,n);i>=0;i--){var a=r[i]&~t[i];i==n&&0===a?(n--,this._length--):r[i]=a}},t.intersectionCollection=function(e){for(var t=e._mask,r=this._mask,n=this._length-1;n>=0;n--){var i=r[n]&t[n];0==i&&n==this._length-1?this._length--:r[n]=i}},t.isEnable=function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)},t.clear=function(){this._length=0},e}(),Le=function(){function e(){this._onStartScripts=new Pe,this._onUpdateScripts=new Pe,this._onLateUpdateScripts=new Pe,this._destoryComponents=[],this._onUpdateAnimations=new Pe,this._renderers=new Pe,this._onUpdateRenderers=new Pe,this._componentsContainerPool=[]}var t=e.prototype;return t.addRenderer=function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)},t.removeRenderer=function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1},t.addOnStartScript=function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)},t.removeOnStartScript=function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1},t.addOnUpdateScript=function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)},t.removeOnUpdateScript=function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnLateUpdateScript=function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)},t.removeOnLateUpdateScript=function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1},t.addOnUpdateAnimations=function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)},t.removeOnUpdateAnimations=function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnUpdateRenderers=function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)},t.removeOnUpdateRenderers=function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addDestoryComponent=function(e){this._destoryComponents.push(e)},t.callScriptOnStart=function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,r=0;r<e.length;r++){var n=t[r];n._started=!0,n._onStartIndex=-1,n.onStart()}e.length=0}},t.callScriptOnUpdate=function(e){for(var t=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var n=t[r];n._started&&n.onUpdate(e)}},t.callScriptOnLateUpdate=function(e){for(var t=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var n=t[r];n._started&&n.onLateUpdate(e)}},t.callAnimationUpdate=function(e){for(var t=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)t[r].update(e)},t.callRendererOnUpdate=function(e){for(var t=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)t[r].update(e)},t.callRender=function(e){for(var t=e._camera,r=this._renderers._elements,n=this._renderers.length-1;n>=0;--n){var i=r[n];t.cullingMask&i._entity.layer&&(t.enableFrustumCulling&&(i.isCulled=!t._frustum.intersectsBox(i.bounds),i.isCulled)||(i._updateShaderData(e),Re.unionCollection(t._globalShaderMacro,i.shaderData._macroCollection,i._globalShaderMacro),i._render(t)))}},t.callComponentDestory=function(){var e=this._destoryComponents,t=e.length;if(t>0){for(var r=t-1;r>=0;--r)e[r].onDestroy();e.length=0}},t.callCameraOnBeginRender=function(e){for(var t=e.entity._components,r=t.length-1;r>=0;--r){var n=t[r];n.onBeginRender&&n.onBeginRender(e)}},t.callCameraOnEndRender=function(e){for(var t=e.entity._components,r=t.length-1;r>=0;--r){var n=t[r];n.onBeginRender&&n.onEndRender(e)}},t.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},t.putActiveChangedTempList=function(e){e.length=0,this._componentsContainerPool.push(e)},e}(),Ee=function(){function e(){}return e.cloneComponent=function(e,t){for(var r=J.getCloneMode(e.constructor),n=Object.keys(e),i=0,a=n.length;i<a;i++){var o=n[i];switch(r[o]){case void 0:case V.Assignment:t[o]=e[o];break;case V.Shallow:var s=e[o];if(s instanceof Object){var c=t[o];null==c&&(c=t[o]=s.constructor()),A(c,s)}else t[o]=s;break;case V.Deep:var u=e[o];if(u instanceof Object){var l=t[o];null==l&&(l=t[o]=u.constructor()),J.deepCloneObject(u,l)}else t[o]=u}}},e}(),Oe=function(){function e(){}return e.register=function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)},e._addCheck=function(t,r){var n=e._dependenciesMap.get(r);if(n)for(var i=0,a=n.length;i<a;i++)if(!t.getComponent(n[i]))throw"you should add "+n[i]+" before adding "+r},e._removeCheck=function(t,r){var n=e._invDependenciesMap.get(r);if(n)for(var i=0,a=n.length;i<a;i++)if(t.getComponent(n[i]))throw"you should remove "+n[i]+" before adding "+r},e._addDependency=function(e,t,r){var n=r.get(e);n||(n=[],r.set(e,n)),-1===n.indexOf(t)&&n.push(t)},e}();function Fe(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e){t.forEach((function(t){return Oe.register(e,t)}))}}Oe._dependenciesMap=new Map,Oe._invDependenciesMap=new Map,(be=e.Layer||(e.Layer={}))[be.Layer0=1]="Layer0",be[be.Layer1=2]="Layer1",be[be.Layer2=4]="Layer2",be[be.Layer3=8]="Layer3",be[be.Layer4=16]="Layer4",be[be.Layer5=32]="Layer5",be[be.Layer6=64]="Layer6",be[be.Layer7=128]="Layer7",be[be.Layer8=256]="Layer8",be[be.Layer9=512]="Layer9",be[be.Layer10=1024]="Layer10",be[be.Layer11=2048]="Layer11",be[be.Layer12=4096]="Layer12",be[be.Layer13=8192]="Layer13",be[be.Layer14=16384]="Layer14",be[be.Layer15=32768]="Layer15",be[be.Layer16=65536]="Layer16",be[be.Layer17=131072]="Layer17",be[be.Layer18=262144]="Layer18",be[be.Layer19=524288]="Layer19",be[be.Layer20=1048576]="Layer20",be[be.Layer21=2097152]="Layer21",be[be.Layer22=4194304]="Layer22",be[be.Layer23=8388608]="Layer23",be[be.Layer24=16777216]="Layer24",be[be.Layer25=33554432]="Layer25",be[be.Layer26=67108864]="Layer26",be[be.Layer27=134217728]="Layer27",be[be.Layer28=268435456]="Layer28",be[be.Layer29=536870912]="Layer29",be[be.Layer30=1073741824]="Layer30",be[be.Layer31=2147483648]="Layer31",be[be.Everything=4294967295]="Everything",be[be.Nothing=0]="Nothing";var Ie,Be,ze,De,Ne,Ge,Ue,Ve,ke,He,We,je,Xe,Ke,qe,Ye,Qe=(we=B((Ae=function(e){function t(t){var r;return I(r=e.call(this,t.engine)||this,"_entity",we,E(r)),I(r,"_destroyed",Ce,E(r)),I(r,"_enabled",Me,E(r)),I(r,"_awaked",Se,E(r)),r._renderPriority=0,r._entity=t,r}C(t,e);var r=t.prototype;return r.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())},r._onAwake=function(){},r._onEnable=function(){},r._onDisable=function(){},r._onDestroy=function(){},r._onActive=function(){},r._onInActive=function(){},r._setActive=function(e){e?(this._awaked||(this._awaked=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())},T(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}},{key:"engine",get:function(){return this._entity.engine}},{key:"renderPriority",get:function(){return this._renderPriority},set:function(e){this._renderPriority=e}}]),t}(fe)).prototype,"_entity",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ce=B(Ae.prototype,"_destroyed",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Me=B(Ae.prototype,"_enabled",[function(e,t){J.registerCloneMode(e,t,V.Assignment)}],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Se=B(Ae.prototype,"_awaked",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ae),Je=function(){function e(e){void 0===e&&(e=[]),this._flags=e,this.flag=!0}return e.prototype.destroy=function(){!function(e,t){var r=e.indexOf(t);if(r<0)return!1;var n=e.length-1;if(r!==n){var i=e[n];e[r]=i}e.length--}(this._flags,this),this._flags=null},e}(),Ze=(Ye=qe=function(e){function t(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return I(r=e.call.apply(e,[this].concat(i))||this,"_position",Be,E(r)),I(r,"_rotation",ze,E(r)),I(r,"_rotationQuaternion",De,E(r)),I(r,"_scale",Ne,E(r)),I(r,"_worldPosition",Ge,E(r)),I(r,"_worldRotation",Ue,E(r)),I(r,"_worldRotationQuaternion",Ve,E(r)),I(r,"_lossyWorldScale",ke,E(r)),I(r,"_localMatrix",He,E(r)),I(r,"_worldMatrix",We,E(r)),I(r,"_changeFlags",je,E(r)),I(r,"_isParentDirty",Xe,E(r)),I(r,"_parentTransformCache",Ke,E(r)),r._dirtyFlag=t._WM_WP_WE_WQ_WS_FLAGS,r}C(t,e);var r=t.prototype;return r.setPosition=function(e,t,r){this._position.setValue(e,t,r),this.position=this._position},r.setRotation=function(e,t,r){this._rotation.setValue(e,t,r),this.rotation=this._rotation},r.setRotationQuaternion=function(e,t,r,n){this._rotationQuaternion.setValue(e,t,r,n),this.rotationQuaternion=this._rotationQuaternion},r.setScale=function(e,t,r){this._scale.setValue(e,t,r),this.scale=this._scale},r.setWorldPosition=function(e,t,r){this._worldPosition.setValue(e,t,r),this.worldPosition=this._worldPosition},r.setWorldRotation=function(e,t,r){this._worldRotation.setValue(e,t,r),this.worldRotation=this._worldRotation},r.setWorldRotationQuaternion=function(e,t,r,n){this._worldRotationQuaternion.setValue(e,t,r,n),this.worldRotationQuaternion=this._worldRotationQuaternion},r.getWorldForward=function(e){var t=this.worldMatrix.elements;return e.setValue(-t[8],-t[9],-t[10]),e.normalize()},r.getWorldRight=function(e){var t=this.worldMatrix.elements;return e.setValue(t[0],t[1],t[2]),e.normalize()},r.getWorldUp=function(e){var t=this.worldMatrix.elements;return e.setValue(t[4],t[5],t[6]),e.normalize()},r.translate=function(e,r,n,i){if("number"==typeof e){var a=t._tempVec3;a.setValue(e,r,n),this._translate(a,i)}else this._translate(e,r)},r.rotate=function(e,t,r,n){"number"==typeof e?this._rotateXYZ(e,t,r,n):this._rotateXYZ(e.x,e.y,e.z,t)},r.rotateByAxis=function(e,r,i){void 0===i&&(i=!0);var a=r*n.degreeToRadFactor;d.rotationAxisAngle(e,a,t._tempQuat0),this._rotateByQuat(t._tempQuat0,i)},r.lookAt=function(e,r){var i,a=this.worldPosition,o=n.zeroTolerance;if(!(Math.abs(a.x-e.x)<o&&Math.abs(a.y-e.y)<o&&Math.abs(a.z-e.z)<o)){var s=t._tempMat43,c=this._worldRotationQuaternion;r=null!=(i=r)?i:t._tempVec3.setValue(0,1,0),h.lookAt(a,e,r,s),s.getRotation(c).invert(),this.worldRotationQuaternion=c}},r.registerWorldChangeFlag=function(){var e=new Je(this._changeFlags);return this._changeFlags.push(e),e},r._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},r._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_FLAGS)){this._worldAssociatedChange(t._WM_WP_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateWorldPositionFlag()}}},r._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(t._WM_WE_WQ_FLAGS)){this._worldAssociatedChange(t._WM_WE_WQ_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},r._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WE_WQ_FLAGS)){this._worldAssociatedChange(t._WM_WP_WE_WQ_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},r._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(t._WM_WS_FLAGS)){this._worldAssociatedChange(t._WM_WS_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},r._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WS_FLAGS)){this._worldAssociatedChange(t._WM_WP_WS_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},r._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WE_WQ_WS_FLAGS)){this._worldAssociatedChange(t._WM_WP_WE_WQ_WS_FLAGS);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var i;null===(i=e[r].transform)||void 0===i||i._updateAllWorldFlag()}}},r._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var r=t.transform;if(r){e=r;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},r._getScaleMatrix=function(){var e=t._tempQuat0,r=t._tempMat30,n=t._tempMat31,i=t._tempMat32;return n.setValueByMatrix(this.worldMatrix),d.invert(this.worldRotationQuaternion,e),l.rotationQuaternion(e,r),l.multiply(r,n,i),i},r._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},r._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},r._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},r._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},r._worldAssociatedChange=function(e){this._dirtyFlag|=e;for(var t=this._changeFlags.length-1;t>=0;t--)this._changeFlags[t].flag=!0},r._rotateByQuat=function(e,t){t?(d.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(d.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)},r._translate=function(e,r){if(void 0===r&&(r=!0),r){var n=t._tempMat40;h.rotationQuaternion(this.rotationQuaternion,n),i.transformCoordinate(e,n,t._tempVec3),this.position=this._position.add(t._tempVec3)}else this.worldPosition=this._worldPosition.add(e)},r._rotateXYZ=function(e,r,i,a){void 0===a&&(a=!0);var o=n.degreeToRadFactor,s=t._tempQuat0;d.rotationEuler(e*o,r*o,i*o,s),this._rotateByQuat(s,a)},r.translateXYZ=function(e,t,r,n){void 0===n&&(n=!0),this.translate(e,t,r,n)},r.rotateXYZ=function(e,t,r,n){void 0===n&&(n=!0),this.rotate(e,t,r,n)},T(t,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag(t._WORLD_POSITION_FLAG)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse(t._WORLD_POSITION_FLAG)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var r=this._getParentTransform();r?(h.invert(r.worldMatrix,t._tempMat41),i.transformCoordinate(e,t._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse(t._WORLD_POSITION_FLAG)}},{key:"rotation",get:function(){return this._isContainDirtyFlag(t._LOCAL_EULER_FLAG)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(n.radToDegreeFactor),this._setDirtyFlagFalse(t._LOCAL_EULER_FLAG)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG|t._LOCAL_QUAT_FLAG),this._setDirtyFlagFalse(t._LOCAL_EULER_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag(t._WORLD_EULER_FLAG)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(n.radToDegreeFactor),this._setDirtyFlagFalse(t._WORLD_EULER_FLAG)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),d.rotationEuler(n.degreeToRadian(e.x),n.degreeToRadian(e.y),n.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse(t._WORLD_EULER_FLAG)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag(t._LOCAL_QUAT_FLAG)&&(d.rotationEuler(n.degreeToRadian(this._rotation.x),n.degreeToRadian(this._rotation.y),n.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse(t._LOCAL_QUAT_FLAG)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG|t._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(t._LOCAL_QUAT_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag(t._WORLD_QUAT_FLAG)){var e=this._getParentTransform();null!=e?d.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse(t._WORLD_QUAT_FLAG)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var r=this._getParentTransform();r?(d.invert(r.worldRotationQuaternion,t._tempQuat0),d.multiply(e,t._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse(t._WORLD_QUAT_FLAG)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(t._WORLD_SCALE_FLAG)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.setValue(e[0],e[4],e[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(t._WORLD_SCALE_FLAG)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(t._LOCAL_MATRIX_FLAG)&&(h.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(t._LOCAL_MATRIX_FLAG)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(t._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(t._LOCAL_MATRIX_FLAG),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(t._WORLD_MATRIX_FLAG)){var e=this._getParentTransform();e?h.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(t._WORLD_MATRIX_FLAG)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var r=this._getParentTransform();r?(h.invert(r.worldMatrix,t._tempMat42),h.multiply(e,t._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(t._WORLD_MATRIX_FLAG)}}]),t}(Qe),qe._tempQuat0=new d,qe._tempVec3=new i,qe._tempMat30=new l,qe._tempMat31=new l,qe._tempMat32=new l,qe._tempMat40=new h,qe._tempMat41=new h,qe._tempMat42=new h,qe._tempMat43=new h,qe._LOCAL_EULER_FLAG=1,qe._LOCAL_QUAT_FLAG=2,qe._WORLD_POSITION_FLAG=4,qe._WORLD_EULER_FLAG=8,qe._WORLD_QUAT_FLAG=16,qe._WORLD_SCALE_FLAG=32,qe._LOCAL_MATRIX_FLAG=64,qe._WORLD_MATRIX_FLAG=128,qe._WM_WP_FLAGS=132,qe._WM_WE_WQ_FLAGS=152,qe._WM_WP_WE_WQ_FLAGS=156,qe._WM_WS_FLAGS=160,qe._WM_WP_WS_FLAGS=164,qe._WM_WP_WE_WQ_WS_FLAGS=188,Be=B((Ie=Ye).prototype,"_position",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i}}),ze=B(Ie.prototype,"_rotation",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i}}),De=B(Ie.prototype,"_rotationQuaternion",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Ne=B(Ie.prototype,"_scale",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i(1,1,1)}}),Ge=B(Ie.prototype,"_worldPosition",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i}}),Ue=B(Ie.prototype,"_worldRotation",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i}}),Ve=B(Ie.prototype,"_worldRotationQuaternion",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),ke=B(Ie.prototype,"_lossyWorldScale",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new i(1,1,1)}}),He=B(Ie.prototype,"_localMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),We=B(Ie.prototype,"_worldMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),je=B(Ie.prototype,"_changeFlags",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xe=B(Ie.prototype,"_isParentDirty",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ke=B(Ie.prototype,"_parentTransformCache",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ie),$e=function(t){function r(n,i){var a;return(a=t.call(this,n)||this).name=void 0,a.layer=e.Layer.Layer0,a.transform=void 0,a._isActiveInHierarchy=!1,a._components=[],a._children=[],a._scene=void 0,a._isRoot=!1,a._isActive=!0,a._parent=null,a._activeChangedComponents=void 0,a._invModelMatrix=new h,a._inverseWorldMatFlag=void 0,r._entitys.add(E(a)),a.name=i,a.transform=a.addComponent(Ze),a._inverseWorldMatFlag=a.transform.registerWorldChangeFlag(),a}C(r,t),r.findByName=function(e){for(var t=r._entitys,n=t._elements,i=t.length-1;i>=0;i--){var a=n[i];if(a.name===e)return a}return null},r.findByPath=function(e,t){return e.findEntityByPath(t)},r._findChildByName=function(e,t){for(var r=e._children,n=r.length-1;n>=0;n--){var i=r[n];if(i.name===t)return i}return null},r._traverseSetOwnerScene=function(e,t){e._scene=t;for(var r=e._children,n=e.childCount-1;n>=0;n--)this._traverseSetOwnerScene(r[n],t)};var n=r.prototype;return n.addComponent=function(e){Oe._addCheck(this,e);var t=new e(this);return this._components.push(t),this._isActiveInHierarchy&&t._setActive(!0),t},n.getComponent=function(e){for(var t=this._components.length-1;t>=0;t--){var r=this._components[t];if(r instanceof e)return r}},n.getComponents=function(e,t){t.length=0;for(var r=this._components.length-1;r>=0;r--){var n=this._components[r];n instanceof e&&t.push(n)}return t},n.getComponentsIncludeChildren=function(e,t){return t.length=0,this._getComponentsInChildren(e,t),t},n.addChild=function(e){e.parent=this},n.removeChild=function(e){e.parent=null},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var t=this._children,n=r._findChildByName(this,e);if(n)return n;for(var i=t.length-1;i>=0;i--){var a=t[i].findByName(e);if(a)return a}return null},n.findByPath=function(e){for(var t=e.split("/"),n=this,i=0,a=t.length;i<a;++i){var o=t[i];if(o&&!(n=r._findChildByName(n,o)))return null}return n},n.createChild=function(e){var t=new r(this.engine,e);return t.layer=this.layer,t.parent=this,t},n.clearChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n._parent=null,n._isActiveInHierarchy&&n._processInActive(),r._traverseSetOwnerScene(n,null)}e.length=0},n.clone=function(){var e=new r(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var t=this._children,n=0,i=this._children.length;n<i;n++){var a=t[n];e.addChild(a.clone())}for(var o=this._components,s=0,c=o.length;s<c;s++){var u=o[s];if(!(u instanceof Ze)){var l=e.addComponent(u.constructor);Ee.cloneComponent(u,l)}}return e},n.destroy=function(){for(var e=this._components,t=e.length-1;t>=0;t--)e[t].destroy();this._components.length=0;for(var n=this._children,i=n.length-1;i>=0;i--)n[i].destroy();if(this._children.length=0,null!=this._parent){var a=this._parent._children;a.splice(a.indexOf(this),1)}this._parent=null,r._entitys.delete(this)},n._removeComponent=function(e){Oe._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)},n._removeFromParent=function(){var e=this._parent;if(null!=e){var t=e._children;t.splice(t.indexOf(this),1),this._parent=null}return e},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._getComponentsInChildren=function(e,t){for(var r=this._components.length-1;r>=0;r--){var n=this._components[r];n instanceof e&&t.push(n)}for(var i=this._children.length-1;i>=0;i--)this._children[i]._getComponentsInChildren(e,t)},n._setActiveComponents=function(e){for(var t=this._activeChangedComponents,r=0,n=t.length;r<n;++r)t[r]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var t=this._components,r=t.length-1;r>=0;r--)e.push(t[r]);for(var n=this._children,i=n.length-1;i>=0;i--){var a=n[i];a.isActive&&a._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var t=this._components,r=t.length-1;r>=0;r--)e.push(t[r]);for(var n=this._children,i=n.length-1;i>=0;i--){var a=n[i];a.isActive&&a._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(h.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},T(r,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var t=this._removeFromParent(),n=this._parent=e;if(n){n._children.push(this);var i=n._scene;this._scene!==i&&r._traverseSetOwnerScene(this,i),n._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),t&&r._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"engine",get:function(){return this._engine}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}]),r}(fe);$e._entitys=new Pe;var et=function(){function e(){this._features=[],this._objects=[]}var t=e.prototype;return t.registerFeature=function(e){for(var t=this._features,r=0,n=t.length;r<n;r++)if(t[r]===e)return;t.push(e);for(var i=this._objects,a=0,o=i.length;a<o;a++)i[a].features.push(new e)},t.addObject=function(e){e.features=[];for(var t=0,r=this._features.length;t<r;t++){var n;e.features.push(new this._features[t](null!=(n=e.engine)?n:e))}this._objects.push(e)},t.callFeatureMethod=function(e,t,r){for(var n=e.features,i=n.length,a=0;a<i;a++){var o=n[a];o[t]&&o[t].apply(o,r)}},t.findFeature=function(e,t){for(var r=e.features,n=r.length,i=0;i<n;i++){var a=r[i];if(a.constructor===t)return a}},e}(),tt=function(){function e(){this.component=void 0,this.primitive=void 0,this.subPrimitive=void 0,this.material=void 0}return e.getFromPool=function(){var t=e._elementPoolIndex,r=e._elementPool;if(e._elementPoolIndex++,r.length===t){var n=new e;return r.push(n),n}return r[t]},e._restPool=function(){e._elementPoolIndex=0},e.prototype.setValue=function(e,t,r,n){this.component=e,this.primitive=t,this.subPrimitive=r,this.material=n},e}();tt._elementPoolIndex=0,tt._elementPool=[];var rt,nt,it,at,ot,st,ct,ut=function(){function e(){}var t=e.prototype;return t.preUpdate=function(e){},t.postUpdate=function(e){},t.preRender=function(e,t){},t.postRender=function(e,t){},t.destroy=function(e){},e}();(rt=e.BlendFactor||(e.BlendFactor={}))[rt.Zero=0]="Zero",rt[rt.One=1]="One",rt[rt.SourceColor=2]="SourceColor",rt[rt.OneMinusSourceColor=3]="OneMinusSourceColor",rt[rt.DestinationColor=4]="DestinationColor",rt[rt.OneMinusDestinationColor=5]="OneMinusDestinationColor",rt[rt.SourceAlpha=6]="SourceAlpha",rt[rt.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",rt[rt.DestinationAlpha=8]="DestinationAlpha",rt[rt.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",rt[rt.SourceAlphaSaturate=10]="SourceAlphaSaturate",rt[rt.BlendColor=11]="BlendColor",rt[rt.OneMinusBlendColor=12]="OneMinusBlendColor",(nt=e.BlendOperation||(e.BlendOperation={}))[nt.Add=0]="Add",nt[nt.Subtract=1]="Subtract",nt[nt.ReverseSubtract=2]="ReverseSubtract",nt[nt.Min=3]="Min",nt[nt.Max=4]="Max",(it=e.ColorWriteMask||(e.ColorWriteMask={}))[it.None=0]="None",it[it.Red=1]="Red",it[it.Green=2]="Green",it[it.Blue=4]="Blue",it[it.Alpha=8]="Alpha",it[it.All=15]="All",(at=e.CompareFunction||(e.CompareFunction={}))[at.Never=0]="Never",at[at.Less=1]="Less",at[at.Equal=2]="Equal",at[at.LessEqual=3]="LessEqual",at[at.Greater=4]="Greater",at[at.NotEqual=5]="NotEqual",at[at.GreaterEqual=6]="GreaterEqual",at[at.Always=7]="Always",(ot=e.CullMode||(e.CullMode={}))[ot.Off=0]="Off",ot[ot.Front=1]="Front",ot[ot.Back=2]="Back",(st=e.StencilOperation||(e.StencilOperation={}))[st.Keep=0]="Keep",st[st.Zero=1]="Zero",st[st.Replace=2]="Replace",st[st.IncrementSaturate=3]="IncrementSaturate",st[st.DecrementSaturate=4]="DecrementSaturate",st[st.Invert=5]="Invert",st[st.IncrementWrap=6]="IncrementWrap",st[st.DecrementWrap=7]="DecrementWrap",(ct=e.RenderQueueType||(e.RenderQueueType={}))[ct.Opaque=1e3]="Opaque",ct[ct.AlphaTest=2e3]="AlphaTest",ct[ct.Transparent=3e3]="Transparent";var lt=function(){function t(){this.items=[]}var r=t.prototype;return r.pushPrimitive=function(e){this.items.push(e)},r.sort=function(t){var r=this;this.items.sort((function(n,a){var o=r._isPrimitive(n),s=r._isPrimitive(a);if(o&&s){var c=n,u=a,l=c.material.renderQueueType,d=u.material.renderQueueType;if(l>d)return 1;if(l<d)return-1;if(l>=e.RenderQueueType.Transparent&&d>=e.RenderQueueType.Transparent){var h=i.distanceSquared(c.component.entity.transform.worldPosition,t);return i.distanceSquared(u.component.entity.transform.worldPosition,t)-h}return c.material.shader.name.localeCompare(u.material.shader.name)}return o&&!s?-1:!o&&s?1:void 0}))},r.pushSprite=function(e,t,r,n,i,a,o){var s={component:e,positionQuad:t,uvRect:r,tintColor:n,texture:i,renderMode:a,camera:o};this.items.push(s)},r.render=function(e,r,n){var i=this.items;if(0!==i.length){for(var a=e._renderPipeline._defaultSpriteMaterial,o=e.engine,s=e.scene,c=o._renderCount,u=o._hardwareRenderer,l=s.shaderData,d=e.shaderData,h=0,f=i.length;h<f;h++){var _=i[h];if(_.component.entity.layer&n)if(this._isPrimitive(_)){u.flushSprite(o,a);var p=t.compileMacros,g=_,v=g.component,m=r||g.material,y=v.shaderData,x=m.shaderData;m._preRender(g),Re.unionCollection(v._globalShaderMacro,x._macroCollection,p),p.unionCollection(g.primitive._macroCollection);var T=m.shader._getShaderProgram(o,p);if(!T.isValid)continue;var b=T.bind();c!==T._uploadRenderCount?(T.groupingOtherUniformBlock(),T.uploadAll(T.sceneUniformBlock,l),T.uploadAll(T.cameraUniformBlock,d),T.uploadAll(T.rendererUniformBlock,y),T.uploadAll(T.materialUniformBlock,x),T._uploadCamera=e,T._uploadRenderer=v,T._uploadMaterial=m,T._uploadRenderCount=c):(T._uploadCamera!==e&&(T.uploadUniforms(T.cameraUniformBlock,d),T._uploadCamera=e),T._uploadRenderer!==v&&(T.uploadUniforms(T.rendererUniformBlock,y),T._uploadRenderer=v),T._uploadMaterial!==m&&(T.uploadUniforms(T.materialUniformBlock,x),T._uploadMaterial=m),b&&(T.uploadTextures(T.sceneUniformBlock,l),T.uploadTextures(T.cameraUniformBlock,d),T.uploadTextures(T.rendererUniformBlock,y),T.uploadTextures(T.materialUniformBlock,x))),m.renderState._apply(e.engine),u.drawPrimitive(g.primitive,g.subPrimitive,T)}else{var A=_;u.drawSprite(a,A.positionQuad,A.uvRect,A.tintColor,A.texture,A.renderMode,A.camera)}}u.flushSprite(o,a)}},r.clear=function(){this.items.length=0},r._isPrimitive=function(e){return!!e.primitive},t}();lt.compileMacros=new Re;var dt=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?w(Object(r),!0).forEach((function(t){b(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):w(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({common:"#define GLSLIFY 1\n#define PI 3.14159265359\n#define LOG2 1.442695\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n#include <noise_common>\n",common_vert:"#define GLSLIFY 1\nattribute vec3 POSITION;\n#ifdef O3_HAS_UV\nattribute vec2 TEXCOORD_0;\n#endif\n#ifdef O3_HAS_SKIN\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;\n#ifdef O3_USE_JOINT_TEXTURE\nuniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}\n#else\nuniform mat4 u_jointMatrix[O3_JOINTS_NUM];\n#endif\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nattribute vec4 COLOR_0;\n#endif\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nattribute vec3 NORMAL;\n#endif\n#ifdef O3_HAS_TANGENT\nattribute vec4 TANGENT;\n#endif\n#endif\n",common_frag:"#define GLSLIFY 1\nuniform O3_VERTEX_PRECISION mat4 u_localMat;uniform O3_VERTEX_PRECISION mat4 u_modelMat;uniform O3_VERTEX_PRECISION mat4 u_viewMat;uniform O3_VERTEX_PRECISION mat4 u_projMat;uniform O3_VERTEX_PRECISION mat4 u_MVMat;uniform O3_VERTEX_PRECISION mat4 u_MVPMat;uniform O3_VERTEX_PRECISION mat4 u_normalMat;uniform O3_VERTEX_PRECISION vec3 u_cameraPos;",color_share:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nvarying vec4 v_color;\n#endif\n",normal_share:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\n#if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\nvarying mat3 v_TBN;\n#else\nvarying vec3 v_normal;\n#endif\n#endif\n",uv_share:"#define GLSLIFY 1\nvarying vec2 v_uv;",worldpos_share:"#define GLSLIFY 1\n#if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\nvarying vec3 v_pos;\n#endif\n",shadow_share:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\nuniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n#endif\n",fog_share:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nvarying vec3 v_fogDepth;uniform O3_VERTEX_PRECISION vec3 u_fogColor;\n#ifdef O3_FOG_EXP2\nuniform O3_VERTEX_PRECISION float u_fogDensity;\n#else\nuniform O3_VERTEX_PRECISION float u_fogNear;uniform O3_VERTEX_PRECISION float u_fogFar;\n#endif\n#endif\n",begin_normal_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\nvec3 normal=vec3(NORMAL);\n#if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\nvec4 tangent=vec4(TANGENT);\n#endif\n#endif\n",begin_position_vert:"#define GLSLIFY 1\nvec4 position=vec4(POSITION,1.0);",morph_target_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_MORPH\nuniform float u_morphWeights[O3_MORPH_NUM];\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position0;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal0;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent0;\n#endif\n#if O3_MORPH_NUM > 1\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position1;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal1;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent1;\n#endif\n#endif\n#if O3_MORPH_NUM > 2\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position2;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal2;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent2;\n#endif\n#endif\n#if O3_MORPH_NUM > 3\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position3;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal3;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent3;\n#endif\n#endif\n#if O3_MORPH_NUM > 4\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position4;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal4;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent4;\n#endif\n#endif\n#if O3_MORPH_NUM > 5\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position5;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal5;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent5;\n#endif\n#endif\n#if O3_MORPH_NUM > 6\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position6;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal6;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent6;\n#endif\n#endif\n#if O3_MORPH_NUM > 7\n#ifdef O3_MORPH_POSITION\nattribute vec3 a_position7;\n#endif\n#ifdef O3_MORPH_NORMAL\nattribute vec3 a_normal7;\n#endif\n#ifdef O3_MORPH_TANGENT\nattribute vec3 a_tangent7;\n#endif\n#endif\n#endif\n",position_vert:"#define GLSLIFY 1\n#ifndef O3_GENERATE_SHADOW_MAP\ngl_Position=u_MVPMat*position;\n#endif\n",color_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nv_color=COLOR_0;\n#endif\n",normal_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\n#if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\nvec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);\n#else\nv_normal=normalize(mat3(u_normalMat)*normal);\n#endif\n#endif\n",skinning_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_SKIN\n#ifdef O3_USE_JOINT_TEXTURE\nmat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);\n#else\nmat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];\n#endif\nposition=skinMatrix*position;\n#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)\nnormal=vec4(skinMatrix*vec4(normal,0.0)).xyz;\n#if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\ntangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;\n#endif\n#endif\n#endif\n",uv_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_UV\nv_uv=TEXCOORD_0;\n#else\nv_uv=vec2(0.,0.);\n#endif\n",worldpos_vert:"#define GLSLIFY 1\n#if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\nvec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;\n#endif\n",shadow_vert:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\ngl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nfor(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}\n#endif\n",morph_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_MORPH\n#if defined( O3_MORPH_POSITION )\nposition.xyz+=u_morphWeights[0]*a_position0;\n#if O3_MORPH_NUM > 1\nposition.xyz+=u_morphWeights[1]*a_position1;\n#endif\n#if O3_MORPH_NUM > 2\nposition.xyz+=u_morphWeights[2]*a_position2;\n#endif\n#if O3_MORPH_NUM > 3\nposition.xyz+=u_morphWeights[3]*a_position3;\n#endif\n#if O3_MORPH_NUM > 4\nposition.xyz+=u_morphWeights[4]*a_position4;\n#endif\n#if O3_MORPH_NUM > 5\nposition.xyz+=u_morphWeights[5]*a_position5;\n#endif\n#if O3_MORPH_NUM > 6\nposition.xyz+=u_morphWeights[6]*a_position6;\n#endif\n#if O3_MORPH_NUM > 7\nposition.xyz+=u_morphWeights[7]*a_position7;\n#endif\n#endif\n#if defined( O3_HAS_NORMAL ) && defined( O3_MORPH_NORMAL )\nnormal.xyz+=u_morphWeights[0]*a_normal0;\n#if O3_MORPH_NUM > 1\nnormal.xyz+=u_morphWeights[1]*a_normal1;\n#endif\n#if O3_MORPH_NUM > 2\nnormal.xyz+=u_morphWeights[2]*a_normal2;\n#endif\n#if O3_MORPH_NUM > 3\nnormal.xyz+=u_morphWeights[3]*a_normal3;\n#endif\n#if O3_MORPH_NUM > 4\nnormal.xyz+=u_morphWeights[4]*a_normal4;\n#endif\n#if O3_MORPH_NUM > 5\nnormal.xyz+=u_morphWeights[5]*a_normal5;\n#endif\n#if O3_MORPH_NUM > 6\nnormal.xyz+=u_morphWeights[6]*a_normal6;\n#endif\n#if O3_MORPH_NUM > 7\nnormal.xyz+=u_morphWeights[7]*a_normal7;\n#endif\n#endif\n#if defined( O3_HAS_TANGENT ) && defined( O3_MORPH_TANGENT ) && defined( O3_HAS_NORMALMAP )\ntangent.xyz+=u_morphWeights[0]*a_tangent0;\n#if O3_MORPH_NUM > 1\ntangent.xyz+=u_morphWeights[1]*a_tangent1;\n#endif\n#if O3_MORPH_NUM > 2\ntangent.xyz+=u_morphWeights[2]*a_tangent2;\n#endif\n#if O3_MORPH_NUM > 3\ntangent.xyz+=u_morphWeights[3]*a_tangent3;\n#endif\n#if O3_MORPH_NUM > 4\ntangent.xyz+=u_morphWeights[4]*a_tangent4;\n#endif\n#if O3_MORPH_NUM > 5\ntangent.xyz+=u_morphWeights[5]*a_tangent5;\n#endif\n#if O3_MORPH_NUM > 6\ntangent.xyz+=u_morphWeights[6]*a_tangent6;\n#endif\n#if O3_MORPH_NUM > 7\ntangent.xyz+=u_morphWeights[7]*a_tangent7;\n#endif\n#endif\n#endif\n",fog_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nv_fogDepth=(u_MVMat*position).xyz;\n#endif\n",ambient_light_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_AMBIENT_LIGHT\nuniform vec3 u_ambientLightColor;\n#endif\n",direct_light_frag:"#define GLSLIFY 1\n#ifdef O3_DIRECT_LIGHT_COUNT\nstruct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];\n#endif\n",point_light_frag:"#define GLSLIFY 1\n#ifdef O3_POINT_LIGHT_COUNT\nstruct PointLight{vec3 color;vec3 position;float distance;float decay;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDecay[O3_POINT_LIGHT_COUNT];\n#endif\n",spot_light_frag:"#define GLSLIFY 1\n#ifdef O3_SPOT_LIGHT_COUNT\nstruct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float decay;float angle;float penumbra;float penumbraCos;float coneCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDecay[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngle[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbra[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightConeCos[O3_SPOT_LIGHT_COUNT];\n#endif\n",mobile_material_frag:"#define GLSLIFY 1\nuniform vec4 u_emissiveColor;uniform vec4 u_diffuseColor;uniform vec4 u_specularColor;uniform float u_shininess;\n#ifdef O3_EMISSIVE_TEXTURE\nuniform sampler2D u_emissiveTexture;\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\nuniform sampler2D u_diffuseTexture;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nuniform sampler2D u_specularTexture;\n#endif\n",fog_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nfloat fogDepth=length(v_fogDepth);\n#ifdef O3_FOG_EXP2\nfloat fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));\n#else\nfloat fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);\n#endif\n",begin_mobile_frag:"#define GLSLIFY 1\nvec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_diffuseColor;vec4 specular=u_specularColor;\n#ifdef O3_HAS_AMBIENT_LIGHT\nambient+=vec4(u_ambientLightColor,1.0);\n#endif\n#ifdef O3_EMISSIVE_TEXTURE\nemission*=texture2D(u_emissiveTexture,v_uv);\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\ndiffuse*=texture2D(u_diffuseTexture,v_uv);\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nspecular*=texture2D(u_specularTexture,v_uv);\n#endif\n",begin_normal_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\n#if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\nvec3 N=normalize(v_TBN[2]);\n#else\nvec3 N=normalize(v_normal);\n#endif\n#endif\n",begin_viewdir_frag:"#define GLSLIFY 1\n#if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP )\nvec3 V=normalize(u_cameraPos-v_pos);\n#endif\n",mobile_blinnphong_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\nN*=float(gl_FrontFacing)*2.0-1.0;\n#else\nvec3 N=vec3(0,0,1);\n#endif\nvec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight lgt;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){lgt.color=u_directLightColor[i];lgt.direction=u_directLightDirection[i];float d=max(dot(N,-lgt.direction),0.0);lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-lgt.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=lgt.color*s;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight lgt;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){lgt.color=u_pointLightColor[i];lgt.position=u_pointLightPosition[i];lgt.distance=u_pointLightDistance[i];lgt.decay=u_pointLightDecay[i];vec3 direction=v_pos-lgt.position;float dist=length(direction);direction/=dist;float decay=pow(max(0.0,1.0-dist/lgt.distance),2.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=lgt.color*s;}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight lgt;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){lgt.color=u_spotLightColor[i];lgt.position=u_spotLightPosition[i];lgt.direction=u_spotLightDirection[i];lgt.distance=u_spotLightDistance[i];lgt.decay=u_spotLightDecay[i];lgt.angle=u_spotLightAngle[i];lgt.penumbra=u_spotLightPenumbra[i];vec3 direction=v_pos-lgt.position;float angle=acos(dot(normalize(direction),normalize(lgt.direction)));float dist=length(direction);direction/=dist;float decay=pow(max(0.0,1.0-dist/lgt.distance),2.0);float hasLight=step(angle,lgt.angle);float hasPenumbra=step(lgt.angle,angle)*step(angle,lgt.angle*(1.0+lgt.penumbra));float penumbra=hasPenumbra*(1.0-(angle-lgt.angle)/(lgt.angle*lgt.penumbra));float d=max(dot(N,-direction),0.0)*decay*(penumbra+hasLight);lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay*(penumbra+hasLight);lightSpecular+=lgt.color*s;}\n#endif\ndiffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);",mobile_lambert_frag:"#define GLSLIFY 1\nvec3 totalLight=vec3(0.0,0.0,0.0);\n#ifdef O3_DIRECT_LIGHT_COUNT\nfor(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){vec3 lightColor=u_directLightColor[i];lightColor*=max(dot(N,-u_directLightDirection[i]),0.0);totalLight+=lightColor;}\n#endif\ndiffuse*=vec4(totalLight,1.0);",noise_common:"#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}\n#define K 0.142857142857\n#define Ko 0.428571428571\n#define K2 0.020408163265306\n#define Kd2 0.0714285714285\n#define Kz 0.166666666667\n#define Kzo 0.416666666667\n#define jitter 1.0\n#define jitter1 0.8\n",noise_cellular_2D:"#define GLSLIFY 1\nvec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}",noise_cellular_2x2:"#define GLSLIFY 1\nvec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}",noise_cellular_2x2x2:"#define GLSLIFY 1\nvec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}",noise_cellular_3D:"#define GLSLIFY 1\nvec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}",noise_cellular:"#define GLSLIFY 1\n#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:"#define GLSLIFY 1\nfloat perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}",noise_perlin_3D:"#define GLSLIFY 1\nfloat perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}",noise_perlin_4D:"#define GLSLIFY 1\nfloat perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}",noise_perlin:"#define GLSLIFY 1\n#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:"#define GLSLIFY 1\nvec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}",noise_simplex_2D:"#define GLSLIFY 1\nfloat simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}",noise_simplex_3D_grad:"#define GLSLIFY 1\nfloat simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}",noise_simplex_3D:"#define GLSLIFY 1\nfloat simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}",noise_simplex_4D:"#define GLSLIFY 1\nvec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}\n#define F4 0.309016994374947451\nfloat simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}",noise_simplex:"#define GLSLIFY 1\n#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n",perturbation_share:"#define GLSLIFY 1\n#ifdef HAS_PERTURBATIONMAP\nuniform sampler2D u_perturbationSampler;uniform float u_perturbationUOffset;uniform float u_perturbationVOffset;\n#endif\n",perturbation_frag:"#define GLSLIFY 1\n#ifdef HAS_PERTURBATIONMAP\nvec2 getScreenUv(){return gl_FragCoord.xy/u_resolution;}vec4 screenColor=texture2D(u_perturbationSampler,getScreenUv()+normalize(u_viewMat*vec4(normal,1.)).xy*vec2(u_perturbationUOffset,u_perturbationVOffset));gl_FragColor=mix(screenColor,gl_FragColor,gl_FragColor.a);\n#endif\n",refraction_share:"#define GLSLIFY 1\n#ifdef HAS_REFRACTIONMAP\nuniform sampler2D u_refractionSampler;uniform mat4 u_PTMMatrix;uniform float u_refractionDepth;\n#endif\n",refraction_frag:"#define GLSLIFY 1\n#ifdef HAS_REFRACTIONMAP\nvec4 refractionColor=vec4(0.);vec3 refractDir=normalize(refract(-geometry.viewDir,geometry.normal,u_refractionRatio));vec3 newPos=v_pos+refractDir*u_refractionDepth;vec4 projectionPos=u_PTMMatrix*u_projMat*u_viewMat*vec4(newPos,1.0);vec2 projectionUv=projectionPos.xy/projectionPos.w;refractionColor=texture2D(u_refractionSampler,projectionUv);gl_FragColor=mix(refractionColor,gl_FragColor,gl_FragColor.a);\n#endif\n",clipPlane_vert_define:"#define GLSLIFY 1\n#ifdef O3_CLIPPLANE_NUM\nuniform vec4 u_clipPlanes[O3_CLIPPLANE_NUM];varying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_vert:"#define GLSLIFY 1\n#ifdef O3_CLIPPLANE_NUM\nfor(int i=0;i<O3_CLIPPLANE_NUM;i++){v_clipDistances[i]=dot(vec4(v_pos,1.0),u_clipPlanes[i]);}\n#endif\n",clipPlane_frag_define:"#define GLSLIFY 1\n#ifdef O3_CLIPPLANE_NUM\nvarying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_frag:"#define GLSLIFY 1\n#ifdef O3_CLIPPLANE_NUM\nfor(int i=0;i<O3_CLIPPLANE_NUM;i++){if(v_clipDistances[i]<0.0){discard;}}\n#endif\n",gamma_frag:"#define GLSLIFY 1\n#ifdef GAMMA\nfloat gamma=2.2;gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(1.0/gamma));\n#endif\n",oit_frag:"#define GLSLIFY 1\n#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\nif(gl_FragCoord.z>texture2D(u_depthSampler,gl_FragCoord.xy/u_resolution).r){discard;}vec4 oitColor=gl_FragColor;gl_FragData[0]=vec4(oitColor.rgb*oitColor.a,oitColor.a);gl_FragData[1]=vec4(1)/255.0;\n#endif\n",oit_frag_define:"#define GLSLIFY 1\n#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\nuniform sampler2D u_depthSampler;float weight(float z,float a){return a*clamp(3e3*pow(1.0-z,3.0),1e-2,3e3);}\n#endif\n"},{pbr_common_frag_define:"#define GLSLIFY 1\n#ifndef EPSILON\n#define EPSILON 1e-6\n#endif\n#ifndef RECIPROCAL_PI\n#define RECIPROCAL_PI 0.31830988618\n#endif\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\n#define RE_Direct RE_Direct_Physical\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular RE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material ) GGXRoughnessToBlinnExponent( material.specularRoughness )\n",pbr_util_frag_define:"#define GLSLIFY 1\nvec4 SRGBtoLINEAR(vec4 srgbIn){\n#ifdef MANUAL_SRGB\n#ifdef SRGB_FAST_APPROXIMATION\nvec3 linOut=pow(srgbIn.xyz,vec3(2.2));\n#else\nvec3 bLess=step(vec3(0.04045),srgbIn.xyz);vec3 linOut=mix(srgbIn.xyz/vec3(12.92),pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)),bLess);\n#endif\nreturn vec4(linOut,srgbIn.w);;\n#else\nreturn srgbIn;\n#endif\n}float pow2(const in float x){return x*x;}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}float punctualLightIntensityToIrradianceFactor(const in float lightDistance,const in float cutoffDistance,const in float decayExponent){if(decayExponent>0.0){\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\nfloat distanceFalloff=1.0/max(pow(lightDistance,decayExponent),0.01);float maxDistanceCutoffFactor=pow2(saturate(1.0-pow4(lightDistance/cutoffDistance)));return distanceFalloff*maxDistanceCutoffFactor;\n#else\nreturn pow(saturate(-lightDistance/cutoffDistance+1.0),decayExponent);\n#endif\n}return 1.0;}vec3 BRDF_Diffuse_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}float GGXRoughnessToBlinnExponent(const in float ggxRoughness){return(2.0/pow2(ggxRoughness+0.0001)-2.0);}float computeSpecularOcclusion(const in float dotNV,const in float ambientOcclusion,const in float roughness){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getLuminance(vec3 color){return dot(color,vec3(0.2126,0.7152,0.0722));}",pbr_envmap_light_frag_define:"#define GLSLIFY 1\n#ifdef O3_HAS_ENVMAP_LIGHT\nstruct EnvMapLight{vec3 diffuse;vec3 specular;float mipMapLevel;float diffuseIntensity;float specularIntensity;mat4 transformMatrix;};uniform EnvMapLight u_envMapLight;\n#ifdef O3_USE_DIFFUSE_ENV\nuniform samplerCube u_env_diffuseSampler;\n#endif\n#ifdef O3_USE_SPECULAR_ENV\nuniform samplerCube u_env_specularSampler;\n#endif\n#endif\n",pbr_base_frag_define:"#define GLSLIFY 1\nuniform float u_alphaCutoff;uniform vec4 u_baseColorFactor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_specularFactor;uniform float u_glossinessFactor;uniform float u_envMapIntensity;uniform float u_refractionRatio;uniform vec2 u_resolution;uniform float u_normalScale;uniform float u_occlusionStrength;",pbr_texture_frag_define:"#define GLSLIFY 1\n#ifdef HAS_BASECOLORMAP\nuniform sampler2D u_baseColorSampler;\n#endif\n#ifdef O3_HAS_NORMALMAP\nuniform sampler2D u_normalSampler;\n#endif\n#ifdef HAS_EMISSIVEMAP\nuniform sampler2D u_emissiveSampler;uniform vec3 u_emissiveFactor;\n#endif\n#ifdef HAS_METALMAP\nuniform sampler2D u_metallicSampler;\n#endif\n#ifdef HAS_ROUGHNESSMAP\nuniform sampler2D u_roughnessSampler;\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nuniform sampler2D u_metallicRoughnessSampler;\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nuniform sampler2D u_specularGlossinessSampler;\n#endif\n#ifdef HAS_OCCLUSIONMAP\nuniform sampler2D u_occlusionSampler;\n#endif\n#ifdef HAS_OPACITYMAP\nuniform sampler2D u_opacitySampler;\n#endif\n#ifdef HAS_REFLECTIONMAP\nuniform samplerCube u_reflectionSampler;\n#endif\n",pbr_runtime_frag_define:"#define GLSLIFY 1\nstruct IncidentLight{vec3 color;vec3 direction;bool visible;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;};struct PhysicalMaterial{vec3 diffuseColor;float specularRoughness;vec3 specularColor;};",pbr_normal_frag_define:"#define GLSLIFY 1\nvec3 getNormal(){\n#ifdef O3_HAS_NORMALMAP\n#ifndef O3_HAS_TANGENT\n#ifdef HAS_DERIVATIVES\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 tex_dx=dFdx(vec3(v_uv,0.0));vec3 tex_dy=dFdy(vec3(v_uv,0.0));vec3 t=(tex_dy.t*pos_dx-tex_dx.t*pos_dy)/(tex_dx.s*tex_dy.t-tex_dy.s*tex_dx.t);\n#ifdef O3_HAS_NORMAL\nvec3 ng=normalize(v_normal);\n#else\nvec3 ng=normalize(cross(pos_dx,pos_dy));\n#endif\nt=normalize(t-ng*dot(ng,t));vec3 b=normalize(cross(ng,t));mat3 tbn=mat3(t,b,ng);\n#else\n#ifdef O3_HAS_NORMAL\nvec3 ng=normalize(v_normal);\n#else\nvec3 ng=vec3(0.0,0.0,1.0);\n#endif\nmat3 tbn=mat3(vec3(0.0),vec3(0.0),ng);\n#endif\n#else\nmat3 tbn=v_TBN;\n#endif\nvec3 n=texture2D(u_normalSampler,v_uv).rgb;n=normalize(tbn*((2.0*n-1.0)*vec3(u_normalScale,u_normalScale,1.0)));\n#else\n#ifdef O3_HAS_NORMAL\nvec3 n=normalize(v_normal);\n#elif defined(HAS_DERIVATIVES)\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 n=normalize(cross(pos_dx,pos_dy));\n#else\nvec3 n=vec3(0.0,0.0,1.0);\n#endif\n#endif\nn*=float(gl_FrontFacing)*2.0-1.0;return n;}",pbr_brdf_cook_torrance_frag_define:"#define GLSLIFY 1\nvec3 F_Schlick(const in vec3 specularColor,const in float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(const in float alpha,const in float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight,const in GeometricContext geometry,const in vec3 specularColor,const in float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentLight.direction+geometry.viewDir);float dotNL=saturate(dot(geometry.normal,incidentLight.direction));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentLight.direction,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}",pbr_direct_irradiance_frag_define:"#define GLSLIFY 1\nvoid RE_Direct_Physical(const in IncidentLight directLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreflectedLight.directSpecular+=irradiance*BRDF_Specular_GGX(directLight,geometry,material.specularColor,material.specularRoughness);reflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_DIRECT_LIGHT_COUNT\nvoid getDirectionalDirectLightIrradiance(const in DirectLight directionalLight,const in GeometricContext geometry,out IncidentLight directLight){directLight.color=directionalLight.color;directLight.direction=-directionalLight.direction;directLight.visible=true;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nvoid getPointDirectLightIrradiance(const in PointLight pointLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=pointLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);directLight.color=pointLight.color;directLight.color*=punctualLightIntensityToIrradianceFactor(lightDistance,pointLight.distance,pointLight.decay);directLight.visible=(directLight.color!=vec3(0.0));}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nvoid getSpotDirectLightIrradiance(const in SpotLight spotLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=spotLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(directLight.direction,-spotLight.direction);if(angleCos>spotLight.coneCos){float spotEffect=smoothstep(spotLight.coneCos,spotLight.penumbraCos,angleCos);directLight.color=spotLight.color;directLight.color*=spotEffect*punctualLightIntensityToIrradianceFactor(lightDistance,spotLight.distance,spotLight.decay);directLight.visible=true;}else{directLight.color=vec3(0.0);directLight.visible=false;}}\n#endif\n",pbr_ibl_specular_frag_define:"#define GLSLIFY 1\nvec3 BRDF_Specular_GGX_Environment(const in GeometricContext geometry,const in vec3 specularColor,const in float roughness){float dotNV=saturate(dot(geometry.normal,geometry.viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(const in float blinnShininessExponent,const in int maxMIPLevel){float maxMIPLevelScalar=float(maxMIPLevel);float desiredMIPLevel=maxMIPLevelScalar+0.79248-0.5*log2(pow2(blinnShininessExponent)+1.0);return clamp(desiredMIPLevel,0.0,maxMIPLevelScalar);}\n#ifdef O3_HAS_ENVMAP_LIGHT\nvec3 getLightProbeIndirectRadiance(const in GeometricContext geometry,const in float blinnShininessExponent,const in int maxMIPLevel){\n#if !defined(O3_USE_SPECULAR_ENV) && !defined(HAS_REFLECTIONMAP)\nreturn u_envMapLight.specular*u_envMapLight.specularIntensity*u_envMapIntensity;\n#else\n#ifdef ENVMAPMODE_REFRACT\nvec3 reflectVec=refract(-geometry.viewDir,geometry.normal,u_refractionRatio);\n#else\nvec3 reflectVec=reflect(-geometry.viewDir,geometry.normal);\n#endif\nreflectVec=mat3(u_envMapLight.transformMatrix)*reflectVec;float specularMIPLevel=getSpecularMIPLevel(blinnShininessExponent,maxMIPLevel);\n#ifdef HAS_TEX_LOD\n#ifdef HAS_REFLECTIONMAP\nvec4 envMapColor=textureCubeLodEXT(u_reflectionSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#else\n#ifdef HAS_REFLECTIONMAP\nvec4 envMapColor=textureCube(u_reflectionSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#endif\nenvMapColor.rgb=SRGBtoLINEAR(envMapColor*u_envMapLight.specularIntensity*u_envMapIntensity).rgb;return envMapColor.rgb;\n#endif\n}\n#endif\nvoid RE_IndirectSpecular_Physical(const in vec3 radiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNL=dotNV;reflectedLight.indirectSpecular+=radiance*BRDF_Specular_GGX_Environment(geometry,material.specularColor,material.specularRoughness);}",pbr_ibl_diffuse_frag_define:"#define GLSLIFY 1\nvoid RE_IndirectDiffuse_Physical(const in vec3 irradiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_HAS_AMBIENT_LIGHT\nvec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreturn irradiance;}\n#endif\n",pbr_begin_frag:"#define GLSLIFY 1\nvec3 normal=getNormal();vec4 diffuseColor=u_baseColorFactor;vec3 totalEmissiveRadiance=vec3(0.0);float metalnessFactor=u_metal;float roughnessFactor=u_roughness;vec3 specularFactor=u_specularFactor;float glossinessFactor=u_glossinessFactor;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));PhysicalMaterial material;GeometricContext geometry;IncidentLight directLight;\n#ifdef HAS_BASECOLORMAP\nvec4 baseMapColor=texture2D(u_baseColorSampler,v_uv);baseMapColor=SRGBtoLINEAR(baseMapColor);diffuseColor*=baseMapColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\ndiffuseColor.rgb*=v_color.rgb;\n#ifdef O3_HAS_VERTEXALPHA\ndiffuseColor.a*=v_color.a;\n#endif\n#endif\n#ifdef ALPHA_CUTOFF\nif(diffuseColor.a<u_alphaCutoff){discard;}\n#endif\n#if defined(ALPHA_BLEND) && defined(HAS_OPACITYMAP)\n#ifdef GETOPACITYFROMRGB\ndiffuseColor.a*=getLuminance(texture2D(u_opacitySampler,v_uv).rgb);\n#else\ndiffuseColor.a*=texture2D(u_opacitySampler,v_uv).a;\n#endif\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nvec4 metalRoughMapColor=texture2D(u_metallicRoughnessSampler,v_uv);metalnessFactor*=metalRoughMapColor.b;roughnessFactor*=metalRoughMapColor.g;\n#else\n#ifdef HAS_METALMAP\nvec4 metalMapColor=texture2D(u_metallicSampler,v_uv);metalnessFactor*=metalMapColor.b;\n#endif\n#ifdef HAS_ROUGHNESSMAP\nvec4 roughMapColor=texture2D(u_roughnessSampler,v_uv);roughnessFactor*=roughMapColor.g;\n#endif\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nvec4 specularGlossinessColor=texture2D(u_specularGlossinessSampler,v_uv);specularFactor*=specularGlossinessColor.rgb;glossinessFactor*=specularGlossinessColor.a;\n#endif\n#ifdef IS_METALLIC_WORKFLOW\nmaterial.diffuseColor=diffuseColor.rgb*(1.0-metalnessFactor);material.specularRoughness=clamp(roughnessFactor,0.04,1.0);material.specularColor=mix(vec3(MAXIMUM_SPECULAR_COEFFICIENT),diffuseColor.rgb,metalnessFactor);\n#else\nfloat specularStrength=max(max(specularFactor.r,specularFactor.g),specularFactor.b);material.diffuseColor=diffuseColor.rgb*(1.0-specularStrength);material.specularRoughness=clamp(1.0-glossinessFactor,0.04,1.0);material.specularColor=specularFactor;\n#endif\ngeometry.position=v_pos;geometry.normal=normal;geometry.viewDir=normalize(u_cameraPos-v_pos);",pbr_direct_irradiance_frag:"#define GLSLIFY 1\n#if defined( O3_DIRECT_LIGHT_COUNT ) && defined( RE_Direct )\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];getDirectionalDirectLightIrradiance(directionalLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n#if defined( O3_POINT_LIGHT_COUNT ) && defined( RE_Direct )\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];pointLight.decay=u_pointLightDecay[i];getPointDirectLightIrradiance(pointLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n#if defined( O3_SPOT_LIGHT_COUNT ) && defined( RE_Direct )\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.decay=u_spotLightDecay[i];spotLight.angle=u_spotLightAngle[i];spotLight.penumbra=u_spotLightPenumbra[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];spotLight.coneCos=u_spotLightConeCos[i];getSpotDirectLightIrradiance(spotLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n",pbr_ibl_diffuse_frag:"#define GLSLIFY 1\n#if defined(RE_IndirectDiffuse)\nvec3 irradiance=vec3(0);\n#if defined(O3_HAS_AMBIENT_LIGHT)\nirradiance+=getAmbientLightIrradiance(u_ambientLightColor);\n#endif\n#if defined(O3_HAS_ENVMAP_LIGHT)\n#ifdef O3_USE_DIFFUSE_ENV\nvec3 lightMapIrradiance=textureCube(u_env_diffuseSampler,geometry.normal).rgb*u_envMapLight.diffuseIntensity;\n#else\nvec3 lightMapIrradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;\n#endif\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nlightMapIrradiance*=PI;\n#endif\nirradiance+=lightMapIrradiance;\n#endif\nRE_IndirectDiffuse(irradiance,geometry,material,reflectedLight);\n#endif\n",pbr_ibl_specular_frag:"#define GLSLIFY 1\n#if defined( RE_IndirectSpecular )\nvec3 radiance=vec3(0.0);\n#endif\n#if defined( O3_HAS_ENVMAP_LIGHT ) && defined( RE_IndirectSpecular )\nradiance+=getLightProbeIndirectRadiance(geometry,Material_BlinnShininessExponent(material),int(u_envMapLight.mipMapLevel));\n#endif\n#if defined( RE_IndirectSpecular )\nRE_IndirectSpecular(radiance,geometry,material,reflectedLight);\n#endif\n",pbr_end_frag:"#define GLSLIFY 1\n#ifdef HAS_OCCLUSIONMAP\nfloat ambientOcclusion=(texture2D(u_occlusionSampler,v_uv).r-1.0)*u_occlusionStrength+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(O3_USE_SPECULAR_ENV)\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.specularRoughness);\n#endif\n#endif\n#ifdef HAS_EMISSIVEMAP\nvec4 emissiveMapColor=texture2D(u_emissiveSampler,v_uv);emissiveMapColor=SRGBtoLINEAR(emissiveMapColor);totalEmissiveRadiance+=u_emissiveFactor*emissiveMapColor.rgb;\n#endif\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;gl_FragColor=vec4(outgoingLight,diffuseColor.a);"});var ht,ft=function(){function e(){}return e.parseVersion=function(e){return void 0===e&&(e="100"),"#version "+e+"\n"},e.parsePrecision=function(e,t,r){return"\n        #ifdef GL_FRAGMENT_PRECISION_HIGH\n          precision "+(r?e:t)+" float;\n          precision "+(r?e:t)+" int;\n\n          #define O3_VERTEX_PRECISION "+e+"\n          #define O3_FRAGMENT_PRECISION "+t+"\n        #else\n          precision "+"mediump float;\n          precision "+"mediump int;\n\n          #define O3_VERTEX_PRECISION "+"mediump\n          #define O3_FRAGMENT_PRECISION "+"mediump\n        #endif\n      "},e.parseShaderName=function(e){return"#define O3_SHADER_NAME "+e+"\n"},e.parseAttributeMacros=function(e){return"#define O3_ATTRIBUTE_MACROS_START\n"+e.map((function(e){return"#define "+e+"\n"})).join("")+"#define O3_ATTRIBUTE_MACROS_END\n"},e.parseCustomMacros=function(e){return"#define O3_CUSTOM_MACROS_START\n"+e.map((function(e){return"#define "+e+"\n"})).join("")+"#define O3_CUSTOM_MACROS_END\n"},e.parseShader=function(t){return e.parseIncludes(t)},e.parseIncludes=function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,r){var n=dt[r];return void 0===n?(xe.error('Shader slice "'+t.trim()+'" not founded.'),""):e.parseIncludes(n)}))},e.InjectShaderSlices=function(e){A(dt,e)},e.parseExtension=function(e){return"#define O3_EXTENSION_START\n"+e.map((function(e){return"#extension "+e+" : enable\n"})).join("")+"#define O3_EXTENSION_END\n"},e.convertTo300=function(e,t){if(e=(e=(e=(e=e.replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\s*\(/g,"texture(")).replace(/\btexture(2D|Cube)LodEXT\s*\(/g,"textureLod("),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var r=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this.replaceMRTShader(e,r)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e},e.getMaxDrawBuffers=function(e){for(var t=new Set,r=e.match(/\bgl_FragData\[.+?\]/g)||[],n=0;n<r.length;n++){var i=r[n].match(/\bgl_FragData\[(.+?)\]/);t.add(i[1])}return t.size},e.compatible=function(e){return/\bgl_FragData\[.+?\]/g.test(e)&&(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")),e},e.replaceMRTShader=function(e,t){for(var r="",n=new Set,i=0;i<t.length;i++){var a=t[i].match(/\bgl_FragData\[(.+?)\]/);n.add(a[1])}return n.forEach((function(e){r+="layout(location="+e+") out vec4 fragOutColor"+e+";\n"})),r+="void main(",e=(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,r)},e}(),_t=function(e,t,r){this.name=void 0,this._index=void 0,this._value=void 0,this.name=e,this._index=t,this._value=r};!function(e){e[e.Scene=0]="Scene",e[e.Camera=1]="Camera",e[e.Renderer=2]="Renderer",e[e.Material=3]="Material"}(ht||(ht={}));var pt=function(){function e(e){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.textureIndex=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this._rhi=void 0,this._gl=void 0;var t=e._hardwareRenderer;this._rhi=t,this._gl=t.gl}var t=e.prototype;return t.upload1f=function(e,t){this.cacheValue!==t&&(this._gl.uniform1f(e.location,t),this.cacheValue=t)},t.upload1fv=function(e,t){this._gl.uniform1fv(e.location,t)},t.upload2f=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g||(this._gl.uniform2f(e.location,t.r,t.g),r.x=t.r,r.y=t.g):r.x===t.x&&r.y===t.y||(this._gl.uniform2f(e.location,t.x,t.y),r.x=t.x,r.y=t.y)},t.upload2fv=function(e,t){this._gl.uniform2fv(e.location,t)},t.upload3f=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b||(this._gl.uniform3f(e.location,t.r,t.g,t.b),r.x=t.r,r.y=t.g,r.z=t.b):r.x===t.x&&r.y===t.y&&r.z===t.z||(this._gl.uniform3f(e.location,t.x,t.y,t.z),r.x=t.x,r.y=t.y,r.z=t.z)},t.upload3fv=function(e,t){this._gl.uniform3fv(e.location,t)},t.upload4f=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b&&r.w===t.a||(this._gl.uniform4f(e.location,t.r,t.g,t.b,t.a),r.x=t.r,r.y=t.g,r.z=t.b,r.w=t.a):r.x===t.x&&r.y===t.y&&r.z===t.z&&r.w===t.w||(this._gl.uniform4f(e.location,t.x,t.y,t.z,t.w),r.x=t.x,r.y=t.y,r.z=t.z,r.w=t.w)},t.upload4fv=function(e,t){this._gl.uniform4fv(e.location,t)},t.upload1i=function(e,t){this.cacheValue!==t&&(this._gl.uniform1i(e.location,t),this.cacheValue=t)},t.upload1iv=function(e,t){this._gl.uniform1iv(e.location,t)},t.upload2i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g||(this._gl.uniform2i(e.location,t.r,t.g),r.x=t.r,r.y=t.g):r.x===t.x&&r.y===t.y||(this._gl.uniform2i(e.location,t.x,t.y),r.x=t.x,r.y=t.y)},t.upload2iv=function(e,t){this._gl.uniform2iv(e.location,t)},t.upload3i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b||(this._gl.uniform3i(e.location,t.r,t.g,t.b),r.x=t.r,r.y=t.g,r.z=t.b):r.x===t.x&&r.y===t.y&&r.z===t.z||(this._gl.uniform3i(e.location,t.x,t.y,t.z),r.x=t.x,r.y=t.y,r.z=t.z)},t.upload3iv=function(e,t){this._gl.uniform3iv(e.location,t)},t.upload4i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b&&r.w===t.a||(this._gl.uniform4i(e.location,t.r,t.g,t.b,t.a),r.x=t.r,r.y=t.g,r.z=t.b,r.w=t.a):r.x===t.x&&r.y===t.y&&r.z===t.z&&r.w===t.w||(this._gl.uniform4i(e.location,t.x,t.y,t.z,t.w),r.x=t.x,r.y=t.y,r.z=t.z,r.w=t.w)},t.upload4iv=function(e,t){this._gl.uniform4iv(e.location,t)},t.uploadMat4=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t.elements)},t.uploadMat4v=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t)},t.uploadTexture=function(e,t){var r=this._rhi;r.activeTexture(e.textureIndex),r.bindTexture(t._target,t._glTexture)},t.uploadTextureArray=function(e,t){for(var r=this._rhi,n=e.textureIndex,i=0;i<t.length;i++){var a=t[i];r.activeTexture(n[i]),r.bindTexture(a._target,a._glTexture)}},e}(),gt=function(){this.constUniforms=[],this.textureUniforms=[]},vt=function(){function e(t,r,n){this.id=void 0,this.sceneUniformBlock=new gt,this.cameraUniformBlock=new gt,this.rendererUniformBlock=new gt,this.materialUniformBlock=new gt,this.otherUniformBlock=new gt,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=t,this._gl=t._hardwareRenderer.gl,this._glProgram=this._createProgram(r,n),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=e._counter++}e._addLineNum=function(e){var t,r=e.split("\n"),n=(r.length+1).toString().length+6;return r.map((function(e,r){if((t="0:"+(r+1)).length>=n)return t.substring(0,n)+e;for(var i=0;i<n-t.length;i++)t+=" ";return t+e})).join("\n")};var t=e.prototype;return t.uploadAll=function(e,t){this.uploadUniforms(e,t),this.uploadTextures(e,t)},t.uploadUniforms=function(e,t){for(var r=t._properties,n=e.constUniforms,i=0,a=n.length;i<a;i++){var o=n[i],s=r[o.propertyId];null!=s&&o.applyFunc(o,s)}},t.uploadTextures=function(e,t){var r=t._properties,n=e.textureUniforms;if(n)for(var i=0,a=n.length;i<a;i++){var o=n[i];o.applyFunc(o,r[o.propertyId])}},t.groupingOtherUniformBlock=function(){var e=this.otherUniformBlock,t=e.constUniforms,r=e.textureUniforms;t.length>0&&this._groupingSubOtherUniforms(t,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},t.bind=function(){var e=this._engine._hardwareRenderer;return e._currentBind!==this&&(this._gl.useProgram(this._glProgram),e._currentBind=this,!0)},t.destroy=function(){var e=this._gl;this._vertexShader&&e.deleteShader(this._vertexShader),this._fragmentShader&&e.deleteShader(this._fragmentShader),this._glProgram&&e.deleteProgram(this._glProgram)},t._groupingSubOtherUniforms=function(e,t){for(var r=e.length-1;r>=0;r--){var n=e[r],i=yt._getShaderPropertyGroup(n.name);void 0!==i&&(e.splice(e.indexOf(n),1),this._groupingUniform(n,i,t))}},t._groupingUniform=function(e,t,r){switch(t){case ht.Scene:r?this.sceneUniformBlock.textureUniforms.push(e):this.sceneUniformBlock.constUniforms.push(e);break;case ht.Camera:r?this.cameraUniformBlock.textureUniforms.push(e):this.cameraUniformBlock.constUniforms.push(e);break;case ht.Renderer:r?this.rendererUniformBlock.textureUniforms.push(e):this.rendererUniformBlock.constUniforms.push(e);break;case ht.Material:r?this.materialUniformBlock.textureUniforms.push(e):this.materialUniformBlock.constUniforms.push(e);break;default:r?this.otherUniformBlock.textureUniforms.push(e):this.otherUniformBlock.constUniforms.push(e)}},t._createProgram=function(e,t){var r=this._gl,n=this._createShader(r.VERTEX_SHADER,e);if(!n)return null;var i=this._createShader(r.FRAGMENT_SHADER,t);if(!i)return null;var a=r.createProgram();return r.attachShader(a,n),r.attachShader(a,i),r.linkProgram(a),r.validateProgram(a),r.isContextLost()?(xe.error("Contex lost while linking program."),r.deleteShader(n),r.deleteShader(i),null):r.getProgramParameter(a,r.LINK_STATUS)?(this._vertexShader=n,this._fragmentShader=i,a):(xe.error("Could not link WebGL program. \n"+r.getProgramInfoLog(a)),r.deleteProgram(a),null)},t._createShader=function(t,r){var n=this._gl,i=n.createShader(t);return i?(n.shaderSource(i,r),n.compileShader(i),n.isContextLost()?(xe.error("Context lost while compiling shader."),n.deleteShader(i),null):n.getShaderParameter(i,n.COMPILE_STATUS)?i:(xe.error("Could not compile WebGL shader.\n"+n.getShaderInfoLog(i),e._addLineNum(r)),n.deleteShader(i),null)):(xe.error("Context lost while create shader."),null)},t._recordLocation=function(){var e=this,t=this._gl,r=this._glProgram,n=this._getUniformInfos(),a=this._getAttributeInfos();n.forEach((function(n){var a=n.name,o=n.size,s=n.type,c=new pt(e._engine),u=!1,l=!1;a.indexOf("[0]")>0&&(a=a.substr(0,a.length-3),u=!0);var d=yt._getShaderPropertyGroup(a),h=t.getUniformLocation(r,a);switch(c.name=a,c.propertyId=yt.getPropertyByName(a)._uniqueId,c.location=h,s){case t.FLOAT:u?c.applyFunc=c.upload1fv:(c.applyFunc=c.upload1f,c.cacheValue=0);break;case t.FLOAT_VEC2:u?c.applyFunc=c.upload2fv:(c.applyFunc=c.upload2f,c.cacheValue=new g(0,0));break;case t.FLOAT_VEC3:u?c.applyFunc=c.upload3fv:(c.applyFunc=c.upload3f,c.cacheValue=new i(0,0,0));break;case t.FLOAT_VEC4:u?c.applyFunc=c.upload4fv:(c.applyFunc=c.upload4f,c.cacheValue=new v(0,0,0,0));break;case t.BOOL:case t.INT:u?c.applyFunc=c.upload1iv:(c.applyFunc=c.upload1i,c.cacheValue=0);break;case t.BOOL_VEC2:case t.INT_VEC2:u?c.applyFunc=c.upload2iv:(c.applyFunc=c.upload2i,c.cacheValue=new g(0,0));break;case t.BOOL_VEC3:case t.INT_VEC3:c.applyFunc=u?c.upload3iv:c.upload3i,c.cacheValue=new i(0,0,0);break;case t.BOOL_VEC4:case t.INT_VEC4:u?c.applyFunc=c.upload4iv:(c.applyFunc=c.upload4i,c.cacheValue=new v(0,0,0));break;case t.FLOAT_MAT4:c.applyFunc=u?c.uploadMat4v:c.uploadMat4;break;case t.SAMPLER_2D:case t.SAMPLER_CUBE:if(l=!0,u){for(var f=new Int32Array(o),_=new Array(o),p=0;p<o;p++)f[p]=e._activeTextureUint,_[p]=t.TEXTURE0+e._activeTextureUint++;c.textureIndex=_,c.applyFunc=c.uploadTextureArray,e.bind(),t.uniform1iv(h,f)}else{var m=t.TEXTURE0+e._activeTextureUint;c.textureIndex=m,c.applyFunc=c.uploadTexture,e.bind(),t.uniform1i(h,e._activeTextureUint++)}}e._groupingUniform(c,d,l)})),a.forEach((function(n){var i=n.name;e.attributeLocation[i]=t.getAttribLocation(r,i)}))},t._getUniformInfos=function(){for(var e=this._gl,t=this._glProgram,r=[],n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[i]=a}return r},t._getAttributeInfos=function(){for(var e=this._gl,t=this._glProgram,r=[],n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i);r[i]=a}return r},T(e,[{key:"isValid",get:function(){return this._isValid}}]),e}();vt._counter=0;var mt=function e(){this._uniqueId=void 0,this._group=void 0,this._uniqueId=e._propertyNameCounter++};mt._propertyNameCounter=0;var yt=function(){function e(t,r,n){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=e._shaderCounter++,this.name=t,this._vertexSource=r,this._fragmentSource=n}e.create=function(t,r,n){var i=e._shaderMap;if(i[t])throw'Shader named "'+t+'" already exists.';return i[t]=new e(t,r,n)},e.find=function(t){return e._shaderMap[t]},e.getMacroByName=function(t){var r=e._macroMap[t];if(!r){var n=e._macroMaskMap,i=e._macroCounter,a=Math.floor(i/32),o=i%32;r=new _t(t,a,1<<o),e._macroMap[t]=r,a==n.length&&(n.length++,n[a]=new Array(32)),n[a][o]=t,e._macroCounter++}return r},e.getPropertyByName=function(t){var r=e._propertyNameMap;if(null!=r[t])return r[t];var n=new mt;return r[t]=n,n},e._getShaderPropertyGroup=function(t){var r=e._propertyNameMap[t];return null==r?void 0:r._group},e._getNamesByMacros=function(t,r){var n=e._macroMaskMap,i=t._mask;r.length=0;for(var a=0,o=t._length;a<o;a++)for(var s=n[a],c=i[a],u=c<0?32:Math.floor(Math.log2(c))+1,l=0;l<u;l++)c&1<<l&&r.push(s[l])};var t=e.prototype;return t.compileVariant=function(t,r){var n=lt.compileMacros;n.clear();for(var i=0,a=r.length;i<a;i++)n.enable(e.getMacroByName(r[i]));this._getShaderProgram(t,n)},t._getShaderProgram=function(t,r){var n=t._getShaderProgramPool(this),i=n.get(r);if(i)return i;var a=t._hardwareRenderer.isWebGL2,o=[];e._getNamesByMacros(r,o);var s=ft.parseCustomMacros(o),c=ft.parseShaderName(this.name||"VOID"),u=a?"#version 300 es":"#version 100",l="\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n      precision highp float;\n      precision highp int;\n      #define O3_VERTEX_PRECISION highp\n      #define O3_FRAGMENT_PRECISION highp\n    #else\n      precision mediump float;\n      precision mediump int;\n      #define O3_VERTEX_PRECISION mediump\n      #define O3_FRAGMENT_PRECISION mediump\n    #endif\n    ",d=ft.parseShader(" "+u+"\n        "+c+"\n        "+l+"\n        "+s+"\n        "+this._vertexSource),h=ft.parseShader(" "+u+"\n        "+c+"\n        "+(a?"":ft.parseExtension(e._shaderExtension))+"\n        "+l+"\n        "+s+"\n      "+this._fragmentSource);return a&&(d=ft.convertTo300(d),h=ft.convertTo300(h,!0)),i=new vt(t,d,h),n.cache(i),i},e}();yt._shaderCounter=0,yt._shaderMap=Object.create(null),yt._propertyNameMap=Object.create(null),yt._macroMaskMap=[],yt._macroCounter=0,yt._macroMap=Object.create(null),yt._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var xt=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this)._viewMat=void 0,t._inverseViewMat=void 0,t}C(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.findFeature(Mt).attachRenderLight(this)},r._onDisable=function(){this.scene.findFeature(Mt).detachRenderLight(this)},T(t,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new h),h.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new h),h.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),t}(Qe);xt._maxLight=10;var Tt=function(e){function t(t){var r;return(r=e.call(this,t)||this)._color=new y(1,1,1,1),r._intensity=1,r._lightColor=new y(1,1,1,1),r.color=r._color,r}return C(t,e),T(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(t._colorProperty,this.lightColor)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e,this.scene.shaderData.setColor(t._colorProperty,this.lightColor)}},{key:"lightColor",get:function(){return this._lightColor.r=this._color.r*this._intensity,this._lightColor.g=this._color.g*this._intensity,this._lightColor.b=this._color.b*this._intensity,this._lightColor.a=this._color.a*this._intensity,this._lightColor}}]),t}(xt);Tt._colorProperty=yt.getPropertyByName("u_ambientLightColor");var bt=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return(t=e.call.apply(e,[this].concat(n))||this).color=new y(1,1,1,1),t.intensity=1,t._forward=new i,t._lightColor=new y(1,1,1,1),t._reverseDirection=new i,t}return C(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._directionProperty,r.direction)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=this.lightColor,a=this.direction,o=t._combinedData;o.color[r]=i.r,o.color[r+1]=i.g,o.color[r+2]=i.b,o.direction[n]=a.x,o.direction[n+1]=a.y,o.direction[n+2]=a.z},T(t,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return i.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),t}(xt);bt._colorProperty=yt.getPropertyByName("u_directLightColor"),bt._directionProperty=yt.getPropertyByName("u_directLightDirection"),bt._combinedData={color:new Float32Array(3*xt._maxLight),direction:new Float32Array(3*xt._maxLight)};var At=function(e){function t(t){var r;return(r=e.call(this,t)||this)._diffuseTexture=void 0,r._specularTexture=void 0,r._diffuseColor=new y(.3,.3,.3,1),r._specularColor=new y(.5,.5,.5,1),r._diffuseIntensity=1,r._specularIntensity=1,r.diffuseColor=r._diffuseColor,r.specularColor=r._specularColor,r.diffuseIntensity=r._diffuseIntensity,r.specularIntensity=r._specularIntensity,r}return C(t,e),t._updateShaderData=function(e,r){var n=r.entity.transform.worldMatrix;e.setMatrix(t._transformMatrixProperty,n)},T(t,[{key:"diffuseTexture",get:function(){return this._diffuseTexture},set:function(e){this._diffuseTexture=e;var r=this.scene.shaderData;e?(r.setTexture(t._diffuseTextureProperty,e),r.enableMacro(t._diffuseMacro)):r.disableMacro(t._diffuseMacro)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e;var r=this.scene.shaderData;e?(r.setTexture(t._specularTextureProperty,e),r.setFloat(t._mipLevelProperty,this.specularTexture.mipmapCount),r.enableMacro(t._specularMacro)):r.disableMacro(t._specularMacro)}},{key:"diffuseColor",get:function(){return this._diffuseColor},set:function(e){this._diffuseColor=e,this.scene.shaderData.setColor(t._diffuseColorProperty,e)}},{key:"specularColor",get:function(){return this._specularColor},set:function(e){this._specularColor=e,this.scene.shaderData.setColor(t._specularColorProperty,e)}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(e){this._diffuseIntensity=e,this.scene.shaderData.setFloat(t._diffuseIntensityProperty,e)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(e){this._specularIntensity=e,this.scene.shaderData.setFloat(t._specularIntensityProperty,e)}}]),t}(xt);At._diffuseMacro=yt.getMacroByName("O3_USE_DIFFUSE_ENV"),At._specularMacro=yt.getMacroByName("O3_USE_SPECULAR_ENV"),At._diffuseTextureProperty=yt.getPropertyByName("u_env_diffuseSampler"),At._specularTextureProperty=yt.getPropertyByName("u_env_specularSampler"),At._mipLevelProperty=yt.getPropertyByName("u_envMapLight.mipMapLevel"),At._diffuseColorProperty=yt.getPropertyByName("u_envMapLight.diffuse"),At._specularColorProperty=yt.getPropertyByName("u_envMapLight.specular"),At._diffuseIntensityProperty=yt.getPropertyByName("u_envMapLight.diffuseIntensity"),At._specularIntensityProperty=yt.getPropertyByName("u_envMapLight.specularIntensity"),At._transformMatrixProperty=yt.getPropertyByName("u_envMapLight.transformMatrix");var wt=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).color=new y(1,1,1,1),t.intensity=1,t.distance=100,t.decay=0,t._lightColor=new y(1,1,1,1),t}return C(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._positionProperty,r.position),e.setFloatArray(t._distanceProperty,r.distance),e.setFloatArray(t._decayProperty,r.decay)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=e,a=e,o=this.lightColor,s=this.position,c=t._combinedData;c.color[r]=o.r,c.color[r+1]=o.g,c.color[r+2]=o.b,c.position[n]=s.x,c.position[n+1]=s.y,c.position[n+2]=s.z,c.distance[i]=this.distance,c.decay[a]=this.decay},T(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(xt);wt._colorProperty=yt.getPropertyByName("u_pointLightColor"),wt._positionProperty=yt.getPropertyByName("u_pointLightPosition"),wt._distanceProperty=yt.getPropertyByName("u_pointLightDistance"),wt._decayProperty=yt.getPropertyByName("u_pointLightDecay"),wt._combinedData={color:new Float32Array(3*xt._maxLight),position:new Float32Array(3*xt._maxLight),distance:new Float32Array(xt._maxLight),decay:new Float32Array(xt._maxLight)};var Ct=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return(t=e.call.apply(e,[this].concat(n))||this).color=new y(1,1,1,1),t.penumbra=.2,t.distance=100,t.intensity=1,t.decay=0,t.angle=Math.PI/6,t._forward=new i,t._lightColor=new y(1,1,1,1),t._inverseDirection=new i,t}return C(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._positionProperty,r.position),e.setFloatArray(t._directionProperty,r.direction),e.setFloatArray(t._distanceProperty,r.distance),e.setFloatArray(t._decayProperty,r.decay),e.setFloatArray(t._angleProperty,r.angle),e.setFloatArray(t._penumbraProperty,r.penumbra),e.setFloatArray(t._penumbraCosProperty,r.penumbraCos),e.setFloatArray(t._coneCosProperty,r.coneCos)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=3*e,a=e,o=e,s=e,c=e,u=e,l=e,d=this.lightColor,h=this.position,f=this.direction,_=t._combinedData;_.color[r]=d.r,_.color[r+1]=d.g,_.color[r+2]=d.b,_.position[n]=h.x,_.position[n+1]=h.y,_.position[n+2]=h.z,_.direction[i]=f.x,_.direction[i+1]=f.y,_.direction[i+2]=f.z,_.distance[a]=this.distance,_.decay[o]=this.decay,_.angle[s]=this.angle,_.penumbra[c]=this.penumbra,_.penumbraCos[u]=Math.cos(this.angle*(1-this.penumbra)),_.coneCos[l]=Math.cos(this.angle)},T(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return i.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(xt);Ct._colorProperty=yt.getPropertyByName("u_spotLightColor"),Ct._positionProperty=yt.getPropertyByName("u_spotLightPosition"),Ct._directionProperty=yt.getPropertyByName("u_spotLightDirection"),Ct._distanceProperty=yt.getPropertyByName("u_spotLightDistance"),Ct._decayProperty=yt.getPropertyByName("u_spotLightDecay"),Ct._angleProperty=yt.getPropertyByName("u_spotLightAngle"),Ct._penumbraProperty=yt.getPropertyByName("u_spotLightPenumbra"),Ct._penumbraCosProperty=yt.getPropertyByName("u_spotLightPenumbraCos"),Ct._coneCosProperty=yt.getPropertyByName("u_spotLightConeCos"),Ct._combinedData={color:new Float32Array(3*xt._maxLight),position:new Float32Array(3*xt._maxLight),direction:new Float32Array(3*xt._maxLight),distance:new Float32Array(xt._maxLight),decay:new Float32Array(xt._maxLight),angle:new Float32Array(xt._maxLight),penumbra:new Float32Array(xt._maxLight),penumbraCos:new Float32Array(xt._maxLight),coneCos:new Float32Array(xt._maxLight)};var Mt=function(e){function t(){var t;return(t=e.call(this)||this).visibleLights=void 0,t.visibleLights=[],t}C(t,e);var r=t.prototype;return r.attachRenderLight=function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):xe.warn("Light already attached.")},r.detachRenderLight=function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)},r._updateShaderData=function(e){for(var r=0,n=0,i=0,a=0,o=0,s=this.visibleLights,c=0,u=s.length;c<u;c++){var l=s[c];l instanceof Tt?r++:l instanceof At?(At._updateShaderData(e,l),n++):l instanceof bt?l._appendData(i++):l instanceof wt?l._appendData(a++):l instanceof Ct&&l._appendData(o++)}r?e.enableMacro(t._ambientMacro):e.disableMacro(t._ambientMacro),n?e.enableMacro(t._envMacro):e.disableMacro(t._envMacro),i?(bt._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",i.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),a?(wt._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",a.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),o?(Ct._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",o.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},t}(ut);Mt._ambientMacro=yt.getMacroByName("O3_HAS_AMBIENT_LIGHT"),Mt._envMacro=yt.getMacroByName("O3_HAS_ENVMAP_LIGHT");var St,Pt,Rt,Lt,Et,Ot,Ft=function(e){function t(t){var r;return(r=e.call(this,t)||this).isGCIgnored=!1,r._refCount=0,r._destroyed=!1,t.resourceManager._addRefObject(r.instanceId,E(r)),r}C(t,e);var r=t.prototype;return r.destroy=function(e){if(void 0===e&&(e=!1),this._destroyed)return!0;if(!e&&0!==this._refCount)return!1;var t=this._engine.resourceManager;t&&(t._deleteAsset(this),t._deleteRefObject(this.instanceId));var r=this._getRefCount();return r>0&&this._addRefCount(-r),this._engine=null,this._onDestroy(),this._destroyed=!0,!0},r._getRefCount=function(){return this._refCount},r._addRefCount=function(e){this._refCount+=e},r._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},T(t,[{key:"refCount",get:function(){return this._refCount}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(fe);(St=e.GLCompressedTextureInternalFormat||(e.GLCompressedTextureInternalFormat={}))[St.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",St[St.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",St[St.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",St[St.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",St[St.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",St[St.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",St[St.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",St[St.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",St[St.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",St[St.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",St[St.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",St[St.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",St[St.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",St[St.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",St[St.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",St[St.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",St[St.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",St[St.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",St[St.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",St[St.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",St[St.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",St[St.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",St[St.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",St[St.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",St[St.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",St[St.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",St[St.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",St[St.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",St[St.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",St[St.R11_EAC=37488]="R11_EAC",St[St.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",St[St.RG11_EAC=37490]="RG11_EAC",St[St.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",St[St.RGB8_ETC2=37492]="RGB8_ETC2",St[St.SRGB8_ETC2=37493]="SRGB8_ETC2",St[St.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",St[St.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",St[St.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",St[St.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",St[St.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",St[St.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",St[St.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",St[St.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",St[St.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",St[St.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",St[St.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",St[St.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT",(Pt=e.RenderBufferColorFormat||(e.RenderBufferColorFormat={}))[Pt.R8G8B8=0]="R8G8B8",Pt[Pt.R8G8B8A8=1]="R8G8B8A8",Pt[Pt.R4G4B4A4=2]="R4G4B4A4",Pt[Pt.R5G5B5A1=3]="R5G5B5A1",Pt[Pt.R5G6B5=4]="R5G6B5",Pt[Pt.Alpha8=5]="Alpha8",Pt[Pt.R16G16B16A16=6]="R16G16B16A16",Pt[Pt.R32G32B32A32=7]="R32G32B32A32",(Rt=e.RenderBufferDepthFormat||(e.RenderBufferDepthFormat={}))[Rt.Depth=0]="Depth",Rt[Rt.DepthStencil=1]="DepthStencil",Rt[Rt.Stencil=2]="Stencil",Rt[Rt.Depth16=3]="Depth16",Rt[Rt.Depth24=4]="Depth24",Rt[Rt.Depth32=5]="Depth32",Rt[Rt.Depth24Stencil8=6]="Depth24Stencil8",Rt[Rt.Depth32Stencil8=7]="Depth32Stencil8",(Lt=e.TextureFilterMode||(e.TextureFilterMode={}))[Lt.Point=0]="Point",Lt[Lt.Bilinear=1]="Bilinear",Lt[Lt.Trilinear=2]="Trilinear",(Et=e.TextureFormat||(e.TextureFormat={}))[Et.R8G8B8=0]="R8G8B8",Et[Et.R8G8B8A8=1]="R8G8B8A8",Et[Et.R4G4B4A4=2]="R4G4B4A4",Et[Et.R5G5B5A1=3]="R5G5B5A1",Et[Et.R5G6B5=4]="R5G6B5",Et[Et.Alpha8=5]="Alpha8",Et[Et.R32G32B32A32=6]="R32G32B32A32",Et[Et.DXT1=7]="DXT1",Et[Et.DXT5=8]="DXT5",Et[Et.ETC1_RGB=9]="ETC1_RGB",Et[Et.ETC2_RGB=10]="ETC2_RGB",Et[Et.ETC2_RGBA5=11]="ETC2_RGBA5",Et[Et.ETC2_RGBA8=12]="ETC2_RGBA8",Et[Et.PVRTC_RGB2=13]="PVRTC_RGB2",Et[Et.PVRTC_RGBA2=14]="PVRTC_RGBA2",Et[Et.PVRTC_RGB4=15]="PVRTC_RGB4",Et[Et.PVRTC_RGBA4=16]="PVRTC_RGBA4",Et[Et.ASTC_4x4=17]="ASTC_4x4",Et[Et.ASTC_5x5=18]="ASTC_5x5",Et[Et.ASTC_6x6=19]="ASTC_6x6",Et[Et.ASTC_8x8=20]="ASTC_8x8",Et[Et.ASTC_10x10=21]="ASTC_10x10",Et[Et.ASTC_12x12=22]="ASTC_12x12",(Ot=e.TextureWrapMode||(e.TextureWrapMode={}))[Ot.Clamp=0]="Clamp",Ot[Ot.Repeat=1]="Repeat",Ot[Ot.Mirror=2]="Mirror";var It=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).name=void 0,e._glTexture=void 0,e._target=void 0,e._formatDetail=void 0,e._width=void 0,e._height=void 0,e._rhi=void 0,e._mipmap=void 0,e._mipmapCount=void 0,e._wrapModeU=void 0,e._wrapModeV=void 0,e._filterMode=void 0,e._anisoLevel=1,e}C(r,t),r._isPowerOf2=function(e){return 0==(e&e-1)},r._getFormatDetail=function(t,r,n){switch(t){case e.TextureFormat.R8G8B8:return{internalFormat:n?r.RGB8:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R8G8B8A8:return{internalFormat:n?r.RGBA8:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R4G4B4A4:return{internalFormat:n?r.RGBA4:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case e.TextureFormat.R5G5B5A1:return{internalFormat:n?r.RGB5_A1:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case e.TextureFormat.R5G6B5:return{internalFormat:n?r.RGB565:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case e.TextureFormat.Alpha8:return{internalFormat:r.ALPHA,baseFormat:r.ALPHA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R32G32B32A32:return{internalFormat:r.RGBA32F,baseFormat:r.RGBA,dataType:r.FLOAT,isCompressed:!1};case e.TextureFormat.DXT1:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,isCompressed:!0};case e.TextureFormat.DXT5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case e.TextureFormat.ETC1_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,isCompressed:!0};case e.TextureFormat.ETC2_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC,isCompressed:!0};case e.TextureFormat.PVRTC_RGB2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGB4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.ASTC_4x4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,isCompressed:!0};case e.TextureFormat.ASTC_5x5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR,isCompressed:!0};case e.TextureFormat.ASTC_6x6:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR,isCompressed:!0};case e.TextureFormat.ASTC_8x8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR,isCompressed:!0};case e.TextureFormat.ASTC_10x10:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR,isCompressed:!0};case e.TextureFormat.ASTC_12x12:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},r._getRenderBufferColorFormatDetail=function(t,r,n){switch(t){case e.RenderBufferColorFormat.R8G8B8:return{internalFormat:n?r.RGB8:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R8G8B8A8:return{internalFormat:n?r.RGBA8:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R4G4B4A4:return{internalFormat:n?r.RGBA4:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case e.RenderBufferColorFormat.R5G5B5A1:return{internalFormat:n?r.RGB5_A1:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case e.RenderBufferColorFormat.R5G6B5:return{internalFormat:n?r.RGB565:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case e.RenderBufferColorFormat.Alpha8:return{internalFormat:r.ALPHA,baseFormat:r.ALPHA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.RenderBufferColorFormat.R16G16B16A16:return{internalFormat:r.RGBA16F,baseFormat:r.RGBA,dataType:r.HALF_FLOAT,isCompressed:!1};case e.RenderBufferColorFormat.R32G32B32A32:return{internalFormat:r.RGBA32F,baseFormat:r.RGBA,dataType:r.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: "+t)}},r._getRenderBufferDepthFormatDetail=function(t,r,n){switch(t){case e.RenderBufferDepthFormat.Depth:return{internalFormat:n?r.DEPTH_COMPONENT32F:r.DEPTH_COMPONENT16,baseFormat:r.DEPTH_COMPONENT,dataType:n?r.FLOAT:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.DepthStencil:return{internalFormat:n?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,baseFormat:r.DEPTH_STENCIL,dataType:r.UNSIGNED_INT_24_8,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Stencil:return{internalFormat:r.STENCIL_INDEX8,baseFormat:r.STENCIL_ATTACHMENT,dataType:r.UNSIGNED_BYTE,isCompressed:!1,attachment:r.STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Depth16:return{internalFormat:r.DEPTH_COMPONENT16,baseFormat:r.DEPTH_COMPONENT,dataType:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth24:return{internalFormat:r.DEPTH_COMPONENT24,baseFormat:r.DEPTH_COMPONENT,dataType:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth32:return{internalFormat:r.DEPTH_COMPONENT32F,baseFormat:r.DEPTH_COMPONENT,dataType:r.FLOAT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.RenderBufferDepthFormat.Depth24Stencil8:return{internalFormat:n?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,baseFormat:r.DEPTH_STENCIL,dataType:r.UNSIGNED_INT_24_8,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};case e.RenderBufferDepthFormat.Depth32Stencil8:return{internalFormat:r.DEPTH32F_STENCIL8,baseFormat:r.DEPTH_STENCIL,dataType:r.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: "+t)}},r._supportTextureFormat=function(t,r){var n=!0;switch(t){case e.TextureFormat.R32G32B32A32:r.canIUse(e.GLCapabilityType.textureFloat)||(n=!1)}return n},r._supportRenderBufferColorFormat=function(t,r){var n=!0;switch(t){case e.RenderBufferColorFormat.R32G32B32A32:r.canIUse(e.GLCapabilityType.colorBufferFloat)&&r.canIUse(e.GLCapabilityType.textureFloat)||(n=!1);break;case e.RenderBufferColorFormat.R16G16B16A16:r.canIUse(e.GLCapabilityType.colorBufferHalfFloat)&&r.canIUse(e.GLCapabilityType.textureHalfFloat)||(n=!1)}return n},r._supportRenderBufferDepthFormat=function(t,r,n){var i=r.isWebGL2,a=!0;if(n&&!r.canIUse(e.GLCapabilityType.depthTexture))return!1;switch(t){case e.RenderBufferDepthFormat.Stencil:a=!1;break;case e.RenderBufferDepthFormat.Depth24:case e.RenderBufferDepthFormat.Depth32:case e.RenderBufferDepthFormat.Depth32Stencil8:i||(a=!1)}return a};var n=r.prototype;return n.generateMipmaps=function(){if(this._mipmap){var e=this._rhi.gl;this._bind(),e.generateMipmap(this._target),this._unbind()}},n._onDestroy=function(){this._rhi.gl.deleteTexture(this._glTexture),this._glTexture=null,this._formatDetail=null,this._rhi=null},n._bind=function(){this._rhi.bindTexture(this._target,this._glTexture)},n._unbind=function(){this._rhi.bindTexture(this._target,null)},n._getPixelBuffer=function(e,t,n,i,a,o){var s=this._rhi.gl,c=this._formatDetail,u=c.baseFormat,l=c.dataType;r._readFrameBuffer||(r._readFrameBuffer=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,r._readFrameBuffer),null!=e?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+e,this._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,0),s.readPixels(t,n,i,a,u,l,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},n._initMipmap=function(e){var t=this._rhi.gl,r=this._rhi.isWebGL2,n=this._formatDetail,i=n.internalFormat,a=n.baseFormat,o=n.dataType;if(this._bind(),r)t.texStorage2D(this._target,this._mipmapCount,i,this._width,this._height);else if(a!==i&&(i=a),e)for(var s=0;s<this._mipmapCount;s++)for(var c=Math.max(1,this._width>>s),u=0;u<6;u++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+u,s,i,c,c,0,a,o,null);else for(var l=0;l<this._mipmapCount;l++){var d=Math.max(1,this._width>>l),h=Math.max(1,this._height>>l);t.texImage2D(this._target,l,i,d,h,0,a,o,null)}this._unbind()},n._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},n._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},n._setWrapMode=function(t,n){var i=this._rhi.gl;switch(this._rhi.isWebGL2||t===e.TextureWrapMode.Clamp||r._isPowerOf2(this._width)&&r._isPowerOf2(this._height)||(xe.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=e.TextureWrapMode.Clamp),t){case e.TextureWrapMode.Clamp:i.texParameteri(this._target,n,i.CLAMP_TO_EDGE);break;case e.TextureWrapMode.Repeat:i.texParameteri(this._target,n,i.REPEAT);break;case e.TextureWrapMode.Mirror:i.texParameteri(this._target,n,i.MIRRORED_REPEAT)}},T(r,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){if(e!==this._wrapModeU){var t=this._rhi.gl;this._wrapModeU=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_S),this._unbind()}}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){if(e!==this._wrapModeV){var t=this._rhi.gl;this._wrapModeV=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_T),this._unbind()}}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(t){if(t!==this._filterMode){var r=this._rhi.gl;switch(this._filterMode=t,this._bind(),t){case e.TextureFilterMode.Point:r.texParameteri(this._target,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(this._target,r.TEXTURE_MIN_FILTER,this._mipmap?r.NEAREST_MIPMAP_NEAREST:r.NEAREST);break;case e.TextureFilterMode.Bilinear:r.texParameteri(this._target,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(this._target,r.TEXTURE_MIN_FILTER,this._mipmap?r.LINEAR_MIPMAP_NEAREST:r.LINEAR);break;case e.TextureFilterMode.Trilinear:r.texParameteri(this._target,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(this._target,r.TEXTURE_MIN_FILTER,this._mipmap?r.LINEAR_MIPMAP_LINEAR:r.LINEAR)}this._unbind()}}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._rhi.capability.maxAnisoLevel;if(e>t&&(xe.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+t),e=t),e<1&&(xe.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel){var r=this._rhi.gl;this._anisoLevel=e,this._bind(),r.texParameterf(this._target,r.TEXTURE_MAX_ANISOTROPY_EXT,e),this._unbind()}}}]),r}(Ft);It._readFrameBuffer=null;var Bt=function(){function e(e){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new Re,this._variableMacros=Object.create(null),this._refCount=0,this._group=e}var t=e.prototype;return t.getFloat=function(e){return this._getData(e)},t.setFloat=function(e,t){this._setData(e,t)},t.getInt=function(e){return this._getData(e)},t.setInt=function(e,t){this._setData(e,t)},t.getFloatArray=function(e){return this._getData(e)},t.setFloatArray=function(e,t){this._setData(e,t)},t.getIntArray=function(e){return this._getData(e)},t.setIntArray=function(e,t){this._setData(e,t)},t.getVector2=function(e){return this._getData(e)},t.setVector2=function(e,t){this._setData(e,t)},t.getVector3=function(e){return this._getData(e)},t.setVector3=function(e,t){this._setData(e,t)},t.getVector4=function(e){return this._getData(e)},t.setVector4=function(e,t){this._setData(e,t)},t.getMatrix=function(e){return this._getData(e)},t.setMatrix=function(e,t){this._setData(e,t)},t.getColor=function(e){return this._getData(e)},t.setColor=function(e,t){this._setData(e,t)},t.getTexture=function(e){return this._getData(e)},t.setTexture=function(e,t){if(this._getRefCount()>0){var r=this._getData(e);r&&r._addRefCount(-1),t&&t._addRefCount(1)}this._setData(e,t)},t.getTextureArray=function(e){return this._getData(e)},t.setTextureArray=function(e,t){if(this._getRefCount()>0){var r=this._getData(e);if(r)for(var n=0,i=r.length;n<i;n++)r[n]._addRefCount(-1);if(t)for(var a=0,o=t.length;a<o;a++)t[a]._addRefCount(1)}this._setData(e,t)},t.enableMacro=function(e,t){void 0===t&&(t=null),t?this._enableVariableMacro(e,t):("string"==typeof e&&(e=yt.getMacroByName(e)),this._macroCollection.enable(e))},t.disableMacro=function(e){if("string"==typeof e){var t=this._variableMacros[e];t?this._disableVariableMacro(e,t):(e=yt.getMacroByName(e),this._macroCollection.disable(e))}else this._macroCollection.disable(e)},t.clone=function(){var t=new e(this._group);return this.cloneTo(t),t},t.cloneTo=function(e){J.deepCloneObject(this._macroCollection,e._macroCollection),A(e._variableMacros,this._variableMacros);for(var t=this._properties,r=e._properties,n=Object.keys(t),i=0,a=n.length;i<a;i++){var o=n[i],s=t[o];null!=s?"number"==typeof s||s instanceof It?r[o]=s:s instanceof Array||s instanceof Float32Array||s instanceof Int32Array?r[o]=s.slice():r[o]=s.clone():r[o]=s}},t._getData=function(e){return"string"==typeof e&&(e=yt.getPropertyByName(e)),this._properties[e._uniqueId]},t._setData=function(e,t){if("string"==typeof e&&(e=yt.getPropertyByName(e)),e._group!==this._group){if(void 0!==e._group)throw"This property has been used as "+ht[e._group]+" property.";e._group=this._group}this._properties[e._uniqueId]=t},t._getRefCount=function(){return this._refCount},t._addRefCount=function(e){this._refCount+=e;var t=this._properties;for(var r in t){var n=t[r];n&&n instanceof It&&n._addRefCount(e)}},t._enableVariableMacro=function(e,t){var r=this._variableMacros,n=r[e];if(n!==t){n&&this._disableVariableMacro(e,n);var i=yt.getMacroByName(e+" "+t);this._macroCollection.enable(i),r[e]=t}},t._disableVariableMacro=function(e,t){var r=yt.getMacroByName(e+" "+t);this._macroCollection.disable(r),delete this._variableMacros[e]},e}(),zt=function(t){function r(n,i){var a;(a=t.call(this,n)||this).shaderData=new Bt(ht.Scene),a.name=void 0,a.clipPlanes=[],a._activeCameras=[],a._isActiveInEngine=!1,a._destroyed=!1,a._rootEntities=[],a._resolution=new g,a.features=[],a.name=i||"";var o=a.shaderData;return r.sceneFeatureManager.addObject(E(a)),o._addRefCount(1),a._engine._hardwareRenderer.canIUse(e.GLCapabilityType.shaderTextureLod)&&o.enableMacro("HAS_TEX_LOD"),a._engine._hardwareRenderer.canIUse(e.GLCapabilityType.standardDerivatives)&&o.enableMacro("HAS_DERIVATIVES"),a}C(r,t);var n=r.prototype;return n.createRootEntity=function(e){var t=new $e(this._engine,e);return this.addRootEntity(t),t},n.addRootEntity=function(e){var t=e._isRoot;t||(e._isRoot=!0,e._removeFromParent());var r=e._scene;r!==this?(r&&t&&r._removeEntity(e),this._rootEntities.push(e),$e._traverseSetOwnerScene(e,this)):t||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},n.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),$e._traverseSetOwnerScene(e,null))},n.getRootEntity=function(e){return void 0===e&&(e=0),this._rootEntities[e]},n.findEntityByName=function(e){for(var t=this._rootEntities,r=t.length-1;r>=0;r--){var n=t[r];if(n.name===e)return n}for(var i=t.length-1;i>=0;i--){var a=t[i].findByName(e);if(a)return a}return null},n.findEntityByPath=function(e){for(var t=e.split("/").filter(Boolean),r=0,n=this.rootEntitiesCount;r<n;r++){var i=this.getRootEntity(r);if(i.name==t[0]){for(var a=1,o=t.length;a<o&&(i=$e._findChildByName(i,t[a]));++a);return i}}return null},n.destroy=function(){if(!this._destroyed){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),r.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,t=this.rootEntitiesCount;e<t;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,r.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1),this._destroyed=!0}},n.attachRenderCamera=function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):xe.warn("Camera already attached.")},n.detachRenderCamera=function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)},n._processActive=function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,r=t.length-1;r>=0;r--){var n=t[r];n._isActive&&(e?n._processActive():n._processInActive())}},n._updateShaderData=function(){var e=this.findFeature(Mt),t=this.shaderData,n=this.engine.canvas,i=this._resolution;e._updateShaderData(t),i.setValue(n.width,n.height),t.setVector2(r._resolutionProperty,i)},n._removeEntity=function(e){var t=this._rootEntities;t.splice(t.indexOf(e),1)},r.registerFeature=function(e){r.sceneFeatureManager.registerFeature(e)},n.findFeature=function(e){return r.sceneFeatureManager.findFeature(this,e)},n.raycast=function(e,t,r){},T(r,[{key:"engine",get:function(){return this._engine}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"destroyed",get:function(){return this._destroyed}}]),r}(fe);zt._resolutionProperty=yt.getPropertyByName("u_resolution"),zt.sceneFeatureManager=new et;var Dt=function(){function e(e){this.engine=e,this._activeScene=void 0}var t=e.prototype;return t.loadScene=function(e,t){var r=this;void 0===t&&(t=!0);var n=this.engine.resourceManager.load(e);return n.then((function(e){var n=r._activeScene;r.activeScene=e,n&&t&&n.destroy()})),n},t.mergeScenes=function(e,t){for(var r=e.rootEntities,n=0,i=r.length;n<i;n++)t.addRootEntity(r[n])},T(e,[{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),Nt="#define GLSLIFY 1\n#include <common_vert>\n#include <normal_share>\n#include <shadow_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <skinning_vert>\n#include <shadow_vert>\n#include <position_vert>\n}",Gt=function(){function e(){}return e.init=function(){yt.create("blinn-phong","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <morph_target_vert>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <morph_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <mobile_material_frag>\n#include <fog_share>\nvoid main(){\n#include <begin_mobile_frag>\n#include <begin_normal_frag>\n#include <begin_viewdir_frag>\n#include <mobile_blinnphong_frag>\ngl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;\n#include <fog_frag>\n}"),yt.create("pbr","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <clipPlane_vert_define>\n#include <morph_target_vert>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <morph_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <clipPlane_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <pbr_common_frag_define>\n#include <pbr_util_frag_define>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <refraction_share>\n#include <perturbation_share>\n#include <clipPlane_frag_define>\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <pbr_envmap_light_frag_define>\n#include <pbr_base_frag_define>\n#include <pbr_texture_frag_define>\n#include <pbr_runtime_frag_define>\n#include <pbr_normal_frag_define>\n#include <pbr_brdf_cook_torrance_frag_define>\n#include <pbr_direct_irradiance_frag_define>\n#include <pbr_ibl_diffuse_frag_define>\n#include <pbr_ibl_specular_frag_define>\n#include <oit_frag_define>\nvoid main(){\n#include <clipPlane_frag>\n#include <pbr_begin_frag>\n#include <pbr_direct_irradiance_frag>\n#include <pbr_ibl_diffuse_frag>\n#include <pbr_ibl_specular_frag>\n#include <pbr_end_frag>\n#include <gamma_frag>\n#include <refraction_frag>\n#include <perturbation_frag>\n#include <fog_frag>\n#include <oit_frag>\n}"),yt.create("unlit","#define GLSLIFY 1\n#include <common_vert>\n#include <uv_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <uv_share>\n#include <fog_share>\nuniform vec4 u_baseColor;\n#ifdef O3_BASECOLOR_TEXTURE\nuniform sampler2D u_baseColorTexture;\n#endif\nvoid main(){vec4 baseColor=u_baseColor;\n#ifdef O3_BASECOLOR_TEXTURE\nbaseColor*=texture2D(u_baseColorTexture,v_uv);\n#endif\ngl_FragColor=baseColor;\n#include <fog_frag>\n}"),yt.create("shadow-map",Nt,"#define GLSLIFY 1\n/***Decompose and save depth value.*/vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}"),yt.create("shadow",Nt,"#define GLSLIFY 1\n#ifdef O3_SHADOW_MAP_COUNT\nuniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));/***Unpack depth value.*/float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}/***Degree of shadow.*/float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}\n#endif\nvoid main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);\n#ifdef O3_SHADOW_MAP_COUNT\nfloat visibility=1.0;\n#if (O3_SHADOW_MAP_COUNT == 1)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);\n#elif (O3_SHADOW_MAP_COUNT == 2)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);\n#elif (O3_SHADOW_MAP_COUNT == 3)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);\n#endif\nvisibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);\n#endif\ngl_FragColor=shadowColor;}"),yt.create("skybox","#define GLSLIFY 1\n#include <common_vert>\nuniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=POSITION.xyz;gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}","#define GLSLIFY 1\nuniform samplerCube u_cube;varying vec3 v_cubeUV;void main(){gl_FragColor=textureCube(u_cube,v_cubeUV);}"),yt.create("particle-shader","#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform bool u_active;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;\n#ifdef is2d\nuniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;\n#endif\nmat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y+a_lifeAndSize.x;float deltaTime=max(mod(u_time,life)-a_lifeAndSize.x,0.0);bool isDying=false;if(u_once||!u_active){isDying=true;}if((isDying&&u_time>life)){deltaTime=life;}if(deltaTime==0.0){deltaTime=life;}v_lifeLeft=1.0-deltaTime/a_lifeAndSize.y;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;\n#ifdef isScaleByLifetime\nscale*=v_lifeLeft;\n#else\nscale*=pow(a_lifeAndSize.w,deltaTime);\n#endif\n#ifdef rotateToVelocity\nvec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;\n#else\nfloat deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;\n#endif\n#ifdef is2d\nvec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);\n#else\n#ifdef rotateToVelocity\nfloat s=sin(angle);float c=cos(angle);\n#else\nfloat s=sin(angle);float c=cos(angle);\n#endif\nvec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;\n#endif\n}","#define GLSLIFY 1\nvarying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){float alphaFactor=1.0;\n#ifdef fadeIn\nfloat fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);\n#endif\n#ifdef fadeOut\nfloat fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;\n#endif\n#ifdef particleTexture\nvec4 tex=texture2D(u_texture,v_uv);\n#ifdef useOriginColor\ngl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);\n#else\ngl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);\n#endif\n#else\ngl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);\n#endif\n}")},e}(),Ut=function(){function e(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var t=e.prototype;return t.get=function(e){var t=this._cacheMap,r=e._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(t,0,r);for(var n=e._mask,i=e._length-1,a=this._cacheHierarchy-1,o=0;o<a;o++){var s=i<o?0:n[o],c=t[s];c||(t[s]=c=Object.create(null)),t=c}var u=i<a?0:n[a],l=t[u];return l||(this._lastQueryKey=u,this._lastQueryMap=t),l},t.cache=function(e){this._lastQueryMap[this._lastQueryKey]=e},t._resizeCacheMapHierarchy=function(e,t,r){var n=this._cacheHierarchy-1;if(t==n){for(var i in e)for(var a=e[i],o=0,s=r-n;o<s;o++)o==s-1?e[0]=a:e=e[0==o?i:0]=Object.create(null);this._cacheHierarchy=r}else for(var c in e)this._resizeCacheMapHierarchy(e[c],++t,r)},e}(),Vt=function(){this.colorBlendOperation=e.BlendOperation.Add,this.alphaBlendOperation=e.BlendOperation.Add,this.sourceColorBlendFactor=e.BlendFactor.One,this.sourceAlphaBlendFactor=e.BlendFactor.One,this.destinationColorBlendFactor=e.BlendFactor.Zero,this.destinationAlphaBlendFactor=e.BlendFactor.Zero,this.colorWriteMask=e.ColorWriteMask.All,this._blendEnable=!1},kt=function(){function t(){this.targetBlendState=new Vt,this.blendColor=new y(0,0,0,0),this.alphaToCoverage=!1}t._getGLBlendFactor=function(t){switch(t){case e.BlendFactor.Zero:return WebGLRenderingContext.ZERO;case e.BlendFactor.One:return WebGLRenderingContext.ONE;case e.BlendFactor.SourceColor:return WebGLRenderingContext.SRC_COLOR;case e.BlendFactor.OneMinusSourceColor:return WebGLRenderingContext.ONE_MINUS_SRC_COLOR;case e.BlendFactor.DestinationColor:return WebGLRenderingContext.DST_COLOR;case e.BlendFactor.OneMinusDestinationColor:return WebGLRenderingContext.ONE_MINUS_DST_COLOR;case e.BlendFactor.SourceAlpha:return WebGLRenderingContext.SRC_ALPHA;case e.BlendFactor.OneMinusSourceAlpha:return WebGLRenderingContext.ONE_MINUS_SRC_ALPHA;case e.BlendFactor.DestinationAlpha:return WebGLRenderingContext.DST_ALPHA;case e.BlendFactor.OneMinusDestinationAlpha:return WebGLRenderingContext.ONE_MINUS_DST_ALPHA;case e.BlendFactor.SourceAlphaSaturate:return WebGLRenderingContext.SRC_ALPHA_SATURATE;case e.BlendFactor.BlendColor:return WebGLRenderingContext.CONSTANT_COLOR;case e.BlendFactor.OneMinusBlendColor:return WebGLRenderingContext.ONE_MINUS_CONSTANT_COLOR}},t._getGLBlendOperation=function(t){switch(t){case e.BlendOperation.Add:return WebGLRenderingContext.FUNC_ADD;case e.BlendOperation.Subtract:return WebGLRenderingContext.FUNC_SUBTRACT;case e.BlendOperation.ReverseSubtract:return WebGLRenderingContext.FUNC_REVERSE_SUBTRACT;case e.BlendOperation.Min:return WebGL2RenderingContext.MIN;case e.BlendOperation.Max:return WebGL2RenderingContext.MAX}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.blendState)},r._platformApply=function(r,n){var i=r.gl,a=n.targetBlendState,o=this.targetBlendState,s=o.colorBlendOperation,c=o.alphaBlendOperation,u=o.sourceColorBlendFactor,l=o.destinationColorBlendFactor,d=o.sourceAlphaBlendFactor,h=o.destinationAlphaBlendFactor,f=o.colorWriteMask,_=!!(u!==e.BlendFactor.One||l!==e.BlendFactor.Zero||d!==e.BlendFactor.One||h!==e.BlendFactor.Zero||s!==e.BlendOperation.Add&&s!==e.BlendOperation.Subtract||c!==e.BlendOperation.Add&&c!==e.BlendOperation.Subtract);if(_!==a._blendEnable&&(_?i.enable(i.BLEND):i.disable(i.BLEND),a._blendEnable=_),_){u===a.sourceColorBlendFactor&&l===a.destinationColorBlendFactor&&d===a.sourceAlphaBlendFactor&&h===a.destinationAlphaBlendFactor||(i.blendFuncSeparate(t._getGLBlendFactor(u),t._getGLBlendFactor(l),t._getGLBlendFactor(d),t._getGLBlendFactor(h)),a.sourceColorBlendFactor=u,a.destinationColorBlendFactor=l,a.sourceAlphaBlendFactor=d,a.destinationAlphaBlendFactor=h),s===a.colorBlendOperation&&c===a.alphaBlendOperation||(i.blendEquationSeparate(t._getGLBlendOperation(s),t._getGLBlendOperation(c)),a.colorBlendOperation=s,a.alphaBlendOperation=c);var p=this.blendColor;y.equals(n.blendColor,p)||(i.blendColor(p.r,p.g,p.b,p.a),p.cloneTo(n.blendColor))}f!==a.colorWriteMask&&(i.colorMask(0!=(f&e.ColorWriteMask.Red),0!=(f&e.ColorWriteMask.Green),0!=(f&e.ColorWriteMask.Blue),0!=(f&e.ColorWriteMask.Alpha)),a.colorWriteMask=f);var g=this.alphaToCoverage;g!==n.alphaToCoverage&&(g?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.alphaToCoverage=g)},t}(),Ht=function(){function t(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=e.CompareFunction.Less}t._getGLCompareFunction=function(t){switch(t){case e.CompareFunction.Never:return WebGLRenderingContext.NEVER;case e.CompareFunction.Less:return WebGLRenderingContext.LESS;case e.CompareFunction.Equal:return WebGLRenderingContext.EQUAL;case e.CompareFunction.LessEqual:return WebGL2RenderingContext.LEQUAL;case e.CompareFunction.Greater:return WebGL2RenderingContext.GREATER;case e.CompareFunction.NotEqual:return WebGL2RenderingContext.NOTEQUAL;case e.CompareFunction.GreaterEqual:return WebGL2RenderingContext.GEQUAL;case e.CompareFunction.Always:return WebGL2RenderingContext.ALWAYS}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.depthState)},r._platformApply=function(e,r){var n=e.gl,i=this.enabled,a=this.compareFunction,o=this.writeEnabled;i!=r.enabled&&(i?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),r.enabled=i),i&&(a!=r.compareFunction&&(n.depthFunc(t._getGLCompareFunction(a)),r.compareFunction=a),o!=r.writeEnabled&&(n.depthMask(o),r.writeEnabled=o))},t}(),Wt=function(){function t(){this.cullMode=e.CullMode.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0}var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.rasterState)},r._platformApply=function(t,r){var n=t.gl,i=this.cullMode,a=this.depthBias,o=this.slopeScaledDepthBias,s=i!==e.CullMode.Off;s!==r._cullFaceEnable&&(s?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),r._cullFaceEnable=s),s&&i!==r.cullMode&&(i==e.CullMode.Back?n.cullFace(n.BACK):n.cullFace(n.FRONT),r.cullMode=i),a===r.depthBias&&o===r.slopeScaledDepthBias||(0!==a||0!==o?(n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(o,a)):n.disable(n.POLYGON_OFFSET_FILL),r.depthBias=a,r.slopeScaledDepthBias=o)},t}(),jt=function(){function t(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=e.CompareFunction.Always,this.compareFunctionBack=e.CompareFunction.Always,this.passOperationFront=e.StencilOperation.Keep,this.passOperationBack=e.StencilOperation.Keep,this.failOperationFront=e.StencilOperation.Keep,this.failOperationBack=e.StencilOperation.Keep,this.zFailOperationFront=e.StencilOperation.Keep,this.zFailOperationBack=e.StencilOperation.Keep}t._getGLCompareFunction=function(t){switch(t){case e.CompareFunction.Never:return WebGLRenderingContext.NEVER;case e.CompareFunction.Less:return WebGLRenderingContext.LESS;case e.CompareFunction.Equal:return WebGLRenderingContext.EQUAL;case e.CompareFunction.LessEqual:return WebGLRenderingContext.LEQUAL;case e.CompareFunction.Greater:return WebGLRenderingContext.GREATER;case e.CompareFunction.NotEqual:return WebGLRenderingContext.NOTEQUAL;case e.CompareFunction.GreaterEqual:return WebGLRenderingContext.GEQUAL;case e.CompareFunction.Always:return WebGLRenderingContext.ALWAYS}},t._getGLStencilOperation=function(t){switch(t){case e.StencilOperation.Keep:return WebGLRenderingContext.KEEP;case e.StencilOperation.Zero:return WebGLRenderingContext.ZERO;case e.StencilOperation.Replace:return WebGLRenderingContext.REPLACE;case e.StencilOperation.IncrementSaturate:return WebGLRenderingContext.INCR;case e.StencilOperation.DecrementSaturate:return WebGLRenderingContext.DECR;case e.StencilOperation.Invert:return WebGLRenderingContext.INVERT;case e.StencilOperation.IncrementWrap:return WebGLRenderingContext.INCR_WRAP;case e.StencilOperation.DecrementWrap:return WebGLRenderingContext.DECR_WRAP}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.stencilState)},r._platformApply=function(e,r){var n=e.gl,i=this.enabled,a=this.referenceValue,o=this.mask,s=this.compareFunctionFront,c=this.compareFunctionBack,u=this.failOperationFront,l=this.zFailOperationFront,d=this.passOperationFront,h=this.failOperationBack,f=this.zFailOperationBack,_=this.passOperationBack,p=this.writeMask;if(i!=r.enabled&&(i?n.enable(n.STENCIL_TEST):n.disable(WebGLRenderingContext.STENCIL_TEST),r.enabled=i),i){var g=a!==r.referenceValue||o!==r.mask;(g||s!==r.compareFunctionFront)&&(n.stencilFuncSeparate(n.FRONT,t._getGLCompareFunction(s),a,o),r.compareFunctionFront=s),(g||c!==r.compareFunctionBack)&&(n.stencilFuncSeparate(n.BACK,t._getGLCompareFunction(c),a,o),r.compareFunctionBack=this.compareFunctionBack),g&&(r.referenceValue=this.referenceValue,r.mask=this.mask),u===r.failOperationFront&&l===r.zFailOperationFront&&d===r.passOperationFront||(n.stencilOpSeparate(n.FRONT,t._getGLStencilOperation(u),t._getGLStencilOperation(l),t._getGLStencilOperation(d)),r.failOperationFront=u,r.zFailOperationFront=l,r.passOperationFront=d),h===r.failOperationBack&&f===r.zFailOperationBack&&_===r.passOperationBack||(n.stencilOpSeparate(n.BACK,t._getGLStencilOperation(h),t._getGLStencilOperation(f),t._getGLStencilOperation(_)),r.failOperationBack=h,r.zFailOperationBack=f,r.passOperationBack=_),p!==r.writeMask&&(n.stencilMask(p),r.writeMask=p)}},t}(),Xt=function(){function e(){this.blendState=new kt,this.depthState=new Ht,this.stencilState=new jt,this.rasterState=new Wt}return e.prototype._apply=function(e){var t=e._hardwareRenderer,r=e._lastRenderState;this.blendState._apply(t,r),this.depthState._apply(t,r),this.stencilState._apply(t,r),this.rasterState._apply(t,r)},e}(),Kt=new et;Gt.init();var qt,Yt,Qt,Jt,Zt,$t,er,tr,rr,nr,ir,ar,or,sr,cr,ur,lr,dr,hr,fr,_r,pr,gr,vr=function(e){function t(t,r){var n;return(n=e.call(this,null)||this)._componentsManager=new Le,n._hardwareRenderer=void 0,n._lastRenderState=new Xt,n._renderCount=0,n._shaderProgramPools=[],n._canvas=void 0,n._resourceManager=new G(E(n)),n._sceneManager=new Dt(E(n)),n._vSyncCount=1,n._targetFrameRate=60,n._time=new Te,n._isPaused=!0,n._requestId=void 0,n._timeoutId=void 0,n._vSyncCounter=1,n._targetFrameInterval=1e3/60,n._animate=function(){n._vSyncCount?(n._requestId=requestAnimationFrame(n._animate),n._vSyncCounter++%n._vSyncCount==0&&(n.update(),n._vSyncCounter=1)):(n._timeoutId=window.setTimeout(n._animate,n._targetFrameInterval),n.update())},n.features=[],n._hardwareRenderer=r,n._hardwareRenderer.init(t),n._canvas=t,Kt.addObject(E(n)),n._sceneManager.activeScene=new zt(E(n),"DefaultScene"),n}C(t,e);var r=t.prototype;return r.createEntity=function(e){return new $e(this,e)},r.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},r.resume=function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))},r.update=function(){var e=this._time,t=e.deltaTime;e.tick(),tt._restPool(),Kt.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var r=this._sceneManager._activeScene,n=this._componentsManager;r&&(n.callScriptOnStart(),n.callScriptOnUpdate(t),n.callAnimationUpdate(t),n.callScriptOnLateUpdate(t),this._render(r)),this._componentsManager.callComponentDestory(),Kt.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},r.run=function(){Kt.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new k("run",this))},r.destroy=function(){this._sceneManager&&(this.trigger(new k("shutdown",this)),Kt.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._sceneManager=null,this._resourceManager.gc(),this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,Kt._objects=[])},r._getShaderProgramPool=function(e){var t=e._shaderId,r=this._shaderProgramPools,n=r[t];if(!n){var i=t+1;i<r.length&&(r.length=i),r[t]=n=new Ut}return n},r._render=function(e){var t=e._activeCameras,r=this._componentsManager,n=this.time.deltaTime;if(r.callRendererOnUpdate(n),e._updateShaderData(),t.length>0){t.sort((function(e,t){return e.priority-t.priority}));for(var i=0,a=t.length;i<a;i++){var o=t[i],s=o.entity;o.enabled&&s.isActiveInHierarchy&&(r.callCameraOnBeginRender(o),zt.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,o]),o.render(),zt.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,o]),r.callCameraOnEndRender(o))}}else xe.debug("NO active camera.")},r.findFeature=function(e){return Kt.findFeature(this,e)},t.registerFeature=function(e){Kt.registerFeature(e)},T(t,[{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"renderhardware",get:function(){return this._hardwareRenderer}}]),t}(_e),mr=function(){function e(){}return T(e,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),e}(),yr=function(){function e(){}var t=e.prototype;return t.preLoad=function(e){},t.preTick=function(e,t){},t.postTick=function(e,t){},t.shutdown=function(e){},e}(),xr=(Yt=B((qt=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return I(t=e.call.apply(e,[this].concat(n))||this,"_started",Yt,E(t)),I(t,"_onStartIndex",Qt,E(t)),I(t,"_onUpdateIndex",Jt,E(t)),I(t,"_onLateUpdateIndex",Zt,E(t)),I(t,"_onPreRenderIndex",$t,E(t)),I(t,"_onPostRenderIndex",er,E(t)),t}C(t,e);var r=t.prototype;return r.onAwake=function(){},r.onEnable=function(){},r.onStart=function(){},r.onUpdate=function(e){},r.onLateUpdate=function(e){},r.onBeginRender=function(e){},r.onEndRender=function(e){},r.onDisable=function(){},r.onDestroy=function(){},r._onAwake=function(){this.onAwake()},r._onEnable=function(){var e=this.engine._componentsManager,r=t.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this.onEnable()},r._onDisable=function(){var e=this.engine._componentsManager;-1!==this._onStartIndex&&e.removeOnStartScript(this),-1!==this._onUpdateIndex&&e.removeOnUpdateScript(this),-1!==this._onLateUpdateIndex&&e.removeOnLateUpdateScript(this),this.onDisable()},r._onDestroy=function(){this.engine._componentsManager.addDestoryComponent(this)},t}(Qe)).prototype,"_started",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qt=B(qt.prototype,"_onStartIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jt=B(qt.prototype,"_onUpdateIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Zt=B(qt.prototype,"_onLateUpdateIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$t=B(qt.prototype,"_onPreRenderIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),er=B(qt.prototype,"_onPostRenderIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),qt),Tr=(pr=_r=function(e){function t(r){var n;I(n=e.call(this,r)||this,"shaderData",rr,E(n)),I(n,"isCulled",nr,E(n)),I(n,"_onUpdateIndex",ir,E(n)),I(n,"_rendererIndex",ar,E(n)),I(n,"_globalShaderMacro",or,E(n)),I(n,"_overrideUpdate",sr,E(n)),I(n,"_transformChangeFlag",cr,E(n)),I(n,"_bounds",ur,E(n)),I(n,"_mvMatrix",lr,E(n)),I(n,"_mvpMatrix",dr,E(n)),I(n,"_mvInvMatrix",hr,E(n)),I(n,"_normalMatrix",fr,E(n));var i=t.prototype;return n._overrideUpdate=n.update!==i.update,n._transformChangeFlag=n.entity.transform.registerWorldChangeFlag(),n.shaderData._addRefCount(1),n}C(t,e);var r=t.prototype;return r._updateShaderData=function(e){var r=this.shaderData,n=this.entity.transform.worldMatrix,i=this._mvMatrix,a=this._mvpMatrix,o=this._mvInvMatrix,s=this._normalMatrix;h.multiply(e._camera.viewMatrix,n,i),h.multiply(e._viewProjectMatrix,n,a),h.invert(i,o),h.invert(n,s),s.transpose(),r.setMatrix(t._localMatrixProperty,this.entity.transform.localMatrix),r.setMatrix(t._worldMatrixProperty,n),r.setMatrix(t._mvMatrixProperty,i),r.setMatrix(t._mvpMatrixProperty,a),r.setMatrix(t._mvInvMatrixProperty,o),r.setMatrix(t._normalMatrixProperty,s)},r._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1)},r.update=function(e){},r._updateBounds=function(e){},r._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},r._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},r._render=function(e){this.render(e)},T(t,[{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),t}(Qe),_r._localMatrixProperty=yt.getPropertyByName("u_localMat"),_r._worldMatrixProperty=yt.getPropertyByName("u_modelMat"),_r._mvMatrixProperty=yt.getPropertyByName("u_MVMat"),_r._mvpMatrixProperty=yt.getPropertyByName("u_MVPMat"),_r._mvInvMatrixProperty=yt.getPropertyByName("u_MVInvMat"),_r._normalMatrixProperty=yt.getPropertyByName("u_normalMat"),rr=B((tr=pr).prototype,"shaderData",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bt(ht.Renderer)}}),nr=B(tr.prototype,"isCulled",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ir=B(tr.prototype,"_onUpdateIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ar=B(tr.prototype,"_rendererIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),or=B(tr.prototype,"_globalShaderMacro",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Re}}),sr=B(tr.prototype,"_overrideUpdate",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cr=B(tr.prototype,"_transformChangeFlag",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ur=B(tr.prototype,"_bounds",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o(new i,new i)}}),lr=B(tr.prototype,"_mvMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),dr=B(tr.prototype,"_mvpMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),hr=B(tr.prototype,"_mvInvMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),fr=B(tr.prototype,"_normalMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),tr);(gr=e.AlphaMode||(e.AlphaMode={}))[gr.Opaque=0]="Opaque",gr[gr.Blend=1]="Blend",gr[gr.CutOff=2]="CutOff";var br,Ar,wr,Cr,Mr,Sr,Pr,Rr,Lr,Er,Or,Fr,Ir,Br,zr,Dr,Nr,Gr,Ur=function(t){function r(r,n){var i;return(i=t.call(this,r)||this).shader=void 0,i.renderQueueType=e.RenderQueueType.Opaque,i.shaderData=new Bt(ht.Material),i.renderState=new Xt,i.shader=n,i}C(r,t);var n=r.prototype;return n.clone=function(){var e=new r(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),J.deepCloneObject(this.renderState,e.renderState)},n._addRefCount=function(e){t.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},n._preRender=function(e){},n._onDestroy=function(){},r}(Ft),Vr=function(t){function r(r){var n;return(n=t.call(this,r,yt.find("blinn-phong"))||this)._emissiveColor=new y(0,0,0,1),n._diffuseColor=new y(1,1,1,1),n._specularColor=new y(1,1,1,1),n._emissiveTexture=void 0,n._diffuseTexture=void 0,n._specularTexture=void 0,n._shininess=16,n._alphaMode=e.AlphaMode.Opaque,n._doubleSided=!1,n.shaderData.enableMacro("O3_NEED_WORLDPOS"),n.emissiveColor=n._emissiveColor,n.diffuseColor=n._diffuseColor,n.specularColor=n._specularColor,n.shininess=n._shininess,n}return C(r,t),r.prototype.clone=function(){var e=new r(this._engine);return this.cloneTo(e),e},T(r,[{key:"emissiveColor",get:function(){return this._emissiveColor},set:function(e){this._emissiveColor=e,this.shaderData.setColor("u_emissiveColor",e)}},{key:"emissiveTexture",get:function(){return this._emissiveTexture},set:function(e){this._emissiveTexture=e,e?(this.shaderData.enableMacro("O3_EMISSIVE_TEXTURE"),this.shaderData.setTexture("u_emissiveTexture",e)):this.shaderData.disableMacro("O3_EMISSIVE_TEXTURE")}},{key:"diffuseColor",get:function(){return this._diffuseColor},set:function(e){this._diffuseColor=e,this.shaderData.setColor("u_diffuseColor",e)}},{key:"diffuseTexture",get:function(){return this._diffuseTexture},set:function(e){this._diffuseTexture=e,e?(this.shaderData.enableMacro("O3_DIFFUSE_TEXTURE"),this.shaderData.setTexture("u_diffuseTexture",e)):this.shaderData.disableMacro("O3_DIFFUSE_TEXTURE")}},{key:"specularColor",get:function(){return this._specularColor},set:function(e){this._specularColor=e,this.shaderData.setColor("u_specularColor",e)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e,e?(this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"),this.shaderData.setTexture("u_specularTexture",e)):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"shininess",get:function(){return this._shininess},set:function(e){this._shininess=e,this.shaderData.setFloat("u_shininess",e)}},{key:"alphaMode",get:function(){return this._alphaMode},set:function(t){var r=this.renderState.blendState.targetBlendState,n=this.renderState.depthState;switch(t){case e.AlphaMode.Opaque:case e.AlphaMode.CutOff:r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.Zero,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!0,this.renderQueueType=e.RenderQueueType.Opaque;break;case e.AlphaMode.Blend:r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!1,this.renderQueueType=e.RenderQueueType.Transparent}}},{key:"doubleSided",get:function(){return this._doubleSided},set:function(t){this.renderState.rasterState.cullMode=t?e.CullMode.Off:e.CullMode.Back}}]),r}(Ur),kr=function(t){function r(r){var n;return(n=t.call(this,r,yt.find("pbr"))||this)._baseColor=new y(1,1,1,1),n._normalScale=1,n._emissiveColor=new y(0,0,0,1),n._occlusionStrength=1,n._alphaCutoff=.5,n._envMapIntensity=1,n._refractionRatio=1/1.33,n._refractionDepth=1,n._perturbationUOffset=0,n._perturbationVOffset=0,n._PTMMatrix=new h(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),n._baseColorTexture=void 0,n._opacityTexture=void 0,n._normalTexture=void 0,n._emissiveTexture=void 0,n._occlusionTexture=void 0,n._reflectionTexture=void 0,n._refractionTexture=void 0,n._perturbationTexture=void 0,n._srgb=!1,n._srgbFast=!1,n._gamma=!1,n._getOpacityFromRGB=!1,n._envMapModeRefract=!1,n._alphaMode=e.AlphaMode.Opaque,n._doubleSided=!1,n.shaderData.enableMacro("O3_NEED_WORLDPOS"),n.baseColor=n._baseColor,n.normalScale=n._normalScale,n.emissiveColor=n._emissiveColor,n.occlusionStrength=n._occlusionStrength,n.alphaCutoff=n._alphaCutoff,n.envMapIntensity=n._envMapIntensity,n.refractionRatio=n._refractionRatio,n.refractionDepth=n._refractionDepth,n.perturbationUOffset=n._perturbationUOffset,n.perturbationVOffset=n._perturbationVOffset,n.srgb=n._srgb,n.srgbFast=n._srgbFast,n.gamma=n._gamma,n.getOpacityFromRGB=n._getOpacityFromRGB,n.envMapModeRefract=n._envMapModeRefract,n.alphaMode=n._alphaMode,n}return C(r,t),T(r,[{key:"baseColor",get:function(){return this._baseColor},set:function(e){this._baseColor=e,this.shaderData.setColor("u_baseColorFactor",e)}},{key:"baseColorTexture",get:function(){return this._baseColorTexture},set:function(e){this._baseColorTexture=e,e?(this.shaderData.enableMacro("HAS_BASECOLORMAP"),this.shaderData.setTexture("u_baseColorSampler",e)):this.shaderData.disableMacro("HAS_BASECOLORMAP")}},{key:"opacity",get:function(){return this.baseColor.a},set:function(e){this.baseColor.a=e}},{key:"opacityTexture",get:function(){return this._opacityTexture},set:function(e){this._opacityTexture=e,e?(this.shaderData.enableMacro("HAS_OPACITYMAP"),this.shaderData.setTexture("u_opacitySampler",e)):this.shaderData.disableMacro("HAS_OPACITYMAP")}},{key:"normalTexture",get:function(){return this._normalTexture},set:function(e){this._normalTexture=e,e?(this.shaderData.enableMacro("O3_HAS_NORMALMAP"),this.shaderData.setTexture("u_normalSampler",e)):this.shaderData.disableMacro("O3_HAS_NORMALMAP")}},{key:"normalScale",get:function(){return this._normalScale},set:function(e){this._normalScale=e,this.shaderData.setFloat("u_normalScale",e)}},{key:"emissiveTexture",get:function(){return this._emissiveTexture},set:function(e){this._emissiveTexture=e,e?(this.shaderData.enableMacro("HAS_EMISSIVEMAP"),this.shaderData.setTexture("u_emissiveSampler",e)):this.shaderData.disableMacro("HAS_EMISSIVEMAP")}},{key:"emissiveColor",get:function(){return this._emissiveColor},set:function(e){this._emissiveColor=e,this.shaderData.setColor("u_emissiveFactor",e)}},{key:"occlusionTexture",get:function(){return this._occlusionTexture},set:function(e){this._occlusionTexture=e,e?(this.shaderData.enableMacro("HAS_OCCLUSIONMAP"),this.shaderData.setTexture("u_occlusionSampler",e)):this.shaderData.disableMacro("HAS_OCCLUSIONMAP")}},{key:"occlusionStrength",get:function(){return this._occlusionStrength},set:function(e){this._occlusionStrength=e,this.shaderData.setFloat("u_occlusionStrength",e)}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff=e,this.shaderData.setFloat("u_alphaCutoff",e)}},{key:"reflectionTexture",get:function(){return this._reflectionTexture},set:function(e){this._reflectionTexture=e,e?(this.shaderData.enableMacro("HAS_REFLECTIONMAP"),this.shaderData.setTexture("u_reflectionSampler",e)):this.shaderData.disableMacro("HAS_REFLECTIONMAP")}},{key:"envMapIntensity",get:function(){return this._envMapIntensity},set:function(e){this._envMapIntensity=e,this.shaderData.setFloat("u_envMapIntensity",e)}},{key:"refractionRatio",get:function(){return this._refractionRatio},set:function(e){this._refractionRatio=e,this.shaderData.setFloat("u_refractionRatio",e)}},{key:"refractionDepth",get:function(){return this._refractionDepth},set:function(e){this._refractionDepth=e,this.shaderData.setFloat("u_refractionDepth",e)}},{key:"refractionTexture",get:function(){return this._refractionTexture},set:function(e){this._refractionTexture=e,e?(this.shaderData.enableMacro("HAS_REFRACTIONMAP"),this.shaderData.setTexture("u_refractionSampler",e),this.shaderData.setMatrix("u_PTMMatrix",this._PTMMatrix)):this.shaderData.disableMacro("HAS_REFRACTIONMAP")}},{key:"perturbationTexture",get:function(){return this._perturbationTexture},set:function(e){this._perturbationTexture=e,e?(this.shaderData.enableMacro("HAS_PERTURBATIONMAP"),this.shaderData.setTexture("u_perturbationSampler",e)):this.shaderData.disableMacro("HAS_PERTURBATIONMAP")}},{key:"perturbationUOffset",get:function(){return this._perturbationUOffset},set:function(e){this._perturbationUOffset=e,this.shaderData.setFloat("u_perturbationUOffset",e)}},{key:"perturbationVOffset",get:function(){return this._perturbationVOffset},set:function(e){this._perturbationVOffset=e,this.shaderData.setFloat("u_perturbationVOffset",e)}},{key:"srgb",get:function(){return this._srgb},set:function(e){this._srgb=e,e?this.shaderData.enableMacro("MANUAL_SRGB"):this.shaderData.disableMacro("MANUAL_SRGB")}},{key:"srgbFast",get:function(){return this._srgbFast},set:function(e){this._srgbFast=e,e?this.shaderData.enableMacro("SRGB_FAST_APPROXIMATION"):this.shaderData.disableMacro("SRGB_FAST_APPROXIMATION")}},{key:"gamma",get:function(){return this._gamma},set:function(e){this._gamma=e,e?this.shaderData.enableMacro("GAMMA"):this.shaderData.disableMacro("GAMMA")}},{key:"getOpacityFromRGB",get:function(){return this._getOpacityFromRGB},set:function(e){this._getOpacityFromRGB=e,e?this.shaderData.enableMacro("GETOPACITYFROMRGB"):this.shaderData.disableMacro("GETOPACITYFROMRGB")}},{key:"envMapModeRefract",get:function(){return this._envMapModeRefract},set:function(e){this._envMapModeRefract=e,e?this.shaderData.enableMacro("ENVMAPMODE_REFRACT"):this.shaderData.disableMacro("ENVMAPMODE_REFRACT")}},{key:"alphaMode",get:function(){return this._alphaMode},set:function(t){var r=this.renderState.blendState.targetBlendState,n=this.renderState.depthState;switch(this.shaderData.disableMacro("ALPHA_CUTOFF"),this.shaderData.disableMacro("ALPHA_BLEND"),t){case e.AlphaMode.Opaque:r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.Zero,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!0,this.renderQueueType=e.RenderQueueType.Opaque;break;case e.AlphaMode.Blend:this.shaderData.enableMacro("ALPHA_BLEND"),r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!1,this.renderQueueType=e.RenderQueueType.Transparent;break;case e.AlphaMode.CutOff:this.shaderData.enableMacro("ALPHA_CUTOFF"),r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.Zero,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!0,this.renderQueueType=e.RenderQueueType.AlphaTest}}},{key:"doubleSided",get:function(){return this._doubleSided},set:function(t){this.renderState.rasterState.cullMode=t?e.CullMode.Off:e.CullMode.Back}}]),r}(Ur),Hr=function(e){function t(t){var r;return(r=e.call(this,t)||this)._metallicFactor=1,r._roughnessFactor=1,r._metallicTexture=void 0,r._roughnessTexture=void 0,r._metallicRoughnessTexture=void 0,r.shaderData.enableMacro("IS_METALLIC_WORKFLOW"),r.metallicFactor=r._metallicFactor,r.roughnessFactor=r._roughnessFactor,r}return C(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"metallicFactor",get:function(){return this._metallicFactor},set:function(e){this._metallicFactor=e,this.shaderData.setFloat("u_metal",e)}},{key:"roughnessFactor",get:function(){return this._roughnessFactor},set:function(e){this._roughnessFactor=e,this.shaderData.setFloat("u_roughness",e)}},{key:"metallicTexture",get:function(){return this._metallicTexture},set:function(e){this._metallicTexture=e,e?(this.shaderData.enableMacro("HAS_METALMAP"),this.shaderData.setTexture("u_metallicSampler",e)):this.shaderData.disableMacro("HAS_METALMAP")}},{key:"roughnessTexture",get:function(){return this._roughnessTexture},set:function(e){this._roughnessTexture=e,e?(this.shaderData.enableMacro("HAS_ROUGHNESSMAP"),this.shaderData.setTexture("u_roughnessSampler",e)):this.shaderData.disableMacro("HAS_ROUGHNESSMAP")}},{key:"metallicRoughnessTexture",get:function(){return this._metallicRoughnessTexture},set:function(e){this._metallicRoughnessTexture=e,e?(this.shaderData.enableMacro("HAS_METALROUGHNESSMAP"),this.shaderData.setTexture("u_metallicRoughnessSampler",e)):this.shaderData.disableMacro("HAS_METALROUGHNESSMAP")}}]),t}(kr),Wr=function(e){function t(t){var r;return(r=e.call(this,t)||this)._specularColor=new y(1,1,1,1),r._glossinessFactor=1,r._specularGlossinessTexture=void 0,r.specularColor=r._specularColor,r.glossinessFactor=r._glossinessFactor,r}return C(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"specularColor",get:function(){return this._specularColor},set:function(e){this._specularColor=e,this.shaderData.setColor("u_specularFactor",e)}},{key:"glossinessFactor",get:function(){return this._glossinessFactor},set:function(e){this._glossinessFactor=e,this.shaderData.setFloat("u_glossinessFactor",e)}},{key:"specularGlossinessTexture",get:function(){return this._specularGlossinessTexture},set:function(e){this._specularGlossinessTexture=e,e?(this.shaderData.enableMacro("HAS_SPECULARGLOSSINESSMAP"),this.shaderData.setTexture("u_specularGlossinessSampler",e)):this.shaderData.disableMacro("HAS_SPECULARGLOSSINESSMAP")}}]),t}(kr),jr=function(t){function r(r){var n;return(n=t.call(this,r,yt.find("unlit"))||this)._baseColor=new y(1,1,1,1),n._baseColorTexture=void 0,n._alphaMode=e.AlphaMode.Opaque,n._doubleSided=!1,n.shaderData.enableMacro("OMIT_NORMAL"),n.baseColor=n._baseColor,n}return C(r,t),r.prototype.clone=function(){var e=new r(this._engine);return this.cloneTo(e),e},T(r,[{key:"baseColor",get:function(){return this._baseColor},set:function(e){this._baseColor=e,this.shaderData.setColor("u_baseColor",e)}},{key:"baseColorTexture",get:function(){return this._baseColorTexture},set:function(e){this._baseColorTexture=e,e?(this.shaderData.enableMacro("O3_BASECOLOR_TEXTURE"),this.shaderData.setTexture("u_baseColorTexture",e)):this.shaderData.disableMacro("O3_BASECOLOR_TEXTURE")}},{key:"alphaMode",get:function(){return this._alphaMode},set:function(t){var r=this.renderState.blendState.targetBlendState,n=this.renderState.depthState;switch(t){case e.AlphaMode.Opaque:case e.AlphaMode.CutOff:r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.Zero,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!0,this.renderQueueType=e.RenderQueueType.Opaque;break;case e.AlphaMode.Blend:r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add,n.writeEnabled=!1,this.renderQueueType=e.RenderQueueType.Transparent}}},{key:"doubleSided",get:function(){return this._doubleSided},set:function(t){this.renderState.rasterState.cullMode=t?e.CullMode.Off:e.CullMode.Back}}]),r}(Ur),Xr=0,Kr=function(){function t(t,r,n,i,a,o){void 0===t&&(t="RENDER_PASS"+Xr++),void 0===r&&(r=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===o&&(o=new v(0,0,0,0)),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearMode=void 0,this._clearParam=void 0,this.name=t,this.enabled=!0,this.priority=r,this.renderTarget=n,this.replaceMaterial=i,this.mask=a||e.Layer.Everything,this.renderOverride=!1,this.clearMode=e.ClearMode.SOLID_COLOR,this._clearParam=o}var r=t.prototype;return r.render=function(e,t){},r.preRender=function(e,t){},r.postRender=function(e,t){},T(t,[{key:"clearParam",get:function(){return this._clearParam},set:function(e){this._clearParam=e}}]),t}(),qr=function(t){function r(r,n){var i;return void 0===r&&(r="SeparateSprite"),void 0===n&&(n=10),(i=t.call(this,r,n)||this)._spriteItems=void 0,i.clearMode=e.ClearMode.DONT_CLEAR,i.renderOverride=!0,i._spriteItems=[],i}C(r,t);var n=r.prototype;return n.preRender=function(){this.enabled=this.isUsed},n.render=function(e){var t=e.renderHardware;this._sortByDistance(e.eyePos);for(var r=this._spriteItems,n=e._renderPipeline._defaultSpriteMaterial,i=0;i<r.length;i++){var a=r[i];t.drawSprite(n,a.positionQuad,a.uvRect,a.tintColor,a.texture,a.renderMode,a.camera)}r.length=0},n.postRender=function(e){this.enabled&&e.renderHardware.flushSprite(e.engine,e._hardwareRenderer._defaultSpriteMaterial)},n._sortByDistance=function(e){this._spriteItems.length>1&&(this._spriteItems=this._spriteItems.sort((function(t,r){if(t.component.renderPriority===r.component.renderPriority){var n=t.component.node.worldPosition,a=r.component.node.worldPosition;return i.distanceSquared(a,e)-i.distanceSquared(n,e)}return t.component.renderPriority-r.component.renderPriority})))},n.pushSprite=function(e,t,r,n,i,a,o){this._spriteItems.push({component:e,positionQuad:t,uvRect:r,tintColor:n,texture:i,renderMode:a,camera:o})},T(r,[{key:"isUsed",get:function(){return this._spriteItems.length>0}}]),r}(Kr),Yr=function(){function t(t){this._defaultSpriteMaterial=void 0,this._camera=void 0,this._queue=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._canvasDepthPass=void 0,this._separateSpritePass=void 0,this._camera=t,this._queue=new lt,this._renderPassArray=[],this._defaultPass=new Kr("default",0,null,null,0),this.addRenderPass(this._defaultPass);var r=this._defaultSpriteMaterial=new Ur(t.engine,yt.find("Sprite")),n=r.renderState.blendState.targetBlendState;n.sourceColorBlendFactor=n.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,n.destinationColorBlendFactor=n.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,n.colorBlendOperation=n.alphaBlendOperation=e.BlendOperation.Add,r.renderState.depthState.writeEnabled=!1,r.renderQueueType=e.RenderQueueType.Transparent,r.renderState.rasterState.cullMode=e.CullMode.Off}var r=t.prototype;return r.addRenderPass=function(e,t,r,n,i,a){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===a&&(a=new v(0,0,0,0)),"string"==typeof e){var o=new Kr(e,t,r,n,i,a);this._renderPassArray.push(o)}else e instanceof Kr&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))},r.removeRenderPass=function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof Kr&&(t=e),t){var r=this._renderPassArray.indexOf(t);this._renderPassArray.splice(r,1)}},r.getRenderPass=function(e){for(var t=0,r=this._renderPassArray.length;t<r;t++){var n=this._renderPassArray[t];if(n.name===e)return n}return null},r.destroy=function(){},r.render=function(t,r){var n=this._camera,i=this._queue;i.clear(),n.engine._componentsManager.callRender(t),i.sort(n.entity.transform.worldPosition),this._canvasDepthPass&&(this._canvasDepthPass.enabled=!1),this._separateSpritePass&&this._separateSpritePass.isUsed&&this._defaultPass.renderTarget&&(this._canvasDepthPass||(this._canvasDepthPass=new Kr("CanvasDepthRenderPass",0,null,null,0),this._canvasDepthPass.clearMode=e.ClearMode.DONT_CLEAR,this.addRenderPass(this._canvasDepthPass)),this._canvasDepthPass.enabled=!0);for(var a=0,o=this._renderPassArray.length;a<o;a++)this._drawRenderPass(this._renderPassArray[a],n,r)},r._drawRenderPass=function(e,t,r){if(e.preRender(t,this.queue),e.enabled){var n=t.scene.engine._hardwareRenderer,i=t.renderTarget||e.renderTarget;n.activeRenderTarget(i,t),n.setRenderTargetFace(i,r),n.clearRenderTarget(t.engine,e.clearMode,e.clearParam),e.renderOverride?e.render(t,this.queue):this.queue.render(t,e.replaceMaterial,e.mask),n.blitRenderTarget(i)}e.postRender(t,this.queue)},r.pushPrimitive=function(e){this._queue.pushPrimitive(e)},r.pushSprite=function(e,t,r,n,i,a,o){if(e.separateDraw)return this._separateSpritePass||(this._separateSpritePass=new qr,this.addRenderPass(this._separateSpritePass)),void this._separateSpritePass.pushSprite(e,t,r,n,i,a,o);this.queue.pushSprite(e,t,r,n,i,a,o)},T(t,[{key:"defaultRenderPass",get:function(){return this._defaultPass}},{key:"queue",get:function(){return this._queue}}]),t}(),Qr=function(){function e(){this._camera=void 0,this._viewProjectMatrix=new h}return e._getRenderContext=function(t){var r=e._renderContext;return r._camera=t,h.multiply(t.projectionMatrix,t.viewMatrix,r._viewProjectMatrix),r},e}();Qr._renderContext=new Qr;var Jr,Zr=function(){};Zr.tempMat4=new h,Zr.tempVec4=new v,Zr.tempVec3=new i,function(e){e[e.DepthSky=0]="DepthSky",e[e.DepthColor=1]="DepthColor",e[e.Depth=2]="Depth",e[e.None=3]="None"}(Jr||(Jr={}));var $r=Fe(Ze)((Gr=Nr=function(t){function r(r){var n;(n=t.call(this,r)||this).priority=0,n.enableFrustumCulling=!0,n.cullingMask=e.Layer.Everything,n.shaderData=new Bt(ht.Camera),n._globalShaderMacro=new Re,I(n,"_frustum",wr,E(n)),I(n,"_renderPipeline",Cr,E(n)),n._isOrthographic=!1,n._isProjMatSetting=!1,n._clearMode=e.ClearMode.SOLID_COLOR,n._nearClipPlane=.1,n._farClipPlane=100,n._fieldOfView=45,n._orthographicSize=10,n._isProjectionDirty=!0,n._isInvProjMatDirty=!0,n._isFrustumProjectDirty=!0,n._customAspectRatio=void 0,n._renderTarget=null,I(n,"_frustumViewChangeFlag",Mr,E(n)),I(n,"_transform",Sr,E(n)),I(n,"_isViewMatrixDirty",Pr,E(n)),I(n,"_isInvViewProjDirty",Rr,E(n)),I(n,"_projectionMatrix",Lr,E(n)),I(n,"_viewMatrix",Er,E(n)),I(n,"_backgroundColor",Or,E(n)),I(n,"_viewport",Fr,E(n)),I(n,"_inverseProjectionMatrix",Ir,E(n)),I(n,"_inverseViewMatrix",Br,E(n)),I(n,"_lastAspectSize",zr,E(n)),I(n,"_invViewProjMat",Dr,E(n));var i=n.entity.transform;return n._transform=i,n._isViewMatrixDirty=i.registerWorldChangeFlag(),n._isInvViewProjDirty=i.registerWorldChangeFlag(),n._frustumViewChangeFlag=i.registerWorldChangeFlag(),n._renderPipeline=new Yr(E(n)),n.shaderData._addRefCount(1),n.setClearMode(),n}C(r,t);var a=r.prototype;return a.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},a.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},a.worldToViewportPoint=function(e,t){h.multiply(this.projectionMatrix,this.viewMatrix,Zr.tempMat4),Zr.tempVec4.setValue(e.x,e.y,e.z,1),v.transform(Zr.tempVec4,Zr.tempMat4,Zr.tempVec4);var r=Zr.tempVec4.w,n=Zr.tempVec4.x/r,i=Zr.tempVec4.y/r,a=Zr.tempVec4.z/r;return t.x=.5*(n+1),t.y=.5*(1-i),t.z=a,t.w=r,t},a.viewportToWorldPoint=function(e,t){var r=this.invViewProjMat;return this._innerViewportToWorldPoint(e,r,t)},a.viewportPointToRay=function(e,t){var r=Zr.tempVec3;r.setValue(e.x,e.y,0);var n=this.viewportToWorldPoint(r,t.origin);r.z=1;var a=this._innerViewportToWorldPoint(r,this._invViewProjMat,r);return i.subtract(a,n,t.direction),t.direction.normalize(),t},a.screenToViewportPoint=function(e,t){var r=this.engine.canvas,n=this.viewport;return t.x=(e.x/r.width-n.x)/n.z,t.y=(e.y/r.height-n.y)/n.w,t},a.viewportToScreenPoint=function(e,t){var r=this.engine.canvas,n=this.viewport;return t.x=(n.x+e.x*n.z)*r.width,t.y=(n.y+e.y*n.w)*r.height,t},a.worldToScreenPoint=function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)},a.screenToWorldPoint=function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)},a.render=function(e){var t=Qr._getRenderContext(this);this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(t._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(t),Re.unionCollection(this.scene.shaderData._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro),this._renderPipeline.render(t,e),this._engine._renderCount++},a._onActive=function(){this.entity.scene.attachRenderCamera(this)},a._onInActive=function(){this.entity.scene.detachRenderCamera(this)},a._onDestroy=function(){var e;null===(e=this._renderPipeline)||void 0===e||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},a._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},a._innerViewportToWorldPoint=function(e,t,r){var n=2*e.z-1,i=Zr.tempVec4;i.setValue(2*e.x-1,1-2*e.y,n,1),v.transform(i,t,i);var a=1/i.w;return r.x=i.x*a,r.y=i.y*a,r.z=i.z*a,r},a._updateShaderData=function(e){var t=this.shaderData;t.setMatrix(r._viewMatrixProperty,this.viewMatrix),t.setMatrix(r._projectionMatrixProperty,this.projectionMatrix),t.setMatrix(r._vpMatrixProperty,e._viewProjectMatrix),t.setMatrix(r._inverseViewMatrixProperty,this.inverseViewMatrix),t.setMatrix(r._inverseProjectionMatrixProperty,this.inverseProjectionMatrix),t.setVector3(r._cameraPositionProperty,this._transform.worldPosition)},a.setClearMode=function(t,r){void 0===t&&(t=e.ClearMode.SOLID_COLOR),void 0===r&&(r=new v(.25,.25,.25,1)),this._clearMode=t,this._backgroundColor=r,this._renderPipeline.defaultRenderPass.clearParam=r,this._renderPipeline.defaultRenderPass.clearMode=t},T(r,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!=(e=this._customAspectRatio)?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"clearFlags",get:function(){throw"not implemented"},set:function(e){throw"not implemented"}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this.setClearMode(this._clearMode,e)}},{key:"backgroundSky",get:function(){throw new Error("not implemented")}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,h.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var r=this._orthographicSize*t,i=this._orthographicSize;h.ortho(-r,r,-i,i,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else h.perspective(n.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implemention"),!1},set:function(e){console.log("not implemention")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}},{key:"invViewProjMat",get:function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,h.multiply(this.inverseViewMatrix,this.inverseProjectionMatrix,this._invViewProjMat)),this._invViewProjMat}},{key:"inverseProjectionMatrix",get:function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,h.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix}},{key:"inverseViewMatrix",get:function(){return this._transform.worldMatrix.cloneTo(this._inverseViewMatrix),this._inverseViewMatrix}}]),r}(Qe),Nr._viewMatrixProperty=yt.getPropertyByName("u_viewMat"),Nr._projectionMatrixProperty=yt.getPropertyByName("u_projMat"),Nr._vpMatrixProperty=yt.getPropertyByName("u_VPMat"),Nr._inverseViewMatrixProperty=yt.getPropertyByName("u_viewInvMat"),Nr._inverseProjectionMatrixProperty=yt.getPropertyByName("u_projInvMat"),Nr._cameraPositionProperty=yt.getPropertyByName("u_cameraPos"),wr=B((Ar=Gr).prototype,"_frustum",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new u}}),Cr=B(Ar.prototype,"_renderPipeline",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mr=B(Ar.prototype,"_frustumViewChangeFlag",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Sr=B(Ar.prototype,"_transform",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pr=B(Ar.prototype,"_isViewMatrixDirty",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rr=B(Ar.prototype,"_isInvViewProjDirty",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Lr=B(Ar.prototype,"_projectionMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),Er=B(Ar.prototype,"_viewMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),Or=B(Ar.prototype,"_backgroundColor",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v}}),Fr=B(Ar.prototype,"_viewport",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v(0,0,1,1)}}),Ir=B(Ar.prototype,"_inverseProjectionMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),Br=B(Ar.prototype,"_inverseViewMatrix",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),zr=B(Ar.prototype,"_lastAspectSize",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new g(0,0)}}),Dr=B(Ar.prototype,"_invViewProjMat",[j],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),br=Ar))||br,en={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function tn(e,t){return void 0===t&&(t={}),new z((function(r,n,i){var a,o,s,c,u=null!=(a=t.retryCount)?a:4,l=null!=(o=t.retryInterval)?o:500;t.timeout=null!=(s=t.timeout)?s:15e3,t.type=null!=(c=t.type)?c:function(e){var t=e.substring(e.lastIndexOf(".")+1);return en[t]}(e);var d,h="image"===t.type?rn:nn,f=new on((function(){return h(e,t).onProgress(i).then((function(e){r(e),f.stop()})).catch((function(e){return d=e}))}),u,l);f.start((function(){n(d)}))}))}function rn(e,t){return new z((function(r,n){var i=t.timeout,a=new Image,o=function(){n(new Error("request "+e+" fail"))};a.onerror=o,a.onabort=o;var s=setTimeout((function(){n(new Error("request "+e+" timeout"))}),i);a.onload=function(e){return function(){requestAnimationFrame((function(){r(a)})),clearTimeout(e)}}(s),a.crossOrigin="anonymous",a.src=e}))}function nn(e,t){return new z((function(r,n,i){var a,o=new XMLHttpRequest;o.timeout=t.timeout,t.method=null!=(a=t.method)?a:"get",o.onload=function(){var t;if(o.status<200||o.status>=300)n(new Error("request failed from: "+e));else{var i=null!=(t=o.response)?t:o.responseText;r(i)}},o.onerror=function(){n(new Error("request failed from: "+e))},o.ontimeout=function(){n(new Error("request timeout from: "+e))},o.onprogress=function(e){i(e.loaded/e.total)},o.open(t.method,e,!0),o.withCredentials="include"===t.credentials,o.responseType=t.type;var s=t.headers;s&&Object.keys(s).forEach((function(e){o.setRequestHeader(e,s[e])})),o.send(t.body)}))}var an,on=function(){function e(e,t,r){this.execFunc=e,this.totalCount=t,this.interval=r,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var t=e.prototype;return t.start=function(e){this.done=e,this.exec()},t.stop=function(){clearTimeout(this._timeoutId)},t.exec=function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))},e}(),sn=function(e){this.useCache=e,this.request=tn};(an=e.AssetType||(e.AssetType={}))[an.Text=0]="Text",an[an.JSON=1]="JSON",an[an.Buffer=2]="Buffer",an[an.Texture2D=3]="Texture2D",an[an.TextureCube=4]="TextureCube",an[an.Material=5]="Material",an[an.Mesh=6]="Mesh",an[an.AnimationClip=7]="AnimationClip",an[an.Perfab=8]="Perfab",an[an.KTX=9]="KTX",an[an.KTXCube=10]="KTXCube";var cn=function(e){function t(){var t;return(t=e.call(this)||this).colliders=void 0,t.colliders=[],t}C(t,e);var r=t.prototype;return r.attachCollider=function(e){this.colliders.push(e)},r.detachCollider=function(e){var t=this.colliders.indexOf(e);-1!=t&&this.colliders.splice(t,1)},t}(ut),un=function(e){function t(t){return e.call(this,t)||this}C(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.findFeature(cn).attachCollider(this)},r._onDisable=function(){this.scene.findFeature(cn).detachCollider(this)},t}(Qe),ln=function(e){function t(t){var r;return(r=e.call(this,t)||this).boxMin=void 0,r.boxMax=void 0,r._corners=[],r._cornerFlag=!1,r.boxMin=new i(-.5,-.5,-.5),r.boxMax=new i(.5,.5,.5),r}C(t,e);var r=t.prototype;return r.setBoxMinMax=function(e,t){this.boxMin=e,this.boxMax=t,this._cornerFlag=!0},r.setBoxCenterSize=function(e,r){var n=t._tempVec3;i.scale(r,.5,n),i.add(e,n,this.boxMax),i.subtract(e,n,this.boxMin),this._cornerFlag=!0},r.getCorners=function(){if(this._cornerFlag){var e=this.boxMin.x,t=this.boxMin.y,r=this.boxMin.z,n=this.boxMax.x-e,a=this.boxMax.y-t,o=this.boxMax.z-r;if(0===this._corners.length)for(var s=0;s<8;++s)this._corners.push(new i);this._corners[0].setValue(e+n,t+a,r+o),this._corners[1].setValue(e,t+a,r+o),this._corners[2].setValue(e,t,r+o),this._corners[3].setValue(e+n,t,r+o),this._corners[4].setValue(e+n,t+a,r),this._corners[5].setValue(e,t+a,r),this._corners[6].setValue(e,t,r),this._corners[7].setValue(e+n,t,r),this._cornerFlag=!1}return this._corners},t}(un);ln._tempVec3=new i;var dn=function(e){function t(t){var r;return(r=e.call(this,t)||this).center=void 0,r.radius=void 0,r.center=new i,r.radius=1,r}return C(t,e),t.prototype.setSphere=function(e,t){this.center=e,this.radius=t},t}(un),hn=function(e){function t(t){var r;return(r=e.call(this,t)||this).planePoint=void 0,r.normal=void 0,r.planePoint=new i,r.normal=new i(0,1,0),r}return C(t,e),t.prototype.setPlane=function(e,t){this.planePoint=e,this.normal=t},t}(un),fn=function(){this.distance=void 0,this.collider=void 0,this.point=void 0,this.distance=Number.MAX_VALUE,this.collider=null,this.point=null},_n=new i,pn=new c,gn=new o,vn=new a;function mn(e,t,r,n,a){var o=_n;t.getPoint(r,o),i.transformCoordinate(o,e.entity.transform.worldMatrix,o),n.distance=i.distance(a,o),n.collider=e,n.point=o}function yn(e,t){var r=e.entity.getInvModelMatrix(),n=new i;i.transformCoordinate(t.origin,r,n);var a,o,s,c,u,l,d,h=new i;return a=h,o=t.direction,s=r,c=o.x,u=o.y,l=o.z,d=s.elements,a.x=c*d[0]+u*d[4]+l*d[8],a.y=c*d[1]+u*d[5]+l*d[9],a.z=c*d[2]+u*d[6]+l*d[10],new f(n,h)}zt.prototype.raycast=function(t,r,n){void 0===n&&(n=e.Layer.Everything);for(var i=this.findFeature(cn).colliders,a=new fn,o=0,s=i.length;o<s;o++){var c=i[o];if(c.entity.isActiveInHierarchy&&c.entity.layer&n){var u=new fn;c.raycast(t,u)&&u.distance<a.distance&&(a=u)}}return r&&a.collider&&a.point.cloneTo(r),a.collider},ln.prototype.raycast=function(e,t){var r=yn(this,e);this.boxMin.cloneTo(gn.min),this.boxMax.cloneTo(gn.max);var n=r.intersectBox(gn);return-1!==n&&(mn(this,r,n,t,e.origin),!0)},dn.prototype.raycast=function(e,t){var r=yn(this,e);this.center.cloneTo(vn.center),vn.radius=this.radio;var n=r.intersectSphere(vn);return-1!==n&&(mn(this,r,n,t,e.origin),!0)},hn.prototype.raycast=function(e,t){var r=yn(this,e);this.normal.cloneTo(pn.normal),pn.distance=-i.dot(this.planePoint,pn.normal);var n=r.intersectPlane(pn);return-1!==n&&(mn(this,r,n,t,e.origin),!0)};var xn,Tn,bn,An=function(e){function t(t,r){var n;return(n=e.call(this,t)||this).name=void 0,n.primitives=[],n.groups=[],n.weights=void 0,n.bounds=new o(new i,new i),n.name=r,n}C(t,e);var r=t.prototype;return r.updatePrimitiveWeightsIndices=function(e){},r.destroy=function(){this.primitives=null},t}(fe),wn=function(e){function t(t){var r;return(r=e.call(this,null)||this).inverseBindMatrices=void 0,r.joints=void 0,r.skeleton=void 0,r.inverseBindMatrices=[],r.joints=[],r.skeleton="none",r}return C(t,e),t}(fe);function Cn(e,t){for(var r=e.primitives,n=0,i=r.length;n<i;n++)r[n]._addRefCount(t)}var Mn,Sn,Pn,Rn,Ln,En,On,Fn,In,Bn,zn,Dn,Nn=(Tn=B((xn=function(e){function t(t){var r;return(r=e.call(this,t)||this)._mesh=void 0,I(r,"_instanceMaterials",Tn,E(r)),I(r,"_sharedMaterials",bn,E(r)),r._mesh=null,r}C(t,e);var r=t.prototype;return r.setSharedMaterial=function(e,t){this._sharedMaterials[e]&&this._sharedMaterials[e]._addRefCount(-1),t._addRefCount(1),this._sharedMaterials[e]=t},r.setMaterial=function(e,t){this._instanceMaterials[e]&&this._instanceMaterials[e]._addRefCount(-1),t._addRefCount(1),this._instanceMaterials[e]=t},r.getInstanceMaterial=function(e){return this._instanceMaterials[e]},r.getSharedMaterial=function(e){return this._sharedMaterials[e]},r.render=function(e){var t=this._mesh;if(t)for(var r=e._renderPipeline,n=t.primitives,i=t.groups,a=0,o=n.length;a<o;a++){var s=n[a],c=this._instanceMaterials[a]||this._sharedMaterials[a];if(c){var u=tt.getFromPool();u.setValue(this,s,i[a],c),r.pushPrimitive(u)}else xe.error("Primitive has no material: "+s.name)}},r.destroy=function(){e.prototype.destroy.call(this),this._mesh=null,this._instanceMaterials=[],this._sharedMaterials=[];for(var t=0;t<this._instanceMaterials.length;t++)this._instanceMaterials[t]._addRefCount(-1);for(var r=0;r<this._sharedMaterials.length;r++)this._sharedMaterials[r]._addRefCount(-1);this._mesh&&Cn(this._mesh,-1)},r._updateBounds=function(e){var t=this.mesh.bounds,r=this._entity.transform.worldMatrix;o.transform(t,r,e)},T(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh&&Cn(this._mesh,-1),Cn(e,1),this._mesh=e,this._sharedMaterials=[],this._instanceMaterials=[]}}]),t}(Tr)).prototype,"_instanceMaterials",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bn=B(xn.prototype,"_sharedMaterials",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xn),Gn=function(t){function r(r,n,i,a,o){var s;void 0===a&&(a=e.TextureFormat.R8G8B8A8),void 0===o&&(o=!0),(s=t.call(this,r)||this)._format=void 0,s._compressedMipFilled=0;var c=r._hardwareRenderer,u=c.gl,l=c.isWebGL2;if(!It._supportTextureFormat(a,c))throw new Error("Texture format is not supported:"+e.TextureFormat[a]);!o||l||It._isPowerOf2(n)&&It._isPowerOf2(i)||(xe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),o=!1);var d=It._getFormatDetail(a,u,l);return s._glTexture=u.createTexture(),s._formatDetail=d,s._rhi=c,s._target=u.TEXTURE_2D,s._mipmap=o,s._width=n,s._height=i,s._format=a,s._mipmapCount=s._getMipmapCount(),d.isCompressed&&!l||s._initMipmap(!1),s.filterMode=e.TextureFilterMode.Bilinear,s.wrapModeU=s.wrapModeV=e.TextureWrapMode.Repeat,s}C(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a){void 0===t&&(t=0);var o=this._rhi.gl,s=this._rhi.isWebGL2,c=this._formatDetail,u=c.internalFormat,l=c.baseFormat,d=c.dataType,h=c.isCompressed,f=Math.max(1,this._width>>t),_=Math.max(1,this._height>>t);if(r=r||0,n=n||0,i=i||f-r,a=a||_-n,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),h){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,r,n,i,a,u,e):(o.compressedTexImage2D(this._target,t,u,i,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,r,n,i,a,l,d,e);this._unbind()},n.setImageSource=function(e,t,r,n,i,a){void 0===t&&(t=0),void 0===r&&(r=!1),void 0===n&&(n=!1);var o=this._rhi.gl,s=this._formatDetail,c=s.baseFormat,u=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+r),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+n),o.texSubImage2D(this._target,t,i||0,a||0,c,u,e),this._unbind()},n.getPixelBuffer=function(e,r,n,i,a){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");t.prototype._getPixelBuffer.call(this,null,e,r,n,i,a)},T(r,[{key:"format",get:function(){return this._format}}]),r}(It),Un=(zn=Bn=function(t){function r(e){var r;return I(r=t.call(this,e)||this,"matrixPalette",Sn,E(r)),I(r,"jointNodes",Pn,E(r)),I(r,"jointTexture",Rn,E(r)),I(r,"_hasInitJoints",Ln,E(r)),I(r,"_mat",En,E(r)),I(r,"_weights",On,E(r)),I(r,"weightsIndices",Fn,E(r)),I(r,"_useJointTexture",In,E(r)),r._skin=void 0,r._mat=new h,r._weights=null,r._skin=null,r}C(r,t);var n=r.prototype;return n._updateShaderData=function(e){t.prototype._updateShaderData.call(this,e),!this._useJointTexture&&this.matrixPalette&&this.shaderData.setFloatArray(r._jointMatrixProperty,this.matrixPalette)},n.setWeights=function(e){if(this._weights=e,e){for(var t=e.length,r=0;r<t;r++)this.weightsIndices[r]=r;for(var n=this.weightsIndices,i=0;i<t-1;i++)for(var a=i+1;a<t;a++)if(e[a]>e[i]){var o=e[i];e[i]=e[a],e[a]=o,o=n[i],n[i]=n[a],n[a]=o}this.mesh.updatePrimitiveWeightsIndices(n)}},n._initJoints=function(){var e;if(this._skin){for(var t=this._skin.joints,n=[],i=t.length-1;i>=0;i--)n[i]=this.findByNodeName(this.entity,t[i]);this.matrixPalette=new Float32Array(16*n.length),this.jointNodes=n;var a=this.entity.engine._hardwareRenderer;if(a){var o=a.renderStates.getParameter(a.gl.MAX_VERTEX_UNIFORM_VECTORS),s=Math.floor((o-20)/4),c=this.shaderData,u=null===(e=this.jointNodes)||void 0===e?void 0:e.length;if(u)if(c.enableMacro("O3_HAS_SKIN"),c.setInt(r._jointCountProperty,u),t.length>s)a.canIUseMoreJoints?(this._useJointTexture=!0,c.enableMacro("O3_USE_JOINT_TEXTURE"),c.setTexture(r._jointSamplerProperty,this.jointTexture)):xe.error("component's joints count("+t+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+o+", and don't support jointTexture in this device. suggest joint count less than "+s+".",this);else{var l=Math.max(r._maxJoints,t.length);r._maxJoints=l,c.disableMacro("O3_USE_JOINT_TEXTURE"),c.enableMacro("O3_JOINTS_NUM",l.toString())}else c.disableMacro("O3_HAS_SKIN")}}},n.findByNodeName=function(e,t){if(!e)return null;var r=e.findByName(t);return r||this.findByNodeName(e.parent,t)},n._findParent=function(e,t){if(e){var r=e.parent;if(!r)return null;if(r.name===t)return r;var n=r.findByName(t);return n||this._findParent(r,t)}return null},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,r=this.matrixPalette,n=this.entity.getInvModelMatrix(),i=this._mat,a=e.length-1;a>=0;a--)i.identity(),e[a]?h.multiply(e[a].transform.worldMatrix,t[a],i):t[a].cloneTo(i),h.multiply(n,i,i),r.set(i.elements,16*a);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var t=this.engine;if(!t._hardwareRenderer)return;this.jointTexture=new Gn(t,4,this.jointNodes.length,e.TextureFormat.R32G32B32A32,!1),this.jointTexture.filterMode=e.TextureFilterMode.Point}this.jointTexture.setPixelBuffer(this.matrixPalette)},T(r,[{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}},{key:"weights",get:function(){return this._weights}}]),r}(Nn),Bn._jointCountProperty=yt.getPropertyByName("u_jointCount"),Bn._jointSamplerProperty=yt.getPropertyByName("u_jointSampler"),Bn._jointMatrixProperty=yt.getPropertyByName("u_jointMatrix"),Bn._maxJoints=0,Sn=B((Mn=zn).prototype,"matrixPalette",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pn=B(Mn.prototype,"jointNodes",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rn=B(Mn.prototype,"jointTexture",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ln=B(Mn.prototype,"_hasInitJoints",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),En=B(Mn.prototype,"_mat",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),On=B(Mn.prototype,"_weights",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Fn=B(Mn.prototype,"weightsIndices",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),In=B(Mn.prototype,"_useJointTexture",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mn),Vn=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this)._lods=[],t}C(t,e);var r=t.prototype;return r.addLod=function(e,t){t.enabled=!1,this._lods.push({distance:e,rendererAbility:t}),this._lods.sort((function(e,t){return t.distance-e.distance}))},r.render=function(e){if(!(this._lods.length<=0)){for(var t=i.distance(e.entity.transform.worldPosition,this.entity.transform.worldPosition),r=this._lods,n=0,a=r.length-1;a>=0;a--){if(t<r[a].distance){n=a;break}}r[n].rendererAbility.render(e)}},t}(Tr);(Dn=e.TextureCubeFace||(e.TextureCubeFace={}))[Dn.PositiveX=0]="PositiveX",Dn[Dn.NegativeX=1]="NegativeX",Dn[Dn.PositiveY=2]="PositiveY",Dn[Dn.NegativeY=3]="NegativeY",Dn[Dn.PositiveZ=4]="PositiveZ",Dn[Dn.NegativeZ=5]="NegativeZ";var kn,Hn,Wn,jn=function(t){function r(r,n,i,a){var o;void 0===i&&(i=e.TextureFormat.R8G8B8A8),void 0===a&&(a=!0),(o=t.call(this,r)||this)._format=void 0,o._compressedFaceFilled=[0,0,0,0,0,0];var s=r._hardwareRenderer,c=s.gl,u=s.isWebGL2;if(!It._supportTextureFormat(i,s))throw new Error("Texture format is not supported:"+e.TextureFormat[i]);!a||u||It._isPowerOf2(n)||(xe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),a=!1);var l=It._getFormatDetail(i,c,u);return o._glTexture=c.createTexture(),o._formatDetail=l,o._rhi=s,o._target=c.TEXTURE_CUBE_MAP,o._mipmap=a,o._width=n,o._height=n,o._format=i,o._mipmapCount=o._getMipmapCount(),l.isCompressed&&!u||o._initMipmap(!0),o.filterMode=e.TextureFilterMode.Bilinear,o.wrapModeU=o.wrapModeV=e.TextureWrapMode.Clamp,o}C(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a,o){void 0===r&&(r=0);var s=this._rhi.gl,c=this._rhi.isWebGL2,u=this._formatDetail,l=u.internalFormat,d=u.baseFormat,h=u.dataType,f=u.isCompressed,_=Math.max(1,this._width>>r);if(n=n||0,i=i||0,a=a||_-n,o=o||_-i,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),f){var p=1<<r;c||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,n,i,a,o,l,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,l,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,n,i,a,o,d,h,t);this._unbind()},n.setImageSource=function(e,t,r,n,i,a,o){void 0===r&&(r=0),void 0===n&&(n=!1),void 0===i&&(i=!1);var s=this._rhi.gl,c=this._formatDetail,u=c.baseFormat,l=c.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+n),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,a||0,o||0,u,l,t),this._unbind()},n.getPixelBuffer=function(e,r,n,i,a,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");t.prototype._getPixelBuffer.call(this,e,r,n,i,a,o)},T(r,[{key:"format",get:function(){return this._format}}]),r}(It),Xn=function(t){function r(r,n,i,a,o,s){var c;void 0===a&&(a=e.RenderBufferDepthFormat.Depth),void 0===o&&(o=!1),void 0===s&&(s=!1),(c=t.call(this,r)||this)._isCube=!1,c._format=void 0,c._autoMipmap=!1;var u=r._hardwareRenderer,l=u.gl,d=u.isWebGL2;if(!It._supportRenderBufferDepthFormat(a,u,!0))throw new Error("RenderBufferDepthFormat is not supported:"+e.RenderBufferDepthFormat[a]);if(s&&n!==i)throw new Error("The cube texture must have the same width and height");return!o||d||It._isPowerOf2(n)&&It._isPowerOf2(i)||(xe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),o=!1),c._glTexture=l.createTexture(),c._formatDetail=It._getRenderBufferDepthFormatDetail(a,l,d),c._isCube=s,c._rhi=u,c._target=s?l.TEXTURE_CUBE_MAP:l.TEXTURE_2D,c._mipmap=o,c._width=n,c._height=i,c._format=a,c._mipmapCount=c._getMipmapCount(),c._initMipmap(s),c.filterMode=e.TextureFilterMode.Bilinear,c.wrapModeU=c.wrapModeV=e.TextureWrapMode.Clamp,c}return C(r,t),T(r,[{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),r}(It),Kn=function(t){function r(r,n,i,a,o,s){var c;void 0===o&&(o=e.RenderBufferDepthFormat.Depth),void 0===s&&(s=1),(c=t.call(this,r)||this)._frameBuffer=void 0,c._MSAAFrameBuffer=void 0,c._rhi=void 0,c._width=void 0,c._height=void 0,c._antiAliasing=void 0,c._colorTextures=void 0,c._depthTexture=void 0,c._depthRenderBuffer=void 0,c._MSAAColorRenderBuffers=[],c._MSAADepthRenderBuffer=void 0,c._oriDrawBuffers=void 0,c._blitDrawBuffers=void 0;var u=r._hardwareRenderer,l=u.gl;if(!(o instanceof Xn||It._supportRenderBufferDepthFormat(o,u,!1)))throw new Error("RenderBufferDepthFormat is not supported:"+e.RenderBufferDepthFormat[o]);if((null==a?void 0:a.length)>1&&!u.canIUse(e.GLCapabilityType.drawBuffers))throw new Error("MRT is not supported");if(c._colorTextures=a?a instanceof Array?a.slice():[a]:[],c._colorTextures.some((function(e){return e.width!==n||e.height!==i})))throw new Error("RenderColorTexture's size must as same as RenderTarget");if(o instanceof Xn&&(o.width!==n||o.height!==i))throw new Error("RenderDepthTexture's size must as same as RenderTarget");if(c._colorTextures.length>1&&c._colorTextures.some((function(e){return e._isCube})))throw new Error("MRT+Cube+[,MSAA] is not supported");var d=u.capability.maxAntiAliasing;return s>d&&(xe.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+d),s=d),c._rhi=u,c._width=n,c._height=i,c._frameBuffer=l.createFramebuffer(),c._antiAliasing=s,o instanceof Xn&&(c._depthTexture=o),c._bindMainFBO(o),s>1&&(c._MSAAFrameBuffer=l.createFramebuffer(),c._bindMSAAFBO(o)),c}C(r,t);var n=r.prototype;return n.getColorTexture=function(e){return void 0===e&&(e=0),this._colorTextures[e]},n.destroy=function(){var e=this._rhi.gl;e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._colorTextures.length;t++)this._colorTextures[t].destroy();for(var r=0;r<this._MSAAColorRenderBuffers.length;r++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[r]);this._depthTexture&&this._depthTexture.destroy(),this._frameBuffer=null,this._colorTextures.length=0,this._depthTexture=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},n._activeRenderTarget=function(){var e=this._rhi.gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)},n._setRenderTargetFace=function(t){void 0===t&&(t=e.TextureCubeFace.PositiveX);var r=this._rhi.gl,n=this._colorTextures[0],i=this._depthTexture;r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),null!=n&&n._isCube&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,n._glTexture,0),null!=i&&i._isCube&&r.framebufferTexture2D(r.FRAMEBUFFER,i._formatDetail.attachment,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i._glTexture,0),this._activeRenderTarget()},n._blitRenderTarget=function(){var e=this._rhi.gl,t=e.COLOR_BUFFER_BIT|(this._depthTexture?e.DEPTH_BUFFER_BIT:0),r=this._colorTextures.length;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var n=0;n<r;n++){var i=e.COLOR_ATTACHMENT0+n;this._blitDrawBuffers[n]=i,e.readBuffer(i),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,t,e.NEAREST),this._blitDrawBuffers[n]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)},n._bindMainFBO=function(e){var t=this._rhi.gl,r=this._rhi.isWebGL2,n=this._colorTextures.length,i=new Array(n);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var a=0;a<n;a++){var o=this._colorTextures[a],s=t.COLOR_ATTACHMENT0+a;i[a]=s,o._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,o._glTexture,0)}if(n>1&&t.drawBuffers(i),this._oriDrawBuffers=i,null!==e)if(e instanceof Xn)e._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,e._formatDetail.attachment,t.TEXTURE_2D,e._glTexture,0);else if(this._antiAliasing<=1){var c=It._getRenderBufferDepthFormatDetail(e,t,r),u=c.internalFormat,l=c.attachment,d=t.createRenderbuffer();this._depthRenderBuffer=d,t.bindRenderbuffer(t.RENDERBUFFER,d),t.renderbufferStorage(t.RENDERBUFFER,u,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,l,t.RENDERBUFFER,d)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},n._bindMSAAFBO=function(e){var t=this._rhi.gl,r=this._rhi.isWebGL2,n=t.createRenderbuffer(),i=this._colorTextures.length;this._blitDrawBuffers=new Array(i),this._MSAADepthRenderBuffer=n,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var a=0;a<i;a++){var o=t.createRenderbuffer();this._MSAAColorRenderBuffers[a]=o,this._blitDrawBuffers[a]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,this._colorTextures[a]._formatDetail.internalFormat,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+a,t.RENDERBUFFER,o)}if(t.drawBuffers(this._oriDrawBuffers),null!==e){var s=e instanceof Xn?e._formatDetail:It._getRenderBufferDepthFormatDetail(e,t,r),c=s.internalFormat,u=s.attachment;t.bindRenderbuffer(t.RENDERBUFFER,n),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,c,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,u,t.RENDERBUFFER,n)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},n._checkFrameBuffer=function(){var e=this._rhi.gl,t=this._rhi.isWebGL2,r=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(r){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&r===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},T(r,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),r}(fe),qn=function(t){function r(r,n,i,a,o,s){var c;void 0===a&&(a=e.RenderBufferColorFormat.R8G8B8A8),void 0===o&&(o=!1),void 0===s&&(s=!1),(c=t.call(this,r)||this)._isCube=!1,c._format=void 0,c._autoMipmap=!1;var u=r._hardwareRenderer,l=u.gl,d=u.isWebGL2;if(!It._supportRenderBufferColorFormat(a,u))throw new Error("RenderBufferColorFormat is not supported:"+e.RenderBufferColorFormat[a]);if(s&&n!==i)throw new Error("The cube texture must have the same width and height");return!o||d||It._isPowerOf2(n)&&It._isPowerOf2(i)||(xe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),o=!1),c._glTexture=l.createTexture(),c._formatDetail=It._getRenderBufferColorFormatDetail(a,l,d),c._isCube=s,c._rhi=u,c._target=s?l.TEXTURE_CUBE_MAP:l.TEXTURE_2D,c._mipmap=o,c._width=n,c._height=i,c._format=a,c._mipmapCount=c._getMipmapCount(),c._initMipmap(s),c.filterMode=e.TextureFilterMode.Bilinear,c.wrapModeU=c.wrapModeV=e.TextureWrapMode.Clamp,c}return C(r,t),r.prototype.getPixelBuffer=function(e,r,n,i,a,o){t.prototype._getPixelBuffer.call(this,e,r,n,i,a,o)},T(r,[{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),r}(It);(kn=e.BufferUsage||(e.BufferUsage={}))[kn.Static=0]="Static",kn[kn.Dynamic=1]="Dynamic",kn[kn.Stream=2]="Stream",(Hn=e.VertexElementFormat||(e.VertexElementFormat={}))[Hn.Float=0]="Float",Hn[Hn.Vector2=1]="Vector2",Hn[Hn.Vector3=2]="Vector3",Hn[Hn.Vector4=3]="Vector4",Hn[Hn.Byte4=4]="Byte4",Hn[Hn.UByte4=5]="UByte4",Hn[Hn.NormalizedByte4=6]="NormalizedByte4",Hn[Hn.NormalizedUByte4=7]="NormalizedUByte4",Hn[Hn.Short2=8]="Short2",Hn[Hn.UShort2=9]="UShort2",Hn[Hn.NormalizedShort2=10]="NormalizedShort2",Hn[Hn.NormalizedUShort2=11]="NormalizedUShort2",Hn[Hn.Short4=12]="Short4",Hn[Hn.UShort4=13]="UShort4",Hn[Hn.NormalizedShort4=14]="NormalizedShort4",Hn[Hn.NormalizedUShort4=15]="NormalizedUShort4",(Wn=e.IndexFormat||(e.IndexFormat={}))[Wn.UInt8=0]="UInt8",Wn[Wn.UInt16=1]="UInt16",Wn[Wn.UInt32=2]="UInt32";var Yn,Qn,Jn=function(){function t(){}return t._getGLBufferUsage=function(t,r){switch(r){case e.BufferUsage.Static:return t.STATIC_DRAW;case e.BufferUsage.Dynamic:return t.DYNAMIC_DRAW;case e.BufferUsage.Stream:return t.STREAM_DRAW}},t._getGLIndexType=function(t){switch(t){case e.IndexFormat.UInt8:return e.DataType.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return e.DataType.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return e.DataType.UNSIGNED_INT}},t._getElementInfo=function(t){var r,n;switch(t){case e.VertexElementFormat.Float:r=1,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector2:r=2,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector3:r=3,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector4:r=4,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Byte4:r=4,n=e.DataType.UNSIGNED_BYTE;break;case e.VertexElementFormat.Short2:r=2,n=e.DataType.SHORT;break;case e.VertexElementFormat.Short4:r=4,n=e.DataType.SHORT;break;case e.VertexElementFormat.UShort2:r=2,n=e.DataType.UNSIGNED_SHORT;break;case e.VertexElementFormat.UShort4:r=4,n=e.DataType.UNSIGNED_SHORT}return{size:r,type:n}},t}();(Yn=e.BufferBindFlag||(e.BufferBindFlag={}))[Yn.VertexBuffer=0]="VertexBuffer",Yn[Yn.IndexBuffer=1]="IndexBuffer",(Qn=e.SetDataOptions||(e.SetDataOptions={}))[Qn.None=0]="None",Qn[Qn.Discard=1]="Discard";var Zn,$n=function(t){function r(r,n,i,a){var o;void 0===a&&(a=e.BufferUsage.Static),(o=t.call(this,r)||this)._glBindTarget=void 0,o._glBufferUsage=void 0,o._nativeBuffer=void 0,o._hardwareRenderer=void 0,o._type=void 0,o._byteLength=void 0,o._bufferUsage=void 0,o._engine=r,o._type=n,o._bufferUsage=a;var s=r._hardwareRenderer,c=s.gl,u=Jn._getGLBufferUsage(c,a),l=n===e.BufferBindFlag.VertexBuffer?c.ARRAY_BUFFER:c.ELEMENT_ARRAY_BUFFER;return o._nativeBuffer=c.createBuffer(),o._hardwareRenderer=s,o._glBufferUsage=u,o._glBindTarget=l,o.bind(),"number"==typeof i?(o._byteLength=i,c.bufferData(l,i,u)):(o._byteLength=i.byteLength,c.bufferData(l,i,u)),c.bindBuffer(l,null),o}C(r,t);var n=r.prototype;return n.bind=function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(t,r,n,i,a){void 0===r&&(r=0),void 0===n&&(n=0),void 0===a&&(a=e.SetDataOptions.None);var o=this._hardwareRenderer.gl,s=this._hardwareRenderer.isWebGL2,c=this._glBindTarget;this.bind(),a===e.SetDataOptions.Discard&&o.bufferData(c,this._byteLength,this._glBufferUsage);var u=t.BYTES_PER_ELEMENT||1,l=i?u*i:t.byteLength;if(0!==n||l<t.byteLength){var d=void 0!==t.byteOffset;if(s&&d)o.bufferSubData(c,r,t,n,l/u);else{var h=new Uint8Array(d?t.buffer:t,n*u,l);o.bufferSubData(c,r,h)}}else o.bufferSubData(c,r,t);o.bindBuffer(c,null)},n.getData=function(e,t,r,n){if(void 0===t&&(t=0),void 0===r&&(r=0),!this._hardwareRenderer.isWebGL2)throw"Buffer is write-only on WebGL1.0 platforms.";var i=this._hardwareRenderer.gl;this.bind(),i.getBufferSubData(this._glBindTarget,t,e,r,n)},n._onDestroy=function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},T(r,[{key:"engine",get:function(){return this._engine}},{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),r}(Ft);(Zn=e.PrimitiveTopology||(e.PrimitiveTopology={}))[Zn.Points=0]="Points",Zn[Zn.Lines=1]="Lines",Zn[Zn.LineLoop=2]="LineLoop",Zn[Zn.LineStrip=3]="LineStrip",Zn[Zn.Triangles=4]="Triangles",Zn[Zn.TriangleStrip=5]="TriangleStrip",Zn[Zn.TriangleFan=6]="TriangleFan";var ei=function(){function e(e,t){this._buffer=void 0,this._format=void 0,this._buffer=e,this._format=t}return T(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),ti=function(){function e(e,t){this._buffer=void 0,this._stride=void 0,this._buffer=e,this._stride=t}return T(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}(),ri=function(t){function r(e,r){var n;return(n=t.call(this,e)||this).name=void 0,n.instanceCount=0,n._macroCollection=new Re,n._vertexElementMap={},n._glIndexType=void 0,n._platformPrimitive=void 0,n._vertexBufferBindings=[],n._indexBufferBinding=null,n._vertexElements=[],n.targets=[],n.name=r,n._platformPrimitive=n._engine._hardwareRenderer.createPlatformPrimitive(E(n)),n}C(r,t);var n=r.prototype;return n.setVertexBufferBinding=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0);var n=e,i=void 0!==n.buffer;i||(n=new ti(e,t));var a=this._vertexBufferBindings;a.length<=r&&(a.length=r+1),this._setVertexBufferBinding(i?t:r,n)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0);var r=this._vertexBufferBindings,n=e.length,i=t+n;r.length<i&&(r.length=i);for(var a=0;a<n;a++)this._setVertexBufferBinding(t+a,e[a])},n.setIndexBufferBinding=function(e,t){var r=e;void 0!==r.buffer||(r=new ei(e,t)),this._indexBufferBinding=r,this._glIndexType=Jn._getGLIndexType(r.format)},n.setVertexElements=function(e){this._clearVertexElements();for(var t=0,r=e.length;t<r;t++)this._addVertexElement(e[t])},n._draw=function(e,t){this._platformPrimitive.draw(e,t)},n._addRefCount=function(e){t.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,n=0,i=r.length;n<i;n++)r[n]._buffer._addRefCount(e)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t];this._macroCollection.disable(r._uvMacro),this._macroCollection.disable(r._normalMacro),this._macroCollection.disable(r._tangentMacro),this._macroCollection.disable(r._vertexColorMacro),this._macroCollection.disable(r._vertexAlphaMacro)},n._addVertexElement=function(t){var n=t.semantic,i=t.format;switch(this._vertexElementMap[n]=t,this._vertexElements.push(t),n){case"TEXCOORD_0":this._macroCollection.enable(r._uvMacro);break;case"NORMAL":this._macroCollection.enable(r._normalMacro);break;case"TANGENT":this._macroCollection.enable(r._tangentMacro);break;case"COLOR_0":this._macroCollection.enable(r._vertexColorMacro),i===e.VertexElementFormat.Vector4&&this._macroCollection.enable(r._vertexAlphaMacro)}},n._setVertexBufferBinding=function(e,t){if(this._getRefCount()>0){var r=this._vertexBufferBindings[e];r&&r._buffer._addRefCount(-1),t._buffer._addRefCount(1)}this._vertexBufferBindings[e]=t},T(r,[{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"vertexElements",get:function(){return this._vertexElements}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}}]),r}(Ft);ri._uvMacro=yt.getMacroByName("O3_HAS_UV"),ri._normalMacro=yt.getMacroByName("O3_HAS_NORMAL"),ri._tangentMacro=yt.getMacroByName("O3_HAS_TANGENT"),ri._vertexColorMacro=yt.getMacroByName("O3_HAS_VERTEXCOLOR"),ri._vertexAlphaMacro=yt.getMacroByName("O3_HAS_VERTEXALPHA");var ni,ii,ai,oi,si=function(){function e(e,t,r,n,i){void 0===i&&(i=0),this.normalized=!1,this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=e,this._offset=t,this._format=r,this._bindingIndex=n,this._glElementInfo=Jn._getElementInfo(this.format),this._instanceStepRate=Math.floor(i)}return T(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"elementInfo",get:function(){return this._glElementInfo}}]),e}(),ci=function(t,r,n){void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=e.PrimitiveTopology.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=t,this.count=r,this.topology=n},ui=function(e){function t(t){var r;return(r=e.call(this,t)||this)._uvRect=void 0,r._worldSize=[],r._positionQuad=void 0,r._rotationAngle=0,r._anchor=void 0,r._texture=void 0,r._rect=void 0,r._worldSizeFactor=void 0,r.renderMode="2D",r.tintColor=new v(1,1,1,1),r.transformMatrix=void 0,r._worldSizeFactor=100,r.setTexture(void 0),r.setRect(void 0),r.setAnchor(void 0),r.setUvRect(),r.setWorldSize(),r._positionQuad={leftTop:new i,leftBottom:new i,rightTop:new i,rightBottom:new i},r}C(t,e);var r=t.prototype;return r.setTexture=function(e){e&&e.asset&&(e=e.asset),this._texture=e},r.setRect=function(e){var t,r,n,i;try{e&&JSON.parse(e)}catch(e){xe.warn("Rect is not valid JSON format")}this._rect=e||{x:0,y:0,width:null!=(t=null===(r=this._texture)||void 0===r?void 0:r.width)?t:0,height:null!=(n=null===(i=this._texture)||void 0===i?void 0:i.height)?n:0}},r.setAnchor=function(e){this._anchor=e||[.5,.5]},r.setWorldSize=function(){var e=this._worldSizeFactor;this._worldSize=[this._rect.width/e,this._rect.height/e]},r.setUvRect=function(){var e,t;this._texture?(e=this._texture.width,t=this._texture.height):(e=this._rect.width,t=this._rect.height),this._uvRect={u:this._rect.x/e,v:this._rect.y/t,width:this._rect.width/e,height:this._rect.height/t}},r.render=function(e){this._updatePositionQuad(e),this._transformByMatrix(),e._renderPipeline.pushSprite(this,this._positionQuad,this._uvRect,this.tintColor,this.texture,this.renderMode,e)},r._transformByMatrix=function(){if(this.transformMatrix){var e=this.transformMatrix,r=this._positionQuad.leftTop,n=t._tempVec40;n.setValue(r.x,r.y,r.z,1),r=this._positionQuad.leftBottom;var i=t._tempVec41;i.setValue(r.x,r.y,r.z,1),r=this._positionQuad.rightTop;var a=t._tempVec42;a.setValue(r.x,r.y,r.z,1),r=this._positionQuad.rightBottom;var o=t._tempVec43;o.setValue(r.x,r.y,r.z,1),v.transform(n,e,n),v.transform(i,e,i),v.transform(a,e,a),v.transform(o,e,o),this._positionQuad.leftTop.setValue(n.x,n.y,n.z),this._positionQuad.leftBottom.setValue(i.x,i.y,i.z),this._positionQuad.rightTop.setValue(a.x,a.y,a.z),this._positionQuad.rightBottom.setValue(o.x,o.y,o.z)}},r._updatePositionQuad=function(e){if("2D"===this.renderMode){var t=e.viewMatrix.elements,r=new i(t[0],t[4],t[8]),n=new i(t[1],t[5],t[9]),a=this.entity.worldPosition.clone(),o=this._worldSize,s=this.entity.scale;if(r.scale(o[0]*s.x),n.scale(o[1]*s.y),0!==this._rotationAngle){var c=new i(t[2],t[6],t[10]),u=new d;d.rotationAxisAngle(c,this._rotationAngle,u),i.transformByQuat(r,u,r),i.transformByQuat(n,u,n)}var l=new i,h=new i;i.scale(r,2*(this.anchor[0]-.5),l),i.scale(n,2*(this.anchor[1]-.5),h),a.subtract(l).add(h);var f=this._positionQuad.leftTop;i.subtract(a,r,f),f.add(n);var _=this._positionQuad.leftBottom;i.subtract(a,r,_),_.subtract(n);var p=this._positionQuad.rightBottom;i.add(a,r,p),p.subtract(n);var g=this._positionQuad.rightTop;i.add(a,r,g),g.add(n)}},T(t,[{key:"texture",get:function(){return this._texture},set:function(e){this.setTexture(e),this.setRect(),this.setUvRect(),this.setWorldSize()}},{key:"anchor",get:function(){return this._anchor},set:function(e){this._anchor=e||[.5,.5]}},{key:"rect",get:function(){return this._rect},set:function(e){this.setRect(e),this.setUvRect(),this.setWorldSize()}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(e){this._rotationAngle=e}}]),t}(Tr);ui._tempVec40=new v,ui._tempVec41=new v,ui._tempVec42=new v,ui._tempVec43=new v,(ni=e.WrapMode||(e.WrapMode={}))[ni.ONCE=0]="ONCE",ni[ni.LOOP=1]="LOOP",(ii=e.AnimationEvent||(e.AnimationEvent={}))[ii.FINISHED=0]="FINISHED",ii[ii.LOOP_END=1]="LOOP_END",ii[ii.FRAME_EVENT=2]="FRAME_EVENT",(ai=e.InterpolationType||(e.InterpolationType={}))[ai.LINEAR=0]="LINEAR",ai[ai.CUBICSPLINE=1]="CUBICSPLINE",ai[ai.STEP=2]="STEP",function(e){e[e.position=0]="position",e[e.rotation=1]="rotation",e[e.scale=2]="scale",e[e.other=3]="other"}(oi||(oi={}));var li=function(t){function r(e){var r;return(r=t.call(this,null)||this).name=e,r.duration=void 0,r.durationIndex=void 0,r.samplers=void 0,r.channels=void 0,r.samplers=[],r.channels=[],r}C(r,t);var n=r.prototype;return n.addSampler=function(t,r,n,i){void 0===i&&(i=e.InterpolationType.LINEAR),i===e.InterpolationType.CUBICSPLINE&&(n<=4?i=e.InterpolationType.LINEAR:n/=3);var a={input:t,output:r,outputSize:n,interpolation:i};this.samplers.push(a)},n.addChannel=function(e,t,n){var i=this.samplers[e],a=r._tagetTypeMap[n],o={sampler:i,target:{id:t,path:n,pathType:null!=a?a:oi.other}};this.channels.push(o)},n.getChannelCount=function(){return this.channels.length},n.getChannelObject=function(e){return this.channels[e]},n.getFrameCount=function(e){return this.channels[e].sampler.input.length},n.getFrameTime=function(e,t){return this.channels[e].sampler.input[t]},n.getChannelTimeLength=function(e){var t=this.channels[e].sampler,r=t.input.length;return t.input[r-1]},n.createChannelValue=function(e){var t=this.channels[e].sampler;return new Float32Array(t.outputSize)},n.evaluate=function(t,r,n,i,a){var o=this.channels[r],s=o.sampler.output,c=o.sampler.outputSize;switch(o.sampler.interpolation){case e.InterpolationType.CUBICSPLINE:this.evaluateCubicSpline(t,s,c,n,i,a);break;case e.InterpolationType.LINEAR:this.evaluateLinear(t,s,c,n,i,a)}return t},n.evaluateCubicSpline=function(e,t,r,n,i,a){for(var o=a*a,s=a*o,c=2*s-3*o+1,u=-2*s+3*o,l=s-2*o+a,d=s-o,h=r;h>=0;h--){var f=t[n*r*3+h],_=t[n*r*3+r+h],p=t[n*r*3+2*r+h],g=t[i*r*3+r+h];e[h]=_*c+g*u+f*l+p*d}},n.evaluateLinear=function(e,t,r,n,i,a){switch(r){case 1:e[0]=t[n]*(1-a)+t[i]*a;break;case 4:this._quaSlerp(e,t,n*r,t,i*r,a);break;default:for(var o=r;o>=0;o--)e[o]=t[n*r+o]*(1-a)+t[i*r+o]*a}},n._quaSlerp=function(e,t,r,n,i,a){var o,s,c,u,l,d=t[0+r],h=t[1+r],f=t[2+r],_=t[3+r],p=n[0+i],g=n[1+i],v=n[2+i],m=n[3+i];return(s=d*p+h*g+f*v+_*m)<0&&(s=-s,p=-p,g=-g,v=-v,m=-m),1-s>1e-6?(o=Math.acos(s),c=Math.sin(o),u=Math.sin((1-a)*o)/c,l=Math.sin(a*o)/c):(u=1-a,l=a),e[0]=u*d+l*p,e[1]=u*h+l*g,e[2]=u*f+l*v,e[3]=u*_+l*m,e},r}(fe);li._tagetTypeMap={position:oi.position,rotation:oi.rotation,scale:oi.scale};var di,hi,fi,_i,pi,gi,vi,mi=function(t){function r(){var e;return(e=t.call(this,null)||this).layerWeight=void 0,e.mixTagetLayer=void 0,e.isFading=void 0,e.fadeDeltaTime=void 0,e.crossFadeDuration=void 0,e.fadeDuration=void 0,e.crossFadeDeltaTime=void 0,e.isMixLayer=void 0,e.hasMixLayer=void 0,e.mixEntity=void 0,e._activedEvents=void 0,e._animClip=void 0,e._isPlaying=void 0,e._wrapMode=void 0,e._channelStates=void 0,e._animClipLength=void 0,e._frameEvents=void 0,e.layerWeight=1,e._activedEvents=[],e}C(r,t);var n=r.prototype;return n.canMix=function(e,t){if(!this._animClip||!this._isPlaying||this.isMixLayer||this.isFading)return!1;if(this._animClip.getChannelCount()!==e.getChannelCount())return!1;for(var r=this._animClip.getChannelCount()-1;r>=0;r--){var n=this._animClip.getChannelObject(r),i=this._findChannelTarget(t,n.target),a=e.getChannelObject(r);if(i!==this._findChannelTarget(t,a.target))return!1}return!0},n.mix=function(e,t,r,n,i){if(void 0===i&&(i={}),this._isPlaying=t.isPlaying,this._animClip=e,this._wrapMode=void 0!==i.wrapMode?i.wrapMode:t._wrapMode,this._addEvents(i),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var a=t._channelStates,o=this._animClip.getChannelCount()-1;o>=0;o--){var s=this._animClip.getChannelObject(o),c=this._findChannelTarget(n,s.target);this._channelStates[o]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(o),mixWeight:c?1:0},a[o].mixWeight=void 0===a[o].mixWeight?1:a[o].mixWeight,1===a[o].mixWeight&&(a[o].mixWeight=c?0:1);var u=this._animClip.getChannelTimeLength(o);this._animClipLength=this._animClipLength>u?this._animClipLength:u}return!0}return!1},n.removeMixWeight=function(){for(var e=this._channelStates.length-1;e>=0;e--)1===this._channelStates[e].mixWeight&&(this.mixTagetLayer._channelStates[e].mixWeight=1)},n.play=function(t,r,n){if(void 0===n&&(n={wrapMode:e.WrapMode.LOOP}),this._isPlaying=!!t,this._animClip=t,this._wrapMode=void 0!==n.wrapMode?n.wrapMode:e.WrapMode.LOOP,this._addEvents(n),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var i=[],a=this._animClip.getChannelCount()-1;a>=0;a--){var o=this._animClip.getChannelObject(a),s=this._findChannelTarget(r,o.target);s||xe.warn("Can not find channel target:"+o.target.id),this._channelStates[a]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(a)},i[a]={targetObject:s,path:o.target.path,pathType:o.target.pathType,outputSize:o.sampler.outputSize};var c=this._animClip.getChannelTimeLength(a);this._animClipLength=this._animClipLength>c?this._animClipLength:c}return i}return!1},n.stop=function(t){this._animClip&&this._isPlaying&&(t?this._isPlaying=!1:this._wrapMode=e.WrapMode.ONCE)},n.updateState=function(e){if(this._animClip&&this._isPlaying){this.isFading?(this.fadeDeltaTime+=e,this.layerWeight=1-this.fadeDeltaTime/this.fadeDuration,this.layerWeight<=0&&(this._isPlaying=!1)):this.crossFadeDuration&&(this.crossFadeDeltaTime+=e,this.layerWeight=this.crossFadeDeltaTime/this.crossFadeDuration,this.layerWeight>=1&&(this.layerWeight=1,delete this.crossFadeDuration)),e/=1e3,this._activeEvents(e);for(var t=0,r=this._animClip.getChannelCount()-1;r>=0;r--)this._updateChannelState(e,r)&&t++;0===t&&(this._isPlaying=!1,this.isMixLayer&&this.removeMixWeight())}},n.getChannelLayerWeight=function(e){return(this.hasMixLayer||this.isMixLayer)&&e<this._channelStates.length?this._channelStates[e].mixWeight*(this.isMixLayer?this.mixTagetLayer.layerWeight:this.layerWeight):this.layerWeight},n.getChannelValue=function(e){return this._channelStates[e].currentValue},n.triggerEvents=function(){var e=this;this._activedEvents&&this._activedEvents.forEach((function(t){e.trigger(t)})),this._activedEvents.length=0},n.jumpToFrame=function(e){for(var t=this._animClip.getChannelCount()-1;t>=0;t--){this._channelStates[t].frameTime=0,this._updateChannelState(e,t)}},n._updateChannelState=function(t,r){var n=this._animClip,i=this._channelStates[r],a=n.getChannelTimeLength(r);if(i.frameTime+=t,i.frameTime>a)switch(this._wrapMode){case e.WrapMode.ONCE:i.frameTime=a;break;case e.WrapMode.LOOP:i.frameTime=i.frameTime%this._animClipLength;break;default:xe.error("Unknown Anim wrap Mode: "+this._wrapMode)}if(i.mixWeight&&0===i.mixWeight)return!0;var o=Math.min(i.frameTime,a),s=this._getKeyAndAlpha(n.getChannelObject(r),o);return i.currentValue=n.evaluate(i.currentValue,r,s.currentKey,s.nextKey,s.alpha),!(this._wrapMode===e.WrapMode.ONCE&&i.frameTime>=a)},n._addEvents=function(t){var r=this;if(this.removeAllEventListeners(),this._frameEvents=[],t.events)for(var n=0,i=function(i){var a=t.events[i],o=a.type;a.type===e.AnimationEvent.FRAME_EVENT&&(o="frameEvent"+n,n++,r._frameEvents.push({eventType:o,triggerTime:a.triggerTime,triggered:!1})),r.addEventListener(o,(function(e){a.callback()}))},a=t.events.length-1;a>=0;a--)i(a)},n._activeEvents=function(t){var r=this._animClip.durationIndex;if(this._frameEvents.length>0&&this._channelStates.length>0)for(var n=this._channelStates[r].frameTime+t,i=this._frameEvents.length-1;i>=0;i--){var a=this._frameEvents[i];!a.triggered&&n>a.triggerTime&&(this._activedEvents.push(new k(a.eventType,this)),a.triggered=!0)}if(this._channelStates.length>0&&this._channelStates[r].frameTime+t>=this._animClip.duration)if(this._wrapMode===e.WrapMode.LOOP){if(this._frameEvents.length>0)for(var o=this._frameEvents.length-1;o>=0;o--)this._frameEvents[o].triggered=!1;this.hasEvent(e.AnimationEvent.LOOP_END)&&this._activedEvents.push(new k(e.AnimationEvent.LOOP_END,this))}else this.hasEvent(e.AnimationEvent.FINISHED)&&this._activedEvents.push(new k(e.AnimationEvent.FINISHED,this))},n._findChannelTarget=function(e,t){var r=t.id,n=null;return n=e.name===r?e:e.findByName(r),"weights"===t.path?n.getComponent(Un):n},n._getKeyAndAlpha=function(t,r){for(var n=0,i=0,a=0,o=t.sampler.input,s=o.length,c=s-1;c>=0;c--)if(r>o[c]){n=r-o[c],i=c;break}if((a=i+1)>=s)switch(this._wrapMode){case e.WrapMode.ONCE:a=s-1;break;case e.WrapMode.LOOP:a=0}var u=o[a]-o[i];return{currentKey:i,nextKey:a,alpha:a===i||u<1e-5?1:n/u}},T(r,[{key:"isPlaying",get:function(){return this._animClip&&this._isPlaying}}]),r}(_e),yi=(hi=B((di=function(e){function t(t){var r;return I(r=e.call(this,t)||this,"_onUpdateIndex",hi,E(r)),I(r,"_animSet",fi,E(r)),I(r,"_animLayers",_i,E(r)),I(r,"_timeScale",pi,E(r)),I(r,"_channelTargets",gi,E(r)),r}C(t,e),t.lerp=function(e,t,r,n,i){switch(i){case 1:e=t*(1-n)+r*n;break;case 4:var a=R(d,t),o=R(d,r),s=new d;d.slerp(a,o,n,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,e[3]=s.w;break;default:for(var c=i;c>=0;c--)e[c]=t[c]*(1-n)+r[c]*n}return e};var r=t.prototype;return r.update=function(e){if(this.isPlaying()){e*=this._timeScale;for(var t=this._animLayers.length-1;t>=0;t--){this._animLayers[t].updateState(e)}this._updateValues();for(var r=this._animLayers.length-1;r>=0;r--){var n=this._animLayers[r];n.triggerEvents(),n.isPlaying||!n.isFading&&!n.isMixLayer||(this._animLayers.splice(r,1),this._removeRefMixLayers(n))}}},r.addAnimationClip=function(e,t){this._animSet[t]=e},r.removeAnimationClip=function(e){this._animSet[e]&&delete this._animSet[e]},r.getAnimationClipLength=function(e){var t=this._animSet[e];return t?t.getChannelTimeLength(0):0},r.getAnimationClip=function(e){return this._animSet[e]||null},r.isPlaying=function(){for(var e=this._animLayers.length-1;e>=0;e--)if(this._animLayers[e].isPlaying)return!0;return!1},r.playAnimationClip=function(e,t){var r=this._animSet[e];if(r){for(var n=null,i=this._animLayers.length-1;i>=0;i--)if(!this._animLayers[i].isFading&&!this._animLayers[i].isMixLayer){n=this._animLayers[i];break}n||(n=new mi,this._animLayers.push(n)),this._removeRefMixLayers(n),this._channelTargets=n.play(r,this.entity,t)}else xe.error("can not find anim clip: "+e)},r.CrossFade=function(e,t,r){var n=this._animSet[e];if(n)if(!t||t<0)xe.error("crossFadeDuration can not less than 0!");else{for(var i=null,a=this._animLayers.length-1;a>=0;a--)if(this._animLayers[a].canMix(n,this.entity)){i=this._animLayers[a];break}if(i){for(var o=this._animLayers.length-1;o>=0;o--)this._animLayers[o].isFading&&this._animLayers.splice(o,1);i.isFading=!0,i.fadeDuration=t,i.fadeDeltaTime=0;var s=new mi;s.crossFadeDuration=t,s.crossFadeDeltaTime=0,s.play(n,this.entity,r),this._animLayers.push(s)}else this.playAnimationClip(e,r)}else xe.error("can not find anim clip: "+e)},r.mix=function(e,t,r){var n=this._animSet[e];if(n){var i=this.entity.findByName(t);if(i){for(var a=null,o=this._animLayers.length-1;o>=0;o--)if(this._animLayers[o].canMix(n,this.entity)){a=this._animLayers[o];break}if(a){this._removeRefMixLayers(null,i),a.hasMixLayer=!0;var s=new mi;s.isMixLayer=!0,s.mixTagetLayer=a,s.mixEntity=i,s.mix(n,a,this.entity,i,r),this._animLayers.push(s)}}else xe.error("can not find mix bone!")}else xe.error("can not find anim clip: "+e)},r.stop=function(e){for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].isFading?this._animLayers.splice(t,1):this._animLayers[t].stop(e)},r.jumpToFrame=function(e){e/=1e3;for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].jumpToFrame(e);this._updateValues()},r._removeRefMixLayers=function(e,t){if(e&&e.hasMixLayer)for(var r=this._animLayers.length-1;r>=0;r--){var n=this._animLayers[r];n.isMixLayer&&n.mixTagetLayer===e&&(n.removeMixWeight(),this._animLayers.splice(r,1))}if(t)for(var i=this._animLayers.length-1;i>=0;i--){var a=this._animLayers[i];a.isMixLayer&&(a.mixEntity===t||a.mixEntity.findByName(t)||t.findByName(a.mixEntity))&&(a.removeMixWeight(),this._animLayers.splice(i,1))}},r._updateValues=function(){if(0!==this._animLayers.length&&this._channelTargets)for(var e=this._channelTargets.length-1;e>=0;e--){var t=this._channelTargets[e],r=this._getChannelValue(e,t.outputSize),n=t.targetObject,i=t.path;if("weights"===i)n.setWeights(r);else{var a=r,o=n.transform;switch(t.pathType){case oi.position:var s=o.position;s.setValue(a[0],a[1],a[2]),o.position=s;break;case oi.rotation:var c=o.rotationQuaternion;c.setValue(a[0],a[1],a[2],a[3]),o.rotationQuaternion=c;break;case oi.scale:var u=o.scale;u.setValue(a[0],a[1],a[2]),o.scale=u;break;default:n[i]=r}}}},r._getChannelValue=function(e,r){for(var n=[],i=[],a=this._animLayers.length-1;a>=0;a--){var o=this._animLayers[a].getChannelLayerWeight(e);o>0&&(n.push(o),i.push(this._animLayers[a].getChannelValue(e)))}return 1===i.length?i[0]:2===i.length?t.lerp(i[0],i[0],i[1],n[1],r):(xe.error("Can not get channel value!"),!1)},r._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},r._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},T(t,[{key:"timeScale",get:function(){return this._timeScale},set:function(e){e>0&&(this._timeScale=e)}}]),t}(Qe)).prototype,"_onUpdateIndex",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fi=B(di.prototype,"_animSet",[W],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_i=B(di.prototype,"_animLayers",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new mi]}}),pi=B(di.prototype,"_timeScale",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gi=B(di.prototype,"_channelTargets",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),di),xi=function(t){function r(e,r){var n;return(n=t.call(this,e)||this).name=void 0,n._primitive=void 0,n.bounds=new o,n._subGeometries=[],n._primitive=new ri(e),n.name=r,n}C(r,t);var n=r.prototype;return n.setVertexBufferBinding=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this._primitive.setVertexBufferBinding(e,t,r)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0),this._primitive.setVertexBufferBindings(e,t)},n.setIndexBufferBinding=function(e,t){this._primitive.setIndexBufferBinding(e,t)},n.setVertexElements=function(e){this._primitive.setVertexElements(e)},n.addSubGeometry=function(t,r,n){void 0===n&&(n=e.PrimitiveTopology.Triangles);var i=new ci(t,r,n);return this._subGeometries.push(i),i},n.removeSubGeometry=function(e){var t=this._subGeometries,r=t.indexOf(e);-1!==r&&t.splice(r,1)},n.clearSubGeometry=function(){this._subGeometries.length=0},n.destroy=function(){this._primitive&&(this._primitive.destroy(),this._primitive=null)},T(r,[{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._primitive.indexBufferBinding}},{key:"vertexElements",get:function(){return this._primitive.vertexElements}},{key:"subGeometry",get:function(){return this._subGeometries[0]||null}},{key:"subGeometries",get:function(){return this._subGeometries}},{key:"instanceCount",get:function(){return this._primitive.instanceCount},set:function(e){this._primitive.instanceCount=e}}]),r}(fe),Ti=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this)._material=void 0,t._geometry=void 0,t}C(t,e);var r=t.prototype;return r.render=function(e){var t=this.geometry;if(t){for(var r=t.subGeometries,n=e._renderPipeline,i=this._material,a=0,o=r.length;a<o;a++)if(i){var s=tt.getFromPool();s.setValue(this,t._primitive,r[a],i),n.pushPrimitive(s)}}else xe.error("geometry is null.")},r._updateBounds=function(e){var t=this._geometry;if(t){var r=t.bounds,n=this._entity.transform.worldMatrix;o.transform(r,n,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},T(t,[{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry&&this._geometry._primitive._addRefCount(-1),e._primitive._addRefCount(1),this._geometry=e}},{key:"material",get:function(){return this._material},set:function(e){this._material&&this._material._addRefCount(-1),e._addRefCount(1),this._material=e}}]),t}(Tr),bi=function(t){function r(){return t.apply(this,arguments)||this}C(r,t);var n=r.prototype;return n._initialize=function(t,r,n){var i=[new si("POSITION",0,e.VertexElementFormat.Vector3,0),new si("NORMAL",12,e.VertexElementFormat.Vector3,0),new si("TEXCOORD_0",24,e.VertexElementFormat.Vector2,0)];this._initBuffer(t,r,n,32,i)},n._initBuffer=function(t,r,n,i,a){var o=a[0],s=new $n(t,e.BufferBindFlag.VertexBuffer,r,e.BufferUsage.Static),c=new $n(t,e.BufferBindFlag.IndexBuffer,n,e.BufferUsage.Static);this.setVertexBufferBinding(s,i),this.setIndexBufferBinding(c,e.IndexFormat.UInt16),this.setVertexElements(a),this.addSubGeometry(0,n.length),this._computeBounds(o,r)},n._computeBounds=function(e,t){var r=e,n=r.bindingIndex,a=this._primitive.vertexBufferBindings[n],o=a.stride,s=r.offset,c=a.buffer.byteLength/o,u=t;u instanceof ArrayBuffer||(u=u.buffer);for(var l=new DataView(u,s),d=new i(1/0,1/0,1/0),h=new i(-1/0,-1/0,-1/0),f=0;f<c;f++){var _=s+o*f,p=new i(l.getFloat32(_,!0),l.getFloat32(_+4,!0),l.getFloat32(_+8,!0));i.min(d,p,d),i.max(h,p,h)}var g=this.bounds;d.cloneTo(g.min),h.cloneTo(g.max)},r}(xi),Ai=function(e){function t(t,r,n,i){var a;void 0===r&&(r=1),void 0===n&&(n=1),void 0===i&&(i=1),a=e.call(this,t)||this;var o=r/2,s=n/2,c=i/2,u=new Float32Array([-o,s,-c,0,1,0,0,0,o,s,-c,0,1,0,1,0,o,s,c,0,1,0,1,1,-o,s,c,0,1,0,0,1,-o,-s,-c,0,-1,0,0,1,o,-s,-c,0,-1,0,1,1,o,-s,c,0,-1,0,1,0,-o,-s,c,0,-1,0,0,0,-o,s,-c,-1,0,0,0,0,-o,s,c,-1,0,0,1,0,-o,-s,c,-1,0,0,1,1,-o,-s,-c,-1,0,0,0,1,o,s,-c,1,0,0,1,0,o,s,c,1,0,0,0,0,o,-s,c,1,0,0,0,1,o,-s,-c,1,0,0,1,1,-o,s,c,0,0,1,0,0,o,s,c,0,0,1,1,0,o,-s,c,0,0,1,1,1,-o,-s,c,0,0,1,0,1,-o,s,-c,0,0,-1,1,0,o,s,-c,0,0,-1,0,0,o,-s,-c,0,0,-1,0,1,-o,-s,-c,0,0,-1,1,1]),l=new Uint16Array([0,2,1,2,0,3,4,6,7,6,4,5,8,10,9,10,8,11,12,14,15,14,12,13,16,18,17,18,16,19,20,22,23,22,20,21]);return a._initialize(t,u,l),a}return C(t,e),t}(bi),wi=function(e){function t(t,r,n,i,a,o,s,c){var u;return void 0===r&&(r=1),void 0===n&&(n=8),void 0===i&&(i=6),void 0===a&&(a=0),void 0===o&&(o=2*Math.PI),void 0===s&&(s=0),void 0===c&&(c=Math.PI),(u=e.call(this,t)||this)._parameters=void 0,u._thetaEnd=void 0,u._parameters={radius:r||1,horizontalSegments:Math.max(3,Math.floor(n)),verticalSegments:Math.max(2,Math.floor(i)),alphaStart:a,alphaRange:o,thetaStart:s,thetaRange:c},u._thetaEnd=u._parameters.thetaStart+u._parameters.thetaRange,u.initialize(t),u}return C(t,e),t.prototype.initialize=function(e){for(var t=this._parameters,r=t.verticalSegments,n=t.horizontalSegments,i=0,a=[],o=new Float32Array((r+1)*(n+1)*8),s=[],c=0;c<=r;c++){for(var u=[],l=c/r,d=0;d<=n;d++){var h=d/n,f=-this._parameters.radius*Math.cos(this._parameters.alphaStart+h*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+l*this._parameters.thetaRange),_=this._parameters.radius*Math.cos(this._parameters.thetaStart+l*this._parameters.thetaRange),p=this._parameters.radius*Math.sin(this._parameters.alphaStart+h*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+l*this._parameters.thetaRange);f=Math.abs(f)<1e-6?0:f,_=Math.abs(_)<1e-6?0:_,p=Math.abs(p)<1e-6?0:p;var g=8*i;o[g]=f,o[g+1]=_,o[g+2]=p,o[g+3]=f,o[g+4]=_,o[g+5]=p,o[g+6]=h,o[g+7]=1-l,u.push(i++)}a.push(u)}for(var v=0;v<r;v++)for(var m=0;m<n;m++){var y=a[v][m+1],x=a[v][m],T=a[v+1][m],b=a[v+1][m+1];(0!==v||this._parameters.thetaStart>0)&&s.push(y,x,b),(v!==r-1||this._thetaEnd<Math.PI)&&s.push(x,T,b)}this._initialize(e,o,Uint16Array.from(s))},t}(bi),Ci=function(e){function t(t,r,n,i,a){var o;return void 0===r&&(r=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===a&&(a=1),(o=e.call(this,t)||this)._parameters=void 0,o.halfWidth=void 0,o.halfHeight=void 0,o._parameters={width:r,height:n,horizontalSegments:Math.floor(i),verticalSegments:Math.floor(a)},o.halfWidth=o._parameters.width/2,o.halfHeight=o._parameters.height/2,o.initialize(t),o}return C(t,e),t.prototype.initialize=function(e){for(var t=this._parameters,r=t.verticalSegments,n=t.horizontalSegments,i=0,a=0,o=[],s=new Float32Array((r+1)*(n+1)*8),c=new Uint16Array(r*n*6),u=0;u<=r;u++){for(var l=[],d=u/r,h=0;h<=n;h++){var f=h/n,_=f*this._parameters.width-this.halfWidth,p=d*this._parameters.height-this.halfHeight;s[a++]=_,s[a++]=p,s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=1,s[a++]=f,s[a++]=1-d,l.push(i++)}o.push(l)}i=0;for(var g=0;g<r;g++)for(var v=0;v<n;v++){var m=o[g][v+1],y=o[g][v],x=o[g+1][v],T=o[g+1][v+1];c[i++]=m,c[i++]=x,c[i++]=y,c[i++]=m,c[i++]=T,c[i++]=x}this._initialize(e,s,c)},t}(bi),Mi=function(t){function r(r,n,i,a,o,s,c,u,l,d){var h;return void 0===n&&(n=1),void 0===i&&(i=1),void 0===a&&(a=1),void 0===o&&(o=8),void 0===s&&(s=1),void 0===c&&(c=!1),void 0===u&&(u=0),void 0===l&&(l=2*Math.PI),void 0===d&&(d=e.FrontFace.CCW),(h=t.call(this,r)||this).FrontFace=void 0,h.index=void 0,h.indexArray=void 0,h.halfHeight=void 0,h._parameters=void 0,h._vertices=void 0,h._indices=void 0,h.FrontFace=d,h._parameters={radiusTop:n,radiusBottom:i,height:a,radialSegments:o,heightSegments:s,openEnded:c,thetaStart:u,thetaLength:l},h._vertices=[],h._indices=[],h.index=0,h.indexArray=[],h.halfHeight=h._parameters.height/2,h.generateTorso(),!1===h._parameters.openEnded&&(h._parameters.radiusTop>0&&h.generateCap(!0),h._parameters.radiusBottom>0&&h.generateCap(!1)),h._initialize(r,Float32Array.from(h._vertices),Uint16Array.from(h._indices)),h}C(r,t);var n=r.prototype;return n.generateTorso=function(){var t,r,n=this._parameters,a=n.radialSegments,o=n.heightSegments,s=n.radiusBottom,c=n.radiusTop,u=n.height,l=new i,d=(s-c)/u;for(r=0;r<=o;r++){var h=[],f=r/o,_=f*(s-c)+c;for(t=0;t<=a;t++){var p=t/a,g=p*this._parameters.thetaLength+this._parameters.thetaStart,v=Math.sin(g),m=Math.cos(g),y=_*v,x=-f*u+this.halfHeight,T=_*m;this._vertices.push(y,x,T),l.setValue(v,d,m),l.normalize(),this._vertices.push(l.x,l.y,l.z),this.FrontFace===e.FrontFace.CCW?this._vertices.push(p,f):this._vertices.push(1-p,f),h.push(this.index++)}this.indexArray.push(h)}for(t=0;t<a;t++)for(r=0;r<o;r++){var b=this.indexArray[r][t],A=this.indexArray[r+1][t],w=this.indexArray[r+1][t+1],C=this.indexArray[r][t+1];this._indices.push(b,A,C),this._indices.push(A,w,C)}},n.generateCap=function(e){var t,r=this._parameters.radialSegments,n=!0===e?this._parameters.radiusTop:this._parameters.radiusBottom,i=!0===e?1:-1,a=this.index;for(t=1;t<=r;t++)this._vertices.push(0,this.halfHeight*i,0),this._vertices.push(0,i,0),this._vertices.push(.5,.5),this.index++;var o=this.index;for(t=0;t<=r;t++){var s=t/r*this._parameters.thetaLength+this._parameters.thetaStart,c=Math.cos(s),u=Math.sin(s),l=n*u,d=this.halfHeight*i,h=n*c;this._vertices.push(l,d,h),this._vertices.push(0,i,0);var f=.5*c+.5,_=.5*u*i+.5;this._vertices.push(f,_),this.index++}for(t=0;t<r;t++){var p=a+t,g=o+t;!0===e?this._indices.push(g,g+1,p):this._indices.push(g+1,g,p)}},r}(bi),Si=function(e){function t(t,r){var n;void 0===r&&(r={}),(n=e.call(this,t)||this).radius=1,n.segments=16,n.thetaStart=0,n.thetaLength=2*Math.PI,n.radius=r.radius||n.radius,n.segments=r.segments||n.segments,n.thetaStart=r.thetaStart||n.thetaStart,n.thetaLength=r.thetaLength||n.thetaLength;var i=E(n),a=i.segments,o=i.radius,s=new Float32Array(8*(a+2));s.set([0,0,0,0,0,1,.5,.5]);for(var c=8,u=0;u<=a;u++){var l=n.thetaStart+u/a*n.thetaLength,d=o*Math.cos(l),h=o*Math.sin(l);s[c++]=d,s[c++]=h,s[c++]=0,s[c++]=0,s[c++]=0,s[c++]=1,s[c++]=.5*(d/o+1),s[c++]=.5*(h/o+1)}var f=new Uint16Array(3*a);c=0;for(var _=1;_<=a;_++)f[c++]=_,f[c++]=_+1,f[c++]=0;return n._initialize(t,s,f),n}return C(t,e),t}(bi),Pi=function(t){function r(r){var n;n=t.call(this,r)||this;var i=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),a=new Uint16Array([0,1,2,3]);return n._initialize(r,i,a),n.subGeometry.topology=e.PrimitiveTopology.TriangleFan,n}return C(r,t),r.prototype._initialize=function(t,r,n){var i=[new si("POSITION",0,e.VertexElementFormat.Vector3,0),new si("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0)];this._initBuffer(t,r,n,20,i)},r}(bi),Ri=function(t){function r(e,r){var n;void 0===e&&(e={}),(n=t.call(this,r)||this).parameters=e;for(var i=n.parameters.radius||1,a=n.parameters.tube||.4,o=Math.floor(n.parameters.radialSegments)||8,s=Math.floor(n.parameters.tubularSegments)||6,c=n.parameters.arc||2*Math.PI,u=new Float32Array((o+1)*(s+1)*3),l=new Uint16Array(o*s*6),d=0,h=0;h<=o;h++)for(var f=0;f<=s;f++){var _=f/s*c,p=h/o*Math.PI*2;u[d++]=(i+a*Math.cos(p))*Math.cos(_),u[d++]=(i+a*Math.cos(p))*Math.sin(_),u[d++]=a*Math.sin(p)}d=0;for(var g=1;g<=o;g++)for(var v=1;v<=s;v++){var m=(s+1)*g+v-1,y=(s+1)*(g-1)+v-1,x=(s+1)*(g-1)+v,T=(s+1)*g+v;l[d++]=m,l[d++]=y,l[d++]=T,l[d++]=y,l[d++]=x,l[d++]=T}return n._initialize(r,u,l),n}return C(r,t),r.prototype._initialize=function(t,r,n){var i=[new si("POSITION",0,e.VertexElementFormat.Vector3,0)];this._initBuffer(t,r,n,12,i)},r}(bi),Li=function(e){function t(t){var r;return(r=e.call(this,t)||this)._props=void 0,r._geometryType=void 0,r}C(t,e);var r=t.prototype;return r.init=function(e){this._props=e;var t=e.geometryType,r=void 0===t?vi.Box:t;this.material=e.material,this.geometryType=r},r.setProp=function(e,t){this._props[e]=t,"material"===e?this.material=t:this.geometryType=this._props.geometryType},T(t,[{key:"geometryType",get:function(){return this._geometryType},set:function(e){switch(e){case"Sphere":var t=this._props,r=t.sphereRadius,n=t.sphereHorizontalSegments,i=t.sphereVerticalSegments,a=t.sphereAlphaStart,o=t.sphereAlphaRange,s=t.sphereThetaStart,c=t.sphereThetaRange;this.geometry=new wi(this.engine,r,n,i,a,o,s,c);break;case"Cylinder":var u=this._props,l=u.cylinderRadiusTop,d=u.cylinderRadiusBottom,h=u.cylinderHeight,f=u.cylinderRadialSegments,_=u.cylinderHeightSegments,p=u.cylinderOpenEnded;this.geometry=new Mi(this.engine,l,d,h,f,_,p,void 0,void 0,void 0);break;case"Plane":var g=this._props,v=g.planeWidth,m=g.planeHeight,y=g.planeHorizontalSegments,x=g.planeVerticalSegments;this.geometry=new Ci(this.engine,v,m,y,x);break;case"Box":var T=this._props,b=T.boxWidth,A=T.boxHeight,w=T.boxDepth;this.geometry=new Ai(this.engine,b,A,w)}this._geometryType=e}},{key:"material",get:function(){return this._material},set:function(e){this._material=e||new Vr(this.engine)}}]),t}(Ti);!function(e){e.Box="Box",e.Cylinder="Cylinder",e.Plane="Plane",e.Sphere="Sphere"}(vi||(vi={}));var Ei,Oi,Fi=function(t){function r(r){var n;return(n=t.call(this,r,yt.find("skybox"))||this).renderState.rasterState.cullMode=e.CullMode.Off,n.renderState.depthState.compareFunction=e.CompareFunction.LessEqual,n}return C(r,t),r}(Ur),Ii=function(e){function t(t){var r;return(r=e.call(this,t)||this)._skyBoxMap=void 0,r._matrix=new h,r._initBounds=!1,r.geometry=new Ai(r.engine,2,2,2),r.material=new Fi(r.engine),r}C(t,e);var r=t.prototype;return r.render=function(t){if(this._skyBoxMap){var r=this.entity.transform.worldMatrix,n=t.viewMatrix,i=t.projectionMatrix,a=this._matrix;h.multiply(n,r,a);var o=a.elements;o[12]=o[13]=o[14]=0,h.multiply(i,a,a),this.shaderData.setMatrix("u_mvpNoscale",a),e.prototype.render.call(this,t)}},r._updateBounds=function(e){this._initBounds||(e.min.setValue(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),e.max.setValue(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this._initBounds=!0)},T(t,[{key:"skyBoxMap",get:function(){return this._skyBoxMap},set:function(e){this._skyBoxMap=e,e&&this.material.shaderData.setTexture("u_cube",e)}}]),t}(Ti);!function(e){e[e.Position=1]="Position",e[e.Velocity=2]="Velocity",e[e.Acceleration=4]="Acceleration",e[e.Color=8]="Color",e[e.Apha=16]="Apha",e[e.Size=32]="Size",e[e.StartAngle=64]="StartAngle",e[e.StartTime=128]="StartTime",e[e.LifeTime=256]="LifeTime",e[e.RotateVelocity=512]="RotateVelocity",e[e.Scale=1024]="Scale",e[e.Everything=4294967295]="Everything"}(Ei||(Ei={})),(Oi=e.ParticleRendererBlendMode||(e.ParticleRendererBlendMode={}))[Oi.Transparent=0]="Transparent",Oi[Oi.Additive=1]="Additive";var Bi=function(t){function r(r){var n;return(n=t.call(this,r)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._maxCount=1e3,n._position=new i,n._positionRandomness=new i,n._positionArray=void 0,n._velocity=new i,n._velocityRandomness=new i,n._acceleration=new i,n._accelerationRandomness=new i,n._color=new y(1,1,1,1),n._colorRandomness=0,n._size=1,n._sizeRandomness=0,n._alpha=1,n._alphaRandomness=0,n._startAngle=0,n._startAngleRandomness=0,n._rotateVelocity=0,n._rotateVelocityRandomness=0,n._lifetime=5,n._startTimeRandomness=0,n._scale=1,n._isOnce=!1,n._time=0,n._isInit=!1,n._isStart=!1,n._updateDirtyFlag=Ei.Everything,n._isRotateToVelocity=!1,n._isUseOriginColor=!1,n._isScaleByLifetime=!1,n._is2d=!0,n._isFadeIn=!1,n._isFadeOut=!1,n._playOnEnable=!0,n._blendMode=e.ParticleRendererBlendMode.Transparent,n.spriteSheet=void 0,n._material=n._createMaterial(),n}C(r,t),r._getRandom=function(){return Math.random()-.5};var a=r.prototype;return a.update=function(e){this._isInit&&this._isStart&&(this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time))},a._onEnable=function(){t.prototype._onEnable.call(this),this._playOnEnable&&this.start()},a.start=function(){this._isStart=!0,this._time=0,this.shaderData.setInt("u_active",1)},a.stop=function(){this.shaderData.setInt("u_active",0)},a._createMaterial=function(){var t=new Ur(this.engine,yt.find("particle-shader")),r=t.renderState,n=r.blendState.targetBlendState;return n.sourceColorBlendFactor=n.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,n.destinationColorBlendFactor=n.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,t.renderQueueType=e.RenderQueueType.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,t},a._createGeometry=function(){for(var t=new xi(this._entity.engine,"particleGeometry"),r=4*this._maxCount*96,n=new Float32Array(r),i=new Uint16Array(6*this._maxCount),a=0,o=0;a<this._maxCount;++a){var s=4*a;i[o++]=s+0,i[o++]=s+1,i[o++]=s+2,i[o++]=s+0,i[o++]=s+2,i[o++]=s+3}var c=[new si("a_position",0,e.VertexElementFormat.Vector3,0),new si("a_velocity",12,e.VertexElementFormat.Vector3,0),new si("a_acceleration",24,e.VertexElementFormat.Vector3,0),new si("a_color",36,e.VertexElementFormat.Vector4,0),new si("a_lifeAndSize",52,e.VertexElementFormat.Vector4,0),new si("a_rotation",68,e.VertexElementFormat.Vector2,0),new si("a_uv",76,e.VertexElementFormat.Vector3,0),new si("a_normalizedUv",88,e.VertexElementFormat.Vector2,0)],u=new $n(this.engine,e.BufferBindFlag.VertexBuffer,4*r,e.BufferUsage.Dynamic),l=new $n(this.engine,e.BufferBindFlag.IndexBuffer,i,e.BufferUsage.Dynamic);return t.setVertexBufferBinding(u,96),t.setIndexBufferBinding(l,e.IndexFormat.UInt16),t.setVertexElements(c),t.addSubGeometry(0,i.length),this._vertexBuffer=u,this._vertexStride=24,this._vertices=n,t},a._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},a._updateSingleBuffer=function(e){var t=this._updateDirtyFlag,i=this._vertices,a=this._vertexStride,o=r._getRandom,s=4*e,c=s*a,u=(s+1)*a,l=(s+2)*a,d=(s+3)*a;if(t&Ei.Position){var h=this._position,f=h.x,_=h.y,p=h.z,g=this._positionArray,v=this._positionRandomness;if(g){if(g.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var m=g[e];f+=m.x,_+=m.y,p+=m.z}else f+=o()*v.x,_+=o()*v.y,p+=o()*v.z;i[c]=i[u]=i[l]=i[d]=f,i[c+1]=i[u+1]=i[l+1]=i[d+1]=_,i[c+2]=i[u+2]=i[l+2]=i[d+2]=p}if(t&Ei.Velocity){var y=this._velocity,x=this._velocityRandomness;i[c+3]=i[u+3]=i[l+3]=i[d+3]=y.x+o()*x.x,i[c+4]=i[u+4]=i[l+4]=i[d+4]=y.y+o()*x.y,i[c+5]=i[u+5]=i[l+5]=i[d+5]=y.z+o()*x.z}if(t&Ei.Acceleration){var T=this._acceleration,b=this._accelerationRandomness;i[c+6]=i[u+6]=i[l+6]=i[d+6]=T.x+o()*b.x,i[c+7]=i[u+7]=i[l+7]=i[d+7]=T.y+o()*b.y,i[c+8]=i[u+8]=i[l+8]=i[d+8]=T.z+o()*b.z}if(t&Ei.Color){var A=this._color,w=this._colorRandomness;i[c+9]=i[u+9]=i[l+9]=i[d+9]=n.clamp(A.r+o()*w,0,1),i[c+10]=i[u+10]=i[l+10]=i[d+10]=n.clamp(A.g+o()*w,0,1),i[c+11]=i[u+11]=i[l+11]=i[d+11]=n.clamp(A.b+o()*w,0,1)}if(t&Ei.Apha&&(i[c+12]=i[u+12]=i[l+12]=i[d+12]=n.clamp(this._alpha+o()*this._alphaRandomness,0,1)),t&Ei.StartTime&&(i[c+13]=i[u+13]=i[l+13]=i[d+13]=Math.random()*this._startTimeRandomness),t&Ei.LifeTime){var C=this._lifetime;i[c+14]=i[u+14]=i[l+14]=i[d+14]=C+o()*C}if(t&Ei.Size){var M=this._size;i[c+15]=i[u+15]=i[l+15]=i[d+15]=Math.max(M+o()*this._sizeRandomness*M*2,0)}t&Ei.Scale&&(i[c+16]=i[u+16]=i[l+16]=i[d+16]=this._scale),t&Ei.StartAngle&&(i[c+17]=i[u+17]=i[l+17]=i[d+17]=this._startAngle+o()*Math.PI*this._startAngleRandomness*2),t&Ei.RotateVelocity&&(i[c+18]=i[u+18]=i[l+18]=i[d+18]=this._rotateVelocity+o()*this._rotateVelocityRandomness),this._updateSingleUv(e,c,u,l,d)},a._updateSingleUv=function(e,t,r,n,i){var a=this.spriteSheet,o=this._material.shaderData.getTexture("u_texture"),s=this._vertices;if(o){var c=o.width,u=o.height;if(a){var l=a[e%a.length],d=l.x,h=l.y,f=l.w,_=l.h,p=d/c,g=h/u,v=p+f/c,m=g+_/u,y=_/f;s[t+19]=p,s[t+20]=m,s[t+21]=y,s[r+19]=v,s[r+20]=m,s[r+21]=y,s[n+19]=v,s[n+20]=g,s[n+21]=y,s[i+19]=p,s[i+20]=g,s[i+21]=y}else{var x=u/c;s[t+19]=0,s[t+20]=1,s[t+21]=x,s[r+19]=1,s[r+20]=1,s[r+21]=x,s[n+19]=1,s[n+20]=0,s[n+21]=x,s[i+19]=0,s[i+20]=0,s[i+21]=x}}else s[t+19]=0,s[t+20]=0,s[t+21]=1,s[r+19]=1,s[r+20]=0,s[r+21]=1,s[n+19]=1,s[n+20]=1,s[n+21]=1,s[i+19]=0,s[i+20]=1,s[i+21]=1;s[t+22]=-.5,s[t+23]=-.5,s[r+22]=.5,s[r+23]=-.5,s[n+22]=.5,s[n+23]=.5,s[i+22]=-.5,s[i+23]=.5},T(r,[{key:"texture",get:function(){return this.material.shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.material.shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=Ei.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=Ei.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=Ei.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=Ei.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=Ei.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=Ei.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=Ei.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=Ei.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=Ei.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=Ei.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=Ei.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=Ei.Apha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=Ei.Apha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=Ei.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=Ei.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=Ei.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=Ei.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=Ei.LifeTime,this._lifetime=e}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=Ei.StartTime,this._startTimeRandomness=e}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=Ei.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=Ei.Everything,this.geometry=this._createGeometry(),this._updateBuffer(),this._isInit=!0}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(t){t?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.material.renderState.rasterState.cullMode=e.CullMode.Off),this._is2d=t}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(t){var r=this.material.renderState.blendState.targetBlendState;t===e.ParticleRendererBlendMode.Transparent?(r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha):t===e.ParticleRendererBlendMode.Additive&&(r.sourceColorBlendFactor=r.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=r.destinationAlphaBlendFactor=e.BlendFactor.One),this._blendMode=t}}]),r}(Ti);yt.create("trail","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}");var zi=function(t){function r(r){var n,i=(n=t.call(this,r,yt.find("trail"))||this).renderState.blendState.targetBlendState;return i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=e.BlendFactor.One,n.renderState.depthState.writeEnabled=!1,n}return C(r,t),r}(Ur),Di=new i,Ni=function(t){function r(e,r){var n;(n=t.call(this,e)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._stroke=void 0,n._minSeg=void 0,n._lifetime=void 0,n._maxPointNum=void 0,n._points=void 0,n._pointStates=void 0,n._strapPoints=void 0,n._curPointNum=void 0,n._prePointsNum=void 0,n._stroke=r.stroke||.2,n._minSeg=r.minSeg||.02,n._lifetime=r.lifetime||1e3,n._maxPointNum=n._lifetime/1e3*e.engine.targetFrameRate,n._points=[],n._pointStates=[],n._strapPoints=[];for(var a=0;a<n._maxPointNum;a++)n._points.push(new i),n._pointStates.push(n._lifetime),n._strapPoints.push(new i),n._strapPoints.push(new i);n._curPointNum=0;var o=r.material||new zi(n.engine);return n.material=o,n.setTexture(r.texture),n._initGeometry(),n}C(r,t);var n=r.prototype;return n.update=function(e){for(var t=0,r=0,n=0;n<this._curPointNum;n++)this._pointStates[n]-=e,this._pointStates[n]<0?t++:t>0&&(r=n-t,this._pointStates[r]=this._pointStates[n],this._points[n].cloneTo(this._points[r]));this._curPointNum-=t;var a=!0;if(this._curPointNum===this._maxPointNum)a=!1;else if(this._curPointNum>0){var o=this._points[this._points.length-1];i.distance(this.entity.worldPosition,o)<this._minSeg&&(a=!1)}a&&(this._pointStates[this._curPointNum]=this._lifetime,this.entity.worldPosition.cloneTo(this._points[this._curPointNum]),this._curPointNum++)},n.render=function(e){this._updateStrapVertices(e,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),t.prototype.render.call(this,e)},n.setTexture=function(e){e&&this.material.shaderData.setTexture("u_texture",e)},n._initGeometry=function(){var t=new xi(this._entity.engine),r=2*this._maxPointNum,n=20*r,i=new Float32Array(n),a=[new si("POSITION",0,e.VertexElementFormat.Vector3,0),new si("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0)],o=new $n(this.engine,4*n,e.BufferUsage.Dynamic);t.setVertexBufferBinding(o,20),t.setVertexElements(a),t.addSubGeometry(0,r,e.PrimitiveTopology.TriangleStrip),this._vertexBuffer=o,this._vertexStride=20,this._vertices=i,this.geometry=t},n._updateStrapVertices=function(e,t){var r=e.viewMatrix.elements,n=new i(r[0],r[4],r[8]),a=new i(r[1],r[5],r[9]),o=new i(r[2],r[6],r[10]),s=this._stroke;a.scale(s);var c=new i,u=new i,l=new d;i.transformByQuat(n,l,n),i.transformByQuat(a,l,a);var h=new i,f=new i,_=new i;n.normalize();for(var p=this._vertices,g=0;g<this._maxPointNum;g++){if(g<this._curPointNum){var v=t[g];g===this._curPointNum-1&&0!==g?i.subtract(v,t[g-1],_):i.subtract(t[g+1],v,_),this._projectOnPlane(_,o,_),_.normalize();var m=Math.acos(i.dot(n,_));i.cross(n,_,f),i.dot(f,o)<=0&&(m=2*Math.PI-m),d.rotationAxisAngle(o,m,l),i.transformByQuat(a,l,h),i.add(v,h,c),i.subtract(v,h,u)}var y=2*g*this._vertexStride/4,x=(2*g+1)*this._vertexStride/4;p[y]=c.x,p[y+1]=c.y,p[y+2]=c.z,p[x]=u.x,p[x+1]=u.y,p[x+2]=u.z}},n._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,t=1/e,r=this._vertices,n=0;n<e;n++){var i=1-n*t,a=2*n*this._vertexStride/4,o=(2*n+1)*this._vertexStride/4;r[a]=0,r[a+1]=i,r[o]=1,r[o+1]=i}}},n._projectOnVector=function(e,t,r){var n=t.clone();i.normalize(n,n);var a=i.dot(e,n);r.x=n.x*a,r.y=n.y*a,r.z=n.z*a},n._projectOnPlane=function(e,t,r){this._projectOnVector(e,t,Di),i.subtract(e,Di,r)},r}(Ti),Gi=function(e){function t(t){var r;return(r=e.call(this,t)||this)._center=new i,r._size=new i,r.isShowCollider=!0,r.center=r.center,r.size=r.size,r.isShowCollider=r.isShowCollider,r}return C(t,e),T(t,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,this.setBoxCenterSize(this._center,this._size)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this.setBoxCenterSize(this._center,this._size)}}]),t}(ln),Ui=function(e){function t(t){var r;return(r=e.call(this,t)||this).__center=new i,r.__radius=1,r.isShowCollider=!0,r._center=r._center,r._radius=r._radius,r.isShowCollider=r.isShowCollider,r}return C(t,e),T(t,[{key:"_center",get:function(){return this.__center},set:function(e){this.__center=e,this.setSphere(this.__center,this.__radius)}},{key:"_radius",get:function(){return this.__radius},set:function(e){this.__radius=e,this.setSphere(this.__center,this.__radius)}}]),t}(dn);function Vi(e,t){var r=e.center,n=new i(Math.max(t.min.x,Math.min(r.x,t.max.x)),Math.max(t.min.y,Math.min(r.y,t.max.y)),Math.max(t.min.z,Math.min(r.z,t.max.z)));return i.distance(r,n)<e.radius}zt.registerFeature(cn);var ki,Hi=function(e){function t(t){var r;return(r=e.call(this,t)||this)._colliderManager=void 0,r._myCollider=void 0,r._overlopCollider=void 0,r._sphere=void 0,r._box=new o,r.hasEvent=void 0,r.eventNames=void 0,r.listenerCount=void 0,r.dispatch=void 0,r.on=void 0,r.once=void 0,r.addEventListener=void 0,r.off=void 0,r.removeEventListener=void 0,r.removeAllEventListeners=void 0,r.trigger=void 0,r._clearEvent=void 0,r}C(t,e);var r=t.prototype;return r.onUpdate=function(t){e.prototype.onUpdate.call(this,t);var r=null;if(this._colliderManager&&this._myCollider){var n=this._colliderManager.colliders;if(this._myCollider instanceof ln){this._updateWorldBox(this._myCollider,this._box);for(var i=0,a=n.length;i<a;i++){var o=n[i];o!=this._myCollider&&this._boxCollision(o)&&(r=o,this.dispatch("collision",{collider:o}))}}else if(this._myCollider instanceof dn){this._sphere=this._getWorldSphere(this._myCollider);for(var s=0,c=n.length;s<c;s++){var u=n[s];u!=this._myCollider&&this._sphereCollision(u)&&(r=u,this.dispatch("collision",{collider:u}))}}}if(null!=r&&this._overlopCollider!=r&&this.dispatch("begin_overlop",{collider:r}),null!=this._overlopCollider&&this._overlopCollider!=r){var l=this._overlopCollider;this.dispatch("end_overlop",{collider:l})}this._overlopCollider=r},r._updateWorldBox=function(e,r){var n=e.entity.transform.worldMatrix,i=t._tempBox1;e.boxMax.cloneTo(i.max),e.boxMin.cloneTo(i.min),o.transform(i,n,r)},r._getWorldSphere=function(e){var t=new i;return i.transformCoordinate(e.center,e.entity.transform.worldMatrix,t),{radius:e.radius,center:t}},r._boxCollision=function(e){if(e instanceof ln){var r=t._tempBox2;return this._updateWorldBox(e,r),n=r,i=this._box,n.min.x<=i.max.x&&n.max.x>=i.min.x&&n.min.y<=i.max.y&&n.max.y>=i.min.y&&n.min.z<=i.max.z&&n.max.z>=i.min.z}var n,i;return e instanceof dn&&Vi(this._getWorldSphere(e),this._box)},r._sphereCollision=function(e){if(e instanceof ln){var r=t._tempBox2;return this._updateWorldBox(e,r),Vi(this._sphere,r)}if(e instanceof dn){var n=this._getWorldSphere(e);return a=n,o=this._sphere,i.distance(a.center,o.center)<a.radius+a.radius}var a,o;return!1},r.onAwake=function(){this._colliderManager=this.scene.findFeature(cn),this._myCollider=this.entity.getComponent(un)},T(t,[{key:"overlopCollider",get:function(){return this._overlopCollider}}]),t}(xr);Hi._tempVec3=new i,Hi._tempBox1=new o,Hi._tempBox2=new o,ki=Hi,[_e].forEach((function(e){Object.getOwnPropertyNames(e.prototype).forEach((function(t){ki.prototype[t]=e.prototype[t]}))}));var Wi=function(e){function t(t){var r;return(r=e.call(this,t)||this)._color=new y(1,0,0,1),r.color=r._color,r}C(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},r._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},T(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(t._colorProperty,e)}}]),t}(Qe);Wi._colorProperty=yt.getPropertyByName("u_fogColor");var ji=function(e){function t(t){var r;return(r=e.call(this,t)||this)._density=.0025,r.density=r._density,r}C(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.shaderData.enableMacro("O3_FOG_EXP2")},r._onDisable=function(){this.scene.shaderData.disableMacro("O3_FOG_EXP2")},T(t,[{key:"density",get:function(){return this._density},set:function(e){this._density=e,this.scene.shaderData.setFloat(t._densityProperty,e)}}]),t}(Wi);ji._densityProperty=yt.getPropertyByName("u_fogDensity");var Xi=function(e){function t(t){var r;return(r=e.call(this,t)||this)._near=1,r._far=1e3,r.near=r._near,r.far=r._far,r}return C(t,e),T(t,[{key:"near",get:function(){return this._near},set:function(e){this._near=e,this.scene.shaderData.setFloat(t._nearProperty,e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this.scene.shaderData.setFloat(t._farProperty,e)}}]),t}(Wi);Xi._nearProperty=yt.getPropertyByName("u_fogNear"),Xi._farProperty=yt.getPropertyByName("u_fogFar");var Ki=function(t){function r(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=t.call.apply(t,[this].concat(i))||this).probeLayer=e.Layer.Everything,r.width=1024,r.height=1024,r.antiAliasing=1,r._isCube=!1,r._oriCameraRenderTarget=void 0,r._renderTarget=void 0,r._renderTargetSwap=void 0,r._activeRenderTarget=void 0,r._camera=void 0,r._oriCameraCullingMask=void 0,r}C(r,t);var n=r.prototype;return n.onTextureChange=function(e){},n.onBeginRender=function(t){this.enabled&&(this._camera=t,this._oriCameraCullingMask=t.cullingMask,t.cullingMask=this.probeLayer,this._activeRenderTarget&&this._activeRenderTarget.width===this.width&&this._activeRenderTarget.height===this.height&&this._activeRenderTarget.antiAliasing===this.antiAliasing||(this._renderTarget=new Kn(this.engine,this.width,this.height,new qn(this.engine,this.width,this.height,void 0,void 0,this._isCube),e.RenderBufferDepthFormat.Depth,this.antiAliasing),this._renderTargetSwap=new Kn(this.engine,this.width,this.height,new qn(this.engine,this.width,this.height,void 0,void 0,this._isCube),e.RenderBufferDepthFormat.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=t.renderTarget,t.renderTarget=this._activeRenderTarget)},n.onEndRender=function(e){this.enabled&&(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},n._reset=function(){this.enabled&&(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},T(r,[{key:"_texture",get:function(){var e;return null===(e=this._activeRenderTarget)||void 0===e?void 0:e.getColorTexture()}}]),r}(xr),qi=new i,Yi=new i,Qi=new i,Ji=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return(e=t.call.apply(t,[this].concat(n))||this).position=new i(0,0,0),e._isCube=!0,e.oriViewMatrix=new h,e._oriFieldOfView=void 0,e}C(r,t);var n=r.prototype;return n.onBeginRender=function(r){if(this.enabled){t.prototype.onBeginRender.call(this,r),this._storeCamera(r);for(var n=0;n<6;n++)this._setCamera(n,r),r.render(e.TextureCubeFace.PositiveX+n);this._restoreCamera(r),t.prototype._reset.call(this)}},n._storeCamera=function(e){e.viewMatrix.cloneTo(this.oriViewMatrix),this._oriFieldOfView=e.fieldOfView},n._restoreCamera=function(e){this.oriViewMatrix.cloneTo(e.viewMatrix),e.fieldOfView=this._oriFieldOfView},n._setCamera=function(e,t){switch(e){case 0:Yi.setValue(0,-1,0),Qi.setValue(1,0,0);break;case 1:Yi.setValue(0,-1,0),Qi.setValue(-1,0,0);break;case 2:Yi.setValue(0,0,1),Qi.setValue(0,1,0);break;case 3:Yi.setValue(0,0,-1),Qi.setValue(0,-1,0);break;case 4:Yi.setValue(0,-1,0),Qi.setValue(0,0,1);break;case 5:Yi.setValue(0,-1,0),Qi.setValue(0,0,-1)}i.add(this.position,Qi,qi),h.lookAt(this.position,qi,Yi,t.viewMatrix),t.fieldOfView=90},r}(Ki),Zi=function(){function e(e,t){void 0===t&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new h,this.light=e;var r=t,n=r.engine,i=r.width,a=r.height;this._mapSize=new g(i,a),this._renderTarget=new Kn(n,i,a,new qn(n,i,a))}e._updateShaderData=function(t){var r=e._combinedData;t.setFloatArray(e._viewMatFromLightProperty,r.viewMatrix),t.setFloatArray(e._projMatFromLightProperty,r.projectionMatrix),t.setFloatArray(e._shadowBiasProperty,r.bias),t.setFloatArray(e._shadowIntensityProperty,r.intensity),t.setFloatArray(e._shadowRadiusProperty,r.radius),t.setFloatArray(e._shadowMapSizeProperty,r.mapSize),t.setTextureArray(e._shadowMapsProperty,r.map)},e.clearMap=function(){e._combinedData.map.length=0};var t=e.prototype;return t.initShadowProjectionMatrix=function(e){if(e instanceof bt&&h.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof wt&&h.perspective(n.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof Ct){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));h.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}},t.appendData=function(t){var r=16*t,n=16*t,i=t,a=t,o=t,s=2*t,c=t,u=e._combinedData;u.viewMatrix.set(this.light.viewMatrix.elements,r),u.projectionMatrix.set(this.projectionMatrix.elements,n),u.bias[i]=this.bias,u.intensity[a]=this.intensity,u.radius[o]=this.radius,u.mapSize[s]=this.mapSize.x,u.mapSize[s+1]=this.mapSize.y,u.map[c]=this.map},T(e,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),e}();Zi._viewMatFromLightProperty=yt.getPropertyByName("u_viewMatFromLight"),Zi._projMatFromLightProperty=yt.getPropertyByName("u_projMatFromLight"),Zi._shadowBiasProperty=yt.getPropertyByName("u_shadowBias"),Zi._shadowIntensityProperty=yt.getPropertyByName("u_shadowIntensity"),Zi._shadowRadiusProperty=yt.getPropertyByName("u_shadowRadius"),Zi._shadowMapSizeProperty=yt.getPropertyByName("u_shadowMapSize"),Zi._shadowMapsProperty=yt.getPropertyByName("u_shadowMaps"),Zi._maxLight=3,Zi._combinedData={viewMatrix:new Float32Array(16*Zi._maxLight),projectionMatrix:new Float32Array(16*Zi._maxLight),bias:new Float32Array(Zi._maxLight),intensity:new Float32Array(Zi._maxLight),radius:new Float32Array(Zi._maxLight),mapSize:new Float32Array(2*Zi._maxLight),map:[]},Object.defineProperty(xt.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof Tt)return this._enableShadow=!1,void xe.warn("Has no shadow!");this.shadow=this.shadow||new Zi(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Qe.prototype,"recieveShadow",{get:function(){return this._recieveShadow},set:function(e){this._recieveShadow=e}}),Object.defineProperty(Qe.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var $i=function(e){function t(t){var r;return(r=e.call(this,t,yt.find("shadow-map"))||this).shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),r}return C(t,e),t}(Ur),ea=function(e){function t(t,r,n,i,a,o){var s;return(s=e.call(this,t,r,n,i,a,new v(1,1,1,1))||this).light=void 0,s.light=o,s}return C(t,e),t.prototype.preRender=function(e,r){var n=this.replaceMaterial.shaderData;n.setMatrix(t._viewMatFromLightProperty,this.light.viewMatrix),n.setMatrix(t._projMatFromLightProperty,this.light.shadow.projectionMatrix)},t}(Kr);ea._viewMatFromLightProperty=yt.getPropertyByName("u_viewMatFromLight"),ea._projMatFromLightProperty=yt.getPropertyByName("u_projMatFromLight");var ta=function(t){function r(r){var n,i=(n=t.call(this,r,yt.find("shadow"))||this).renderState.blendState.targetBlendState;return i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=e.BlendFactor.DestinationColor,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=e.BlendFactor.Zero,n.renderState.depthState.compareFunction=e.CompareFunction.LessEqual,n.renderQueueType=e.RenderQueueType.Transparent,n}return C(r,t),r}(Ur),ra=function(t){function r(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=t.call.apply(t,[this].concat(i))||this).clearMode=e.ClearMode.DONT_CLEAR,r}return C(r,t),r.prototype.preRender=function(e,t){this.enabled=!1;var r=e.scene.findFeature(Mt).visibleLights,n=this.replaceMaterial.shaderData,i=e._renderPipeline.defaultRenderPass;this.renderTarget=i.renderTarget;var a=0;Zi.clearMap();for(var o=0,s=r.length;o<s;o++){var c=r[o];c.enableShadow&&c.shadow.appendData(a++)}a?(this.enabled=!0,Zi._updateShaderData(n),n.enableMacro("O3_SHADOW_MAP_COUNT",a.toString())):n.disableMacro("O3_SHADOW_MAP_COUNT")},r}(Kr),na=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this)._shadowPass=void 0,e._shadowMapMaterial=void 0,e}C(r,t);var n=r.prototype;return n.preRender=function(e,t){var r=e.findFeature(Mt).visibleLights;if(r.length>0){this._shadowPass||this.addShadowPass(t);for(var n=t._renderPipeline,i=0,a=r.length;i<a;i++){var o=r[i];o.enableShadow&&!o.shadowMapPass?o.shadowMapPass=this.addShadowMapPass(t,o):!o.enableShadow&&o.shadowMapPass&&(n.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null)}this.updatePassRenderFlag(n.queue)}},n.addShadowPass=function(t){var r=new ta(t.engine);this._shadowPass=new ra("ShadowPass",1,null,r,e.Layer.Layer30),t._renderPipeline.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(t,r){this._shadowMapMaterial=this._shadowMapMaterial||new $i(t.engine);var n=new ea("ShadowMapPass",-1,r.shadow.renderTarget,this._shadowMapMaterial,e.Layer.Layer31,r);return t._renderPipeline.addRenderPass(n),n},n.updatePassRenderFlag=function(t){for(var r=t.items,n=0,i=r.length;n<i;n++){var a=r[n].component,o=a.recieveShadow,s=a.castShadow;!0===o?a.entity.layer|=e.Layer.Layer30:!1===o&&(a.entity.layer&=~e.Layer.Layer30),!0===s?a.entity.layer|=e.Layer.Layer31:!1===s&&(a.entity.layer&=~e.Layer.Layer31)}},r}(ut);function ia(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}zt.registerFeature(na),zt.registerFeature(Mt),zt.prototype.hasLight=function(){return this.findFeature(Mt).visibleLights.length>0};var aa=function(){function e(e,t){var r=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(e),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t.geometry);break;case"error":r._callbacks[t.id].reject(t);break;default:xe.error('DRACOWorker: Unexpected message, "'+t.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var t,r,n,i=e.prototype;return i.setCosts=function(e,t){this._costs[e]=t},i.addCurrentLoad=function(e){this._currentLoad+=e},i.setCallback=function(e,t,r){this._callbacks[e]={resolve:t,reject:r}},i.decode=function(e,t,r){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:r},[r])},i.releaseTask=function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]},t=e,(r=[{key:"currentLoad",get:function(){return this._currentLoad}}])&&ia(t.prototype,r),n&&ia(t,n),e}(),oa='#define GLSLIFY 1\nlet decoderPending;let decoderConfig;onmessage=function(e){const message=e.data;switch(message.type){case "init":decoderConfig=message.decoderConfig;decoderPending=new Promise(function(resolve){decoderConfig.onModuleLoaded=function(draco){resolve({draco: draco});};DracoDecoderModule(decoderConfig);});break;case "decode":const buffer=message.buffer;const taskConfig=message.taskConfig;decoderPending.then(module=>{const draco=module.draco;const decoder=new draco.Decoder();const decoderBuffer=new draco.DecoderBuffer();decoderBuffer.Init(new Int8Array(buffer),buffer.byteLength);try{const geometry=decodeGeometry(draco,decoder,decoderBuffer,taskConfig);const buffers=geometry.attributes.map(attr=>attr.array.buffer);if(geometry.index)buffers.push(geometry.index.array.buffer);self.postMessage({type: "decode",id: message.id,geometry},buffers);}catch(error){console.error(error);self.postMessage({type: "error",id: message.id,error: error.message});}finally{draco.destroy(decoderBuffer);draco.destroy(decoder);}});break;}};function decodeGeometry(draco,decoder,decoderBuffer,taskConfig){const attributeIDs=taskConfig.attributeIDs;const attributeTypes=taskConfig.attributeTypes;let dracoGeometry;let decodingStatus;const geometryType=decoder.GetEncodedGeometryType(decoderBuffer);if(geometryType===draco.TRIANGULAR_MESH){dracoGeometry=new draco.Mesh();decodingStatus=decoder.DecodeBufferToMesh(decoderBuffer,dracoGeometry);}else{throw new Error("DRACODecoder worker: Unexpected geometry type.");}if(!decodingStatus.ok()||dracoGeometry.ptr===0){throw new Error("DRACODecoder worker: Decoding failed: "+decodingStatus.error_msg());}const geometry={index: null,attributes:[]};for(let attributeName in attributeIDs){const attributeType=self[attributeTypes[attributeName]];let attribute;let attributeID;if(taskConfig.useUniqueIDs){attributeID=attributeIDs[attributeName];attribute=decoder.GetAttributeByUniqueId(dracoGeometry,attributeID);}else{attributeID=decoder.GetAttributeId(dracoGeometry,draco[attributeIDs[attributeName]]);if(attributeID===-1)continue;attribute=decoder.GetAttribute(dracoGeometry,attributeID);}geometry.attributes.push(decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute));}if(geometryType===draco.TRIANGULAR_MESH){const numFaces=dracoGeometry.num_faces();const numIndices=numFaces*3;let dataSize;let ptr;let index;const indexType=self[taskConfig.indexType];switch(indexType){case Uint16Array:dataSize=numIndices*2;ptr=draco._malloc(dataSize);decoder.GetTrianglesUInt16Array(dracoGeometry,dataSize,ptr);index=new Uint16Array(draco.HEAPU16.buffer,ptr,numIndices).slice();draco._free(ptr);break;case Uint32Array:dataSize=numIndices*4;ptr=draco._malloc(dataSize);decoder.GetTrianglesUInt32Array(dracoGeometry,dataSize,ptr);index=new Uint32Array(draco.HEAPU32.buffer,ptr,numIndices).slice();draco._free(ptr);default:throw new Error("DRACODecoder: Unexpected index type.");}geometry.index={array: index,itemSize: 1};}draco.destroy(dracoGeometry);return geometry;}function decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute){const numComponents=attribute.num_components();const numPoints=dracoGeometry.num_points();const numValues=numPoints*numComponents;let ptr;let array;let dataSize;switch(attributeType){case Float32Array:dataSize=numValues*4;ptr=draco._malloc(dataSize);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_FLOAT32,dataSize,ptr);array=new Float32Array(draco.HEAPF32.buffer,ptr,numValues).slice();draco._free(ptr);break;case Int8Array:ptr=draco._malloc(numValues);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT8,numValues,ptr);array=new Int8Array(draco.HEAP8.buffer,ptr,numValues).slice();draco._free(ptr);break;case Int16Array:dataSize=numValues*2;ptr=draco._malloc(dataSize);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT16,dataSize,ptr);array=new Int16Array(draco.HEAP16.buffer,ptr,numValues).slice();draco._free(ptr);break;case Int32Array:dataSize=numValues*4;ptr=draco._malloc(dataSize);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_INT32,dataSize,ptr);array=new Int32Array(draco.HEAP32.buffer,ptr,numValues).slice();draco._free(ptr);break;case Uint8Array:ptr=draco._malloc(numValues);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT8,numValues,ptr);array=new Uint8Array(draco.HEAPU8.buffer,ptr,numValues).slice();draco._free(ptr);break;case Uint16Array:dataSize=numValues*2;ptr=draco._malloc(dataSize);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT16,dataSize,ptr);array=new Uint16Array(draco.HEAPU16.buffer,ptr,numValues).slice();draco._free(ptr);break;case Uint32Array:dataSize=numValues*4;ptr=draco._malloc(dataSize);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,draco.DT_UINT32,dataSize,ptr);array=new Uint32Array(draco.HEAPU32.buffer,ptr,numValues).slice();draco._free(ptr);break;default:throw new Error("DRACODecoder: Unexpected attribute type.");}return{name: attributeName,array: array,itemSize: numComponents};}',sa="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",ca=function(){function e(e){var t;(void 0===e&&(e={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,e.workerLimit>this.workerLimit)?xe.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+e.workerLimit):this.workerLimit=null!=(t=e.workerLimit)?t:4;this.useJS="object"!=typeof WebAssembly||"js"===e.type,this.loadLibPromise=this.preloadLib()}var t=e.prototype;return t.preloadLib=function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,r){e.useJS?tn(sa+"draco_decoder_gltf.js",{type:"text"}).then((function(e){var r=[e,oa].join("\n"),n=URL.createObjectURL(new Blob([r]));t({workerSourceURL:n,decoderWASMBinary:null})})).catch((function(e){r(e)})):Promise.all([tn(sa+"draco_wasm_wrapper_gltf.js",{type:"text"}),tn(sa+"draco_decoder_gltf.r3bin",{type:"arraybuffer"})]).then((function(e){var r=e[0],n=e[1],i=[r,oa].join("\n"),a=URL.createObjectURL(new Blob([i]));t({workerSourceURL:a,decoderWASMBinary:n})})).catch((function(e){r(e)}))}))},t.getWorker=function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var r=new aa(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(r)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))},t.decode=function(e,t){var r=this,n=JSON.stringify(t);if(this.taskCache.has(e)){var i=this.taskCache.get(e);if(i.key===n)return i.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,c=new Promise((function(n,i){r.getWorker().then((function(r){a=r,r.setCosts(o,s),r.addCurrentLoad(s),r.setCallback(o,n,i),r.decode(o,t,e)})).catch((function(e){i(e)}))}));return c.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:n,promise:c}),c},e}();function ua(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function la(e,t,r){return t&&ua(e.prototype,t),r&&ua(e,r),e}function da(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ha(){return(ha=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function fa(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?fa(Object(r),!0).forEach((function(t){da(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):fa(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function pa(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ga(e,t)}function ga(e,t){return(ga=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function va(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function ma(e,t,r){return(ma=va()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&ga(i,r.prototype),i}).apply(null,arguments)}function ya(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function xa(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ta(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return xa(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?xa(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function ba(e,t,r,n,i){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=r.slice().reverse().reduce((function(r,n){return n(e,t,r)||r}),a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}U(e.AssetType.Buffer,["bin","r3bin"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return pa(t,e),t.prototype.load=function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new z((function(e){var r=t.slice(13+RegExp.$1.length);e(Uint8Array.from(atob(r),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,_a(_a({},e),{},{type:"arraybuffer"}))},t}(sn));var Aa,wa={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Ca(e){return{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}[e]}function Ma(e){return wa[e]}function Sa(e,t,r){var n,i,a=e.bufferViews[t.bufferView],o=r[a.buffer],s=t.hasOwnProperty("byteOffset")?t.byteOffset:0,c=a.hasOwnProperty("byteOffset")?a.byteOffset:0,u=s+c,l=Ca(t.type),d=l*t.count,h=null!=(n=a.byteStride)?n:0,f=Ma(t.componentType);if(h){i=new Uint8Array(d*f.BYTES_PER_ELEMENT);for(var _=new Uint8Array(o,c,a.byteLength),p=0,g=l*f.BYTES_PER_ELEMENT,v=0;v<t.count;v++){p=v*h+s;for(var m=0;m<g;m++)i[v*g+m]=_[p+m]}}else i=new Uint8Array(o,u,d*f.BYTES_PER_ELEMENT),i=new Uint8Array(i);return new f(i.buffer)}function Pa(e,t){var r=t[e.buffer],n=e.byteOffset||0;return r.slice(n,n+e.byteLength)}function Ra(e){return Ca(e.type)*Ma(e.componentType).BYTES_PER_ELEMENT}function La(t,r,n,i){var a=Ca(n.type);return new si(r,0,function(t,r){if(t==e.DataType.FLOAT)switch(r){case 1:return e.VertexElementFormat.Float;case 2:return e.VertexElementFormat.Vector2;case 3:return e.VertexElementFormat.Vector3;case 4:return e.VertexElementFormat.Vector4}if(t==e.DataType.UNSIGNED_SHORT)switch(r){case 2:return e.VertexElementFormat.UShort2;case 4:return e.VertexElementFormat.UShort4}}(n.componentType,a),i)}function Ea(e,t){return new Promise((function(r,n){var i=new window.Blob([e],{type:t}),a=new Image;a.src=URL.createObjectURL(i),a.crossOrigin="anonymous",a.onerror=function(){n(new Error("Failed to load image buffer"))},a.onload=function(){requestAnimationFrame((function(){r(a)}))}}))}function Oa(e,t){return/^(?:http|blob|data:|\/)/.test(t)?t:e.substring(0,e.lastIndexOf("/")+1)+t}var Fa={init:function(){Aa||(Aa=new ca)},parse:function(e,t,r,n){var i=r.bufferViews,a=r.accessors,o=e.bufferView,s=e.attributes,c={},u={};for(var l in s)c[l]=s[l];for(var d in t.attributes)if(void 0!==s[d]){var h=a[t.attributes[d]];u[d]=Ma(h.componentType).name}var f={attributeIDs:c,attributeTypes:u,useUniqueIDs:!0,indexType:Ma(a[t.indices].componentType).name},_=Pa(i[o],n);return Aa.decode(_,f).then((function(e){return e}))}},Ia={translation:"position",rotation:"rotation",scale:"scale",weights:"weights"},Ba=0,za={},Da={},Na=function(e){var t=new Vr(e);return t.emissiveColor=new y(.749,.749,.749,1),t},Ga="KHR_lights",Ua="KHR_draco_mesh_compression",Va=null,ka={KHR_lights:Va,KHR_materials_unlit:jr,KHR_materials_pbrSpecularGlossiness:Wr,KHR_techniques_webgl:Ur,KHR_draco_mesh_compression:Fa};var Ha=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).defaultSceneRoot=void 0,t.defaultScene=void 0,t.scenes=void 0,t.textures=void 0,t.animations=void 0,t.materials=void 0,t.meshes=void 0,t.skins=void 0,t.cameras=void 0,t.meta=void 0,t}return pa(t,e),t}(fe);function Wa(e,t){var r={engine:t,gltf:e.gltf,buffers:e.buffers,asset:new Ha(t)};return r.asset.textures=e.textures,r.asset.meta=e.gltf,r.gltf.asset&&r.gltf.asset.version&&(r.gltf.version=Number(r.gltf.asset.version),r.gltf.isGltf2=r.gltf.version>=2&&r.gltf.version<=3),function(e){var t=e.gltf,r=e.asset,n=t.extensions,i=t.extensionsUsed,a=t.extensionsRequired;if(i){xe.info("extensionsUsed: ",i);for(var o=0;o<i.length;o++)Object.keys(ka).indexOf(i[o])>-1?ka[i[o]]||xe.warn("extension "+i[o]+" is used, you can add this extension into gltf"):xe.warn("extensionsUsed has unsupported extension "+i[o])}if(a){xe.info("extensionsRequired: "+a);for(var s=0;s<a.length;s++)(Object.keys(ka).indexOf(a[s])<0||!ka[a[s]])&&xe.error("model has not supported required extension "+a[s]),a[s]===Ua&&ka.KHR_draco_mesh_compression.init()}n&&Va&&n.KHR_lights&&(r.lights=Va.parseLights(n.KHR_lights.lights))}(r),ja(r,"materials",Xa).then((function(){return ja(r,"meshes",Ya)})).then((function(){return ja(r,"nodes",Ja)})).then((function(){return ja(r,"scenes",Za)})).then((function(){return ja(r,"skins",Ka)})).then((function(){return ja(r,"animations",Qa)})).then((function(){return function(e){var t,r=e.asset,n=e.gltf,i=n.nodes||[],a=n.meshes;r.defaultScene=$a("scenes",null!=(t=n.scene)?t:0,e);for(var o=i.length-1;o>=0;o--){var s=i[o],c=$a("nodes",o,e);if(s.hasOwnProperty("children"))for(var u=s.children||[],l=u.length-1;l>=0;l--){var d=$a("nodes",u[l],e);c.addChild(d)}if(s.hasOwnProperty("mesh")){var h=s.mesh;c.meshIndex=h;var f=a[h].primitives,_=$a("meshes",h,e),p=void 0;if(s.hasOwnProperty("skin")||_.hasOwnProperty("weights")){var g=$a("skins",s.skin,e),v=_.weights,m=c.addComponent(Un);m.mesh=_,m.skin=g,m.setWeights(v),p=m}else(p=c.addComponent(Nn)).mesh=_;for(var y=0,x=f.length;y<x;y++){var T=f[y].material;_.primitives[y].materialIndex=T;var b=void 0!==T?$a("materials",T,e):Na(c.engine);p.setSharedMaterial(y,b)}}}var A=r.defaultScene.nodes;if(1===A.length)r.defaultSceneRoot=A[0];else{for(var w=new $e(e.engine),C=0;C<A.length;C++)w.addChild(A[C]);r.defaultSceneRoot=w}var M=r.defaultSceneRoot.addComponent(yi),S=r.animations;S&&S.forEach((function(e){M.addAnimationClip(e,e.name)}));return e.asset}(r)}))}function ja(e,t,r){var n=e.gltf,i=e.asset;if(i[t]||(i[t]=[]),n.hasOwnProperty(t)){var a=n[t]||[];xe.debug(t+":",a);for(var o=[],s=a.length-1;s>=0;s--)o.push(r(a[s],e));return Promise.all(o).then((function(e){for(var r=0;r<e.length;r++)i[t].push(e[r])}))}return Promise.resolve()}function Xa(t,r){var n=r.gltf,i=r.engine;if(n.isGltf2&&void 0===t.technique){var a=t.extensions,o=void 0===a?{}:a,s=t.pbrMetallicRoughness,c=t.normalTexture,u=t.emissiveTexture,l=t.emissiveFactor,d=t.occlusionTexture,h=t.alphaMode,f=t.alphaCutoff,_=t.doubleSided,p=o.KHR_materials_unlit,g=o.KHR_materials_pbrSpecularGlossiness,v=null;switch((v=p?new jr(i):g?new Wr(i):new Hr(i)).doubleSided=_,h){case"OPAQUE":v.alphaMode=e.AlphaMode.Opaque;break;case"BLEND":v.alphaMode=e.AlphaMode.Blend;break;case"MASK":v.alphaMode=e.AlphaMode.CutOff,v.alphaCutoff=void 0===f?.5:f}if(s){var m=s.baseColorFactor,x=s.baseColorTexture,T=s.metallicFactor,b=s.roughnessFactor,A=s.metallicRoughnessTexture;x&&(v.baseColorTexture=$a("textures",x.index||0,r,!1)),m&&(v.baseColor=ma(y,m)),p||((v=v).metallicFactor=void 0!==T?T:1,v.roughnessFactor=void 0!==b?b:1,A&&(v.metallicRoughnessTexture=$a("textures",A.index||0,r,!1)))}if(p)return Promise.resolve(v);if(v=v,u&&(v.emissiveTexture=$a("textures",u.index||0,r,!1)),l&&(v.emissiveColor=ma(y,l)),c){var w=c.index;c.texCoord;var C=c.scale;(v=v).normalTexture=$a("textures",w||0,r,!1),void 0!==typeof C&&(v.normalScale=C)}if(d&&((v=v).occlusionTexture=$a("textures",d.index||0,r,!1),void 0!==d.strength&&(v.occlusionStrength=d.strength)),g){var M=o.KHR_materials_pbrSpecularGlossiness,S=M.diffuseFactor,P=M.diffuseTexture,R=M.specularFactor,L=M.glossinessFactor,E=M.specularGlossinessTexture;v=v,S&&(v.baseColor=ma(y,S)),P&&(v.baseColorTexture=$a("textures",P.index||0,r,!1)),R&&(v.specularColor=ma(y,R)),void 0!==L&&(v.glossinessFactor=L),E&&(v.specularGlossinessTexture=$a("textures",E.index||0,r,!1))}return Promise.resolve(v)}var O=t.technique;if(xe.warn("Deprecated: Please use a model that meets the glTF 2.0 specification"),"Texture"===O){var F=new jr(i),I=t.values._MainTex[0];return F.baseColorTexture=$a("textures",I||0,r,!1),Promise.resolve(F)}return Promise.resolve()}function Ka(e,t){for(var r=t.gltf,n=t.buffers,i=e.joints.length,a=new wn(e.name),o=Sa(r,r.accessors[e.inverseBindMatrices],n),s=0;s<i;s++){var c=16*s,u=c+16;a.inverseBindMatrices[s]=ma(h,o.subarray(c,u))}for(var l=0;l<i;l++){var d=$a("nodes",e.joints[l],t);a.joints[l]=d.name}var f=$a("nodes",null==e.skeleton?e.joints[0]:e.skeleton,t);return a.skeleton=f.name,Promise.resolve(a)}function qa(t,r,n,a,o,s,c,u){var l=0,d=[];for(var h in a.attributes){var f=a.attributes[h],_=o.accessors[f],p=Ra(_),g=La(0,h,_,l);d.push(g);var v=s(h),m=new $n(u,e.BufferBindFlag.VertexBuffer,v.byteLength,e.BufferUsage.Static);if(m.setData(v),r.setVertexBufferBinding(m,p,l++),"POSITION"==g.semantic)for(var y=new i,x=v.length/3,T=t.bounds,b=T.min,A=T.max,w=0;w<x;w++){var C=3*w;y.setValue(v[C],v[C+1],v[C+2]),i.min(b,y,b),i.max(A,y,A)}}r.setVertexElements(d);var M=o.accessors[a.indices],S=c(),P=M.count,R=function(t){switch(t){case e.DataType.UNSIGNED_BYTE:return e.IndexFormat.UInt8;case e.DataType.UNSIGNED_SHORT:return e.IndexFormat.UInt16;case e.DataType.UNSIGNED_INT:return e.IndexFormat.UInt32}}(M.componentType),L=R==e.IndexFormat.UInt32?4:R==e.IndexFormat.UInt16?2:1,E=new $n(u,e.BufferBindFlag.IndexBuffer,P*L,e.BufferUsage.Static);return E.setData(S),r.setIndexBufferBinding(new ei(E,R)),n.start=0,n.count=P,Promise.resolve(r)}function Ya(t,r){for(var n=r.gltf,i=r.buffers,a=r.engine,o=new An(t.name),s=[],c=[],u=function(u){s.push(new Promise((function(s,l){var d,h=t.primitives[u],f=new ri(a,h.name||t.name||u),_=new ci;if(c.push(_),_.topology=null==h.mode?e.PrimitiveTopology.Triangles:h.mode,h.hasOwnProperty("targets")&&(f.targets=[],o.weights=t.weights||new Array(h.targets.length).fill(0)),h.extensions&&h.extensions[Ua]){var p=ka.KHR_draco_mesh_compression,g=h.extensions[Ua];d=p.parse(g,h,n,i).then((function(e){return qa(o,f,_,h,n,(function(t){for(var r=0;r<e.attributes.length;r++)if(e.attributes[r].name===t)return e.attributes[r].array;return null}),(function(){return e.index.array}),r.engine)}))}else d=qa(o,f,_,h,n,(function(e){var t=h.attributes[e],r=n.accessors[t];return Sa(n,r,i)}),(function(){var e=n.accessors[h.indices];return Sa(n,e,i)}),r.engine);d.then((function(e){s(e)})).catch((function(e){l(e)}))})))},l=0;l<t.primitives.length;l++)u(l);return Promise.all(s).then((function(e){for(var t=0;t<e.length;t++)o.primitives.push(e[t]),o.groups.push(c[t]);return o}))}function Qa(t,r){for(var n=r.gltf,i=r.buffers,a=t.samplers||[],o=t.channels||[],s=n.animations.indexOf(t),c=new li(t.name||"Animation"+s),u=-1,l=-1,d=0;d<a.length;d++){var h=a[d],f=n.accessors[h.input],_=n.accessors[h.output],p=Sa(n,f,i),g=Sa(n,_,i),v=Ca(_.type);v*p.length!==g.length&&(v=g.length/p.length);var m=e.InterpolationType.LINEAR;switch(h.interpolation){case"CUBICSPLINE":m=e.InterpolationType.CUBICSPLINE;break;case"STEP":m=e.InterpolationType.STEP}var y=p[p.length-1];y>u&&(u=y,l=d),c.addSampler(p,g,v,m)}c.durationIndex=l,c.duration=u;for(var x=0;x<o.length;x++){var T=o[x],b=T.target,A=T.sampler,w=$a("nodes",b.node,r),C=Ia[b.path];c.addChannel(A,w.name,C)}return Promise.resolve(c)}function Ja(e,t){var r=new $e(t.engine,e.name||"GLTF_NODE_"+Ba++);if(e.hasOwnProperty("matrix")){var n=e.matrix,a=new h;a.setValueByArray(n);var o=new i,s=new i(1,1,1),c=new d;a.decompose(o,c,s),r.transform.position=o,r.transform.rotationQuaternion=c,r.transform.scale=s}else for(var u in Ia)if(e.hasOwnProperty(u)){var l=Ia[u];if("weights"===l)r[l]=e[u];else{var f=e[u],_=f.length,p=r[l];2===_?p.setValue(f[0],f[1]):3===_?p.setValue(f[0],f[1],f[2]):4===_&&p.setValue(f[0],f[1],f[2],f[3]),r[l]=p}}if(void 0!==e.camera){var g=t.gltf.cameras[e.camera],v=r.addComponent($r);if("orthographic"===g.type){v.isOrthographic=!0;var m=g.orthographic,y=m.ymag,x=m.xmag,T=m.zfar,b=m.znear;void 0!==b&&(v.nearClipPlane=b),void 0!==T&&(v.farClipPlane=T),y&&x&&(v.orthographicSize=Math.max(y,x)/2),void 0!==y&&x&&(v.orthographicSize=x/2),void 0!==x&&y&&(v.orthographicSize=y/2)}else{var A=g.perspective,w=A.aspectRatio,C=A.yfov,M=A.zfar,S=A.znear;void 0!==w&&(v.aspectRatio=w),void 0!==C&&(v.fieldOfView=C),void 0!==M&&(v.farClipPlane=M),void 0!==S&&(v.nearClipPlane=S)}}if(e.extensions&&Va&&e.extensions.KHR_lights){var P=e.extensions.KHR_lights.light;if(void 0!==P){var R=$a("lights",P,t);if(R)ha(r.addComponent(R.ability),R.props)}}return Promise.resolve(r)}function Za(e,t){for(var r=[],n=0;n<e.nodes.length;n++){var i=$a("nodes",e.nodes[n],t);r.push(i)}if(e.extensions&&Va&&e.extensions.KHR_lights){var a=e.extensions.KHR_lights.light;if(void 0!==a){var o=$a("lights",a,t);o&&r[0].addComponent(o.ability,o.props)}}return Promise.resolve({nodes:r})}function $a(e,t,r,n){void 0===n&&(n=!0);var i=r.asset,a=n?i[e].length-t-1:t;return i[e][a]}function eo(e){var t=1313821514,r=5130562,n=new DataView(e),i={magic:n.getUint32(0,!0),version:n.getUint32(4,!0),length:n.getUint32(8,!0)};if(1179937895!==i.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+i.magic.toString(16)),null;var a=n.getUint32(12,!0),o=n.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;for(var s=new Uint8Array(e,20,a),c=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",r=0,n=e.length;r<n;r++)t+=String.fromCharCode(e[r]);return decodeURIComponent(encodeURIComponent(t))}(s)),u=[],l=20+a;l<i.length;){if(a=n.getUint32(l,!0),(o=n.getUint32(l+4,!0))!==r)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;var d=l+8,h=e.slice(d,d+a);u.push(h),l+=a+8}return{gltf:c,buffers:u}}U(e.AssetType.Perfab,["gltf","glb"])(function(t){function r(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=t.call.apply(t,[this].concat(i))||this).baseUrl=void 0,r.requestGLTF=function(e,t){return r.request(e.url,_a(_a({},e),{},{type:"json"})).then((function(n){return r._loadGLTFResources(e,n,t)}))},r.requestGLB=function(e,t){return r.request(e.url,_a(_a({},e),{},{type:"arraybuffer"})).then(eo).then((function(r){return _a(_a({},r),{},{baseUrl:e.url,resourceManager:t})})).then(r._loadImages)},r._loadImages=function(t){var r=t.gltf,n=t.buffers,i=t.baseUrl,a=t.resourceManager;return r.images?Promise.all(r.images.map((function(t){var o=t.uri,s=t.bufferView,c=t.mimeType;return o?a.load({url:Oa(i,o),type:e.AssetType.Texture2D}):Ea(Pa(r.bufferViews[s],n),c).then((function(e){var t=new Gn(a.engine,e.width,e.height);return t.setImageSource(e),t.generateMipmaps(),t}))}))).then((function(e){return{gltf:r,buffers:n,textures:e}})):Promise.resolve({gltf:r,buffers:n})},r}pa(r,t);var n=r.prototype;return n.load=function(e,t){var r=this;return new z((function(n,i){(r.isGLB(e.url)?r.requestGLB:r.requestGLTF)(e,t).then((function(e){Wa(e,t.engine).then((function(e){n(e)}))})).catch((function(t){console.error(t),i("Error loading glTF JSON from "+e.url)}))}))},n.isGLB=function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)},n._loadGLTFResources=function(e,t,r){return this._loadBuffers(e.url,t,r).then(this._loadImages)},n._loadBuffers=function(t,r,n){return r.buffers?Promise.all(r.buffers.map((function(r){return r instanceof ArrayBuffer?Promise.resolve(r):n.load({url:Oa(t,r.uri),type:e.AssetType.Buffer})}))).then((function(e){return{buffers:e,gltf:r,baseUrl:t,resourceManager:n}})):Promise.resolve({baseUrl:t,gltf:r,resourceManager:n})},r}(sn)),U(e.AssetType.JSON,["json"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return pa(t,e),t.prototype.load=function(e){return this.request(e.url,_a(_a({},e),{},{type:"json"}))},t}(sn));var to=function(t,r,n,i){if(void 0===i&&(i=!1),!function(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}(t))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var a=Uint32Array.BYTES_PER_ELEMENT,o=new DataView(t,12,13*a),s=67305985===o.getUint32(0,!0),c={buffer:t,glType:o.getUint32(1*a,s),glTypeSize:o.getUint32(2*a,s),glFormat:o.getUint32(3*a,s),glInternalFormat:o.getUint32(4*a,s),glBaseInternalFormat:o.getUint32(5*a,s),pixelWidth:o.getUint32(6*a,s),pixelHeight:o.getUint32(7*a,s),pixelDepth:o.getUint32(8*a,s),numberOfArrayElements:o.getUint32(9*a,s),numberOfFaces:o.getUint32(10*a,s),numberOfMipmapLevels:o.getUint32(11*a,s),bytesOfKeyValueData:o.getUint32(12*a,s),loadType:0};if(0!==c.glType)throw new Error("only compressed formats currently supported");if(c.numberOfMipmapLevels=Math.max(1,c.numberOfMipmapLevels),0===c.pixelHeight||0!==c.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==c.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(c.numberOfFaces!==r)throw new Error("number of faces expected"+r+", but found "+c.numberOfFaces);return n&&(c.mipmaps=function(e,t){for(var r=[],n=64+e.bytesOfKeyValueData,i=e.pixelWidth,a=e.pixelHeight,o=t?e.numberOfMipmapLevels:1,s=0;s<o;s++){var c=new Int32Array(e.buffer,n,1)[0];n+=4;for(var u=0;u<e.numberOfFaces;u++){var l=new Uint8Array(e.buffer,n,c);r.push({data:l,width:i,height:a}),n+=c,n+=3-(c+3)%4}i=Math.max(1,.5*i),a=Math.max(1,.5*a)}return r}(c,!0)),i&&(c.engineFormat=function(t){switch(t){case e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT:return e.TextureFormat.DXT1;case e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT:return e.TextureFormat.DXT5;case e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL:return e.TextureFormat.ETC1_RGB;case e.GLCompressedTextureInternalFormat.RGB8_ETC2:return e.TextureFormat.ETC2_RGB;case e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return e.TextureFormat.ETC2_RGBA5;case e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC:return e.TextureFormat.ETC2_RGBA8;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGB2;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA2;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGB4;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR:return e.TextureFormat.ASTC_4x4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR:return e.TextureFormat.ASTC_5x5;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR:return e.TextureFormat.ASTC_6x6;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR:return e.TextureFormat.ASTC_8x8;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR:return e.TextureFormat.ASTC_10x10;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR:return e.TextureFormat.ASTC_12x12;default:var r=e.GLCompressedTextureInternalFormat[t];throw new Error("this format is not supported in Oasis Engine: "+r)}}(c.glInternalFormat)),c};function ro(e){var t=to(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}U(e.AssetType.KTXCube,[])(function(t){function r(){return t.apply(this,arguments)||this}return pa(r,t),r.prototype.load=function(t,r){var n=this;return new z((function(i,a){Promise.all(t.urls.map((function(e){return n.request(e,_a(_a({},t),{},{type:"arraybuffer"}))}))).then((function(t){for(var n=function(e){for(var t,r,n,i,a=[],o=0;o<e.length;o++){var s=to(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(n=s.pixelWidth,i=s.pixelHeight,t=s.glInternalFormat,r=s.engineFormat)}return{mipmapsFaces:a,engineFormat:r,internalFormat:t,width:n,height:i}}(t),a=n.width,o=n.mipmapsFaces,s=n.engineFormat,c=o[0].length>1,u=new jn(r.engine,a,s,c),l=0;l<6;l++)for(var d=o[l].length,h=0;h<d;h++){var f=o[l][h],_=f.data,p=f.width,g=f.height;u.setPixelBuffer(e.TextureCubeFace.PositiveX+l,_,h,0,0,p,g)}i(u)})).catch((function(e){a(e)}))}))},r}(sn)),U(e.AssetType.KTX,["ktx"])(function(e){function t(){return e.apply(this,arguments)||this}return pa(t,e),t.prototype.load=function(e,t){var r=this;return new z((function(n,i){r.request(e.url,_a(_a({},e),{},{type:"arraybuffer"})).then((function(e){for(var r=ro(e),i=r.width,a=r.height,o=r.mipmaps,s=r.engineFormat,c=o.length>1,u=new Gn(t.engine,i,a,s,c),l=0;l<o.length;l++){var d=o[l],h=d.width,f=d.height,_=d.data;u.setPixelBuffer(_,l,0,0,h,f)}n(u)})).catch((function(e){i(e)}))}))},t}(sn)),U(e.AssetType.Texture2D,["png","jpg","webp","jpeg"])(function(e){function t(){return e.apply(this,arguments)||this}return pa(t,e),t.prototype.load=function(e,t){var r=this;return new z((function(n,i){r.request(e.url,_a(_a({},e),{},{type:"image"})).then((function(r){var i=new Gn(t.engine,r.width,r.height);if(i._glTexture){if(i.setImageSource(r),i.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");i.name=a[a.length-1]}n(i)}})).catch((function(e){i(e)}))}))},t}(sn)),U(e.AssetType.TextureCube,[""])(function(t){function r(){return t.apply(this,arguments)||this}return pa(r,t),r.prototype.load=function(t,r){var n=this;return new z((function(i,a){Promise.all(t.urls.map((function(e){return n.request(e,_a(_a({},t),{},{type:"image"}))}))).then((function(t){var n=t[0],a=n.width;if(a===n.height){var o=new jn(r.engine,a);if(o._glTexture){for(var s=0;s<6;s++)o.setImageSource(e.TextureCubeFace.PositiveX+s,t[s],0);o.generateMipmaps(),i(o)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){a(e)}))}))},r}(sn));var no=function(e){function t(t){var r;return(r=e.call(this,t)||this)._animator=void 0,r.animationsNames=void 0,r._asset=void 0,r.GLTFNode=void 0,r._loop=void 0,r._autoPlay=void 0,r._hasBuiltNode=!1,r}pa(t,e);var r=t.prototype;return r.init=function(e){var t=e.asset,r=void 0===t?null:t,n=e.autoPlay,i=e.loop;if(e.isClone){var a=e.gltfRootName;a&&(this.GLTFNode=this.entity.findByName(a))}if(this.GLTFNode)this._hasBuiltNode=!0;else{var o="GLTF-"+Date.now();e.gltfRootName=o,this.GLTFNode=this.entity.createChild(o),this._hasBuiltNode=!1}this.asset=r,this.loop=i,this.autoPlay=n},r._onEnable=function(){this.GLTFNode&&(this.GLTFNode.isActive=!0)},r._onDisable=function(){this.GLTFNode&&(this.GLTFNode.isActive=!1)},la(t,[{key:"asset",get:function(){return this._asset},set:function(e){e&&e.defaultSceneRoot===this.GLTFNode||(this._hasBuiltNode||(this.GLTFNode.clearChildren(),null!==e&&(this.GLTFNode&&this.GLTFNode.destroy(),this.GLTFNode=e.defaultSceneRoot.clone(),this._animator=this.GLTFNode.getComponent(yi),this.entity.addChild(this.GLTFNode))),this._asset=e)}},{key:"animator",get:function(){return this._animator}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._animator&&(e?this._animator.playAnimationClip(e,{wrapMode:this._loop}):this._animator.stop(!1)),this._autoPlay=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._animator&&this.autoPlay&&this._animator.playAnimationClip(this._autoPlay,{wrapMode:e}),this._loop=e}}]),t}(Qe),io=function(){function e(){this.registeredPlugins=new Set,this.plugins=[]}var t=e.prototype;return t.register=function(e){this.registeredPlugins.add(e)},t.boot=function(e){for(var t,r=Ta(this.registeredPlugins.values());!(t=r()).done;){var n=t.value;"function"==typeof n&&(n=n(e)),this.plugins.push(n)}},t.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},t.nodeAdded=function(e){this.delegateMethod("nodeAdded",e)},t.delegateMethod=function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.plugins.forEach((function(t){return t[e]&&t[e].apply(t,r)}))},e}();function ao(e){return function(t,r,n){var i=n.value;n.value=function(){for(var t,r=this,n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];return e.before&&(t=this.oasis.pluginManager).delegateMethod.apply(t,[e.before].concat(a)),Promise.resolve(i.apply(this,arguments)).then((function(t){return e.after&&r.oasis.pluginManager.delegateMethod(e.after,t),t}))}}}function oo(e,t,r){if(t!==r&&null!=r){var n=[e[r],e[t]];e[t]=n[0],e[r]=n[1]}}function so(e){return e&&"asset"===e.type}function co(e){for(var t=[],r=Object.getPrototypeOf(e),n=Object.getOwnPropertyDescriptors(r),i=0,a=Object.entries(n);i<a.length;i++){var o=a[i],s=o[0];"function"==typeof o[1].get&&t.push(s)}return t}var uo=function(){var e=t.prototype;function t(e,t){this.resourceManager=e,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}return e.setMeta=function(){},e.loadWithAttachedResources=function(e,t,r){var n=this;return new Promise((function(i,a){n.load(e,t,r).then((function(){i({resources:[n],structure:{index:0,props:{}}})})).catch((function(e){a(e)}))}))},e.getProps=function(){return{}},e.bind=function(){},e.attach=function(){},e.update=function(e,t){if(so(t)){var r=this.resourceManager.get(t.id);r?this._resource[e]=r.resource:xe.warn("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+t.id)}else this._resource[e]=t},e.updateMeta=function(e,t){this._meta[e]=t},e.onDestroy=function(){},la(t,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),t}(),lo=function(t){function r(){return t.apply(this,arguments)||this}pa(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return new Promise((function(a,o){var s,c,u,l,d=e.AssetType.Texture2D;if(i.resourceManager.useCompressedTexture&&null!=r&&null!==(s=r.props)&&void 0!==s&&null!==(c=s.compression)&&void 0!==c&&c.compressions.length)for(var h=n.engine._hardwareRenderer,f=r.props.compression.compressions,_=0;_<f.length;_++){var p=f[_];if("ktx"===p.container&&h.canIUse(e.GLCapabilityType[p.type])){l=p.url,d=e.AssetType.KTX;break}}l=null!=(u=l)?u:r.url,t.load({url:l,type:d}).then((function(e){i._resource=e,a(i)})).catch((function(e){o(e)}))}))},n.setMeta=function(){this.resource&&(this._meta.name=this.resource.name,this.resource.image&&(this._meta.url=this.resource.image.src))},r}(uo),ho=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}pa(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new Vr(e.engine);for(var a in r.configProps=t.props,r._resource=i,r.configProps)so(r.configProps[a])||(i[a]=r.configProps[a]);r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof Vr?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load BlinnPhongMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;co(r._resource).forEach((function(n){if(t[n]instanceof It){var i=new lo(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(so(n)){var i=e.resourceManager.get(n.id);i&&i instanceof lo?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,xe.warn("BlinnPhongMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(uo),fo=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}pa(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new Hr(e.engine);for(var a in r.configProps=t.props,r.configProps)so(r.configProps[a])||(i[a]=r.configProps[a]);r._resource=i,r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof Hr?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;co(r._resource).forEach((function(n){if(t[n]instanceof It){var i=new lo(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return co(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(so(n)){var i=e.resourceManager.get(n.id);i&&i instanceof lo?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,xe.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(uo),_o=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}pa(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new Wr(e.engine);for(var a in r.configProps=t.props,r._resource=i,r.configProps)so(r.configProps[a])||(i[a]=r.configProps[a]);r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof Wr?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRSpecularMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;co(r._resource).forEach((function(n){if(t[n]instanceof It){var i=new lo(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return co(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(so(n)){var i=e.resourceManager.get(n.id);i&&i instanceof lo?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,xe.warn("PBRSpecularMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(uo),po=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}pa(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new jr(e.engine);for(var a in r.configProps=t.props,r.configProps)so(r.configProps[a])||(i[a]=r.configProps[a]);r._resource=i,r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof jr?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;co(r._resource).forEach((function(n){if(t[n]instanceof It){var i=new lo(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return co(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(so(n)){var i=e.resourceManager.get(n.id);i&&i instanceof lo?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,xe.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(uo),go=function(t){function r(){return t.apply(this,arguments)||this}pa(r,t);var n=r.prototype;return n.load=function(t,r,n){var i,a=this;return null!==(i=r.props)&&void 0!==i&&i.compression&&Fa.init(),t.load({url:r.url,type:e.AssetType.Perfab}).then((function(e){var t=e;r.props&&(t.newMaterial=r.props.newMaterial),a._resource=t}))},n.loadWithAttachedResources=function(e,t,r){var n=this;return new Promise((function(i){n.load(e,t,r).then((function(){for(var t=n.resource.materials,r=[],a={resources:[n],structure:{index:0,props:{newMaterial:[]}}},o=0;o<t.length;o++){var s=t[o],c=null,u="";s instanceof Hr?(c=new fo(n.resourceManager),u="PBRMaterial"):s instanceof jr?(c=new po(n.resourceManager),u="UnlitMaterial"):s instanceof Wr?(c=new _o(n.resourceManager),u="PBRSpecularMaterial"):(c=new ho(n.resourceManager),u="BlinnPhongMaterial"),n._attachedResources.push(c),r.push(c.loadWithAttachedResources(e,{type:u,name:s.name,resource:s}))}Promise.all(r).then((function(e){var t=a.structure.props.newMaterial;e.forEach((function(e){var r=e.structure,n=e.resources[r.index];for(var i in a.resources.push(n),r.index=a.resources.length-1,r.props)if(r.props.hasOwnProperty(i)){var o=r.props[i],s=e.resources[o.index];a.resources.push(s),o.index=a.resources.length-1}t.push(r)})),i(a)}))}))}))},n.setMeta=function(e){e&&(this.meta.name=e.name)},n.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial)},n.update=function(e,t){"newMaterial"===e?this.bindMaterials(t):this._resource[e]=t},n.bindMaterials=function(e){if(e&&e.length){for(var t=this._resource,r=t.meshes,n=0;n<e.length;n++){var i=this.resourceManager.get(e[n].id);i?(this._attachedResources.push(i),t.materials[n]=i.resource):xe.warn("GLTFResource: "+this.meta.name+' can\'t find asset "material", which id is: '+e[n].id)}for(var a=0;a<r.length;a++){var o=this.getNodeByMeshIndex(t.nodes,r.length-1-a);if(o)for(var s=0;s<r[a].primitives.length;s++){var c=r[a].primitives[s],u=o.getComponent(Nn),l=t.materials[t.materials.length-1-c.materialIndex];u&&l&&l instanceof Ur&&u.setSharedMaterial(s,l)}}}},n.getNodeByMeshIndex=function(e,t){for(var r=0;r<=e.length;r++){var n=e[r];if(n.meshIndex===t)return n}return null},r}(uo),vo={};var mo,yo,xo,To,bo,Ao,wo,Co,Mo,So,Po,Ro=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).isInit=!1,t}pa(t,e);var r=t.prototype;return r.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:Xo._components.o3,script:function(e){return function(t){vo[e]=t}}})},r.load=function(e,t,r){var n=this;return this.initScriptContext(),new Promise((function(e){var i=t.props.scripts;if(n.resourceManager.isLocal){for(var a=0;a<i.length;a++){var o,s=i[a].name;vo[s]=null===(o=r.options)||void 0===o?void 0:o.scripts[s]}e(n)}else{var c=document.createElement("script");c.crossOrigin="anonymous",n.setMeta(t),c.onload=function(){for(var t=window.o3Scripts,r=0;r<i.length;r++){var a=i[r].name;n._resource=t&&t[a],vo[a]=n._resource}e(n)},c.src=t.url,document.body.appendChild(c)}}))},r.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},t}(uo),Lo={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Eo=function(t){function r(){return t.apply(this,arguments)||this}pa(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return new Promise((function(a,o){var s,c,u=[],l=e.AssetType.TextureCube;if(i.resourceManager.useCompressedTexture&&null!=r&&null!==(s=r.props)&&void 0!==s&&null!==(c=s.compression)&&void 0!==c&&c.compressions.length)for(var d=n.engine._hardwareRenderer,h=r.props.compression.compressions,f=0;f<h.length;f++){var _=h[f];if("ktx"===_.container&&d.canIUse(e.GLCapabilityType[_.type])){for(var p in _.files)if(_.files.hasOwnProperty(p)){var g=_.files[p];u[Lo[p]]=g.url}console.warn(_.type),l=e.AssetType.KTXCube;break}}if(l===e.AssetType.TextureCube)for(var v in r.props.images)if(r.props.images.hasOwnProperty(v)){var m=r.props.images[v];u[Lo[v]]=m.url}t.load({urls:u,type:l}).then((function(e){i._resource=e,a(i)})).catch((function(e){o(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r}(uo),Oo=function(e){function t(){return e.apply(this,arguments)||this}pa(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(e){r._resource=t,r.setMetaData("name",r.resource.name),r.setMetaData("url",r.resource.url),e(r)}))},r.setMetaData=function(e,t){this._meta[e]=t},t}(uo),Fo=(mo=ao({after:"abilityAdded",before:"beforeAbilityAdded"}),yo=ao({before:"beforeAbilityUpdated",after:"abilityUpdated"}),xo=ao({after:"abilityDeleted",before:"beforeAbilityDeleted"}),ba((To=function(){function e(e){this.oasis=e,this.abilityMap={}}var t=e.prototype;return t.add=function(e){var t=e.type,r=e.node,n=e.props,i=e.id,a=e.index,o=this.oasis.nodeManager.get(r),s=this.getCompConstructor(t);if(s){var c=this.mixPropsToExplicitProps(n),u=o.addComponent(s),l=c.enabled;if(void 0!==l&&(u.enabled=l),"Model"===t||"GLTFModel"===t)u.init(c);else for(var d in c)null!==c[d]&&(u[d]=c[d]);var h=o._components;return oo(h,h.length-1,a),u.id=i,this.abilityMap[i]=u,u}xe.error(t+" abiltiy is not defined")},t.update=function(e,t,r){return"Model"===this.get(e).constructor.name?r&&this.checkIsAsset(r)?this.get(e).setProp(t,this.oasis.resourceManager.get(r.id).resource):this.get(e).setProp(t,r):r&&this.checkIsAsset(r)?this.get(e)[t]=this.oasis.resourceManager.get(r.id).resource:this.get(e)[t]=r,{id:e,key:t,value:r}},t.get=function(e){return this.abilityMap[e]},t.delete=function(e){return this.abilityMap[e].destroy(),delete this.abilityMap[e],e},t.getCompConstructor=function(e){var t=e.split(".");if("script"===t[0])return vo[t[1]];var r=Xo._components.o3[e];if(!r)throw new Error(e+" is not defined");return r},t.mixPropsToExplicitProps=function(e){var t=_a({},e);for(var r in e){var n=e[r];if(n&&this.checkIsAsset(n)){var i=this.oasis.resourceManager.get(n.id);i?t[r]=i.resource:(t[r]=null,xe.warn("AbilityManager: can't get asset \""+r+'", which id is '+n.id))}}return t},t.checkIsAsset=function(e){return"asset"===e.type},e}()).prototype,"add",[mo],Object.getOwnPropertyDescriptor(To.prototype,"add"),To.prototype),ba(To.prototype,"update",[yo],Object.getOwnPropertyDescriptor(To.prototype,"update"),To.prototype),ba(To.prototype,"delete",[xo],Object.getOwnPropertyDescriptor(To.prototype,"delete"),To.prototype),To),Io=(bo=ao({after:"nodeAdded"}),Ao=ao({before:"beforeNodeUpdated",after:"nodeUpdated"}),wo=ao({before:"beforeNodeDeleted"}),ba((Co=function(){function e(e){this.oasis=e,this.nodeMap={},this.root=void 0,this.root=new $e(this.oasis.engine,"root")}var t=e.prototype;return t.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},t.add=function(e){return this.create(e),this.append(e.id,e.parent,e.index),this.get(e.id)},t.update=function(e,t,r){return this.get(e)[t]=r,{id:e,key:t,value:r}},t.get=function(e){return this.nodeMap[e]},t.reset=function(){this.nodeMap={}},t.delete=function(e){this.nodeMap[e].destroy(),delete this.nodeMap[e]},t.create=function(e){var t=e.isActive,r=e.position,n=e.rotation,a=e.scale,o=e.id,s=e.name,c=new $e(this.oasis.engine,s);return c.isActive=t,c.transform.position=new i(r[0],r[1],r[2]),c.transform.rotation=new i(n[0],n[1],n[2]),c.transform.scale=new i(a[0],a[1],a[2]),c.id=o,this.nodeMap[o]=c,c},t.append=function(e,t,r){var n=this.nodeMap[e],i=this.nodeMap[t]||this.root;i.addChild(n);var a=i._children;oo(a,a.length-1,r)},e}()).prototype,"add",[bo],Object.getOwnPropertyDescriptor(Co.prototype,"add"),Co.prototype),ba(Co.prototype,"update",[Ao],Object.getOwnPropertyDescriptor(Co.prototype,"update"),Co.prototype),ba(Co.prototype,"delete",[wo],Object.getOwnPropertyDescriptor(Co.prototype,"delete"),Co.prototype),Co),Bo={script:Ro,gltf:go,texture:lo,cubeTexture:Eo,PBRMaterial:fo,PBRSpecularMaterial:_o,UnlitMaterial:po,BlinnPhongMaterial:ho,base:Oo},zo=new Map;for(var Do in Bo)if(Bo.hasOwnProperty(Do)){var No=Bo[Do];zo.set(No,Do)}var Go=function(e,t){return new Bo[t](e)};var Uo,Vo,ko=(Mo=ao({before:"beforeResourceRemove"}),So=ao({after:"resourceUpdated",before:"beforeResourceUpdate"}),ba((Po=function(){function e(e){this.oasis=e,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=void 0,this.engineResourceManager=this.oasis.engine.resourceManager}var t=e.prototype;return t.load=function(e){var t=this,r=Go(this,e.type),n=r.load(this.oasis.engine.resourceManager,e,this.oasis);return this.maxId=Math.max(+e.id,this.maxId),n.then((function(){t.resourceMap[e.id]=r,t.resourceIdMap.set(r,e.id)})),n},t.add=function(e){var t=this,r=Go(this,e.type);return new Promise((function(n){r.loadWithAttachedResources(t.oasis.engine.resourceManager,e,t.oasis).then((function(e){n(t.getAddResourceResult(e.resources,e.structure))}))}))},t.remove=function(e){var t=this;return new Promise((function(r){var n=t.resourceMap[e],i=[e],a=!1;if(delete t.resourceMap[e],n)for(var o=n.attachedResources,s=0;s<o.length;s++){var c=o[s],u=t.resourceIdMap.get(c);u&&(a=!0,t.remove(u).then((function(e){i.push.apply(i,e),r(i)})))}a||r(i)}))},t.update=function(e,t,r){var n=this.get(e);return n&&n.update(t,r),{resource:n,id:e,key:t,value:r}},t.updateMeta=function(e,t,r){var n=this.get(e);n&&n.updateMeta(t,r)},t.get=function(e){return this.resourceMap[e]},t.getAll=function(){return N(this.resourceMap)},t.getAddResourceResult=function(e,t){var r=this,n={},i=e[t.index],a=""+ ++this.maxId;for(var o in this.resourceMap[a]=i,this.resourceIdMap.set(i,a),n.id=this.maxId,n.type=zo.get(i.constructor),n.meta=i.meta,n.props={},t.props)if(t.props.hasOwnProperty(o)){var s=t.props[o];s&&(Array.isArray(s)?n.props[o]=s.map((function(t){return r.getAddResourceResult(e,t)})):n.props[o]=this.getAddResourceResult(e,s))}return n},la(e,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var e;return null==(e=this.oasis.options.useCompressedTexture)||e}}]),e}()).prototype,"remove",[Mo],Object.getOwnPropertyDescriptor(Po.prototype,"remove"),Po.prototype),ba(Po.prototype,"update",[So],Object.getOwnPropertyDescriptor(Po.prototype,"update"),Po.prototype),Po),Ho=(Uo=ao({after:"schemaParsed"}),ba((Vo=function(e){function t(t,r){var n,i;return(i=e.call(this,t.engine)||this)._options=t,i.pluginManager=r,i.engine=null,i.nodeManager=void 0,i.abilityManager=void 0,i.resourceManager=void 0,i._canvas=void 0,i.schema=void 0,i.timeout=void 0,i.oasis=ya(i),i.engine=t.engine,i.schema=t.config,i.timeout=t.timeout,t.scripts=null!=(n=t.scripts)?n:{},i.nodeManager=new Io(ya(i)),i.abilityManager=new Fo(ya(i)),i.nodeManager.add=i.nodeManager.add.bind(i.nodeManager),i.abilityManager.add=i.abilityManager.add.bind(i.abilityManager),i.resourceManager=new ko(ya(i)),t.fps&&(i.engine.targetFrameRate=t.fps,i.engine.vSyncCount=0),i}pa(t,e);var r=t.prototype;return r.updateConfig=function(e){this.schema=e,this.init()},r.init=function(){var e=this;return this.loadResources().then((function(){e.bindResources(),e.parseEntities(),e.attach(),e.nodeManager.addRootEntity(),e.parseNodeAbilities(),e.pluginManager.boot(e)}))},r.loadResources=function(){var e=this,t=this.schema.assets,r=N(void 0===t?{}:t).filter((function(e){return!!Bo[e.type]||(console.warn(e.type+" loader is not defined. the "+e.type+" type will be ignored."),!1)})).map((function(t){return e.resourceManager.load(t)}));return Promise.all(r)},r.bindResources=function(){this.resourceManager.getAll().forEach((function(e){e.bind()}))},r.parseEntities=function(){var e=this.schema.nodes;this.bfsNodes().map((function(t){return e[t]})).forEach(this.nodeManager.add)},r.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map((function(t){return _a({id:t},e[t])})).forEach(this.abilityManager.add)},r.bfsNodes=function(){var e=this.schema.nodes,t=N(e).filter((function(t){return!e[t.parent]})).map((function(e){return e.id})),r=[];return function t(n){r=r.concat(n),n.forEach((function(r){var n=e[r].children;n&&t(n)}))}(t),r},r.attach=function(){this.resourceManager.getAll().forEach((function(e){e.attach()}))},t.create=function(e,r){var n=new t(e,r);return n.init().then((function(){return e.autoPlay&&n.engine.run(),n}))},la(t,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),t}(_e)).prototype,"init",[Uo],Object.getOwnPropertyDescriptor(Vo.prototype,"init"),Vo.prototype),Vo);function Wo(e){for(var t=Object.keys(e),r=0,n=t.length;r<n;++r){var a=t[r],o=e[a];Array.isArray(o)&&(-1!==["color","diffuseColor","specularColor"].indexOf(a)?e[a]=new y(o[0],o[1],o[2],o[3]):4===o.length?e[a]=new v(o[0],o[1],o[2],o[3]):3===o.length?e[a]=new i(o[0],o[1],o[2]):2===o.length&&(e[a]=new g(o[0],o[1])))}}function jo(e){if(void 0===e&&(e={}),e)for(var t=Object.keys(e),r=0,n=t.length;r<n;r++){var a=t[r],o=e[a];"newMaterial"!==a&&"scripts"!==a&&(Array.isArray(o)&&(-1!==["emissiveColor","diffuseColor","specularColor","baseColor"].indexOf(a)?e[a]=new y(o[0],o[1],o[2],o[3]):4===o.length?e[a]=new v(o[0],o[1],o[2],o[3]):3===o.length?e[a]=new i(o[0],o[1],o[2]):2===o.length&&(e[a]=new g(o[0],o[1]))))}}var Xo=function(){var e=t.prototype;function t(){this.pluginManager=new io}return e.parse=function(e){var t,r;3!==(null==e||null===(t=e.config)||void 0===t?void 0:t.version)&&console.warn('schema-parser: schema version "'+(null==e||null===(r=e.config)||void 0===r?void 0:r.version)+'" is out of date, please re-pull the latest version (version 3) of the schema');return function(e){for(var t=e.abilities,r=void 0===t?{}:t,n=e.assets,i=void 0===n?{}:n,a=Object.keys(r),o=Object.keys(i),s=0,c=a.length;s<c;++s)Wo(r[a[s]].props);for(var u=0,l=o.length;u<l;++u)jo(i[o[u]].props)}(e.config),Ho.create(e,this.pluginManager)},e.register=function(e){this.pluginManager.register(e)},e.resetPlugins=function(){this.pluginManager.reset()},t.create=function(){return new t},t.registerComponents=function(e,t){this._components[e]||(this._components[e]={}),ha(this._components[e],t)},t}();Xo._components={};var Ko=Xo.create();function qo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Yo(e,t,r){return t&&qo(e.prototype,t),r&&qo(e,r),e}function Qo(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Jo(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Zo(e,t){return(Zo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var $o=function(){var e=t.prototype;function t(e){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new g;var t=e.width,r=e.height;this._webCanvas=e,this._width=t,this._height=r}return e.resizeByClientSize=function(e){void 0===e&&(e=window.devicePixelRatio);var t=this._webCanvas;if(t instanceof HTMLCanvasElement){var r=t.clientWidth,n=t.clientHeight;this.width=r*e,this.height=n*e}},e.setScale=function(e,t){this._scale.setValue(e,t),this.scale=this._scale},Yo(t,[{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return e instanceof HTMLCanvasElement&&this._scale.setValue(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;t instanceof HTMLCanvasElement&&(t.style.transformOrigin="left top",t.style.transform="scale("+e.x+", "+e.y+")")}}]),t}(),es=function(){function t(e){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=e,this.capabilityList=new Map,this.init(),this.compatibleAllInterface()}var r=t.prototype;return r.canIUse=function(e){return this.capabilityList.get(e)},r.canIUseCompressedTextureInternalFormat=function(t){var r=e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,n=e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,i=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_4X4_KHR,a=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_12X12_KHR,o=e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,s=e.GLCompressedTextureInternalFormat.R11_EAC,c=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ETC2_EAC,u=e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,l=e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,d=e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,h=e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT;return t>=r&&n<=n||t>=i&&t<=a?this.canIUse(e.GLCapabilityType.astc):t===o?this.canIUse(e.GLCapabilityType.etc1):t>=s&&t<=c?this.canIUse(e.GLCapabilityType.etc):t>=u&&t<=l?this.canIUse(e.GLCapabilityType.pvrtc):t>=d&&t<=h&&this.canIUse(e.GLCapabilityType.s3tc)},r.init=function(){var t=this.capabilityList,r=this.rhi.isWebGL2,n=this.rhi.requireExtension.bind(this.rhi),i=e.GLCapabilityType.standardDerivatives,a=e.GLCapabilityType.shaderTextureLod,o=e.GLCapabilityType.elementIndexUint,s=e.GLCapabilityType.depthTexture,c=e.GLCapabilityType.vertexArrayObject,u=e.GLCapabilityType.instancedArrays,l=e.GLCapabilityType.multipleSample,d=e.GLCapabilityType.drawBuffers,h=e.GLCapabilityType.astc,f=e.GLCapabilityType.astc_webkit,_=e.GLCapabilityType.etc,p=e.GLCapabilityType.etc_webkit,g=e.GLCapabilityType.etc1,v=e.GLCapabilityType.etc1_webkit,m=e.GLCapabilityType.pvrtc,y=e.GLCapabilityType.pvrtc_webkit,x=e.GLCapabilityType.s3tc,T=e.GLCapabilityType.s3tc_webkit,b=e.GLCapabilityType.textureFloat,A=e.GLCapabilityType.textureHalfFloat,w=e.GLCapabilityType.textureFloatLinear,C=e.GLCapabilityType.textureHalfFloatLinear,M=e.GLCapabilityType.WEBGL_colorBufferFloat,S=e.GLCapabilityType.colorBufferFloat,P=e.GLCapabilityType.colorBufferHalfFloat,R=e.GLCapabilityType.textureFilterAnisotropic;t.set(i,r||!!n(i)),t.set(a,r||!!n(a)),t.set(o,r||!!n(o)),t.set(s,r||!!n(s)),t.set(c,r||!!n(c)),t.set(u,r||!!n(u)),t.set(l,r),t.set(d,r||!!n(d)),t.set(b,r||!!n(b)),t.set(A,r||!!n(A)),t.set(w,!!n(w)),t.set(C,r||!!n(C)),t.set(S,r&&!!n(S)||!!n(M)),t.set(P,r&&!!n(S)||!!n(P)),t.set(R,!!n(R)),t.set(h,!(!n(h)&&!n(f))),t.set(_,!(!n(_)&&!n(p))),t.set(g,!(!n(g)&&!n(v))),t.set(m,!(!n(m)&&!n(y))),t.set(x,!(!n(x)&&!n(T)))},r.compatibleInterface=function(e,t){var r,n=this.rhi,i=n.gl;if(r=n.requireExtension(e))for(var a in t){var o=r[t[a]];null!=o&&o.bind?i[a]=o.bind(r):i[a]=o}},r.compatibleAllInterface=function(){var t=e.GLCapabilityType.depthTexture,r=e.GLCapabilityType.vertexArrayObject,n=e.GLCapabilityType.instancedArrays,i=e.GLCapabilityType.drawBuffers,a=e.GLCapabilityType.textureFilterAnisotropic,o=e.GLCapabilityType.textureHalfFloat,s=e.GLCapabilityType.colorBufferHalfFloat,c=e.GLCapabilityType.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this.compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this.compatibleInterface(r,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this.compatibleInterface(n,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this.compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var u={};if(this.canIUse(e.GLCapabilityType.drawBuffers)){for(var l=this.maxDrawBuffers,d=0;d<l;d++)0!=d&&(u["COLOR_ATTACHMENT"+d]="COLOR_ATTACHMENT"+d+"_WEBGL"),u["DRAW_BUFFER"+d]="DRAW_BUFFER"+d+"_WEBGL";this.compatibleInterface(i,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Jo(Object(r),!0).forEach((function(t){Qo(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Jo(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({drawBuffers:"drawBuffersWEBGL"},u))}this.compatibleInterface(o,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this.compatibleInterface(s,{RGBA16F:"RBGA16F_EXT"}),this.compatibleInterface(c,{RGBA32F:"RBGA32F_EXT"})}this.compatibleInterface(a,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},Yo(t,[{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(e.GLCapabilityType.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(e.GLCapabilityType.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,r=this.canIUse(e.GLCapabilityType.multipleSample);this._maxAntiAliasing=r?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(e.GLCapabilityType.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}}]),t}(),ts=function(){function e(e){this.rhi=void 0,this._requireResult=void 0,this.rhi=e,this._requireResult={}}return e.prototype.requireExtension=function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]},e}(),rs=function(){function t(t,r){this._primitive=void 0,this.attribLocArray=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=r,this.canUseInstancedArrays=t.canIUse(e.GLCapabilityType.instancedArrays),this._useVao=t.canIUse(e.GLCapabilityType.vertexArrayObject),this.gl=t.gl}var r=t.prototype;return r.draw=function(e,t){var r=this.gl,n=this._primitive;if(this._useVao){this.vao.has(e.id)||this.registerVAO(e);var i=this.vao.get(e.id);r.bindVertexArray(i)}else this.bindBufferAndAttrib(e);var a=n.indexBufferBinding,o=n.instanceCount,s=n._glIndexType,c=t.topology,u=t.start,l=t.count;if(o)if(this.canUseInstancedArrays)if(a)if(this._useVao)r.drawElementsInstanced(c,l,s,u,o);else{var d=a.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,d),r.drawElementsInstanced(c,l,s,u,o),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(c,u,l,o);else xe.error("ANGLE_instanced_arrays extension is not supported");else if(a)if(this._useVao)r.drawElements(c,l,s,u);else{var h=a.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h),r.drawElements(c,l,s,u),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(c,u,l);this._useVao?r.bindVertexArray(null):this.disableAttrib()},r.destroy=function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)}))}},r.bindBufferAndAttrib=function(e){var t=this.gl,r=this._primitive,n=r.vertexBufferBindings;this.attribLocArray=[];var i,a,o=e.attributeLocation,s=r._vertexElementMap;for(var c in o){var u=o[c];if(-1!==u){var l=s[c];if(l){var d=n[l.bindingIndex],h=d.buffer,f=d.stride;a!==(i=h._nativeBuffer)&&(a=i,t.bindBuffer(t.ARRAY_BUFFER,i)),t.enableVertexAttribArray(u);var _=l._glElementInfo,p=_.size,g=_.type;t.vertexAttribPointer(u,p,g,l.normalized,f,l.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(u,l.instanceDivisor),this.attribLocArray.push(u)}else xe.warn("vertex attribute not found: "+c)}}t.bindBuffer(t.ARRAY_BUFFER,null)},r.disableAttrib=function(){for(var e=this.gl,t=0,r=this.attribLocArray.length;t<r;t++)e.disableVertexAttribArray(this.attribLocArray[t])},r.registerVAO=function(e){var t=this.gl,r=t.createVertexArray();t.bindVertexArray(r);var n=this._primitive.indexBufferBinding;n&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.id,r)},t}(),ns=function(){function e(e){this._gl=void 0,this._parameters={},this._gl=e,this._parameters={},this._parameters[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_VERTEX_UNIFORM_VECTORS]=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[e.MAX_VERTEX_ATTRIBS]=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._parameters[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.depthMask(!0),e.disable(e.STENCIL_TEST),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,0,255),e.stencilFuncSeparate(e.BACK,e.ALWAYS,0,255),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0)}return e.prototype.getParameter=function(e){return this._parameters[e]},e}(),is=function(){function e(e){this.gl=void 0,this._vbo=void 0,this._maxBatchCount=void 0,this._vertBuffer=void 0,this._vertCursor=void 0,this._drawSpriteCount=void 0,this._vertAttributes=void 0,this.gl=e,this._initVertexAttributes(e),this._vbo=e.createBuffer(),this._maxBatchCount=0,this._vertBuffer=null,this._vertCursor=0,this._drawSpriteCount=0}var t=e.prototype;return t.setMaxBatchCount=function(e){var t=6*e*9;this._vertBuffer&&this._vertBuffer.length>=t||(this._maxBatchCount=e,this._vertBuffer=new Float32Array(t))},t.beginDraw=function(e){this._vertCursor=0,this._drawSpriteCount=0,e>this._maxBatchCount&&this.setMaxBatchCount(e)},t.drawSprite=function(e,t,r){if(this._drawSpriteCount++,this._drawSpriteCount>this._maxBatchCount)xe.warn("Sprite: sprite count overflow");else{var n=r,i=t.u,a=t.v,o=t.u+t.width,s=t.v+t.height;this._pushVertex(e.leftTop,new g(i,a),n),this._pushVertex(e.leftBottom,new g(i,s),n),this._pushVertex(e.rightBottom,new g(o,s),n),this._pushVertex(e.rightBottom,new g(o,s),n),this._pushVertex(e.rightTop,new g(o,a),n),this._pushVertex(e.leftTop,new g(i,a),n)}},t.endDraw=function(e){var t=this._vertCursor/9;if(!(t<=0)){var r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,this._vbo),r.bufferData(r.ARRAY_BUFFER,this._vertBuffer,r.DYNAMIC_DRAW);var n=e.attributeLocation;for(var i in n){var a=n[i],o=this._vertAttributes[i];r.vertexAttribPointer(a,o.size,o.type,o.normalized,o.stride,o.offset),r.enableVertexAttribArray(a)}for(var s in r.drawArrays(r.TRIANGLES,0,t),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),r.bindBuffer(r.ARRAY_BUFFER,null),n)r.disableVertexAttribArray(n[s])}},t._initVertexAttributes=function(e){var t={name:"a_pos",size:3,offset:0},r={name:"a_uv",size:2,offset:12},n={name:"a_color",size:4,offset:20};for(var i in this._vertAttributes={a_pos:t,a_uv:r,a_color:n},this._vertAttributes){var a=this._vertAttributes[i];a.type=e.FLOAT,a.normalized=!1,a.stride=36}},t._pushVertex=function(e,t,r){var n=this._vertBuffer,i=this._vertCursor;n[i]=e.x,n[i+1]=e.y,n[i+2]=e.z,n[i+3]=t.x,n[i+4]=t.y,n[i+5]=r.x,n[i+6]=r.y,n[i+7]=r.z,n[i+8]=r.w,this._vertCursor+=9},t.finalize=function(){this._vbo&&(this.gl.deleteBuffer(this._vbo),this._vbo=null)},e}();yt.create("Sprite","\nprecision highp float;\n\nuniform mat4 matProjection;\nuniform mat4 matView;\n\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  gl_Position = matProjection * matView * vec4(a_pos,1.0);\n  v_uv = a_uv;\n  v_color = a_color;\n}\n","\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D s_diffuse;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  // Only use the Alpha of the texture as a mask, so that the tint color can still be controlled to fade out.\n  vec4 baseColor = texture2D(s_diffuse, v_uv);\n  gl_FragColor = baseColor * v_color;\n}\n");var as,os=function(){function e(e){this._gl=void 0,this._batchedQueue=void 0,this._targetTexture=void 0,this._glSprite=void 0,this._camera=void 0,this._gl=e.gl,this._batchedQueue=[],this._targetTexture=null,this._glSprite=new is(e.gl),this._camera=null}var t=e.prototype;return t.flush=function(e,t){if(0!==this._batchedQueue.length)if(this._targetTexture){var r=t.shaderData;r.setTexture("s_diffuse",this._targetTexture),r.setMatrix("matView",this._camera.viewMatrix),r.setMatrix("matProjection",this._camera.projectionMatrix);var n=lt.compileMacros;n.clear();var i=t.shader._getShaderProgram(e,n);if(i.isValid){i.bind(),i.groupingOtherUniformBlock(),i.uploadAll(i.materialUniformBlock,r),t.renderState._apply(e),this._glSprite.beginDraw(this._batchedQueue.length);for(var a=0,o=this._batchedQueue.length;a<o;a++){var s=this._batchedQueue[a].positionQuad,c=this._batchedQueue[a].uvRect,u=this._batchedQueue[a].tintColor;this._glSprite.drawSprite(s,c,u)}this._glSprite.endDraw(i),this._batchedQueue=[],this._targetTexture=null,this._camera=null}}else xe.error("No texture!")},t.canBatch=function(e,t,r){return null===this._targetTexture||e===this._targetTexture&&r===this._camera},t.drawSprite=function(e,t,r,n,i,a,o){this.canBatch(i,a,o)||this.flush(o.engine,e),this._targetTexture=i,this._camera=o,this._batchedQueue.push({positionQuad:t,uvRect:r,tintColor:n})},t.finalize=function(){this._glSprite.finalize()},e}();(as=e.WebGLMode||(e.WebGLMode={}))[as.Auto=0]="Auto",as[as.WebGL2=1]="WebGL2",as[as.WebGL1=2]="WebGL1";var ss=function(){function t(e){void 0===e&&(e={}),this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._spriteBatcher=void 0,this._capability=void 0,this._isWebGL2=void 0,this._activedTextureID=void 0,this._activeTextures=new Array(32),this._options=e}var r=t.prototype;return r.init=function(t){var r,n=this._options,i=t._webCanvas,a=n.webGLMode||e.WebGLMode.Auto;if(a!=e.WebGLMode.Auto&&a!=e.WebGLMode.WebGL2||(!(r=i.getContext("webgl2",n))&&i instanceof HTMLCanvasElement&&(r=i.getContext("experimental-webgl2",n)),this._isWebGL2=!0),r||a!=e.WebGLMode.Auto&&a!=e.WebGLMode.WebGL1||(!(r=i.getContext("webgl",n))&&i instanceof HTMLCanvasElement&&(r=i.getContext("experimental-webgl",n)),this._isWebGL2=!1),!r)throw new Error("Get GL Context FAILED.");this._gl=r,this._renderStates=new ns(r),this._extensions=new ts(this),this._capability=new es(this),this._options=null},r.createPlatformPrimitive=function(e){return new rs(this,e)},r.requireExtension=function(e){return this._extensions.requireExtension(e)},r.canIUse=function(e){return this.capability.canIUse(e)},r.canIUseCompressedTextureInternalFormat=function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)},r.viewport=function(e,t,r,n){var i=this._gl;i.viewport(e,i.drawingBufferHeight-t-n,r,n)},r.colorMask=function(e,t,r,n){this._gl.colorMask(e,t,r,n)},r.clearRenderTarget=function(t,r,n){var i=this._gl,a=t._lastRenderState,o=a.blendState.targetBlendState.colorWriteMask,s=a.depthState.writeEnabled,c=a.stencilState.writeMask,u=!1,l=!1,d=!1;switch(r){case e.ClearMode.SOLID_COLOR:i.clearColor(n.x,n.y,n.z,n.w),u=l=!0;break;case e.ClearMode.DEPTH_ONLY:l=!0;break;case e.ClearMode.COLOR_ONLY:i.clearColor(n.x,n.y,n.z,n.w),u=!0;break;case e.ClearMode.STENCIL_ONLY:i.clear(i.STENCIL_BUFFER_BIT),d=!0;break;case e.ClearMode.ALL_CLEAR:i.clearColor(n.x,n.y,n.z,n.w),u=l=d=!0}u&&o!==e.ColorWriteMask.All&&(i.colorMask(!0,!0,!0,!0),a.blendState.targetBlendState.colorWriteMask=e.ColorWriteMask.All),l&&!0!==s&&(i.depthMask(!0),a.depthState.writeEnabled=!0),d&&255!==c&&(i.stencilMask(255),a.stencilState.writeMask=255),i.clear((u?i.COLOR_BUFFER_BIT:0)|(l?i.DEPTH_BUFFER_BIT:0)|(d?i.STENCIL_BUFFER_BIT:0))},r.drawPrimitive=function(e,t,r){e?e._draw(r,t):xe.error("draw primitive failed.")},r.drawSprite=function(e,t,r,n,i,a,o){this._spriteBatcher||(this._spriteBatcher=new os(this)),this._spriteBatcher.drawSprite(e,t,r,n,i,a,o)},r.flushSprite=function(e,t){this._spriteBatcher&&this._spriteBatcher.flush(e,t)},r.activeRenderTarget=function(e,t){var r=this._gl;if(e){e._activeRenderTarget();var n=e.width,i=e.height;r.viewport(0,0,n,i)}else{r.bindFramebuffer(r.FRAMEBUFFER,null);var a=t.viewport,o=r.drawingBufferWidth,s=r.drawingBufferHeight;this.viewport(a.x*o,a.y*s,a.z*o,a.w*s)}},r.blitRenderTarget=function(e){e&&e._MSAAFrameBuffer&&e._blitRenderTarget()},r.setRenderTargetFace=function(e,t){e&&e._setRenderTargetFace(t)},r.destroy=function(){},r.activeTexture=function(e){this._activedTextureID!==e&&(this._gl.activeTexture(e),this._activedTextureID=e)},r.bindTexture=function(e,t){var r=this._gl;this._activeTextures[this._activedTextureID-r.TEXTURE0]!==t&&(r.bindTexture(e,t),this._activeTextures[this._activedTextureID-r.TEXTURE0]=t)},Yo(t,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),t}(),cs=function(e){var t,r;function n(t,r){var n=new $o("string"==typeof t?document.getElementById(t):t),i=new ss(r);return e.call(this,n,i)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,Zo(t,r),Yo(n,[{key:"canvas",get:function(){return this._canvas}}]),n}(vr);Xo.registerComponents("o3",{GLTFModel:no,SpriteRenderer:ui,PointLight:wt,AmbientLight:Tt,DirectLight:bt,EnvironmentMapLight:At,ParticleRenderer:Bi,SkyBox:Ii,BoxCollider:Gi,GeometryRenderer:Ti,Camera:$r,Component:Qe,SphereCollider:Ui,Model:Li});var us="0.2.1";console.log("oasis engine version: 0.2.1"),e.ABoxCollider=ln,e.ACollider=un,e.ASphereCollider=dn,e.AmbientLight=Tt,e.Animation=yi,e.AnimationClip=li,e.AssetPromise=z,e.BasicRenderPipeline=Yr,e.BlinnPhongMaterial=Vr,e.BoundingBox=o,e.BoundingFrustum=u,e.BoundingSphere=a,e.BoxCollider=Gi,e.Buffer=$n,e.BufferGeometry=xi,e.BufferUtil=Jn,e.Camera=$r,e.CircleGeometry=Si,e.ColliderFeature=cn,e.CollisionDetection=Hi,e.CollisionUtil=s,e.Color=y,e.Component=Qe,e.CubeProbe=Ji,e.CuboidGeometry=Ai,e.CylinderGeometry=Mi,e.DirectLight=bt,e.EXP2Fog=ji,e.Engine=vr,e.EngineFeature=yr,e.EngineObject=fe,e.Entity=$e,e.EnvironmentMapLight=At,e.Event=k,e.EventDispatcher=_e,e.Fog=Wi,e.GLTFModel=no,e.GeometryRenderer=Ti,e.IndexBufferBinding=ei,e.LODGroup=Vn,e.Light=xt,e.LightFeature=Mt,e.LinearFog=Xi,e.Loader=sn,e.Logger=xe,e.Material=Ur,e.MathUtil=n,e.Matrix=h,e.Matrix3x3=l,e.Mesh=An,e.MeshRenderer=Nn,e.Model=Li,e.Oasis=Ho,e.ObjectValues=N,e.PBRMaterial=Hr,e.PBRSpecularMaterial=Wr,e.Parser=Xo,e.ParticleRenderer=Bi,e.Plane=c,e.PlaneCollider=hn,e.PlaneGeometry=Ci,e.PointLight=wt,e.Primitive=ri,e.Probe=Ki,e.Quaternion=d,e.Ray=f,e.RefObject=Ft,e.RegistExtension=function(e){Object.keys(e).forEach((function(t){if(void 0===za[t])switch(za[t]=e[t],t){case Ga:Va=e[t],ka.KHR_lights=Va;break;default:Ur.isPrototypeOf(e[t])&&e[t].TECH_NAME&&(Da[e[t].TECH_NAME]=e[t])}}))},e.RenderColorTexture=qn,e.RenderDepthTexture=Xn,e.RenderElement=tt,e.RenderPass=Kr,e.RenderQueue=lt,e.RenderTarget=Kn,e.Renderer=Tr,e.ResourceManager=G,e.Scene=zt,e.SceneFeature=ut,e.SchemaResource=uo,e.ScreenQuadGeometry=Pi,e.Script=xr,e.Shader=yt,e.ShaderFactory=ft,e.ShapeGeometry=bi,e.Skin=wn,e.SkinnedMeshRenderer=Un,e.SkyBox=Ii,e.SphereCollider=Ui,e.SphereGeometry=wi,e.Spherical=p,e.SpotLight=Ct,e.SpriteRenderer=ui,e.SubPrimitive=ci,e.SystemInfo=mr,e.Texture=It,e.Texture2D=Gn,e.TextureCubeMap=jn,e.Time=Te,e.TorusGeometry=Ri,e.TrailMaterial=zi,e.TrailRenderer=Ni,e.Transform=Ze,e.UnlitMaterial=jr,e.UpdateFlag=Je,e.Util=D,e.Vector2=g,e.Vector3=i,e.Vector4=v,e.VertexBufferBinding=ti,e.VertexElement=si,e.WebCanvas=$o,e.WebGLEngine=cs,e.WebGLRenderer=ss,e.dependencies=Fe,e.parseSingleKTX=ro,e.parser=Ko,e.registerResource=function(e,t){Bo.hasOwnProperty(e)||(Bo[e]=t,zo.set(t,e))},e.request=tn,e.resourceLoader=U,e.script=function(e){return function(t){vo[e]=t}},e.version=us,Object.defineProperty(e,"__esModule",{value:!0})}));
